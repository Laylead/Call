<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firebase Admin/User Dashboard</title>
<style>
  /* Basic styling to keep dashboard clean and consistent */
  body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
  #authForm, #dashboard { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 5px; }
  label { display: block; margin-top: 15px; }
  input, select, button { padding: 8px; width: 100%; margin-top: 5px; box-sizing: border-box; }
  button { cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 3px; }
  button:hover { background-color: #0056b3; }
  #dashboardTabs button { margin-right: 8px; padding: 8px 16px; border-radius: 4px; border: 1px solid #ddd; background: #f0f0f0; }
  #dashboardTabs button.active { background: #007bff; color: white; border-color: #007bff; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  table, th, td { border: 1px solid #ddd; }
  th, td { padding: 8px; text-align: left; }
  .badge { padding: 4px 8px; border-radius: 12px; color: white; font-size: 0.8em; }
  .success { background-color: #28a745; }
  .danger { background-color: #dc3545; }
  .warning { background-color: #ffc107; color: #212529; }
  #alertBox { padding: 10px; margin-bottom: 15px; border-radius: 4px; display: none; }
  #logoutBtn { float: right; margin-top: -40px; }
  .stats-cards { display: flex; gap: 15px; margin-top: 10px; }
  .stat-card { flex: 1; background: #007bff; color: white; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<div id="alertBox"></div>

<!-- Authentication Form -->
<div id="authForm">
  <h2 id="formTitle">Login</h2>
  <form>
    <label for="fullnameInput" style="display:none;">Full Name</label>
    <input type="text" id="fullnameInput" placeholder="Full Name" style="display:none;" />
    
    <label for="emailInput">Email</label>
    <input type="email" id="emailInput" placeholder="Email" required />
    
    <label for="passwordInput">Password</label>
    <input type="password" id="passwordInput" placeholder="Password" required minlength="6" />
    
    <label for="referralCodeInput" style="display:none;">Referral Code (optional)</label>
    <input type="text" id="referralCodeInput" placeholder="Referral Code (optional)" style="display:none;" />
    
    <button type="submit" id="submitBtn">Login</button>
  </form>
  <p id="toggleAuthText">Don't have an account? <a href="#" id="toggleAuthLink">Register</a></p>
</div>

<button id="logoutBtn" style="display:none;">Logout</button>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <div id="dashboardTabs"></div>
  <div id="dashboardContent" style="margin-top: 20px;"></div>
</div>

<!-- Firebase + app script -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Your config file -->
<script src="configuration.js"></script>

<script>
(async () => {
  // Initialize Firebase App (from your configuration.js)
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI elements
  const authForm = document.querySelector('#authForm form');
  const formTitle = document.getElementById('formTitle');
  const fullnameInput = document.getElementById('fullnameInput');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const referralCodeInput = document.getElementById('referralCodeInput');
  const submitBtn = document.getElementById('submitBtn');
  const toggleAuthText = document.getElementById('toggleAuthText');
  const toggleAuthLink = document.getElementById('toggleAuthLink');
  const logoutBtn = document.getElementById('logoutBtn');
  const dashboard = document.getElementById('dashboard');
  const dashboardTabs = document.getElementById('dashboardTabs');
  const dashboardContent = document.getElementById('dashboardContent');
  const alertBox = document.getElementById('alertBox');

  let isRegister = false;
  let currentUser = null;
  let userRole = null;

  // Toggle form between login/register
  toggleAuthLink.onclick = e => {
    e.preventDefault();
    isRegister = !isRegister;
    if (isRegister) {
      formTitle.textContent = 'Register';
      fullnameInput.style.display = 'block';
      referralCodeInput.style.display = 'block';
      referralCodeInput.previousElementSibling.style.display = 'block'; // label
      fullnameInput.previousElementSibling.style.display = 'block'; // label
      submitBtn.textContent = 'Register';
      toggleAuthText.innerHTML = 'Already have an account? <a href="#" id="toggleAuthLink">Login</a>';
    } else {
      formTitle.textContent = 'Login';
      fullnameInput.style.display = 'none';
      referralCodeInput.style.display = 'none';
      referralCodeInput.previousElementSibling.style.display = 'none'; // label
      fullnameInput.previousElementSibling.style.display = 'none'; // label
      submitBtn.textContent = 'Login';
      toggleAuthText.innerHTML = 'Don\'t have an account? <a href="#" id="toggleAuthLink">Register</a>';
    }
    // Re-bind the new toggle link:
    document.getElementById('toggleAuthLink').onclick = toggleAuthLink.onclick;
    clearForm();
  };

  // Clear inputs
  function clearForm() {
    fullnameInput.value = '';
    emailInput.value = '';
    passwordInput.value = '';
    referralCodeInput.value = '';
  }

  // Show alert
  function showAlert(message, type = 'info') {
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.style.display = 'block';
    setTimeout(() => alertBox.style.display = 'none', 4000);
  }

  // Format Firestore timestamp
  function formatDate(timestamp) {
    if (!timestamp) return '-';
    const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return d.toLocaleString();
  }

  // Register new user
  async function registerUser(fullname, email, password, referralCode) {
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      currentUser = userCredential.user;

      // Save user data to Firestore
      let referralUid = null;
      if (referralCode) {
        // Try to find referrer by token (assuming token is uid)
        const refUserSnap = await db.collection('users').doc(referralCode).get();
        if (refUserSnap.exists) referralUid = refUserSnap.id;
      }

      await db.collection('users').doc(currentUser.uid).set({
        fullname,
        email,
        role: 'user',
        status: 'active',
        referrals: [],
        earned: 0,
        withdrawn: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        referralUid,
      });

      // Add referral to referrer if applicable
      if (referralUid) {
        const refDoc = db.collection('users').doc(referralUid);
        await refDoc.update({
          referrals: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
      }

      showAlert('Registration successful. Logged in!', 'success');
      clearForm();
    } catch (err) {
      showAlert(`Registration error: ${err.message}`, 'danger');
    }
  }

  // Login user
  async function loginUser(email, password) {
    try {
      await auth.signInWithEmailAndPassword(email, password);
      showAlert('Login successful', 'success');
      clearForm();
    } catch (err) {
      showAlert(`Login error: ${err.message}`, 'danger');
    }
  }

  // Auth form submit handler
  authForm.onsubmit = async e => {
    e.preventDefault();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (isRegister) {
      const fullname = fullnameInput.value.trim();
      const referralCode = referralCodeInput.value.trim();

      if (!fullname) {
        showAlert('Full name is required for registration.', 'warning');
        return;
      }
      if (password.length < 6) {
        showAlert('Password must be at least 6 characters.', 'warning');
        return;
      }
      await registerUser(fullname, email, password, referralCode);
    } else {
      await loginUser(email, password);
    }
  };

  // Logout button
  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // Tabs for admin and user
  const adminTabs = ['Overview', 'Tokens', 'Users', 'Affiliates', 'Withdrawals', 'Settings'];
  const userTabs = ['Dashboard', 'Referrals', 'Withdrawals', 'Account'];

  function renderTabs() {
    dashboardTabs.innerHTML = '';
    let tabs = userRole === 'admin' ? adminTabs : userTabs;
    tabs.forEach(tab => {
      const btn = document.createElement('button');
      btn.textContent = tab;
      btn.onclick = () => setActiveTab(tab);
      dashboardTabs.appendChild(btn);
    });
    setActiveTab(tabs[0]);
  }

  function setActiveTab(tabName) {
    Array.from(dashboardTabs.children).forEach(btn => {
      btn.classList.toggle('active', btn.textContent === tabName);
    });
    loadTabContent(tabName);
  }

  // Load tab content
  async function loadTabContent(tabName) {
    dashboardContent.innerHTML = '';
    if (userRole === 'admin') {
      switch (tabName) {
        case 'Overview': await renderAdminOverview(); break;
        case 'Tokens': await renderAdminTokens(); break;
        case 'Users': await renderAdminUsers(); break;
        case 'Affiliates': await renderAdminAffiliates(); break;
        case 'Withdrawals': await renderAdminWithdrawals(); break;
        case 'Settings': await renderAdminSettings(); break;
      }
    } else {
      switch (tabName) {
        case 'Dashboard': await renderUserDashboard(); break;
        case 'Referrals': await renderUserReferrals(); break;
        case 'Withdrawals': await renderUserWithdrawals(); break;
        case 'Account': await renderUserAccount(); break;
      }
    }
  }

  // ======= ADMIN RENDERERS =======

  async function renderAdminOverview() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Admin Overview</h2>`;

    // Fetch stats
    const usersSnap = await db.collection('users').get();
    const withdrawalsSnap = await db.collection('withdrawals').get();

    const totalUsers = usersSnap.size;
    const totalWithdrawals = withdrawalsSnap.size;

    // Calculate total earnings and total withdrawn
    let totalEarned = 0;
    let totalWithdrawn = 0;

    usersSnap.forEach(doc => {
      const u = doc.data();
      totalEarned += u.earned || 0;
      totalWithdrawn += u.withdrawn || 0;
    });

    const cardsDiv = document.createElement('div');
    cardsDiv.className = 'stats-cards';

    cardsDiv.innerHTML = `
      <div class="stat-card">Users<br><strong>${totalUsers}</strong></div>
      <div class="stat-card">Total Earned<br><strong>$${totalEarned.toFixed(2)}</strong></div>
      <div class="stat-card">Total Withdrawn<br><strong>$${totalWithdrawn.toFixed(2)}</strong></div>
      <div class="stat-card">Withdrawals<br><strong>${totalWithdrawals}</strong></div>
    `;

    content.appendChild(cardsDiv);
    dashboardContent.appendChild(content);
  }

  async function renderAdminTokens() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Tokens Management</h2>`;

    // Show tokens list
    const tokensTable = document.createElement('table');
    tokensTable.innerHTML = `
      <thead><tr><th>Token</th><th>Assigned To</th><th>Created At</th><th>Actions</th></tr></thead>
      <tbody id="tokensBody"></tbody>
    `;
    content.appendChild(tokensTable);
    dashboardContent.appendChild(content);

    const tokensBody = tokensTable.querySelector('#tokensBody');

    async function loadTokens() {
      tokensBody.innerHTML = '';
      const tokensSnap = await db.collection('tokens').orderBy('createdAt', 'desc').get();
      tokensSnap.forEach(doc => {
        const t = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${t.assignedToEmail || '-'}</td>
          <td>${formatDate(t.createdAt)}</td>
          <td><button data-id="${doc.id}" class="deleteTokenBtn">Delete</button></td>
        `;
        tokensBody.appendChild(tr);
      });

      // Delete token buttons
      tokensBody.querySelectorAll('.deleteTokenBtn').forEach(btn => {
        btn.onclick = async () => {
          if(confirm('Delete this token?')) {
            await db.collection('tokens').doc(btn.dataset.id).delete();
            showAlert('Token deleted', 'success');
            loadTokens();
          }
        };
      });
    }

    await loadTokens();

    // Token generator form
    const generateForm = document.createElement('form');
    generateForm.innerHTML = `
      <h3>Generate New Token</h3>
      <label for="tokenUserEmail">Assign to User Email (optional):</label>
      <input type="email" id="tokenUserEmail" placeholder="User email" />
      <button type="submit">Generate Token</button>
    `;
    content.appendChild(generateForm);

    generateForm.onsubmit = async e => {
      e.preventDefault();
      const email = generateForm.querySelector('#tokenUserEmail').value.trim();

      let assignedToUid = null;
      let assignedToEmail = null;
      if (email) {
        // Find user by email
        const usersRef = db.collection('users');
        const query = await usersRef.where('email', '==', email).get();
        if (query.empty) {
          showAlert('User email not found.', 'warning');
          return;
        }
        assignedToUid = query.docs[0].id;
        assignedToEmail = email;
      }

      // Generate random token string
      const tokenId = 'token-' + Math.random().toString(36).slice(2, 12);
      await db.collection('tokens').doc(tokenId).set({
        assignedToUid,
        assignedToEmail,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showAlert('Token generated: ' + tokenId, 'success');
      generateForm.reset();
      loadTokens();
    };
  }

  async function renderAdminUsers() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Users Management</h2>`;

    const usersTable = document.createElement('table');
    usersTable.innerHTML = `
      <thead>
        <tr><th>Full Name / Email</th><th>Referrals</th><th>Earned</th><th>Withdrawn</th><th>Balance</th><th>Status</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody id="usersBody"></tbody>
    `;
    content.appendChild(usersTable);
    dashboardContent.appendChild(content);

    const usersBody = usersTable.querySelector('#usersBody');

    async function loadUsers() {
      usersBody.innerHTML = '';
      const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
      usersSnap.forEach(doc => {
        const u = doc.data();
        const balance = (u.earned || 0) - (u.withdrawn || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.fullname || u.email}</td>
          <td>${(u.referrals || []).length}</td>
          <td>$${(u.earned || 0).toFixed(2)}</td>
          <td>$${(u.withdrawn || 0).toFixed(2)}</td>
          <td>$${balance.toFixed(2)}</td>
          <td>${u.status || 'active'}</td>
          <td>${u.role || 'user'}</td>
          <td>
            <button class="toggleStatusBtn" data-id="${doc.id}">${u.status === 'active' ? 'Disable' : 'Enable'}</button>
            <button class="changeRoleBtn" data-id="${doc.id}">${u.role === 'admin' ? 'Make User' : 'Make Admin'}</button>
          </td>
        `;
        usersBody.appendChild(tr);
      });

      // Status toggles
      usersBody.querySelectorAll('.toggleStatusBtn').forEach(btn => {
        btn.onclick = async () => {
          const userId = btn.dataset.id;
          const userDoc = await db.collection('users').doc(userId).get();
          const userData = userDoc.data();
          const newStatus = userData.status === 'active' ? 'disabled' : 'active';
          if(confirm(`Change status to ${newStatus}?`)) {
            await db.collection('users').doc(userId).update({ status: newStatus });
            showAlert('User status updated', 'success');
            loadUsers();
          }
        };
      });

      // Role toggles
      usersBody.querySelectorAll('.changeRoleBtn').forEach(btn => {
        btn.onclick = async () => {
          const userId = btn.dataset.id;
          const userDoc = await db.collection('users').doc(userId).get();
          const userData = userDoc.data();
          const newRole = userData.role === 'admin' ? 'user' : 'admin';
          if(confirm(`Change role to ${newRole}?`)) {
            await db.collection('users').doc(userId).update({ role: newRole });
            showAlert('User role updated', 'success');
            loadUsers();
          }
        };
      });
    }

    await loadUsers();
  }

  async function renderAdminAffiliates() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Affiliates Overview</h2>`;

    // Affiliates table
    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr><th>User</th><th>Referrals</th><th>Earned</th><th>Withdrawn</th><th>Balance</th></tr></thead>
      <tbody id="affiliatesBody"></tbody>
    `;
    content.appendChild(table);
    dashboardContent.appendChild(content);

    const tbody = table.querySelector('#affiliatesBody');

    async function loadAffiliates() {
      tbody.innerHTML = '';
      const usersSnap = await db.collection('users').get();
      usersSnap.forEach(doc => {
        const u = doc.data();
        if ((u.referrals || []).length > 0) {
          const balance = (u.earned || 0) - (u.withdrawn || 0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.fullname || u.email}</td>
            <td>${u.referrals.length}</td>
            <td>$${(u.earned || 0).toFixed(2)}</td>
            <td>$${(u.withdrawn || 0).toFixed(2)}</td>
            <td>$${balance.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        }
      });
    }

    await loadAffiliates();
  }

  async function renderAdminWithdrawals() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Withdrawals Management</h2>`;

    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr><th>User</th><th>Amount</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
      <tbody id="withdrawalsBody"></tbody>
    `;
    content.appendChild(table);
    dashboardContent.appendChild(content);

    const tbody = table.querySelector('#withdrawalsBody');

    async function loadWithdrawals() {
      tbody.innerHTML = '';
      const withdrawalsSnap = await db.collection('withdrawals').orderBy('createdAt', 'desc').get();
      withdrawalsSnap.forEach(doc => {
        const w = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${w.userFullname || w.userEmail || '-'}</td>
          <td>$${w.amount.toFixed(2)}</td>
          <td><span class="badge ${w.status === 'pending' ? 'warning' : w.status === 'approved' ? 'success' : 'danger'}">${w.status}</span></td>
          <td>${formatDate(w.createdAt)}</td>
          <td>
            ${w.status === 'pending' ? `<button class="approveBtn" data-id="${doc.id}">Approve</button> <button class="rejectBtn" data-id="${doc.id}">Reject</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('.approveBtn').forEach(btn => {
        btn.onclick = async () => {
          if(confirm('Approve this withdrawal?')) {
            await db.collection('withdrawals').doc(btn.dataset.id).update({ status: 'approved' });
            showAlert('Withdrawal approved', 'success');
            loadWithdrawals();
          }
        };
      });

      tbody.querySelectorAll('.rejectBtn').forEach(btn => {
        btn.onclick = async () => {
          if(confirm('Reject this withdrawal?')) {
            await db.collection('withdrawals').doc(btn.dataset.id).update({ status: 'rejected' });
            showAlert('Withdrawal rejected', 'success');
            loadWithdrawals();
          }
        };
      });
    }

    await loadWithdrawals();
  }

  async function renderAdminSettings() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Settings</h2><p>Settings functionality can be added here.</p>`;
    dashboardContent.appendChild(content);
  }

  // ======= USER RENDERERS =======

  async function renderUserDashboard() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Your Dashboard</h2>`;

    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const u = userDoc.data();

    const earned = u.earned || 0;
    const withdrawn = u.withdrawn || 0;
    const balance = earned - withdrawn;

    const statsHTML = `
      <p><strong>Full Name:</strong> ${u.fullname || ''}</p>
      <p><strong>Email:</strong> ${u.email}</p>
      <p><strong>Total Earned:</strong> $${earned.toFixed(2)}</p>
      <p><strong>Total Withdrawn:</strong> $${withdrawn.toFixed(2)}</p>
      <p><strong>Balance:</strong> $${balance.toFixed(2)}</p>
    `;
    content.innerHTML += statsHTML;

    dashboardContent.appendChild(content);
  }

  async function renderUserReferrals() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Your Referrals</h2>`;

    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const u = userDoc.data();

    const referrals = u.referrals || [];

    if (referrals.length === 0) {
      content.innerHTML += `<p>You have no referrals yet.</p>`;
    } else {
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>Full Name</th><th>Email</th><th>Status</th></tr></thead>`;
      const tbody = document.createElement('tbody');

      for (const refUid of referrals) {
        const refDoc = await db.collection('users').doc(refUid).get();
        const refData = refDoc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${refData.fullname || ''}</td>
          <td>${refData.email || ''}</td>
          <td>${refData.status || 'active'}</td>
        `;
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      content.appendChild(table);
    }
    dashboardContent.appendChild(content);
  }

  async function renderUserWithdrawals() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Your Withdrawals</h2>`;

    const withdrawalsSnap = await db.collection('withdrawals').where('userUid', '==', currentUser.uid).orderBy('createdAt', 'desc').get();

    if (withdrawalsSnap.empty) {
      content.innerHTML += `<p>You have no withdrawal requests yet.</p>`;
    } else {
      const table = document.createElement('table');
      table.innerHTML = `
        <thead><tr><th>Amount</th><th>Status</th><th>Date</th></tr></thead>
      `;
      const tbody = document.createElement('tbody');
      withdrawalsSnap.forEach(doc => {
        const w = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>$${w.amount.toFixed(2)}</td>
          <td><span class="badge ${w.status === 'pending' ? 'warning' : w.status === 'approved' ? 'success' : 'danger'}">${w.status}</span></td>
          <td>${formatDate(w.createdAt)}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      content.appendChild(table);
    }

    // Request withdrawal form
    const form = document.createElement('form');
    form.innerHTML = `
      <h3>Request Withdrawal</h3>
      <label for="withdrawAmount">Amount to Withdraw</label>
      <input type="number" id="withdrawAmount" min="1" step="0.01" placeholder="Enter amount" required />
      <button type="submit">Request Withdrawal</button>
    `;
    content.appendChild(form);

    form.onsubmit = async e => {
      e.preventDefault();
      const amount = parseFloat(form.withdrawAmount.value);
      if (isNaN(amount) || amount <= 0) {
        showAlert('Please enter a valid withdrawal amount.', 'warning');
        return;
      }

      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      const u = userDoc.data();
      const balance = (u.earned || 0) - (u.withdrawn || 0);

      if (amount > balance) {
        showAlert('Withdrawal amount exceeds your available balance.', 'danger');
        return;
      }

      // Add withdrawal request
      await db.collection('withdrawals').add({
        userUid: currentUser.uid,
        userFullname: u.fullname || '',
        userEmail: u.email,
        amount,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showAlert('Withdrawal request submitted.', 'success');
      form.reset();
      renderUserWithdrawals(); // reload withdrawals list
    };

    dashboardContent.appendChild(content);
  }

  async function renderUserAccount() {
    const content = document.createElement('div');
    content.innerHTML = `<h2>Account Settings</h2>`;

    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const u = userDoc.data();

    const form = document.createElement('form');
    form.innerHTML = `
      <label for="fullname">Full Name</label>
      <input type="text" id="fullname" value="${u.fullname || ''}" required />
      <label for="email" style="opacity:0.6;">Email (cannot change)</label>
      <input type="email" id="email" value="${u.email}" disabled />
      <label for="password">Change Password (leave blank if no change)</label>
      <input type="password" id="password" placeholder="New Password" minlength="6" />
      <button type="submit">Update Account</button>
    `;
    content.appendChild(form);
    dashboardContent.appendChild(content);

    form.onsubmit = async e => {
      e.preventDefault();
      const fullname = form.fullname.value.trim();
      const newPassword = form.password.value.trim();

      if (!fullname) {
        showAlert('Full name cannot be empty.', 'warning');
        return;
      }

      try {
        await db.collection('users').doc(currentUser.uid).update({ fullname });
        if (newPassword.length >= 6) {
          await currentUser.updatePassword(newPassword);
        }
        showAlert('Account updated successfully.', 'success');
      } catch (err) {
        showAlert('Error updating account: ' + err.message, 'danger');
      }
    };
  }

  // Check if user is logged in
  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;

      // Fetch user role from Firestore
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (!userDoc.exists) {
        // User data missing in Firestore? Log out
        await auth.signOut();
        showAlert('User record not found. Please register again.', 'danger');
        return;
      }
      userRole = userDoc.data().role || 'user';

      authForm.style.display = 'none';
      logoutBtn.style.display = 'block';
      dashboard.style.display = 'block';

      renderTabs();
    } else {
      currentUser = null;
      userRole = null;
      authForm.style.display = 'block';
      logoutBtn.style.display = 'none';
      dashboard.style.display = 'none';
      clearForm();
    }
  });

})();
</script>

</body>
</html>
