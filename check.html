<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Firebase Chat (User ↔ Admin) — with blinded media unlock</title>
  <style>
    :root{--accent:#ff7a00;--bg:#f6f6f6}
    body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;height:100vh;display:flex;flex-direction:column}
    header{background:white;padding:12px 16px;box-shadow:0 1px 3px rgba(0,0,0,.06);display:flex;justify-content:space-between;align-items:center}
    .container{display:flex;flex-direction:column;flex:1;padding:12px;gap:12px;overflow:hidden}
    #messages{flex:1;overflow:auto;background:white;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .msg{padding:8px;border-radius:8px;margin-bottom:8px;max-width:70%;}
    .msg.user{background:#fffbe9;align-self:flex-end}
    .msg.admin{background:#eef7ff;align-self:flex-start}
    .meta{font-size:12px;color:#666;margin-top:6px}
    .compose{display:flex;gap:8px}
    .compose input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    .compose button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    #adminPanel{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .filePreview{max-width:260px;border-radius:6px;display:block}
    .blur{filter:blur(14px);transform:scale(1.02);transition:filter .3s}
    .unlockOverlay{position:relative;margin-top:8px}
    .unlockBtn{position:absolute;left:8px;top:8px;background:#0008;color:white;padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.open{display:flex}
    .modal .content{background:black;padding:0;border-radius:6px;max-width:95%;max-height:95%;display:flex;align-items:center;justify-content:center}
    .modal img, .modal video{max-width:100%;max-height:100%;display:block}
    footer{background:white;padding:12px;box-shadow:0 -1px 3px rgba(0,0,0,.04)}
    small.note{color:#666}
    .adminBadge{background:var(--accent);color:white;padding:6px 8px;border-radius:20px;font-size:13px}
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Firebase Chat</strong>
      <small style="margin-left:8px; color:#666">User ↔ Admin</small>
    </div>
    <div>
      <span id="userIdLabel">Not signed</span>
      <button id="adminToggleBtn" style="margin-left:12px">Enter Admin</button>
    </div>
  </header>

  <div class="container">
    <div id="messages" aria-live="polite"></div>

    <!-- Admin panel (hidden unless adminMode) -->
    <div id="adminPanel" style="display:none">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="adminText" placeholder="Admin message..." />
        <input id="adminFile" type="file" accept="image/*,video/*" />
        <input id="adminSecret" placeholder="9-digit secret (required for files)" maxlength="9" style="width:140px" />
        <button id="adminSend">Send</button>
      </div>
      <div style="margin-top:8px"><small class="note">When attaching media, provide a 9-digit secret — users must enter it to view.</small></div>
    </div>

    <div id="composeRow" style="display:flex;gap:8px;align-items:center">
      <input id="textInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
    <div id="bottomNote" style="display:flex;justify-content:space-between;align-items:center">
      <small class="note">Messages are stored in Firestore; media in Storage.</small>
      <div id="adminStatus"></div>
    </div>
  </div>

  <!-- Modal for unlocked media -->
  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="content" id="modalContent">
      <!-- image/video will be injected here -->
    </div>
  </div>

  <!-- include Firebase compat libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- load your external configuration (create configuration.js per instructions) -->
  <script src="configuration.js"></script>

  <script>
  (async function(){
    // ====== CONFIG CHECK ======
    if (!window.FIREBASE_CONFIG) {
      document.body.innerHTML = "<div style='padding:24px;font-family:Arial'>Missing configuration.js or FIREBASE_CONFIG variable. Create configuration.js and set window.FIREBASE_CONFIG. See instructions.</div>";
      return;
    }

    // initialize firebase
    firebase.initializeApp(window.FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ====== UI hooks ======
    const messagesEl = document.getElementById('messages');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    const adminToggleBtn = document.getElementById('adminToggleBtn');
    const adminPanel = document.getElementById('adminPanel');
    const adminText = document.getElementById('adminText');
    const adminFile = document.getElementById('adminFile');
    const adminSecret = document.getElementById('adminSecret');
    const adminSend = document.getElementById('adminSend');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const userIdLabel = document.getElementById('userIdLabel');
    const adminStatus = document.getElementById('adminStatus');

    let currentUser = null;
    let adminMode = false;

    // ====== Helpers ======
    function formatTime(ts) {
      try{
        const d = ts && ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      }catch(e){ return String(ts); }
    }

    async function sha256hex(message) {
      // returns hex string
      const msgUint8 = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const k in attrs){
        if(k === 'class') e.className = attrs[k];
        else if(k === 'html') e.innerHTML = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
      children.forEach(c => { if(c===null) return; e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
      return e;
    }

    // ====== AUTHENTICATE USER ANONYMOUSLY ======
    auth.onAuthStateChanged(async (u) => {
      if(u){
        currentUser = u;
        userIdLabel.textContent = "You: " + (u.isAnonymous ? "anon" : u.email || u.uid.slice(0,6));
        userIdLabel.title = u.uid;
      } else {
        // sign in anonymously
        try {
          await auth.signInAnonymously();
        } catch(e){
          console.error("Auth error",e);
          userIdLabel.textContent = "Auth error";
        }
      }
    });

    // ====== Admin toggle (simple) ======
    adminToggleBtn.addEventListener('click', async () => {
      if(!adminMode){
        // attempt enter admin mode: prompt for 9-digit secret
        const code = prompt("Enter admin 9-digit secret to enable admin mode");
        if(!code) return;
        if(code.length !== 9) { alert("Admin secret must be 9 digits."); return; }
        let providedHash = await sha256hex(code);
        // Accept either APP_ADMIN_SECRET_HASH (recommended) or APP_ADMIN_SECRET plaintext in config
        const expectedHash = window.APP_ADMIN_SECRET_HASH || (window.APP_ADMIN_SECRET ? await sha256hex(window.APP_ADMIN_SECRET) : null);
        if(!expectedHash){
          alert("No admin secret configured on server (configuration.js missing APP_ADMIN_SECRET_HASH or APP_ADMIN_SECRET).");
          return;
        }
        if(providedHash === expectedHash){
          adminMode = true;
          adminPanel.style.display = 'block';
          adminToggleBtn.textContent = 'Exit Admin';
          adminStatus.innerHTML = '<span class="adminBadge">Admin</span>';
          alert("Admin mode enabled.");
        } else {
          alert("Wrong admin secret.");
        }
      } else {
        adminMode = false;
        adminPanel.style.display = 'none';
        adminToggleBtn.textContent = 'Enter Admin';
        adminStatus.innerHTML = '';
      }
    });

    // ====== Send user message ======
    sendBtn.addEventListener('click', sendUserMessage);
    textInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') sendUserMessage(); });

    async function sendUserMessage(){
      const txt = textInput.value.trim();
      if(!txt) return;
      const doc = {
        text: txt,
        sender: 'user',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        unlocked: true // no secret needed for plain user messages
      };
      try {
        await db.collection('chats').add(doc);
        textInput.value = '';
      } catch (e) {
        console.error(e);
        alert("Failed to send message.");
      }
    }

    // ====== Admin send (text or file) ======
    adminSend.addEventListener('click', async () => {
      const txt = adminText.value.trim();
      const file = adminFile.files[0];
      const secret = adminSecret.value.trim();

      if(!txt && !file) { alert("Enter text or pick a file to send."); return; }
      if(file && (!secret || secret.length !== 9)){ alert("For files provide a 9-digit secret."); return; }

      if(file){
        // upload file
        const path = `chat_files/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
        const ref = storage.ref().child(path);
        const uploadTask = ref.put(file);
        adminSend.disabled = true;
        adminSend.textContent = "Uploading...";
        try {
          await uploadTask;
          const url = await ref.getDownloadURL();
          // store doc with file info and hashed secret
          const secretHash = await sha256hex(secret);
          await db.collection('chats').add({
            text: txt || null,
            sender: 'admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            fileURL: url,
            fileType: file.type,
            filePath: path,
            secretHash: secretHash,
            unlocked: false
          });
          adminText.value = '';
          adminFile.value = '';
          adminSecret.value = '';
        } catch(e){
          console.error(e);
          alert("Failed to upload/send file.");
        } finally {
          adminSend.disabled = false;
          adminSend.textContent = "Send";
        }
      } else {
        // text-only admin message
        try {
          await db.collection('chats').add({
            text: txt,
            sender: 'admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            unlocked: true
          });
          adminText.value = '';
        } catch(e){
          console.error(e);
          alert("Failed to send admin message.");
        }
      }
    });

    // ====== Render messages real-time ======
    const query = db.collection('chats').orderBy('timestamp', 'asc');
    query.onSnapshot((snapshot) => {
      messagesEl.innerHTML = '';
      snapshot.forEach(doc => {
        const data = { id: doc.id, ...doc.data() };
        messagesEl.appendChild(renderMessage(data));
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // ====== Render single message ======
    function renderMessage(m){
      const wrapper = el('div',{class: 'msg ' + (m.sender === 'user' ? 'user' : 'admin')});
      if(m.text) wrapper.appendChild(el('div',{}, m.text));
      if(m.fileURL){
        const fileType = m.fileType || '';
        const preview = (fileType.startsWith('image/') ? el('img',{src:m.fileURL,class:'filePreview'}) : el('video',{controls:true, class:'filePreview'}));
        if(fileType.startsWith('video/')){
          preview.setAttribute('preload','metadata');
          preview.innerHTML = ''; // for video tag element we will create element instead
          const videoEl = document.createElement('video');
          videoEl.setAttribute('playsinline','');
          videoEl.setAttribute('preload','metadata');
          videoEl.className = 'filePreview';
          const source = document.createElement('source');
          source.src = m.fileURL;
          videoEl.appendChild(source);
          // replace preview reference
          preview = videoEl;
        }

        // if unlocked or admin user show normally
        if(m.unlocked){
          // unlocked content appears clickable to open fullscreen
          const thumb = el('div',{}, preview);
          thumb.style.position = 'relative';
          thumb.style.cursor = 'zoom-in';
          thumb.addEventListener('click', () => openModalWith(m.fileURL, m.fileType));
          wrapper.appendChild(thumb);
        } else {
          // blurred view + overlay with "enter secret"
          const container = el('div',{class:'unlockOverlay'});
          // create blurred element clone for preview
          let blurredEl;
          if(m.fileType && m.fileType.startsWith('image/')){
            blurredEl = el('img',{src:m.fileURL,class:'filePreview blur'});
          } else {
            blurredEl = document.createElement('video');
            blurredEl.className = 'filePreview blur';
            blurredEl.setAttribute('preload','metadata');
            const s = document.createElement('source');
            s.src = m.fileURL;
            blurredEl.appendChild(s);
          }
          container.appendChild(blurredEl);

          const btn = el('button',{class:'unlockBtn'}, 'Enter 9-digit code');
          btn.addEventListener('click', async () => {
            const code = prompt("Enter the 9-digit secret to unlock this media");
            if(!code) return;
            if(code.length !== 9){ alert("Secret must be 9 digits."); return; }
            const hash = await sha256hex(code);
            // fetch the message doc to compare hash (to ensure latest)
            const doc = await db.collection('chats').doc(m.id).get();
            if(!doc.exists){ alert("Message no longer exists."); return; }
            const data = doc.data();
            if(!data.secretHash){ alert("This file has no secret configured."); return; }
            if(hash === data.secretHash){
              // mark unlocked on DB
              await db.collection('chats').doc(m.id).update({ unlocked: true });
              // open modal with full file
              openModalWith(m.fileURL, m.fileType);
            } else {
              alert("Wrong code.");
            }
          });

          container.appendChild(btn);
          wrapper.appendChild(container);
        }
      } // fileURL

      const meta = el('div',{class:'meta'}, `${m.sender} • ${m.timestamp ? formatTime(m.timestamp) : ''}`);
      if(m.fileURL && !m.unlocked) {
        meta.appendChild(el('span',{style:'margin-left:8px;color:#aa0000'},' (locked)'));
      }
      wrapper.appendChild(meta);
      return wrapper;
    }

    // ====== Modal for full-screen media ======
    function openModalWith(url, type){
      modalContent.innerHTML = '';
      if(type && type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = url;
        modalContent.appendChild(img);
      } else {
        const videoEl = document.createElement('video');
        videoEl.controls = true;
        videoEl.autoplay = true;
        videoEl.setAttribute('playsinline','');
        videoEl.style.maxHeight = '90vh';
        const source = document.createElement('source');
        source.src = url;
        videoEl.appendChild(source);
        modalContent.appendChild(videoEl);
      }
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    modal.addEventListener('click', (e) => {
      if(e.target === modal) {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
        modalContent.innerHTML = '';
      }
    });

    // ====== small UX: press Enter to admin send too ======
    adminText.addEventListener('keydown', (e) => { if(e.key === 'Enter') adminSend.click(); });

    // ====== initial focus ======
    textInput.focus();

    // ====== done ======
  })();
  </script>
</body>
</html>
