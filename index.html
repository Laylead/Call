<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>LeadConnect</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="configuration.js"></script>
<style>
  :root {
    --bg: #f0f2f5; --card-bg: #fff; --primary: #4a90e2;
    --success: #28a745; --warning: #ffc107; --danger: #dc3545;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:sans-serif;background:var(--bg);color:#333;}
  .hidden{display:none !important;}
  .container{max-width:1200px;margin:auto;padding:15px;}
  header {background:linear-gradient(90deg,#4a90e2,#50c9c3);color:#fff;padding:20px;position:relative;text-align:center;}
  .tabs{display:flex;border-bottom:1px solid #ccc;margin:20px 0 10px;}
  .tab{padding:10px 15px;cursor:pointer;border-bottom:3px solid transparent;transition:border-color .2s;}
  .tab.active{border-color:var(--primary);color:var(--primary);}
  .card{background:var(--card-bg);padding:15px;margin-bottom:15px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
  .badge{display:inline-block;padding:3px 7px;font-size:.8em;border-radius:4px;color:#fff;}
  .badge.success{background:var(--success);} .badge.warning{background:var(--warning);}
  .badge.info{background:var(--primary);} .badge.danger{background:var(--danger);}
  .table{width:100%;border-collapse:collapse;margin:10px 0;font-size:.9em;}
  .table th,.table td{padding:8px;border:1px solid #ddd;}
  input,select{width:100%;padding:8px;margin:5px 0 15px;border:1px solid #ccc;border-radius:4px;}
  button{padding:10px 15px;margin:5px 0;border:none;border-radius:4px;background:var(--primary);color:#fff;cursor:pointer;transition:background .2s;}
  button.danger{background:var(--danger);}
  .progress{width:100%;height:20px;background:#ddd;border-radius:4px;margin:5px 0;overflow:hidden;}
  .progress-bar{height:100%;background:var(--success);width:0;transition:width .3s;}
  .alert{padding:10px 15px;border-radius:4px;margin-bottom:15px;}
  .alert.info{background:#e7f3fe;color:#31708f;}
  .alert.success{background:#dff0d8;color:#3c763d;}
  .alert.danger{background:#f2dede;color:#a94442;}
  @media (max-width:768px){.tabs{flex-wrap:wrap;} .tab{flex:1;text-align:center;}}
</style>
</head>
<body>
<!-- Auth Screen -->
<div id="auth-screen" class="container">
  <div class="card" style="max-width:400px;margin:40px auto;">
    <div class="tabs"><div id="to-login" class="tab active">Login</div><div id="to-register" class="tab">Register</div></div>
    <div id="login-form">
      <h3>Login</h3>
      <input type="email" id="login-email" placeholder="Email"><input type="password" id="login-password" placeholder="Password">
      <button onclick="login()">Login</button>
      <small>(Admin: admin@leadconnect.com / admin123)</small>
    </div>
    <div id="register-form" class="hidden">
      <h3>Register</h3>
      <input type="text" id="reg-name" placeholder="Full Name"><input type="email" id="reg-email" placeholder="Email">
      <input type="password" id="reg-password" placeholder="Password"><input type="text" id="reg-ref" placeholder="Referral Code (optional)">
      <button onclick="register()">Register</button>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="app" class="container hidden">
  <header><h1 id="app-title">Dashboard</h1><button onclick="logout()">Logout</button></header>
  <div id="tabs" class="tabs"></div><div id="content"></div>
</div>

<script>
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore(), logs = db.collection('logs');
let currentUser = null, isAdmin = false;

// UI toggles
document.getElementById('to-login').onclick = () => switchForms('login');
document.getElementById('to-register').onclick = () => switchForms('register');
function switchForms(mode) {
  document.getElementById('to-login').classList.toggle('active', mode==='login');
  document.getElementById('to-register').classList.toggle('active', mode==='register');
  document.getElementById('login-form').classList.toggle('hidden', mode!=='login');
  document.getElementById('register-form').classList.toggle('hidden', mode!=='register');
}

// Activity logger
function logEvent(uid, action, meta = {}) {
  logs.add({ uid, action, meta, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
}

// Registration
function register(){
  const name = document.getElementById('reg-name').value.trim(),
        email = document.getElementById('reg-email').value.trim(),
        pwd = document.getElementById('reg-password').value,
        ref = document.getElementById('reg-ref').value.trim();
  if(pwd.length < 6) return alert('Password must be ≥6 characters');
  auth.createUserWithEmailAndPassword(email,pwd)
    .then(res => {
      return db.collection('users').doc(res.user.uid).set({
        name, email, ref, joined: firebase.firestore.FieldValue.serverTimestamp(),
        role: 'user', status: 'active', balance: 0, referrals: 0, commissionRate: 0.15,
        twoFA: false
      }).then(() => logEvent(res.user.uid, 'register'));
    })
    .then(() => login())
    .catch(alert);
}

// Modified login with 2FA support
function login(){
  const email = document.getElementById('login-email').value.trim(),
        pwd = document.getElementById('login-password').value;
  
  if(email==='admin@leadconnect.com' && pwd==='admin123'){
    isAdmin=true; currentUser={uid:'admin', email}; initApp(); return;
  }
  
  auth.signInWithEmailAndPassword(email, pwd)
    .then(res => db.collection('users').doc(res.user.uid).get().then(d=>({user:res.user, data:d.data()})))
    .then(({user, data})=>{
      if(data.twoFA){
        return auth.sendSignInLinkToEmail(email, {
          url: location.href, handleCodeInApp: true
        }).then(()=>{
          alert('2FA link sent to your email.');
          db.collection('users').doc(user.uid).update({
            twoFALinkSent: firebase.firestore.FieldValue.serverTimestamp()
          });
          throw '2FA pending';
        });
      }
      return {user, data};
    })
    .then(({user, data}) => {
      currentUser = user;
      isAdmin = data.role === 'admin';
      logEvent(user.uid, 'login');
      initApp();
    })
    .catch(err => { if(typeof err !== 'string') alert(err.message); });
}

// Handle email link for 2FA
if(auth.isSignInWithEmailLink(window.location.href)){
  let email = window.localStorage.getItem('emailForSignIn') || prompt('Confirm email for 2FA:');
  auth.signInWithEmailLink(email, window.location.href)
    .then(res => {
      logEvent(res.user.uid, 'login_2fa');
      window.history.replaceState({}, document.title, '/');
      initApp();
    })
    .catch(alert);
}

// Auth and logout
auth.onAuthStateChanged(u => {
  if(u) {
    currentUser = u;
    db.collection('users').doc(u.uid).get().then(d=>{
      isAdmin = d.data().role === 'admin';
      initApp();
    });
  }
});
function logout(){ auth.signOut(); localStorage.clear(); window.location.reload(); }

// Initialize app UI
function initApp(){
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  buildTabs();
  const first = isAdmin ? 'Overview' : 'Dashboard';
  setActiveTab(first); loadTab(first);
}

// Tabs setup
const adminTabs = ['Overview','Tokens','Users','Affiliates','Withdrawals','Settings'],
      userTabs = ['Dashboard','Referrals','Withdrawals','Account'];
function buildTabs(){
  const tabsEl = document.getElementById('tabs');
  tabsEl.innerHTML = '';
  (isAdmin ? adminTabs : userTabs).forEach(t => {
    const div = document.createElement('div');
    div.innerText = t; div.className = 'tab';
    div.onclick = ()=>{ setActiveTab(t); loadTab(t); };
    tabsEl.appendChild(div);
  });
}
function setActiveTab(tab){
  document.getElementById('app-title').innerText = tab;
  document.querySelectorAll('.tabs .tab').forEach(el =>
    el.classList.toggle('active', el.innerText === tab)
  );
}
function loadTab(tab){
  document.getElementById('content').innerHTML = '';
  isAdmin ? loadAdminTab(tab) : loadUserTab(tab);
}

// Admin Functions
function loadAdminTab(tab){
  switch(tab){
    case 'Overview': return adminOverview();
    case 'Tokens':     return adminTokens();
    case 'Users':      return adminUsers();
    case 'Affiliates': return adminAffiliates();
    case 'Withdrawals':return adminWithdrawals();
    case 'Settings':   return adminSettings();
  }
}

function adminOverview(){
  const c = document.getElementById('content');
  c.innerHTML = '';
  const stats = {users:0, earnings:0, pending:0, tokens:0};
  
  db.collection('users').get().then(q=>{ stats.users=q.size; })
  .then(()=> db.collection('transactions').get()).then(q=>{
    q.forEach(d => { const t = d.data(); if(t.type==='earn') stats.earnings += t.amount; if(t.status==='pending') stats.pending += t.amount; });
  })
  .then(()=> db.collection('tokens').get())
  .then(q => { stats.tokens = q.size; })
  .then(()=> {
    Object.entries({
      'Total Users': stats.users,
      'Total Earnings ($)': stats.earnings.toFixed(2),
      'Pending Withdrawals ($)': stats.pending.toFixed(2),
      'Active Tokens': stats.tokens
    }).forEach(([label, val]) => {
      const card = document.createElement('div');
      card.className = 'card'; card.innerHTML=`<h4>${label}</h4><p>${val}</p>`;
      c.appendChild(card);
    });
    logEvent('admin', 'view_overview');
  });
}

function adminTokens(){
  const c = document.getElementById('content');
  c.innerHTML = `
    <button onclick="adminCreateToken('one-time')">One‑Time Token</button>
    <button onclick="adminCreateToken('reusable')">Reusable</button>
    <button onclick="adminBulkGenerate()">Bulk</button>
    <div>Filter: <select id="token-filter"><option value="">All</option><option>used</option><option>unused</option></select></div>
    <div id="tok-table"></div>`;
  document.getElementById('token-filter').onchange = adminRefreshTokens;
  adminRefreshTokens();
}

function adminCreateToken(type){
  const tok = Math.random().toString(36).substr(2,12);
  db.collection('tokens').add({
    token: tok, type, status:'unused', created: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{ adminRefreshTokens(); logEvent('admin','create_token',{type,token:tok}); });
}
function adminBulkGenerate(){
  const count = parseInt(prompt('Count (1–100)?','5'),10);
  if(isNaN(count)||count<1||count>100)return;
  const batch = db.batch();
  for(let i=0;i<count;i++){
    const ref = db.collection('tokens').doc();
    batch.set(ref, {token:Math.random().toString(36).substr(2,12),type:'one-time',status:'unused',created:firebase.firestore.FieldValue.serverTimestamp()});
  }
  batch.commit().then(()=>{ adminRefreshTokens(); logEvent('admin','bulk_tokens',{count}); });
}
function adminRefreshTokens(){
  const c=document.getElementById('tok-table'), f=document.getElementById('token-filter').value;
  let query = db.collection('tokens').orderBy('created','desc');
  if(f) query = query.where('status','==',f);
  query.get().then(q=>{
    let html = '<table class="table"><tr><th>Token</th><th>Type</th><th>Status</th><th>Created</th><th>Action</th></tr>';
    q.forEach(doc => {
      const d=doc.data();
      html += `<tr><td>${d.token}</td><td>${d.type}</td><td>${d.status}</td><td>${d.created?.toDate().toLocaleString()||'-'}</td><td><button onclick="adminDeleteToken('${doc.id}')">Delete</button></td></tr>`;
    });
    html += '</table>'; c.innerHTML = html;
  });
}
function adminDeleteToken(id){
  if(confirm('Delete token?')) {
    db.collection('tokens').doc(id).delete().then(()=>{ adminRefreshTokens(); logEvent('admin','delete_token',{id}); });
  }
}

function adminUsers(){
  const c = document.getElementById('content');
  c.innerHTML = '<input placeholder="Search..." id="user-search"><div id="user-table"></div>';
  document.getElementById('user-search').oninput = adminRefreshUsers;
  adminRefreshUsers();
}
function adminRefreshUsers(){
  const qstr=document.getElementById('user-search').value.trim().toLowerCase();
  db.collection('users').orderBy('joined','desc').get().then(q=>{
    let html='<table class="table"><tr><th>ID</th><th>Name</th><th>Email</th><th>Joined</th><th>Status</th><th>Action</th></tr>';
    q.forEach(doc=>{
      const d=doc.data();
      if(qstr && !(d.name.toLowerCase().includes(qstr)||d.email.toLowerCase().includes(qstr)))return;
      html+=`<tr><td>${doc.id}</td><td>${d.name}</td><td>${d.email}</td><td>${d.joined?.toDate().toLocaleDateString()||'-'}</td><td><span class="badge ${d.status==='active'?'success':'warning'}">${d.status}</span></td><td><button onclick="adminToggleUserStatus('${doc.id}','${d.status}')">${d.status==='active'?'Suspend':'Activate'}</button></td></tr>`;
    });
    html += '</table>'; document.getElementById('user-table').innerHTML = html;
  });
}
function adminToggleUserStatus(uid, current){
  const next = current==='active'?'suspended':'active';
  db.collection('users').doc(uid).update({status: next})
    .then(()=>{ adminRefreshUsers(); logEvent('admin','toggle_user',{uid,status:next}); });
}

function adminAffiliates(){
  const c = document.getElementById('content');
  c.innerHTML = `
    <h3>Affiliate Settings</h3>
    <div class="card">
      Commission Rate: <input type="number" id="aff-commission"><br>
      Min Referrals: <input type="number" id="aff-minref"><br>
      Min Withdrawal ($): <input type="number" id="aff-minwd"><br>
      <button onclick="adminSaveAffiliateSettings()">Save Settings</button>
    </div>
    <h3>Performance</h3><div id="aff-table"></div>`;
  db.collection('settings').doc('affiliate').get().then(doc=>{
    if(doc.exists){
      const d=doc.data();
      document.getElementById('aff-commission').value = d.commissionRate;
      document.getElementById('aff-minref').value = d.minReferrals;
      document.getElementById('aff-minwd').value = d.minWithdrawal;
    }
  });
  adminRefreshAffPerformance();
}
function adminSaveAffiliateSettings(){
  const data = {
    commissionRate: parseFloat(document.getElementById('aff-commission').value),
    minReferrals: parseInt(document.getElementById('aff-minref').value,10),
    minWithdrawal: parseFloat(document.getElementById('aff-minwd').value)
  };
  db.collection('settings').doc('affiliate').set(data).then(()=>{alert('Saved'); logEvent('admin','save_affiliate',data);});
}
function adminRefreshAffPerformance(){
  db.collection('users').where('role','==','user').get().then(q=>{
    let html='<table class="table"><tr><th>Affiliate</th><th>Referrals</th><th>Balance</th></tr>';
    q.forEach(doc=>{
      const d=doc.data(), bal=(d.referrals||0)*(d.commissionRate||0.15)*100;
      html+=`<tr><td>${d.name}</td><td>${d.referrals||0}</td><td>$${bal.toFixed(2)}</td></tr>`;
    });
    html += '</table>'; document.getElementById('aff-table').innerHTML = html;
  });
}

function adminWithdrawals(){
  const c=document.getElementById('content');
  c.innerHTML = '<h3>Withdrawals</h3><div id="wd-table"></div>';
  adminRefreshWithdrawals();
}
function adminRefreshWithdrawals(){
  db.collection('transactions').orderBy('created','desc').get().then(q=>{
    let html='<table class="table"><tr><th>User</th><th>Amount</th><th>Account</th><th>Date</th><th>Status</th><th>Action</th></tr>';
    q.forEach(doc=>{
      const d = doc.data();
      if(d.type!=='withdrawal') return;
      html+=`<tr><td>${d.email}</td><td>$${d.amount.toFixed(2)}</td><td>${d.account}</td><td>${d.created.toDate().toLocaleString()}</td><td><span class="badge ${d.status==='pending'?'warning':'success'}">${d.status}</span></td><td>${d.status==='pending'?`<button onclick="adminApproveWithdrawal('${doc.id}')">Approve</button><button class="danger" onclick="adminRejectWithdrawal('${doc.id}')">Reject</button>`:'-'}</td></tr>`;
    });
    html += '</table>' ; document.getElementById('wd-table').innerHTML = html;
  });
}
function adminApproveWithdrawal(id){
  db.collection('transactions').doc(id).update({status:'paid'}).then(()=>{adminRefreshWithdrawals(); logEvent('admin','approve_withdrawal',{id});});
}
function adminRejectWithdrawal(id){
  db.collection('transactions').doc(id).update({status:'rejected'}).then(()=>{adminRefreshWithdrawals(); logEvent('admin','reject_withdrawal',{id});});
}

function adminSettings(){
  const c = document.getElementById('content');
  c.innerHTML = `
    <h3>System Settings</h3><div class="card">
      Maintenance: <input type="checkbox" id="sys-maint"><br>
      Currency: <select id="sys-currency"><option>USD</option><option>EUR</option></select><br>
      Max Commission (%): <input type="number" id="sys-maxcom"><br>
      Session Timeout (mins): <input type="number" id="sys-timeout"><br>
      <button onclick="adminSaveSystemSettings()">Save</button>
    </div>`;
  db.collection('settings').doc('system').get().then(doc=>{
    if(doc.exists){
      const d=doc.data();
      document.getElementById('sys-maint').checked = !!d.maintenance;
      document.getElementById('sys-currency').value = d.currency;
      document.getElementById('sys-maxcom').value = d.maxCommission;
      document.getElementById('sys-timeout').value = d.sessionTimeout;
    }
  });
}
function adminSaveSystemSettings(){
  const data = {
    maintenance: document.getElementById('sys-maint').checked,
    currency: document.getElementById('sys-currency').value,
    maxCommission: parseFloat(document.getElementById('sys-maxcom').value),
    sessionTimeout: parseInt(document.getElementById('sys-timeout').value,10)
  };
  db.collection('settings').doc('system').set(data).then(()=>{alert('Saved'); logEvent('admin','save_system',data);});
}

// User Functions
function loadUserTab(tab){
  switch(tab){
    case 'Dashboard': return userDashboard();
    case 'Referrals': return userReferrals();
    case 'Withdrawals': return userWithdrawals();
    case 'Account': return userAccount();
  }
}

function userDashboard(){
  const c=document.getElementById('content');
  c.innerHTML = '<h3>Your Stats</h3><div id="user-stats" class="card"></div>';
  db.collection('users').doc(currentUser.uid).get().then(doc=>{
    const d=doc.data(), bal=d.balance||0, refs=d.referrals||0, commissionRate=d.commissionRate||0.15;
    document.getElementById('user-stats').innerHTML = `
      <p><strong>Balance:</strong> $${bal.toFixed(2)}</p>
      <p><strong>Referrals:</strong> ${refs}</p>
      <p><strong>Commission Rate:</strong> ${(commissionRate*100).toFixed(1)}%</p>
      <label><input type="checkbox" id="twofa-toggle" ${d.twoFA?'checked':''}> Enable 2FA (Email Link)</label>`;
    document.getElementById('twofa-toggle').onchange = () => {
      const on = document.getElementById('twofa-toggle').checked;
      db.collection('users').doc(currentUser.uid).update({twoFA:on}).then(() => {
        alert(`2FA ${on?'enabled':'disabled'}`);
        logEvent(currentUser.uid,'toggle_2fa',{twoFA:on});
      });
    };
  });
}

function userReferrals(){
  const c=document.getElementById('content');
  c.innerHTML = `
    <h3>Your Referral Program</h3>
    <iframe width="100%" height="315" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
    <button onclick="copyReferralLink()">Copy Link</button>
    <div class="progress"><div id="ref-progress" class="progress-bar"></div></div><p id="ref-status"></p>
    <h4>Your Referrals</h4><div id="ref-table"></div>
    <h4>Activate Token</h4>
    <input id="token-code" placeholder="Token code"><button onclick="activateToken()">Activate</button><div id="token-msg"></div>`;
  db.collection('users').doc(currentUser.uid).get().then(doc=>{
    const d=doc.data(), have=d.referrals||0, needed=6;
    const pct = Math.min((have/needed)*100,100);
    document.getElementById('ref-progress').style.width=`${pct}%`;
    document.getElementById('ref-status').innerText=`Referrals: ${have}/${needed}`;
  });
  reloadReferralsTable();
}

function copyReferralLink(){
  const url = location.origin + '?ref=' + currentUser.uid;
  navigator.clipboard.writeText(url).then(()=>alert('Referral link copied!'));
}

function reloadReferralsTable(){
  const c = document.getElementById('ref-table');
  db.collection('users').where('ref','==',currentUser.uid).get().then(q=>{
    let html='<table class="table"><tr><th>Name</th><th>Joined</th><th>Status</th></tr>';
    q.forEach(doc=>{
      const d=doc.data(); html+=`<tr><td>${d.name}</td><td>${d.joined?.toDate().toLocaleDateString() || '-'}</td><td><span class="badge ${d.status==='active'?'success':'warning'}">${d.status}</span></td></tr>`;
    });
    html+='</table>'; c.innerHTML=html;
  });
}

function activateToken(){
  const code = document.getElementById('token-code').value.trim();
  if(!code) return;
  db.collection('tokens').where('token','==',code).get()
    .then(q=> {
      if(q.empty) throw 'Invalid token';
      const d=q.docs[0].data();
      if(d.status==='used' && d.type==='one-time') throw 'Token already used';
      return q.docs[0];
    })
    .then(doc => db.collection('tokens').doc(doc.id).update({status:'used',usedBy:currentUser.uid}))
    .then(()=> { document.getElementById('token-msg').innerText='Token activated!'; logEvent(currentUser.uid,'activate_token',{code}); })
    .catch(e => document.getElementById('token-msg').innerText=e);
}

function userWithdrawals(){
  const c = document.getElementById('content');
  c.innerHTML = `
    <h3>Request Withdrawal ($20 min)</h3>
    <input id="wd-amount" type="number" placeholder="Amount">
    <input id="wd-account" placeholder="Account Info">
    <button onclick="requestWithdrawal()">Request</button><div id="wd-msg"></div>
    <h4>Withdrawal History</h4><div id="wd-history"></div>`;
  loadUserWithdrawalHistory();
}

function requestWithdrawal(){
  const amt=parseFloat(document.getElementById('wd-amount').value),
        acc=document.getElementById('wd-account').value.trim();
  if(isNaN(amt)||amt<20) return document.getElementById('wd-msg').innerText='Minimum $20';
  if(!acc) return document.getElementById('wd-msg').innerText='Account info required';
  db.collection('transactions').add({
    uid:currentUser.uid, email:currentUser.email, type:'withdrawal',
    amount:amt, account:acc, status:'pending', created:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    localStorage.setItem('pendingWithdrawal', amt);
    document.getElementById('wd-msg').innerText='Requested';
    logEvent(currentUser.uid,'request_withdrawal',{amount:amt,account:acc});
    loadUserWithdrawalHistory();
  });
}

function loadUserWithdrawalHistory(){
  const c = document.getElementById('wd-history');
  db.collection('transactions').where('uid','==',currentUser.uid).orderBy('created','desc').get().then(q=>{
    let html='<table class="table"><tr><th>Amount</th><th>Date</th><th>Status</th></tr>';
    q.forEach(doc=>{
      const d=doc.data();
      html+=`<tr><td>$${d.amount.toFixed(2)}</td><td>${d.created.toDate().toLocaleString()}</td><td><span class="badge ${d.status==='pending'?'warning':'success'}">${d.status}</span></td></tr>`;
    });
    html+='</table>'; c.innerHTML=html;
  });
}

function userAccount(){
  const c=document.getElementById('content');
  c.innerHTML = `
    <h3>Account Details</h3>
    <input id="acc-name" placeholder="Name">
    <input id="acc-email" placeholder="Email" disabled>
    <input id="acc-phone" placeholder="Phone">
    <input id="acc-account" placeholder="Account Info">
    <button onclick="updateAccount()">Save</button><div id="acc-msg"></div>`;
  db.collection('users').doc(currentUser.uid).get().then(doc=>{
    const d=doc.data();
    document.getElementById('acc-name').value=d.name||'';
    document.getElementById('acc-email').value=d.email||'';
    document.getElementById('acc-phone').value=d.phone||'';
    document.getElementById('acc-account').value=d.account||'';
  });
}

function updateAccount(){
  const data = {
    name: document.getElementById('acc-name').value.trim(),
    phone: document.getElementById('acc-phone').value.trim(),
    account: document.getElementById('acc-account').value.trim()
  };
  db.collection('users').doc(currentUser.uid).update(data)
    .then(()=>{ document.getElementById('acc-msg').innerText='Saved!'; logEvent(currentUser.uid,'update_account', data); })
    .catch(err => document.getElementById('acc-msg').innerText = err.message);
}
</script>
</body>
</html>
