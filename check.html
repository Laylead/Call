<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kheemz Private Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter',sans-serif;margin:0;background:#0b0f18;color:#fff;height:100vh;display:flex;justify-content:center;align-items:center}
#chatIcon{position:fixed;bottom:25px;right:25px;width:60px;height:60px;border-radius:50%;background:linear-gradient(45deg,#ff6f2d,#ff4b98);display:flex;justify-content:center;align-items:center;font-size:26px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
#chatApp{position:fixed;bottom:20px;right:20px;width:400px;max-width:95%;height:550px;border-radius:16px;display:none;flex-direction:column;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);overflow:hidden}
header{background:rgba(255,255,255,0.05);padding:10px;text-align:center;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.1)}
#chat-box{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:75%;padding:10px 14px;border-radius:14px;word-wrap:break-word;animation:fadeIn .3s}
.msg.self{align-self:flex-end;background:linear-gradient(45deg,#ff6f2d,#ff4b98)}
.msg.other{align-self:flex-start;background:rgba(255,255,255,0.08)}
.msg img,.msg video{max-width:100%;border-radius:10px;margin-top:6px}
#input-area{display:flex;gap:8px;padding:10px;background:rgba(255,255,255,0.06);border-top:1px solid rgba(255,255,255,0.1)}
#msg-input{flex:1;border:none;border-radius:10px;padding:10px;background:rgba(255,255,255,0.1);color:#fff}
#msg-input:focus{outline:none}
button,label{border:none;background:linear-gradient(45deg,#ff6f2d,#ff4b98);color:white;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
#file-input{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:200}
.modal-content{background:#0e1624;padding:20px;border-radius:12px;width:90%;max-width:360px;color:#fff}
.modal input{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff}
#userList{overflow:auto;max-height:150px;margin-bottom:10px}
.userItem{padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);cursor:pointer}
.userItem:hover{background:rgba(255,255,255,0.05)}
</style>
</head>
<body>

<div id="chatIcon">ðŸ’¬</div>

<div id="chatApp">
  <header id="chatHeader">Kheemz Chat</header>
  <div id="userList" style="display:none"></div>
  <div id="chat-box"></div>
  <div id="input-area">
    <label for="file-input"><i>ðŸ“Ž</i></label>
    <input type="file" id="file-input" accept="image/*,video/*">
    <input type="text" id="msg-input" placeholder="Type a message...">
    <button id="send-btn">Send</button>
  </div>
</div>

<div class="modal" id="loginModal">
  <div class="modal-content">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p style="font-size:13px;opacity:0.7;text-align:center;margin-top:6px">or</p>
    <button id="anonBtn" style="background:rgba(255,255,255,0.15)">Continue as Guest</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="configuration.js"></script>

<script>
if(!window.FIREBASE_CONFIG){alert("Missing configuration.js");}
else{
firebase.initializeApp(window.FIREBASE_CONFIG);
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();

const chatIcon=document.getElementById('chatIcon'),
      chatApp=document.getElementById('chatApp'),
      loginModal=document.getElementById('loginModal'),
      emailInput=document.getElementById('loginEmail'),
      passInput=document.getElementById('loginPass'),
      loginBtn=document.getElementById('loginBtn'),
      anonBtn=document.getElementById('anonBtn'),
      chatBox=document.getElementById('chat-box'),
      msgInput=document.getElementById('msg-input'),
      sendBtn=document.getElementById('send-btn'),
      fileInput=document.getElementById('file-input'),
      userList=document.getElementById('userList'),
      chatHeader=document.getElementById('chatHeader');

let currentUser=null,role='guest',currentChatUser=null,unsubMessages=null;

chatIcon.onclick=()=>loginModal.style.display='flex';

loginBtn.onclick=async()=>{
  try{
    const cred=await auth.signInWithEmailAndPassword(emailInput.value,passInput.value);
    currentUser=cred.user;
    await checkRole();
    openChat();
  }catch(e){alert(e.message);}
};

anonBtn.onclick=async()=>{
  const cred=await auth.signInAnonymously();
  currentUser=cred.user;
  role='user';
  await db.collection('users').doc(currentUser.uid).set({role:'user'}, {merge:true});
  openChat();
};

async function checkRole(){
  const doc=await db.collection('users').doc(currentUser.uid).get();
  role=doc.exists?doc.data().role||'user':'user';
}

function openChat(){
  loginModal.style.display='none';
  chatApp.style.display='flex';
  chatIcon.style.display='none';
  if(role==='admin') showAdminPanel(); else openUserChat();
}

function showAdminPanel(){
  userList.style.display='block';
  chatHeader.textContent='Admin Panel';
  db.collection('users').onSnapshot(snap=>{
    userList.innerHTML='';
    snap.forEach(doc=>{
      const data=doc.data();
      if(data.role!=='admin'){
        const div=document.createElement('div');
        div.className='userItem';
        div.textContent=data.email||('User '+doc.id.slice(0,6));
        div.onclick=()=>openAdminConversation(doc.id,div.textContent);
        userList.appendChild(div);
      }
    });
  });
}

function openAdminConversation(uid,name){
  currentChatUser=uid;
  chatHeader.textContent='Chat with '+name;
  if(unsubMessages)unsubMessages();
  unsubMessages=db.collection('messages').doc(uid).collection('items')
    .orderBy('timestamp','asc')
    .onSnapshot(snap=>{
      chatBox.innerHTML='';
      snap.forEach(d=>renderMsg(d.data(),d.id));
      chatBox.scrollTop=chatBox.scrollHeight;
    });
}

function openUserChat(){
  currentChatUser=currentUser.uid;
  chatHeader.textContent='Private Chat';
  unsubMessages=db.collection('messages').doc(currentUser.uid).collection('items')
    .orderBy('timestamp','asc')
    .onSnapshot(snap=>{
      chatBox.innerHTML='';
      snap.forEach(d=>renderMsg(d.data()));
      chatBox.scrollTop=chatBox.scrollHeight;
    });
}

function renderMsg(m,id){
  const div=document.createElement('div');
  div.className='msg '+(m.from===currentUser.uid?'self':'other');
  div.innerHTML=`${m.text||''}`;
  if(m.mediaUrl){
    if(m.mediaType.startsWith('video/'))div.innerHTML+=`<video src="${m.mediaUrl}" controls></video>`;
    else div.innerHTML+=`<img src="${m.mediaUrl}">`;
  }
  if(role==='admin'){
    const small=document.createElement('small');small.textContent='from: '+(m.fromName||m.from.slice(0,6));
    div.appendChild(small);
  }
  chatBox.appendChild(div);
}

async function sendMessage(text,file){
  if(!currentChatUser)return;
  let mediaUrl='',mediaType='';
  if(file){
    const ref=storage.ref('chat/'+Date.now()+'_'+file.name);
    await ref.put(file);
    mediaUrl=await ref.getDownloadURL();
    mediaType=file.type;
  }
  const msg={
    from:currentUser.uid,
    fromName:currentUser.email||'User',
    text:text||'',
    mediaUrl,mediaType,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('messages').doc(currentChatUser).collection('items').add(msg);
  await db.collection('conversations').doc(currentChatUser).set({
    lastMessage:text||'media',lastTimestamp:firebase.firestore.FieldValue.serverTimestamp(),uid:currentChatUser
  },{merge:true});
}

sendBtn.onclick=async()=>{
  const text=msgInput.value.trim(),file=fileInput.files[0];
  if(!text&&!file)return;
  await sendMessage(text,file);
  msgInput.value='';fileInput.value='';
};
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendBtn.click();});
}
</script>
</body>
</html>
