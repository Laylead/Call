<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectX - Professional Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --gray-color: #6c757d;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-color: #333333;
            --message-sent: #4361ee;
            --message-received: #f0f0f0;
            --input-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 24px;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-actions i {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .header-actions i:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background-color: var(--card-bg);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            border-right: 1px solid var(--border-color);
        }

        /* User Profiles Section */
        .user-profiles-section {
            padding: 15px;
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .user-profiles-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 5px;
            scrollbar-width: thin;
        }

        .user-profiles-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .user-profiles-scroll::-webkit-scrollbar-thumb {
            background-color: var(--gray-color);
            border-radius: 10px;
        }

        .user-profile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
            min-width: 55px;
            position: relative;
        }

        .user-profile-item:hover {
            transform: translateY(-2px);
        }

        .user-profile-item.active {
            animation: glowPulse 2s infinite;
        }

        @keyframes glowPulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(67, 97, 238, 0.8);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
            }
        }

        .user-profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            position: relative;
            animation: fadeIn 0.5s ease;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .user-profile-item.active .user-profile-avatar {
            border-color: var(--primary-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .user-profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile-name {
            font-size: 11px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 55px;
            color: var(--gray-color);
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            height: calc(100vh - 160px);
            padding: 10px;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 10px;
            margin-bottom: 5px;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chat-list-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
            transform: translateX(5px);
        }

        .chat-list-item.active {
            background-color: rgba(67, 97, 238, 0.08);
            animation: glowPulse 2s infinite;
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            position: relative;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        .status-online {
            background-color: #4ade80;
        }

        .status-away {
            background-color: #f59e0b;
        }

        .status-offline {
            background-color: #9ca3af;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: var(--gray-color);
            font-size: 11px;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            color: var(--gray-color);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            position: relative;
        }

        /* Conversation Header */
        .conversation-header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .conversation-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-back-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            margin-right: 5px;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .conversation-user-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .conversation-user-details p {
            color: var(--gray-color);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .conversation-actions {
            display: flex;
            gap: 10px;
        }

        .conversation-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-color);
            background: none;
            border: none;
        }

        .conversation-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23f0f2f5' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.2s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--message-sent);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--message-received);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-media {
            margin-top: 8px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .message-media img {
            width: 100%;
            display: block;
        }

        /* Voice Message */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            margin-top: 8px;
        }

        .message.received .voice-message {
            background: rgba(0,0,0,0.05);
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message.received .voice-play-btn {
            background: rgba(0,0,0,0.1);
            color: var(--text-color);
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.6);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .message.received .voice-bar {
            background: rgba(0,0,0,0.3);
        }

        .voice-duration {
            font-size: 12px;
            min-width: 40px;
            text-align: center;
            opacity: 0.8;
        }

        /* Input Area */
        .input-area {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .balance-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .pricing-display {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            padding: 10px;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            font-size: 12px;
        }

        .pricing-item {
            flex: 1;
            text-align: center;
        }

        .pricing-type {
            color: var(--gray-color);
            margin-bottom: 3px;
        }

        .pricing-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .chat-input-wrapper {
            flex: 1;
            background-color: var(--input-bg);
            border-radius: 24px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            display: flex;
            align-items: flex-end;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            line-height: 1.4;
            max-height: 120px;
            min-height: 24px;
            resize: none;
            padding: 4px 0;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: var(--gray-color);
        }

        .input-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .input-action-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            transform: none;
        }

        /* Floating Search Widget */
        .floating-search {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: var(--transition);
        }

        .floating-search:hover {
            transform: scale(1.1);
        }

        .floating-search.active {
            width: 300px;
            border-radius: 25px;
            justify-content: flex-start;
            padding: 0 15px;
        }

        .floating-search.active i {
            margin-right: 10px;
        }

        .floating-search input {
            display: none;
            width: 100%;
            border: none;
            background: transparent;
            outline: none;
            color: white;
            font-size: 15px;
        }

        .floating-search.active input {
            display: block;
        }

        .floating-search input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Voice Recorder */
        .voice-recorder {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 200px;
        }

        .voice-recorder.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning-color);
            font-weight: 600;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-timer {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .recording-actions {
            display: flex;
            gap: 15px;
        }

        .record-action-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .record-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .record-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        .record-action-btn:hover {
            transform: scale(1.1);
        }

        /* Voice Preview */
        .voice-preview {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 250px;
        }

        .voice-preview.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        .voice-preview-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .voice-preview-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .voice-preview-play-btn:hover {
            transform: scale(1.05);
        }

        .voice-preview-waveform {
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-preview-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .voice-preview-duration {
            font-size: 14px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
        }

        .voice-preview-actions {
            display: flex;
            gap: 10px;
        }

        .voice-preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .voice-preview-action-btn.delete {
            background-color: var(--warning-color);
            color: white;
        }

        .voice-preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        /* Media Preview */
        .media-preview {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .media-preview.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .media-preview-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .media-preview img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .media-preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .preview-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .empty-state p {
            max-width: 300px;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background-color: var(--message-received);
            border-radius: 18px;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-bottom: 8px;
            max-width: 70px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Word Counter */
        .word-counter {
            font-size: 12px;
            color: var(--gray-color);
            text-align: right;
            margin-top: 5px;
            display: none;
        }

        .word-counter.near-limit {
            color: var(--warning-color);
        }

        /* Settings Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: translateY(20px) scale(0.95);
            transition: var(--transition);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 22px;
        }

        .close-modal {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .close-modal:hover {
            color: var(--warning-color);
            background-color: rgba(247, 37, 133, 0.1);
        }

        /* Settings Sections */
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section-title i {
            font-size: 18px;
        }

        .settings-grid {
            display: grid;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 15px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        /* Earnings and Pricing Cards */
        .earnings-info {
            background: rgba(67, 97, 238, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .earnings-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .earnings-item:last-child {
            margin-bottom: 0;
        }

        .earnings-label {
            color: var(--gray-color);
        }

        .earnings-value {
            font-weight: 600;
            color: var(--success-color);
        }

        .pricing-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .pricing-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .pricing-card-header i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .pricing-card-header h4 {
            font-size: 15px;
            font-weight: 600;
        }

        .pricing-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .pricing-input-label {
            font-size: 12px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .pricing-currency {
            background: var(--body-bg);
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Verification Badge */
        .verified-badge {
            color: var(--primary-color);
            margin-left: 5px;
        }

        .mentor-badge {
            background: linear-gradient(135deg, #ff9a00, #ff6a00);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .status-badge.mentor {
            background: linear-gradient(135deg, #ff9a00, #ff6a00);
            color: white;
        }

        .status-badge.verified {
            background: linear-gradient(135deg, #4361ee, #4cc9f0);
            color: white;
        }

        /* Application Form */
        .application-form {
            max-width: 100%;
        }

        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .camera-container {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .camera-preview {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin: 0 auto 15px;
            display: none;
        }

        .camera-preview.active {
            display: block;
        }

        .camera-video {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .camera-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .camera-btn.capture {
            background-color: var(--primary-color);
            color: white;
        }

        .camera-btn.retake {
            background-color: var(--gray-color);
            color: white;
        }

        .application-note {
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .application-note i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        /* Application Message Styles */
        .application-message {
            max-width: 85%;
            padding: 15px;
            border-radius: 12px;
            background-color: var(--message-received);
            align-self: flex-start;
            margin-bottom: 15px;
        }

        .application-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .application-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        .application-user-info h4 {
            margin: 0;
            font-size: 14px;
        }

        .application-user-info p {
            margin: 0;
            font-size: 12px;
            color: var(--gray-color);
        }

        .application-details {
            margin-bottom: 15px;
        }

        .application-detail-item {
            display: flex;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .application-detail-label {
            font-weight: 600;
            min-width: 100px;
            color: var(--gray-color);
        }

        .application-detail-value {
            flex: 1;
        }

        .application-photo {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }

        .application-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .application-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 100px;
        }

        .application-action-btn.approve-mentor {
            background-color: #ff9a00;
            color: white;
        }

        .application-action-btn.approve-verified {
            background-color: #4361ee;
            color: white;
        }

        .application-action-btn.approve-both {
            background: linear-gradient(135deg, #4361ee, #ff9a00);
            color: white;
        }

        .application-action-btn.decline {
            background-color: var(--warning-color);
            color: white;
        }

        .application-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                height: 100%;
            }
            
            .chat-area {
                width: 100%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .conversation-header {
                padding: 12px 15px;
            }
            
            .messages-area {
                padding: 15px;
            }
            
            .input-area {
                padding: 12px 15px;
            }

            .floating-search {
                bottom: 80px;
                right: 15px;
            }

            .floating-search.active {
                width: calc(100% - 30px);
            }

            .user-profile-avatar {
                width: 40px;
                height: 40px;
            }

            .user-profile-name {
                font-size: 10px;
            }
        }

        /* Hide elements when in conversation view */
        .conversation-view header,
        .conversation-view .sidebar {
            display: none;
        }

        .conversation-view .chat-area {
            width: 100%;
        }

        .conversation-view .floating-search {
            display: none;
        }

        /* Block User Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .context-menu.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .context-menu-item.danger {
            color: var(--warning-color);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>ConnectX Messages</h1>
        </div>
        <div class="header-actions">
            <i class="fas fa-cog" id="settingsBtn"></i>
            <a href="home.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home"></i>
            </a>
            <div style="position: relative;">
                <i class="fas fa-bell" id="notificationsBtn"></i>
                <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Sidebar with Chat List -->
        <div class="sidebar">
            <!-- User Profiles Section -->
            <div class="user-profiles-section" id="userProfilesSection">
                <div class="user-profiles-scroll" id="userProfilesScroll">
                    <!-- User profiles will be populated here -->
                </div>
            </div>
            
            <div class="chat-list" id="chatList">
                <!-- Chat list will be populated here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <h3>No conversation selected</h3>
                <p>Select a conversation from the list or start a new chat to begin messaging.</p>
            </div>
            
            <!-- Conversation View (hidden by default) -->
            <div class="conversation-view" id="conversationView" style="display: none;">
                <!-- Conversation Header -->
                <div class="conversation-header">
                    <div class="conversation-user-info">
                        <button class="conversation-back-btn" id="conversationBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="conversation-avatar" id="conversationAvatar">
                            <!-- Avatar will be loaded here -->
                        </div>
                        <div class="conversation-user-details">
                            <h3 id="conversationUserName">User Name</h3>
                            <p id="conversationUserStatus">
                                <span class="status-indicator status-online"></span>
                                <span id="statusText">Online</span>
                            </p>
                        </div>
                    </div>
                    <div class="conversation-actions">
                        <button class="conversation-action-btn" id="viewProfileBtn" title="View Profile">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="balance-info">
                        <i class="fas fa-wallet"></i>
                        <span>Balance: <span class="balance-amount" id="balanceAmount">₦0</span></span>
                    </div>
                    
                    <!-- Pricing Display - Only shown when chatting with mentor/verified user -->
                    <div class="pricing-display" id="pricingDisplay" style="display: none;">
                        <div class="pricing-item">
                            <div class="pricing-type">Text Message</div>
                            <div class="pricing-amount" id="textPriceDisplay">₦0</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-type">Voice Message</div>
                            <div class="pricing-amount" id="voicePriceDisplay">₦0/min</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-type">Image Message</div>
                            <div class="pricing-amount" id="imagePriceDisplay">₦0</div>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="input-action-btn" id="attachBtn" title="Attach File">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="input-action-btn" id="voiceBtn" title="Record Voice">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <button class="send-btn" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="word-counter" id="wordCounter">0/35 words • ₦0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Search Widget -->
    <div class="floating-search" id="floatingSearch">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search users...">
    </div>
    
    <!-- Voice Recorder -->
    <div class="voice-recorder" id="voiceRecorder">
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <span>Recording</span>
        </div>
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="voice-waveform" id="voiceWaveform">
            <!-- Voice bars will be generated here -->
        </div>
        <div class="recording-actions">
            <button class="record-action-btn cancel" id="cancelRecordingBtn">
                <i class="fas fa-times"></i>
            </button>
            <button class="record-action-btn send" id="sendRecordingBtn">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>
    
    <!-- Voice Preview -->
    <div class="voice-preview" id="voicePreview">
        <div class="recording-timer" id="voicePreviewDuration">00:00</div>
        <div class="voice-preview-controls">
            <button class="voice-preview-play-btn" id="voicePreviewPlayBtn">
                <i class="fas fa-play"></i>
            </button>
            <div class="voice-preview-waveform" id="voicePreviewWaveform">
                <!-- Voice bars will be generated here -->
            </div>
        </div>
        <div class="voice-preview-actions">
            <button class="voice-preview-action-btn delete" id="deleteVoiceBtn">Delete</button>
            <button class="voice-preview-action-btn send" id="sendVoiceBtn">Send</button>
        </div>
    </div>
    
    <!-- Media Preview -->
    <div class="media-preview" id="mediaPreview">
        <div class="media-preview-content">
            <img id="mediaPreviewImage" src="" alt="Preview">
            <div>
                <div id="mediaPreviewName">image.jpg</div>
                <div class="media-preview-actions">
                    <button class="preview-action-btn send" id="sendMediaBtn">Send</button>
                    <button class="preview-action-btn cancel" id="cancelMediaBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu for Blocking Users -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="blockUserBtn">
            <i class="fas fa-ban"></i>
            <span>Block User</span>
        </div>
        <div class="context-menu-item danger" id="reportUserBtn">
            <i class="fas fa-flag"></i>
            <span>Report User</span>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat Settings</h2>
                <i class="fas fa-times close-modal" id="closeSettingsModal"></i>
            </div>
            
            <!-- Earnings Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-chart-line"></i>
                    Earnings Overview
                </h3>
                <div class="earnings-info">
                    <div class="earnings-item">
                        <span class="earnings-label">Total Earnings</span>
                        <span class="earnings-value" id="totalEarnings">₦0</span>
                    </div>
                    <div class="earnings-item">
                        <span class="earnings-label">Available for Withdrawal</span>
                        <span class="earnings-value" id="availableEarnings">₦0</span>
                    </div>
                </div>
            </div>
            
            <!-- Monetization Settings for Verified/Mentor Users -->
            <div class="settings-section" id="monetizationSettings">
                <h3 class="settings-section-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Monetization Settings
                </h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color);">
                    Set your custom pricing for messages. 50% of earnings go to you, 50% to ConnectX.
                </p>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-comment-alt"></i>
                        <h4>Text Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per 35 words</div>
                            <input type="number" id="textMessagePrice" min="5" max="1000" value="10">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-microphone"></i>
                        <h4>Voice Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per minute</div>
                            <input type="number" id="voiceMessagePrice" min="10" max="5000" value="30">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-image"></i>
                        <h4>Image Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per image</div>
                            <input type="number" id="imageMessagePrice" min="5" max="1000" value="15">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="savePricingBtn">Save Pricing</button>
            </div>
            
            <!-- General Settings -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-sliders-h"></i>
                    General Settings
                </h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="onlineStatus">Online Status</label>
                        <select id="onlineStatus">
                            <option value="online">Online</option>
                            <option value="away">Away</option>
                            <option value="busy">Busy</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageSounds">Message Sounds</label>
                        <select id="messageSounds">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="browserNotifications">Browser Notifications</label>
                        <select id="browserNotifications">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>

    <!-- Monetization Application Modal -->
    <div class="modal" id="monetizationApplicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Apply for Monetization</h2>
                <i class="fas fa-times close-modal" id="closeApplicationModal"></i>
            </div>
            
            <div class="application-note">
                <i class="fas fa-info-circle"></i>
                <span>Your application will be reviewed by our team. You'll receive a response within 3-5 business days.</span>
            </div>
            
            <form id="monetizationApplicationForm" class="application-form">
                <div class="form-section">
                    <h3 class="form-section-title">Personal Information</h3>
                    
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" min="18" max="100" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="form-section-title">Contact Information</h3>
                    
                    <div class="form-group">
                        <label for="socialMediaLinks">Social Media Links</label>
                        <textarea id="socialMediaLinks" placeholder="Include links to your social media profiles (Instagram, Twitter, YouTube, etc.)" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactMethod">Preferred Contact Method</label>
                        <select id="contactMethod" required>
                            <option value="">Select contact method</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="email">Email</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactInfo">Contact Information</label>
                        <input type="text" id="contactInfo" placeholder="Phone number or email address" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="form-section-title">Live Photo Verification</h3>
                    
                    <div class="camera-container" id="cameraContainer">
                        <div id="cameraInstructions">
                            <i class="fas fa-camera" style="font-size: 40px; color: var(--gray-color); margin-bottom: 10px;"></i>
                            <p>Click "Start Camera" to take a live verification photo</p>
                        </div>
                        <video id="cameraVideo" class="camera-video" autoplay playsinline style="display: none;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <img id="cameraPreview" class="camera-preview" src="" alt="Photo Preview">
                        <div class="camera-controls" id="cameraControls" style="display: none;">
                            <button type="button" class="camera-btn capture" id="captureBtn">Capture Photo</button>
                            <button type="button" class="camera-btn retake" id="retakeBtn" style="display: none;">Retake</button>
                        </div>
                        <button type="button" class="camera-btn capture" id="startCameraBtn">Start Camera</button>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitApplicationBtn">Submit Application</button>
            </form>
        </div>
    </div>

    <!-- External Configuration -->
    <script src="configuration.js"></script>
    <script src="agora.js"></script>

    <!-- External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Main Application Script -->
    <script>
        // Professional Chat Application with All Features Working
        class ConnectXChat {
            constructor() {
                this.state = {
                    currentUser: null,
                    conversations: [],
                    activeConversation: null,
                    messages: [],
                    userProfile: null,
                    mediaFile: null,
                    isRecording: false,
                    recordingTimer: null,
                    recordingStartTime: null,
                    audioChunks: [],
                    mediaRecorder: null,
                    voiceNote: null,
                    conversationId: null,
                    isInConversationView: false,
                    balance: 0,
                    freeMessagesRemaining: 3,
                    settings: {
                        onlineStatus: 'online',
                        messageSounds: 'enabled',
                        browserNotifications: 'enabled'
                    },
                    audioContext: null,
                    analyser: null,
                    dataArray: null,
                    animationId: null,
                    networkUsers: [],
                    searchResults: [],
                    isVoicePreview: false,
                    audioPlayer: null,
                    isPlaying: false,
                    lastScrollTop: 0,
                    isSearchActive: false,
                    blockedUsers: [],
                    contextMenu: {
                        targetUser: null,
                        targetElement: null
                    },
                    notificationSound: null,
                    agoraStream: null
                };

                this.init();
            }

            async init() {
                try {
                    console.log('Initializing ConnectX Chat...');
                    
                    // Check if Firebase is available
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase not loaded. Please check your configuration.');
                    }

                    // Initialize Firebase if not already done
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }

                    this.setupDOMReferences();
                    this.setupEventListeners();
                    await this.checkAuthStatus();
                    await this.loadUserProfile();
                    await this.loadConversations();
                    await this.loadNetworkUsers();
                    await this.handleURLParameters();
                    
                    this.setupScrollBehavior();
                    this.setupContextMenu();
                    this.setupBrowserNotifications();
                    
                    console.log('ConnectX Chat initialized successfully');
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    this.showError('Failed to initialize chat application: ' + error.message);
                }
            }

            setupDOMReferences() {
                this.elements = {
                    mainContainer: document.getElementById('mainContainer'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    notificationsBtn: document.getElementById('notificationsBtn'),
                    notificationBadge: document.getElementById('notificationBadge'),
                    chatList: document.getElementById('chatList'),
                    userProfilesScroll: document.getElementById('userProfilesScroll'),
                    userProfilesSection: document.getElementById('userProfilesSection'),
                    floatingSearch: document.getElementById('floatingSearch'),
                    searchInput: document.getElementById('searchInput'),
                    chatArea: document.getElementById('chatArea'),
                    emptyState: document.getElementById('emptyState'),
                    conversationView: document.getElementById('conversationView'),
                    conversationBackBtn: document.getElementById('conversationBackBtn'),
                    conversationAvatar: document.getElementById('conversationAvatar'),
                    conversationUserName: document.getElementById('conversationUserName'),
                    conversationUserStatus: document.getElementById('conversationUserStatus'),
                    statusText: document.getElementById('statusText'),
                    viewProfileBtn: document.getElementById('viewProfileBtn'),
                    messagesArea: document.getElementById('messagesArea'),
                    chatInput: document.getElementById('chatInput'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    attachBtn: document.getElementById('attachBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    wordCounter: document.getElementById('wordCounter'),
                    balanceAmount: document.getElementById('balanceAmount'),
                    pricingDisplay: document.getElementById('pricingDisplay'),
                    textPriceDisplay: document.getElementById('textPriceDisplay'),
                    voicePriceDisplay: document.getElementById('voicePriceDisplay'),
                    imagePriceDisplay: document.getElementById('imagePriceDisplay'),
                    voiceRecorder: document.getElementById('voiceRecorder'),
                    recordingTimer: document.getElementById('recordingTimer'),
                    voiceWaveform: document.getElementById('voiceWaveform'),
                    cancelRecordingBtn: document.getElementById('cancelRecordingBtn'),
                    sendRecordingBtn: document.getElementById('sendRecordingBtn'),
                    voicePreview: document.getElementById('voicePreview'),
                    voicePreviewDuration: document.getElementById('voicePreviewDuration'),
                    voicePreviewWaveform: document.getElementById('voicePreviewWaveform'),
                    voicePreviewPlayBtn: document.getElementById('voicePreviewPlayBtn'),
                    deleteVoiceBtn: document.getElementById('deleteVoiceBtn'),
                    sendVoiceBtn: document.getElementById('sendVoiceBtn'),
                    mediaPreview: document.getElementById('mediaPreview'),
                    mediaPreviewImage: document.getElementById('mediaPreviewImage'),
                    mediaPreviewName: document.getElementById('mediaPreviewName'),
                    sendMediaBtn: document.getElementById('sendMediaBtn'),
                    cancelMediaBtn: document.getElementById('cancelMediaBtn'),
                    settingsModal: document.getElementById('settingsModal'),
                    closeSettingsModal: document.getElementById('closeSettingsModal'),
                    onlineStatus: document.getElementById('onlineStatus'),
                    messageSounds: document.getElementById('messageSounds'),
                    browserNotifications: document.getElementById('browserNotifications'),
                    saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                    totalEarnings: document.getElementById('totalEarnings'),
                    availableEarnings: document.getElementById('availableEarnings'),
                    monetizationSettings: document.getElementById('monetizationSettings'),
                    textMessagePrice: document.getElementById('textMessagePrice'),
                    voiceMessagePrice: document.getElementById('voiceMessagePrice'),
                    imageMessagePrice: document.getElementById('imageMessagePrice'),
                    savePricingBtn: document.getElementById('savePricingBtn'),
                    monetizationApplicationModal: document.getElementById('monetizationApplicationModal'),
                    closeApplicationModal: document.getElementById('closeApplicationModal'),
                    monetizationApplicationForm: document.getElementById('monetizationApplicationForm'),
                    fullName: document.getElementById('fullName'),
                    age: document.getElementById('age'),
                    country: document.getElementById('country'),
                    socialMediaLinks: document.getElementById('socialMediaLinks'),
                    contactMethod: document.getElementById('contactMethod'),
                    contactInfo: document.getElementById('contactInfo'),
                    cameraContainer: document.getElementById('cameraContainer'),
                    cameraVideo: document.getElementById('cameraVideo'),
                    cameraCanvas: document.getElementById('cameraCanvas'),
                    cameraPreview: document.getElementById('cameraPreview'),
                    cameraControls: document.getElementById('cameraControls'),
                    startCameraBtn: document.getElementById('startCameraBtn'),
                    captureBtn: document.getElementById('captureBtn'),
                    retakeBtn: document.getElementById('retakeBtn'),
                    submitApplicationBtn: document.getElementById('submitApplicationBtn'),
                    cameraInstructions: document.getElementById('cameraInstructions'),
                    contextMenu: document.getElementById('contextMenu'),
                    blockUserBtn: document.getElementById('blockUserBtn'),
                    reportUserBtn: document.getElementById('reportUserBtn')
                };
            }

            setupEventListeners() {
                // Navigation
                this.elements.conversationBackBtn.addEventListener('click', () => this.exitConversationView());
                this.elements.viewProfileBtn.addEventListener('click', () => this.viewUserProfile());
                
                // Settings
                this.elements.settingsBtn.addEventListener('click', () => this.showSettingsModal());
                this.elements.closeSettingsModal.addEventListener('click', () => this.hideSettingsModal());
                this.elements.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
                this.elements.savePricingBtn.addEventListener('click', () => this.saveCustomPricing());
                
                // Message Input
                this.elements.chatInput.addEventListener('input', () => {
                    this.handleInputResize();
                    this.updateWordCounter();
                });
                
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.elements.sendMessageBtn.addEventListener('click', () => this.sendMessage());
                this.elements.attachBtn.addEventListener('click', () => this.handleAttachFile());
                this.elements.voiceBtn.addEventListener('click', () => this.startRecording());
                
                // Voice Recording
                this.elements.cancelRecordingBtn.addEventListener('click', () => this.cancelRecording());
                this.elements.sendRecordingBtn.addEventListener('click', () => this.stopRecording());
                
                // Voice Preview
                this.elements.voicePreviewPlayBtn.addEventListener('click', () => this.toggleVoicePlayback());
                this.elements.deleteVoiceBtn.addEventListener('click', () => this.deleteVoicePreview());
                this.elements.sendVoiceBtn.addEventListener('click', () => this.sendVoiceMessage());
                
                // Media Preview
                this.elements.sendMediaBtn.addEventListener('click', () => this.sendMediaMessage());
                this.elements.cancelMediaBtn.addEventListener('click', () => this.cancelMedia());
                
                // Context Menu
                this.elements.blockUserBtn.addEventListener('click', () => this.blockUser());
                this.elements.reportUserBtn.addEventListener('click', () => this.reportUser());
                
                // Close context menu when clicking elsewhere
                document.addEventListener('click', (e) => {
                    if (this.elements.contextMenu && !this.elements.contextMenu.contains(e.target)) {
                        this.hideContextMenu();
                    }
                });

                // Notifications
                this.elements.notificationsBtn.addEventListener('click', () => this.requestNotificationPermission());
                
                // Monetization Application
                this.elements.closeApplicationModal.addEventListener('click', () => this.hideApplicationModal());
                this.elements.monetizationApplicationForm.addEventListener('submit', (e) => this.submitApplication(e));
                this.elements.startCameraBtn.addEventListener('click', () => this.startCamera());
                this.elements.captureBtn.addEventListener('click', () => this.capturePhoto());
                this.elements.retakeBtn.addEventListener('click', () => this.retakePhoto());
            }

            setupScrollBehavior() {
                const chatList = this.elements.chatList;
                let lastScrollTop = 0;
                let isScrolling;
                
                chatList.addEventListener('scroll', () => {
                    const scrollTop = chatList.scrollTop;
                    
                    // Clear our timeout throughout the scroll
                    window.clearTimeout(isScrolling);
                    
                    // Determine scroll direction
                    if (scrollTop > lastScrollTop && scrollTop > 50) {
                        // Scrolling down - hide user profiles with smooth animation
                        this.elements.userProfilesSection.style.transform = 'translateY(-100%)';
                        this.elements.userProfilesSection.style.opacity = '0';
                    } else if (scrollTop < lastScrollTop) {
                        // Scrolling up - show user profiles
                        this.elements.userProfilesSection.style.transform = 'translateY(0)';
                        this.elements.userProfilesSection.style.opacity = '1';
                    }
                    
                    lastScrollTop = scrollTop;
                    
                    // Set a timeout to run after scrolling ends
                    isScrolling = setTimeout(() => {
                        this.handleScrollEnd();
                    }, 66);
                });
            }

            setupContextMenu() {
                // Add context menu to chat list items and user profiles
                this.elements.chatList.addEventListener('contextmenu', (e) => {
                    const chatItem = e.target.closest('.chat-list-item');
                    if (chatItem) {
                        e.preventDefault();
                        this.showContextMenu(e, chatItem);
                    }
                });

                this.elements.userProfilesScroll.addEventListener('contextmenu', (e) => {
                    const userProfile = e.target.closest('.user-profile-item');
                    if (userProfile) {
                        e.preventDefault();
                        this.showContextMenu(e, userProfile);
                    }
                });
            }

            showContextMenu(e, element) {
                const userId = element.getAttribute('data-user-id') || 
                              element.getAttribute('data-conversation-id');
                
                if (!userId) return;

                // Store target information
                this.state.contextMenu.targetUser = userId;
                this.state.contextMenu.targetElement = element;

                // Position the context menu
                this.elements.contextMenu.style.left = e.pageX + 'px';
                this.elements.contextMenu.style.top = e.pageY + 'px';
                this.elements.contextMenu.classList.add('active');
            }

            hideContextMenu() {
                this.elements.contextMenu.classList.remove('active');
                this.state.contextMenu.targetUser = null;
                this.state.contextMenu.targetElement = null;
            }

            async blockUser() {
                const userId = this.state.contextMenu.targetUser;
                if (!userId) return;

                try {
                    // Add to blocked users list
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            blockedUsers: firebase.firestore.FieldValue.arrayUnion(userId)
                        });

                    this.state.blockedUsers.push(userId);
                    
                    // Hide the context menu
                    this.hideContextMenu();
                    
                    // Show notification
                    this.showNotification('User Blocked', 'This user can no longer message you');
                    
                    // Remove from UI if currently visible
                    if (this.state.contextMenu.targetElement) {
                        this.state.contextMenu.targetElement.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('Error blocking user:', error);
                    this.showError('Failed to block user');
                }
            }

            async reportUser() {
                const userId = this.state.contextMenu.targetUser;
                if (!userId) return;

                const reason = prompt('Please enter the reason for reporting this user:');
                if (!reason) return;

                try {
                    await firebase.firestore()
                        .collection('reports')
                        .add({
                            reporterId: this.state.currentUser.uid,
                            reportedUserId: userId,
                            reason: reason,
                            timestamp: new Date().toISOString(),
                            status: 'pending'
                        });

                    this.hideContextMenu();
                    this.showNotification('User Reported', 'Thank you for your report. We will review it shortly.');
                    
                } catch (error) {
                    console.error('Error reporting user:', error);
                    this.showError('Failed to report user');
                }
            }

            setupBrowserNotifications() {
                if (!("Notification" in window)) {
                    console.log("This browser does not support notifications");
                    return;
                }

                // Create notification sound
                this.createNotificationSound();
            }

            createNotificationSound() {
                try {
                    // Create a simple beep sound
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    this.state.notificationSound = {
                        play: () => {
                            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                            
                            oscillator.start();
                            oscillator.stop(audioContext.currentTime + 0.3);
                        }
                    };
                } catch (error) {
                    console.warn('Could not create notification sound:', error);
                }
            }

            async requestNotificationPermission() {
                if (Notification.permission === "granted") {
                    this.showNotification('Notifications', 'Notifications are already enabled');
                    return;
                }

                if (Notification.permission !== "denied") {
                    try {
                        const permission = await Notification.requestPermission();
                        if (permission === "granted") {
                            this.showNotification('Notifications Enabled', 'You will now receive notifications for new messages');
                        }
                    } catch (error) {
                        console.error('Error requesting notification permission:', error);
                    }
                }
            }

            async showBrowserNotification(title, body) {
                if (Notification.permission !== "granted") return;
                if (!document.hidden) return;

                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: '/icon.png',
                        badge: '/badge-icon.png',
                        tag: 'connectx-notification',
                        requireInteraction: false
                    });

                    // Play sound
                    if (this.state.settings.messageSounds === 'enabled' && this.state.notificationSound) {
                        this.state.notificationSound.play();
                    }

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    // Auto close after 5 seconds
                    setTimeout(() => notification.close(), 5000);
                    
                } catch (error) {
                    console.error('Error showing notification:', error);
                }
            }

            async checkAuthStatus() {
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                            console.log('User authenticated:', user.uid);
                            resolve();
                        } else {
                            console.log('No user signed in');
                            // For demo purposes, create a mock user
                            this.createMockUser();
                            resolve();
                        }
                    });
                });
            }

            createMockUser() {
                // Create a mock user for demonstration
                this.state.currentUser = {
                    uid: 'mock-user-' + Date.now(),
                    email: 'demo@connectx.com',
                    displayName: 'Demo User'
                };
                
                this.state.userProfile = {
                    name: 'Demo User',
                    balance: 1000,
                    totalEarnings: 500,
                    availableEarnings: 250,
                    freeMessagesUsed: 0,
                    isMentor: false,
                    isVerified: false,
                    customPricing: {
                        text: 10,
                        voice: 30,
                        image: 15
                    }
                };
                
                console.log('Mock user created for demonstration');
            }

            async loadUserProfile() {
                if (!this.state.currentUser) return;

                try {
                    // For demo, use the mock profile
                    if (this.state.userProfile) {
                        this.state.balance = this.state.userProfile.balance || 0;
                        this.state.freeMessagesRemaining = 3 - (this.state.userProfile.freeMessagesUsed || 0);
                        
                        this.elements.balanceAmount.textContent = `₦${this.state.balance}`;
                        
                        const totalEarnings = this.state.userProfile.totalEarnings || 0;
                        const availableEarnings = this.state.userProfile.availableEarnings || 0;
                        this.elements.totalEarnings.textContent = `₦${totalEarnings}`;
                        this.elements.availableEarnings.textContent = `₦${availableEarnings}`;
                        
                        // Load pricing
                        if (this.state.userProfile.customPricing) {
                            this.elements.textMessagePrice.value = this.state.userProfile.customPricing.text || 10;
                            this.elements.voiceMessagePrice.value = this.state.userProfile.customPricing.voice || 30;
                            this.elements.imageMessagePrice.value = this.state.userProfile.customPricing.image || 15;
                        }
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async loadNetworkUsers() {
                try {
                    // Create mock network users for demonstration
                    this.state.networkUsers = [
                        {
                            id: 'user1',
                            name: 'John Doe',
                            profilePicture: null,
                            onlineStatus: 'online',
                            isMentor: true,
                            isVerified: false
                        },
                        {
                            id: 'user2', 
                            name: 'Jane Smith',
                            profilePicture: null,
                            onlineStatus: 'away',
                            isMentor: false,
                            isVerified: true
                        },
                        {
                            id: 'user3',
                            name: 'Mike Johnson',
                            profilePicture: null,
                            onlineStatus: 'offline',
                            isMentor: true,
                            isVerified: true
                        },
                        {
                            id: 'user4',
                            name: 'Sarah Wilson',
                            profilePicture: null,
                            onlineStatus: 'online',
                            isMentor: false,
                            isVerified: false
                        }
                    ];
                    
                    this.renderNetworkUsers();
                } catch (error) {
                    console.error('Error loading network users:', error);
                }
            }

            renderNetworkUsers() {
                const usersHTML = this.state.networkUsers.map(user => {
                    let statusBadges = '';
                    if (user.isMentor) {
                        statusBadges += '<span class="status-badge mentor"><i class="fas fa-graduation-cap"></i></span>';
                    }
                    if (user.isVerified) {
                        statusBadges += '<span class="status-badge verified"><i class="fas fa-check"></i></span>';
                    }
                    
                    return `
                        <div class="user-profile-item" data-user-id="${user.id}">
                            <div class="user-profile-avatar">
                                ${user.name.charAt(0).toUpperCase()}
                                <div class="status-indicator status-${user.onlineStatus}"></div>
                            </div>
                            <div class="user-profile-name">${user.name}${statusBadges}</div>
                        </div>
                    `;
                }).join('');
                
                this.elements.userProfilesScroll.innerHTML = usersHTML;
                
                // Add event listeners
                this.elements.userProfilesScroll.querySelectorAll('.user-profile-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const userId = item.getAttribute('data-user-id');
                        this.startConversation(userId);
                    });
                    
                    // Add long press for mobile
                    let pressTimer;
                    item.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            this.showContextMenu(e, item);
                        }, 500);
                    });
                    
                    item.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                });
            }

            async loadConversations() {
                try {
                    // Create mock conversations for demonstration
                    this.state.conversations = [
                        {
                            id: 'conv1',
                            participants: [this.state.currentUser.uid, 'user1'],
                            participantsData: {
                                [this.state.currentUser.uid]: {
                                    name: this.state.userProfile?.name || 'You',
                                    profilePicture: null,
                                    onlineStatus: 'online'
                                },
                                'user1': {
                                    name: 'John Doe',
                                    profilePicture: null,
                                    onlineStatus: 'online',
                                    isMentor: true
                                }
                            },
                            lastMessage: 'Hello there! How can I help you today?',
                            lastMessageType: 'text',
                            lastMessageSender: 'user1',
                            lastMessageAt: new Date(Date.now() - 300000).toISOString(), // 5 minutes ago
                            unreadCount: {
                                [this.state.currentUser.uid]: 1
                            }
                        },
                        {
                            id: 'conv2',
                            participants: [this.state.currentUser.uid, 'user2'],
                            participantsData: {
                                [this.state.currentUser.uid]: {
                                    name: this.state.userProfile?.name || 'You',
                                    profilePicture: null,
                                    onlineStatus: 'online'
                                },
                                'user2': {
                                    name: 'Jane Smith',
                                    profilePicture: null,
                                    onlineStatus: 'away',
                                    isVerified: true
                                }
                            },
                            lastMessage: 'Can you help me with this project?',
                            lastMessageType: 'text',
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                            unreadCount: {
                                [this.state.currentUser.uid]: 0
                            }
                        },
                        {
                            id: 'conv3',
                            participants: [this.state.currentUser.uid, 'user3'],
                            participantsData: {
                                [this.state.currentUser.uid]: {
                                    name: this.state.userProfile?.name || 'You',
                                    profilePicture: null,
                                    onlineStatus: 'online'
                                },
                                'user3': {
                                    name: 'Mike Johnson',
                                    profilePicture: null,
                                    onlineStatus: 'offline',
                                    isMentor: true,
                                    isVerified: true
                                }
                            },
                            lastMessage: 'Thanks for the voice message!',
                            lastMessageType: 'voice',
                            lastMessageSender: 'user3',
                            lastMessageAt: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
                            unreadCount: {
                                [this.state.currentUser.uid]: 0
                            }
                        }
                    ];
                    
                    this.renderConversations();
                    this.setupConversationsListener();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            setupConversationsListener() {
                // Simulate real-time updates for demo
                setInterval(() => {
                    this.updateNotificationBadge();
                }, 5000);
            }

            updateNotificationBadge() {
                const totalUnread = this.state.conversations.reduce((total, conversation) => {
                    return total + (conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0);
                }, 0);
                
                if (totalUnread > 0) {
                    this.elements.notificationBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    this.elements.notificationBadge.style.display = 'flex';
                } else {
                    this.elements.notificationBadge.style.display = 'none';
                }
            }

            renderConversations() {
                const conversationsHTML = this.state.conversations.map(conversation => {
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const isActive = this.state.activeConversation && this.state.activeConversation.id === conversation.id;
                    const unreadCount = conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0;
                    
                    let statusBadges = '';
                    if (otherParticipant && otherParticipant.isMentor) {
                        statusBadges += '<span class="status-badge mentor"><i class="fas fa-graduation-cap"></i></span>';
                    }
                    if (otherParticipant && otherParticipant.isVerified) {
                        statusBadges += '<span class="status-badge verified"><i class="fas fa-check"></i></span>';
                    }
                    
                    let previewText = conversation.lastMessage;
                    if (conversation.lastMessageType === 'voice') {
                        previewText = '<i class="fas fa-microphone"></i> Voice message';
                    } else if (conversation.lastMessageType === 'image') {
                        previewText = '<i class="fas fa-image"></i> Image';
                    }
                    
                    return `
                        <div class="chat-list-item ${isActive ? 'active' : ''}" data-conversation-id="${conversation.id}" data-user-id="${otherParticipantId}">
                            <div class="chat-avatar">
                                ${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}
                                <div class="status-indicator ${otherParticipant ? `status-${otherParticipant.onlineStatus}` : 'status-offline'}"></div>
                            </div>
                            <div class="chat-info">
                                <div class="chat-header-info">
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}${statusBadges}</div>
                                    <div class="chat-time">${this.formatTime(conversation.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    ${previewText}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.elements.chatList.innerHTML = conversationsHTML;
                
                // Add event listeners
                this.elements.chatList.querySelectorAll('.chat-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        this.loadConversation(conversationId);
                    });
                });
            }

            async loadConversation(conversationId) {
                try {
                    console.log('Loading conversation:', conversationId);
                    
                    // Find conversation in state
                    const conversation = this.state.conversations.find(conv => conv.id === conversationId);
                    if (!conversation) {
                        this.showError('Conversation not found');
                        return;
                    }
                    
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Update URL with conversation ID
                    this.updateURLWithConversation(conversationId);
                    
                    // Get user data
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData[otherParticipantId];
                    
                    this.state.activeConversation.user = {
                        id: otherParticipantId,
                        ...otherParticipant
                    };
                    
                    // Check if paid conversation
                    if (otherParticipant.isMentor || otherParticipant.isVerified) {
                        this.state.recipientPricing = {
                            text: appConfig.textMessagePrice,
                            voice: appConfig.voiceMessagePrice,
                            image: appConfig.imageMessagePrice
                        };
                        this.showPricingDisplay();
                    } else {
                        this.hidePricingDisplay();
                    }
                    
                    // Load messages
                    await this.loadMessages(conversationId);
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    
                    // Mark as read
                    await this.markAsRead(conversationId);
                    
                    // Highlight active conversation
                    this.highlightActiveConversation(conversationId);
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    this.showError('Failed to load conversation');
                }
            }

            async loadMessages(conversationId) {
                try {
                    // Create mock messages for demonstration
                    this.state.messages = [
                        {
                            id: '1',
                            senderId: 'user1',
                            content: 'Hello! How can I help you today?',
                            type: 'text',
                            createdAt: new Date(Date.now() - 300000).toISOString()
                        },
                        {
                            id: '2', 
                            senderId: this.state.currentUser.uid,
                            content: 'I need some advice about your mentoring services',
                            type: 'text',
                            createdAt: new Date(Date.now() - 240000).toISOString()
                        },
                        {
                            id: '3',
                            senderId: 'user1',
                            content: 'Sure, I\'d be happy to help! What would you like to know?',
                            type: 'text',
                            createdAt: new Date(Date.now() - 180000).toISOString()
                        },
                        {
                            id: '4',
                            senderId: this.state.currentUser.uid,
                            content: 'Can you tell me about your experience and pricing?',
                            type: 'text',
                            createdAt: new Date(Date.now() - 120000).toISOString()
                        }
                    ];
                    
                    this.renderMessages();
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            renderMessages() {
                if (!this.state.messages.length) {
                    this.elements.messagesArea.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-alt"></i>
                            <h3>No messages yet</h3>
                            <p>Send a message to start the conversation.</p>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = this.state.messages.map(message => {
                    const isSent = message.senderId === this.state.currentUser.uid;
                    
                    let messageContent = '';
                    
                    if (message.type === 'text') {
                        messageContent = `<div class="message-text">${message.content}</div>`;
                    } else if (message.type === 'image') {
                        messageContent = `
                            <div class="message-media">
                                <img src="${message.mediaUrl}" alt="Shared image">
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        messageContent = `
                            <div class="voice-message">
                                <button class="voice-play-btn" data-audio="${message.mediaUrl}">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="voice-waveform">
                                    ${this.generateVoiceWaveform()}
                                </div>
                                <div class="voice-duration">${message.duration || '0:15'}</div>
                            </div>
                        `;
                    }
                    
                    // Show pricing info for paid messages
                    let costInfo = '';
                    if (message.isPaid && message.cost) {
                        costInfo = `<div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Paid: ₦${message.cost}</div>`;
                    }
                    
                    return `
                        <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${message.id}">
                            ${messageContent}
                            <div class="message-time">${this.formatTime(message.createdAt)}</div>
                            ${costInfo}
                        </div>
                    `;
                }).join('');
                
                this.elements.messagesArea.innerHTML = messagesHTML;
                
                // Add event listeners to voice messages
                this.elements.messagesArea.querySelectorAll('.voice-play-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const audioUrl = e.target.closest('.voice-play-btn').getAttribute('data-audio');
                        this.playVoiceMessage(audioUrl, e.target.closest('.voice-message'));
                    });
                });
                
                // Scroll to bottom
                this.scrollToBottom();
            }

            async startConversation(userId) {
                try {
                    console.log('Starting conversation with user:', userId);
                    
                    // Check if conversation already exists
                    const existingConversation = this.state.conversations.find(conv => 
                        conv.participants.includes(userId)
                    );
                    
                    if (existingConversation) {
                        await this.loadConversation(existingConversation.id);
                        return;
                    }
                    
                    // Find user data
                    const user = this.state.networkUsers.find(u => u.id === userId);
                    if (!user) {
                        this.showError('User not found');
                        return;
                    }
                    
                    // Create new conversation
                    const conversationId = 'conv_' + Date.now();
                    const conversation = {
                        id: conversationId,
                        participants: [this.state.currentUser.uid, userId],
                        participantsData: {
                            [this.state.currentUser.uid]: {
                                name: this.state.userProfile?.name || 'You',
                                profilePicture: null,
                                onlineStatus: 'online'
                            },
                            [userId]: {
                                ...user
                            }
                        },
                        messages: [],
                        lastMessage: '',
                        lastMessageType: '',
                        lastMessageSender: '',
                        lastMessageAt: new Date().toISOString(),
                        unreadCount: {
                            [this.state.currentUser.uid]: 0,
                            [userId]: 0
                        }
                    };
                    
                    this.state.conversations.unshift(conversation);
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Update URL with conversation ID
                    this.updateURLWithConversation(conversationId);
                    
                    // Check if paid conversation
                    if (user.isMentor || user.isVerified) {
                        this.state.recipientPricing = {
                            text: appConfig.textMessagePrice,
                            voice: appConfig.voiceMessagePrice,
                            image: appConfig.imageMessagePrice
                        };
                        this.showPricingDisplay();
                    } else {
                        this.hidePricingDisplay();
                    }
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages(conversationId);
                    
                    // Render conversations to show new one
                    this.renderConversations();
                    this.highlightActiveConversation(conversationId);
                    
                    // Show browser notification
                    this.showBrowserNotification(
                        'New Conversation',
                        `You started a conversation with ${user.name}`
                    );
                    
                } catch (error) {
                    console.error('Error starting conversation:', error);
                    this.showError('Failed to start conversation');
                }
            }

            async sendMessage() {
                const content = this.elements.chatInput.value.trim();
                if (!content && !this.state.mediaFile && !this.state.voiceNote) return;

                try {
                    let message = {
                        id: Date.now().toString(),
                        senderId: this.state.currentUser.uid,
                        content: content,
                        type: 'text',
                        createdAt: new Date().toISOString(),
                        isPaid: false,
                        cost: 0
                    };

                    // Handle media files
                    if (this.state.mediaFile) {
                        message.type = 'image';
                        message.mediaUrl = URL.createObjectURL(this.state.mediaFile);
                        message.content = '';
                        
                        // Check if paid conversation
                        if (this.state.recipientPricing) {
                            message.isPaid = true;
                            message.cost = this.state.recipientPricing.image;
                        }
                    }

                    // Handle voice notes
                    if (this.state.voiceNote) {
                        message.type = 'voice';
                        message.mediaUrl = this.state.voiceNote.url;
                        message.duration = this.state.voiceNote.duration;
                        message.content = '';
                        
                        // Check if paid conversation
                        if (this.state.recipientPricing) {
                            message.isPaid = true;
                            const minutes = Math.ceil(this.state.voiceNote.duration / 60);
                            message.cost = minutes * this.state.recipientPricing.voice;
                        }
                    }

                    // Check if paid text message
                    if (this.state.recipientPricing && message.type === 'text') {
                        const wordCount = content.split(/\s+/).length;
                        if (wordCount > 0) {
                            message.isPaid = true;
                            message.cost = this.state.recipientPricing.text;
                        }
                    }

                    // Add message to conversation
                    this.state.messages.push(message);
                    
                    // Update conversation last message
                    if (this.state.activeConversation) {
                        this.state.activeConversation.lastMessage = content || (message.type === 'voice' ? 'Voice message' : 'Image');
                        this.state.activeConversation.lastMessageType = message.type;
                        this.state.activeConversation.lastMessageSender = this.state.currentUser.uid;
                        this.state.activeConversation.lastMessageAt = new Date().toISOString();
                    }

                    // Re-render
                    this.renderMessages();
                    this.renderConversations();

                    // Clear input and reset state
                    this.elements.chatInput.value = '';
                    this.state.mediaFile = null;
                    this.state.voiceNote = null;
                    this.hideMediaPreview();
                    this.hideVoicePreview();
                    this.handleInputResize();
                    this.updateWordCounter();

                    // Show browser notification to recipient (simulated)
                    if (this.state.activeConversation && this.state.activeConversation.user) {
                        this.showBrowserNotification(
                            `New message from ${this.state.userProfile?.name || 'You'}`,
                            content || (message.type === 'voice' ? 'Sent a voice message' : 'Sent an image')
                        );
                    }

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message');
                }
            }

            async markAsRead(conversationId) {
                try {
                    // Mark conversation as read in UI
                    const conversation = this.state.conversations.find(conv => conv.id === conversationId);
                    if (conversation && conversation.unreadCount) {
                        conversation.unreadCount[this.state.currentUser.uid] = 0;
                        this.renderConversations();
                        this.updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }

            // Voice Recording
            async startRecording() {
                try {
                    console.log('Starting voice recording...');
                    
                    // Use Agora audio manager if available
                    if (typeof agoraAudioManager !== 'undefined') {
                        this.state.agoraStream = await agoraAudioManager.startRecording();
                    } else {
                        await this.startStandardRecording();
                    }
                    
                    this.state.isRecording = true;
                    this.state.recordingStartTime = Date.now();
                    
                    // Show voice recorder UI
                    this.elements.voiceRecorder.classList.add('active');
                    
                    // Start timer
                    this.state.recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        this.elements.recordingTimer.textContent = this.formatAudioTime(elapsed);
                        this.animateWaveform();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Could not access microphone. Please check your permissions.');
                }
            }

            async startStandardRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    this.state.audioChunks = [];
                    this.state.mediaRecorder = new MediaRecorder(stream);
                    
                    this.state.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.state.audioChunks.push(event.data);
                        }
                    };
                    
                    this.state.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/webm' });
                        const duration = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        
                        this.state.voiceNote = {
                            blob: audioBlob,
                            duration: duration,
                            url: URL.createObjectURL(audioBlob)
                        };
                        
                        // Stop stream
                        stream.getTracks().forEach(track => track.stop());
                        this.showVoicePreview();
                    };
                    
                    this.state.mediaRecorder.start();
                    
                } catch (error) {
                    console.error('Error in standard recording:', error);
                    throw error;
                }
            }

            animateWaveform() {
                if (!this.state.isRecording) return;
                
                this.elements.voiceWaveform.innerHTML = '';
                
                // Get audio levels from Agora or generate random ones
                let audioLevels = [];
                if (typeof agoraAudioManager !== 'undefined') {
                    audioLevels = agoraAudioManager.getAudioLevels();
                } else {
                    // Generate random levels for visualization
                    for (let i = 0; i < 20; i++) {
                        audioLevels.push(Math.floor(Math.random() * 20) + 5);
                    }
                }
                
                // Create waveform bars
                audioLevels.forEach(level => {
                    const bar = document.createElement('div');
                    bar.className = 'voice-bar';
                    bar.style.height = `${level}px`;
                    this.elements.voiceWaveform.appendChild(bar);
                });
            }

            async stopRecording() {
                if (this.state.isRecording) {
                    if (typeof agoraAudioManager !== 'undefined' && agoraAudioManager.isRecording) {
                        this.state.voiceNote = await agoraAudioManager.stopRecording();
                    } else if (this.state.mediaRecorder) {
                        this.state.mediaRecorder.stop();
                    }
                    
                    this.state.isRecording = false;
                    this.elements.voiceRecorder.classList.remove('active');
                    
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                        this.state.recordingTimer = null;
                    }
                    
                    // Show voice preview
                    if (this.state.voiceNote) {
                        this.showVoicePreview();
                    }
                }
            }

            cancelRecording() {
                this.stopRecording();
                this.state.voiceNote = null;
                this.hideVoicePreview();
                
                // Stop Agora recording if active
                if (typeof agoraAudioManager !== 'undefined' && agoraAudioManager.isRecording) {
                    agoraAudioManager.stopRecording();
                }
            }

            showVoicePreview() {
                if (!this.state.voiceNote) return;
                
                this.state.isVoicePreview = true;
                this.elements.voicePreviewDuration.textContent = this.formatAudioTime(this.state.voiceNote.duration);
                this.elements.voicePreview.classList.add('active');
                this.generateVoicePreviewWaveform();
            }

            hideVoicePreview() {
                this.state.isVoicePreview = false;
                this.elements.voicePreview.classList.remove('active');
                this.state.voiceNote = null;
            }

            generateVoicePreviewWaveform() {
                this.elements.voicePreviewWaveform.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 30) + 10;
                    const bar = document.createElement('div');
                    bar.className = 'voice-preview-bar';
                    bar.style.height = `${height}px`;
                    this.elements.voicePreviewWaveform.appendChild(bar);
                }
            }

            toggleVoicePlayback() {
                if (!this.state.voiceNote) return;
                
                if (!this.state.audioPlayer) {
                    this.state.audioPlayer = new Audio(this.state.voiceNote.url);
                    this.state.audioPlayer.addEventListener('ended', () => {
                        this.state.isPlaying = false;
                        this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                    });
                }
                
                if (this.state.isPlaying) {
                    this.state.audioPlayer.pause();
                    this.state.isPlaying = false;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    this.state.audioPlayer.play();
                    this.state.isPlaying = true;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                }
            }

            deleteVoicePreview() {
                if (this.state.audioPlayer) {
                    this.state.audioPlayer.pause();
                    this.state.audioPlayer = null;
                }
                this.state.isPlaying = false;
                this.hideVoicePreview();
            }

            sendVoiceMessage() {
                this.sendMessage();
            }

            playVoiceMessage(audioUrl, voiceElement) {
                const audio = new Audio(audioUrl);
                const playBtn = voiceElement.querySelector('.voice-play-btn');
                const voiceBars = voiceElement.querySelectorAll('.voice-bar');
                
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                audio.addEventListener('timeupdate', () => {
                    const progress = audio.currentTime / audio.duration;
                    
                    // Animate voice bars during playback
                    voiceBars.forEach((bar, index) => {
                        const baseHeight = 5 + (index % 3) * 3;
                        const animation = Math.sin((Date.now() / 100) + index) * 5;
                        bar.style.height = `${baseHeight + animation}px`;
                    });
                });
                
                audio.addEventListener('ended', () => {
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    // Reset voice bars
                    voiceBars.forEach(bar => {
                        bar.style.height = '10px';
                    });
                });
                
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            }

            // Media Handling
            handleAttachFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > appConfig.maxFileSize) {
                            this.showError(`File size too large. Maximum size is ${appConfig.maxFileSize / 1024 / 1024}MB`);
                            return;
                        }
                        this.previewMedia(file);
                    }
                };
                input.click();
            }

            previewMedia(file) {
                this.state.mediaFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.elements.mediaPreviewImage.src = e.target.result;
                    this.elements.mediaPreviewName.textContent = file.name;
                    this.elements.mediaPreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }

            sendMediaMessage() {
                this.sendMessage();
            }

            cancelMedia() {
                this.state.mediaFile = null;
                this.hideMediaPreview();
            }

            hideMediaPreview() {
                this.elements.mediaPreview.classList.remove('active');
            }

            // UI Methods
            enterConversationView() {
                this.state.isInConversationView = true;
                this.elements.mainContainer.classList.add('conversation-view');
                this.elements.conversationView.style.display = 'block';
                this.elements.emptyState.style.display = 'none';
                this.elements.floatingSearch.style.display = 'none';
            }

            exitConversationView() {
                this.state.isInConversationView = false;
                this.elements.mainContainer.classList.remove('conversation-view');
                this.elements.conversationView.style.display = 'none';
                this.elements.emptyState.style.display = 'flex';
                this.elements.floatingSearch.style.display = 'flex';
                this.state.activeConversation = null;
                this.state.conversationId = null;
                
                // Remove conversation from URL
                const url = new URL(window.location);
                url.searchParams.delete('conversation');
                window.history.replaceState({}, '', url);
                
                // Remove active highlights
                this.removeActiveHighlights();
            }

            updateConversationHeader() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                
                const user = this.state.activeConversation.user;
                this.elements.conversationUserName.textContent = user.name;
                this.elements.conversationAvatar.textContent = user.name.charAt(0).toUpperCase();
                
                const status = user.onlineStatus || 'offline';
                this.elements.conversationUserStatus.innerHTML = `
                    <span class="status-indicator status-${status}"></span>
                    <span id="statusText">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
            }

            highlightActiveConversation(conversationId) {
                this.removeActiveHighlights();
                
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
                
                if (this.state.activeConversation && this.state.activeConversation.user) {
                    const userProfile = document.querySelector(`[data-user-id="${this.state.activeConversation.user.id}"]`);
                    if (userProfile) {
                        userProfile.classList.add('active');
                    }
                }
            }

            removeActiveHighlights() {
                document.querySelectorAll('.user-profile-item, .chat-list-item').forEach(item => {
                    item.classList.remove('active');
                });
            }

            handleInputResize() {
                const textarea = this.elements.chatInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            updateWordCounter() {
                const content = this.elements.chatInput.value.trim();
                if (!content || !this.state.recipientPricing) {
                    this.elements.wordCounter.style.display = 'none';
                    return;
                }
                
                const wordCount = content.split(/\s+/).length;
                const cost = this.state.recipientPricing.text;
                
                this.elements.wordCounter.textContent = `${wordCount}/35 words • ₦${cost}`;
                this.elements.wordCounter.style.display = 'block';
                
                if (wordCount > 35) {
                    this.elements.wordCounter.classList.add('near-limit');
                } else {
                    this.elements.wordCounter.classList.remove('near-limit');
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
                }, 100);
            }

            viewUserProfile() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                this.showNotification('Profile', `Viewing profile of ${this.state.activeConversation.user.name}`);
            }

            showPricingDisplay() {
                if (this.state.recipientPricing) {
                    this.elements.textPriceDisplay.textContent = `₦${this.state.recipientPricing.text}`;
                    this.elements.voicePriceDisplay.textContent = `₦${this.state.recipientPricing.voice}/min`;
                    this.elements.imagePriceDisplay.textContent = `₦${this.state.recipientPricing.image}`;
                    this.elements.pricingDisplay.style.display = 'flex';
                }
            }

            hidePricingDisplay() {
                this.elements.pricingDisplay.style.display = 'none';
                this.elements.wordCounter.style.display = 'none';
            }

            updateURLWithConversation(conversationId) {
                const url = new URL(window.location);
                url.searchParams.set('conversation', conversationId);
                window.history.replaceState({}, '', url);
            }

            async handleURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const conversationId = urlParams.get('conversation');
                
                if (conversationId && conversationId !== 'null' && conversationId !== 'undefined') {
                    console.log('Loading conversation from URL:', conversationId);
                    await this.loadConversation(conversationId);
                }
            }

            handleScrollEnd() {
                // Additional logic when scrolling stops
            }

            // Settings Methods
            showSettingsModal() {
                this.elements.onlineStatus.value = this.state.settings.onlineStatus;
                this.elements.messageSounds.value = this.state.settings.messageSounds;
                this.elements.browserNotifications.value = this.state.settings.browserNotifications;
                this.elements.settingsModal.classList.add('active');
            }

            hideSettingsModal() {
                this.elements.settingsModal.classList.remove('active');
            }

            async saveSettings() {
                try {
                    this.state.settings.onlineStatus = this.elements.onlineStatus.value;
                    this.state.settings.messageSounds = this.elements.messageSounds.value;
                    this.state.settings.browserNotifications = this.elements.browserNotifications.value;
                    
                    this.showNotification('Settings Saved', 'Your settings have been updated');
                    this.hideSettingsModal();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Failed to save settings');
                }
            }

            async saveCustomPricing() {
                try {
                    const textPrice = parseInt(this.elements.textMessagePrice.value);
                    const voicePrice = parseInt(this.elements.voiceMessagePrice.value);
                    const imagePrice = parseInt(this.elements.imageMessagePrice.value);
                    
                    // Validate prices
                    if (textPrice < 5 || textPrice > 1000 || voicePrice < 10 || voicePrice > 5000 || imagePrice < 5 || imagePrice > 1000) {
                        this.showError('Please enter valid prices within the allowed ranges');
                        return;
                    }
                    
                    // Update user profile
                    if (this.state.userProfile) {
                        this.state.userProfile.customPricing = {
                            text: textPrice,
                            voice: voicePrice,
                            image: imagePrice
                        };
                    }
                    
                    this.showNotification('Pricing Updated', 'Your custom pricing has been saved');
                } catch (error) {
                    console.error('Error saving custom pricing:', error);
                    this.showError('Failed to save custom pricing');
                }
            }

            // Monetization Application Methods
            showApplicationModal() {
                this.elements.monetizationApplicationModal.classList.add('active');
            }

            hideApplicationModal() {
                this.elements.monetizationApplicationModal.classList.remove('active');
                this.resetApplicationForm();
            }

            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: 640, 
                            height: 480,
                            facingMode: 'user'
                        } 
                    });
                    
                    this.state.cameraStream = stream;
                    this.elements.cameraVideo.srcObject = stream;
                    this.elements.cameraVideo.style.display = 'block';
                    this.elements.cameraInstructions.style.display = 'none';
                    this.elements.cameraControls.style.display = 'flex';
                    this.elements.startCameraBtn.style.display = 'none';
                    this.elements.captureBtn.style.display = 'block';
                    this.elements.retakeBtn.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    this.showError('Could not access camera. Please check your permissions.');
                }
            }

            capturePhoto() {
                const video = this.elements.cameraVideo;
                const canvas = this.elements.cameraCanvas;
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Stop the camera stream
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Show the captured image
                this.elements.cameraPreview.src = canvas.toDataURL('image/png');
                this.elements.cameraPreview.classList.add('active');
                this.elements.cameraVideo.style.display = 'none';
                this.elements.captureBtn.style.display = 'none';
                this.elements.retakeBtn.style.display = 'block';
                
                // Store the image data
                canvas.toBlob(blob => {
                    this.state.applicationPhoto = blob;
                }, 'image/png');
            }

            retakePhoto() {
                this.elements.cameraPreview.classList.remove('active');
                this.elements.cameraPreview.src = '';
                this.state.applicationPhoto = null;
                this.startCamera();
            }

            async submitApplication(e) {
                e.preventDefault();
                
                try {
                    // Validate form
                    if (!this.validateApplicationForm()) {
                        this.showError('Please fill all required fields and take a verification photo');
                        return;
                    }

                    // Show loading state
                    const originalText = this.elements.submitApplicationBtn.innerHTML;
                    this.elements.submitApplicationBtn.innerHTML = '<div class="loading"></div> Submitting...';
                    this.elements.submitApplicationBtn.disabled = true;

                    // Simulate API call with timeout
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Create application data
                    const applicationData = {
                        applicantId: this.state.currentUser.uid,
                        applicantName: this.state.userProfile?.name || 'Demo User',
                        fullName: this.elements.fullName.value,
                        age: parseInt(this.elements.age.value),
                        country: this.elements.country.value,
                        socialMediaLinks: this.elements.socialMediaLinks.value,
                        contactMethod: this.elements.contactMethod.value,
                        contactInfo: this.elements.contactInfo.value,
                        photoUrl: this.elements.cameraPreview.src || '',
                        appliedAt: new Date().toISOString(),
                        status: 'pending'
                    };

                    console.log('Application submitted:', applicationData);

                    this.showNotification('Success', 'Application submitted successfully!');
                    this.hideApplicationModal();

                } catch (error) {
                    console.error('Submission error:', error);
                    this.showError('Failed to submit application: ' + error.message);
                } finally {
                    this.resetApplicationButton();
                }
            }

            validateApplicationForm() {
                return this.elements.fullName.value && 
                    this.elements.age.value && 
                    this.elements.country.value && 
                    this.elements.socialMediaLinks.value && 
                    this.elements.contactMethod.value && 
                    this.elements.contactInfo.value && 
                    this.state.applicationPhoto;
            }

            resetApplicationForm() {
                this.elements.monetizationApplicationForm.reset();
                this.elements.cameraPreview.classList.remove('active');
                this.elements.cameraPreview.src = '';
                this.elements.cameraVideo.style.display = 'none';
                this.elements.cameraInstructions.style.display = 'block';
                this.elements.cameraControls.style.display = 'none';
                this.elements.startCameraBtn.style.display = 'block';
                this.state.applicationPhoto = null;
                
                // Stop camera if it's running
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(track => track.stop());
                    this.state.cameraStream = null;
                }
            }

            resetApplicationButton() {
                this.elements.submitApplicationBtn.innerHTML = 'Submit Application';
                this.elements.submitApplicationBtn.disabled = false;
            }

            // Utility Methods
            formatTime(timestamp) {
                if (!timestamp) return 'Just now';
                const now = new Date();
                const time = new Date(timestamp);
                const diff = now - time;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (days > 0) return `${days}d ago`;
                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return 'Just now';
            }

            formatAudioTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            generateVoiceWaveform() {
                let waveform = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 20) + 5;
                    waveform += `<div class="voice-bar" style="height: ${height}px;"></div>`;
                }
                return waveform;
            }

            showError(message) {
                this.showNotification('Error', message, 'error');
            }

            showNotification(title, message, type = 'success') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'error' ? 'var(--warning-color)' : 'var(--primary-color)'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideInRight 0.3s ease;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">${title}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${message}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);

            // Initialize chat application
            window.connectXChat = new ConnectXChat();
        });
    </script>
</body>
</html>
