<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadConnect - WhatsApp Lead Generation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- External configuration files -->
    <script src="configuration.js"></script>
    <script src="script.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #5e7cff;
            --primary-dark: #2a4ad5;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --success-light: #6bdbf9;
            --warning: #f72585;
            --warning-light: #ff4da7;
            --danger: #e63946;
            --danger-light: #ff5c6d;
            --dark: #14213d;
            --dark-light: #2c3a5c;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --gray-light: #e9ecef;
            --card-bg: #ffffff;
            --bg: #f0f2f5;
            --sidebar-bg: #1c2b4a;
            --sidebar-active: #2a4ad5;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 18px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.4rem;
        }
        
        .logo-icon {
            background: rgba(255, 255, 255, 0.15);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 30px;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .user-profile:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Main App Layout */
        .app-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            padding: 30px 0;
            transition: var(--transition);
            position: sticky;
            top: 76px;
            height: calc(100vh - 76px);
            overflow-y: auto;
        }
        
        .sidebar-title {
            padding: 0 25px 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 25px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid transparent;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-light);
        }
        
        .nav-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            background: var(--bg);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-title-icon {
            background: var(--primary-light);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }
        
        .page-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Card Styles */
        .card {
            background: var(--card-bg);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 25px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success));
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 5px 0;
            color: var(--dark);
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.95rem;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            margin-top: 10px;
            color: var(--success);
        }
        
        .stat-trend.down {
            color: var(--danger);
        }
        
        /* Table Styles */
        .table-container {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95rem;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .table td {
            padding: 14px 20px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover td {
            background: rgba(67, 97, 238, 0.03);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .input-group {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Buttons */
        .btn {
            padding: 14px 24px;
            margin: 5px 0;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .btn-sm {
            padding: 10px 18px;
            font-size: 0.9rem;
        }
        
        .btn-lg {
            padding: 16px 32px;
            font-size: 1.1rem;
        }
        
        .btn-icon {
            padding: 10px;
            width: 40px;
            height: 40px;
        }
        
        .btn-primary {
            background: var(--primary);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary);
        }
        
        .badge-success {
            background: rgba(76, 201, 240, 0.15);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(247, 37, 133, 0.15);
            color: var(--warning);
        }
        
        .badge-danger {
            background: rgba(230, 57, 70, 0.15);
            color: var(--danger);
        }
        
        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert i {
            font-size: 1.2rem;
        }
        
        .alert-primary {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .alert-success {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .alert-danger {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }
        
        /* Progress */
        .progress {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0;
            transition: width 0.5s ease;
            border-radius: 6px;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            position: relative;
            animation: modalFade 0.3s ease;
        }
        
        @keyframes modalFade {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--gray);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close:hover {
            color: var(--dark);
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Auth Screen */
        .auth-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f2f5 0%, #e6e9f0 100%);
        }
        
        .auth-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        
        .auth-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .auth-logo-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .auth-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0 0;
        }
        
        .auth-tab {
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            flex: 1;
            font-weight: 500;
        }
        
        .auth-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .auth-tab.active {
            background: white;
            color: var(--primary);
        }
        
        .auth-body {
            padding: 30px;
        }
        
        /* Enrollment Section */
        .enrollment-section {
            text-align: center;
            padding: 50px 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius-md);
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }
        
        .enrollment-section::before {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .enrollment-section::after {
            content: "";
            position: absolute;
            bottom: -80px;
            left: -80px;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .enrollment-section h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }
        
        .enrollment-section p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }
        
        .enrollment-count {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 20px 0;
            color: var(--success-light);
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* CTA Banner */
        .cta-banner {
            background: linear-gradient(135deg, var(--warning), var(--danger));
            color: white;
            padding: 25px;
            border-radius: var(--radius-md);
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow-sm);
        }
        
        .cta-banner h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .nav-item span {
                display: none;
            }
            
            .sidebar-title {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 0;
                position: static;
                display: flex;
                overflow-x: auto;
            }
            
            .nav-list {
                display: flex;
                width: 100%;
            }
            
            .nav-item {
                border-left: none;
                border-bottom: 3px solid transparent;
                flex-direction: column;
                padding: 15px 10px;
                min-width: 80px;
            }
            
            .nav-item.active {
                border-bottom-color: var(--primary-light);
                border-left: none;
            }
            
            .nav-item span {
                font-size: 0.8rem;
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .page-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        @media (max-width: 576px) {
            .header-actions {
                gap: 10px;
            }
            
            .user-profile span {
                display: none;
            }
            
            .main-content {
                padding: 20px 15px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .auth-card {
                margin: 20px;
            }
        }
        
        /* Animation enhancements */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Chart placeholder */
        .chart-placeholder {
            height: 300px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="30" viewBox="0 0 100 30"><path d="M0,30 L20,15 L40,20 L60,10 L80,25 L100,5" fill="none" stroke="%234361ee" stroke-width="2" stroke-dasharray="5,5"/></svg>') center center no-repeat;
            background-size: 90% 80%;
            opacity: 0.7;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">
                        <div class="auth-logo-icon">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        LeadConnect
                    </div>
                    <p>WhatsApp Lead Generation Platform</p>
                    
                    <div class="auth-tabs">
                        <div id="to-login" class="auth-tab active">Login</div>
                        <div id="to-register" class="auth-tab">Register</div>
                    </div>
                </div>
                
                <div class="auth-body">
                    <div id="login-form">
                        <div class="form-group">
                            <input type="email" id="login-email" class="form-control" placeholder="Email Address">
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <input type="password" id="login-password" class="form-control" placeholder="Password">
                                <span class="password-toggle" id="password-toggle">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        
                        <div style="display:flex;justify-content:space-between;align-items:center;margin: 20px 0;">
                            <div class="form-check">
                                <input type="checkbox" id="remember" class="form-check-input">
                                <label for="remember" class="form-check-label">Remember me</label>
                            </div>
                            <a href="#" style="color:var(--primary);text-decoration:none;">Forgot password?</a>
                        </div>
                        
                        <button id="login-btn" class="btn btn-primary btn-lg w-100" onclick="login()">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        
                        <div id="login-error" class="alert alert-danger hidden" style="margin-top:20px;">
                            <i class="fas fa-exclamation-circle"></i> 
                            <span id="error-msg"></span>
                        </div>
                    </div>
                    
                    <div id="register-form" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" id="reg-name" class="form-control" placeholder="Full Name">
                            </div>
                            <div class="form-group">
                                <input type="text" id="reg-phone" class="form-control" placeholder="Phone Number">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <input type="email" id="reg-email" class="form-control" placeholder="Email Address">
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <input type="password" id="reg-password" class="form-control" placeholder="Password">
                                <span class="password-toggle" id="reg-password-toggle">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="input-group">
                                <input type="password" id="reg-confirm-password" class="form-control" placeholder="Confirm Password">
                                <span class="password-toggle" id="reg-confirm-password-toggle">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <input type="text" id="reg-ref" class="form-control" placeholder="Referral Code (optional)">
                        </div>
                        
                        <button id="register-btn" class="btn btn-primary btn-lg w-100" onclick="register()">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                        <div id="register-error" class="alert alert-danger hidden" style="margin-top:20px;">
                            <i class="fas fa-exclamation-circle"></i> 
                            <span id="register-error-msg"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                <span>LeadConnect</span>
            </div>
            
            <div class="header-actions">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="user-name"></span>
                </div>
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <div class="app-container">
            <aside class="sidebar">
                <div class="sidebar-title">Main Navigation</div>
                <div class="nav-list" id="nav-list"></div>
            </aside>
            
            <main class="main-content" id="content">
                <!-- Content will be loaded here dynamically -->
            </main>
        </div>
    </div>

    <!-- Token Modal -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tokenModal')">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Enter Enrollment Token</h2>
                <p>You need a valid token to enroll in the program</p>
            </div>
            <div class="form-group">
                <input type="text" id="enrollmentToken" class="form-control" placeholder="Enter your token">
            </div>
            <button class="btn btn-primary w-100" onclick="verifyEnrollmentToken()">Verify Token</button>
            <div id="tokenMessage" class="alert hidden" style="margin-top:20px;"></div>
        </div>
    </div>

    <script>
        // Initialize Firebase with configuration from external file
        firebase.initializeApp(firebaseConfig);
        
        // Enable offline persistence with error handling
        firebase.firestore().enablePersistence()
          .catch((err) => {
            if (err.code == 'failed-precondition') {
              console.log("Persistence failed - multiple tabs open");
            } else if (err.code == 'unimplemented') {
              console.log("Persistence not available in this browser");
            }
          });
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const functions = firebase.functions();
        const logs = db.collection('logs');
        
        let currentUser = null;
        let isAdmin = false;
        let loadingStates = {};
        let userCache = {};

        // Password visibility toggle
        document.getElementById('password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('login-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        
        document.getElementById('reg-password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('reg-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        
        document.getElementById('reg-confirm-password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('reg-confirm-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Modal functions
        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // UI toggles
        document.getElementById('to-login').onclick = () => switchForms('login');
        document.getElementById('to-register').onclick = () => switchForms('register');
        
        function switchForms(mode) {
            document.getElementById('to-login').classList.toggle('active', mode === 'login');
            document.getElementById('to-register').classList.toggle('active', mode === 'register');
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', mode !== 'register');
        }

        // Enhanced activity logger with offline support
        function logEvent(uid, action, meta = {}) {
            return new Promise((resolve) => {
                const logData = {
                    uid,
                    action,
                    meta,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                logs.add(logData)
                  .then(resolve)
                  .catch(err => {
                    if (err.code === 'unavailable') {
                      const offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
                      offlineLogs.push(logData);
                      localStorage.setItem('offlineLogs', JSON.stringify(offlineLogs));
                      resolve();
                    }
                  });
            });
        }

        // Process any pending offline logs when connection is restored
        function processOfflineLogs() {
            const offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
            if (offlineLogs.length === 0) return;
            
            const batch = db.batch();
            offlineLogs.forEach(log => {
                const ref = logs.doc();
                batch.set(ref, log);
            });
            
            batch.commit()
              .then(() => {
                localStorage.removeItem('offlineLogs');
              })
              .catch(console.error);
        }

        // Set loading state for buttons
        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (isLoading) {
                loadingStates[buttonId] = button.innerHTML;
                button.innerHTML = '<div class="loading"></div> Processing...';
                button.disabled = true;
            } else {
                if (loadingStates[buttonId]) {
                    button.innerHTML = loadingStates[buttonId];
                }
                button.disabled = false;
            }
        }
        
        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.remove('hidden');
            errorElement.querySelector('span').textContent = message;
        }
        
        // Hide error message
        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // Registration with validation and proper error handling
        function register() {
            hideError('register-error');
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pwd = document.getElementById('reg-password').value;
            const confirmPwd = document.getElementById('reg-confirm-password').value;
            const ref = document.getElementById('reg-ref').value.trim();
            
            if (!name) return showError('register-error', 'Please enter your full name');
            if (!email || !validateEmail(email)) return showError('register-error', 'Please enter a valid email address');
            if (!phone) return showError('register-error', 'Please enter your phone number');
            if (pwd.length < 8) return showError('register-error', 'Password must be at least 8 characters');
            if (pwd !== confirmPwd) return showError('register-error', 'Passwords do not match');
            
            setLoading('register-btn', true);
            
            auth.createUserWithEmailAndPassword(email, pwd)
                .then(userCredential => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name,
                        email,
                        phone,
                        ref,
                        joined: firebase.firestore.FieldValue.serverTimestamp(),
                        role: 'user',
                        status: 'active',
                        balance: 0,
                        referralBalance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: false,
                        whatsappNumber: '',
                        enrollmentDate: null
                    }).then(() => userCredential.user);
                })
                .then(user => {
                    return logEvent(user.uid, 'register').then(() => user);
                })
                .then(user => {
                    // If referral code was provided, update referrer's stats
                    if (ref) {
                        return db.collection('users').where('refCode', '==', ref).limit(1).get()
                            .then(snap => {
                                if (!snap.empty) {
                                    const referrer = snap.docs[0];
                                    return db.collection('users').doc(referrer.id).update({
                                        referrals: firebase.firestore.FieldValue.increment(1),
                                        referralBalance: firebase.firestore.FieldValue.increment(10) // $10 referral bonus
                                    });
                                }
                            })
                            .then(() => user);
                    }
                    return user;
                })
                .then(user => {
                    currentUser = user;
                    userCache[user.uid] = {
                        name,
                        email,
                        phone,
                        ref,
                        role: 'user',
                        status: 'active',
                        balance: 0,
                        referralBalance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: false,
                        whatsappNumber: '',
                        enrollmentDate: null
                    };
                    isAdmin = false;
                    initApp();
                })
                .catch(err => {
                    console.error("Registration error:", err);
                    showError('register-error', `Registration failed: ${err.message}`);
                    if (auth.currentUser) {
                        auth.currentUser.delete().catch(console.error);
                    }
                })
                .finally(() => {
                    setLoading('register-btn', false);
                });
        }

        // Email validation
        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Login function with security enhancements
        function login() {
            hideError('login-error');
            const email = document.getElementById('login-email').value.trim();
            const pwd = document.getElementById('login-password').value;
            
            if (!email || !validateEmail(email)) return showError('login-error', 'Please enter a valid email address');
            if (!pwd) return showError('login-error', 'Please enter your password');
            
            setLoading('login-btn', true);
            
            // Check for admin login
            if (email === "admin@leadconnect.com") {
                // Handle admin login directly
                if (adminCredentials && pwd === adminCredentials.password) {
                    // Create admin session
                    currentUser = {
                        uid: 'admin-uid',
                        email: email,
                        displayName: "Admin User"
                    };
                    
                    // Create admin profile in cache
                    userCache['admin-uid'] = {
                        name: "Admin User",
                        email: email,
                        role: 'admin',
                        status: 'active',
                        balance: 0,
                        referralBalance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: true,
                        whatsappNumber: 'admin',
                        enrollmentDate: new Date()
                    };
                    
                    isAdmin = true;
                    
                    // Store admin session in localStorage
                    localStorage.setItem('adminSession', JSON.stringify({
                        email: email,
                        timestamp: new Date().getTime()
                    }));
                    
                    initApp();
                    setLoading('login-btn', false);
                    return;
                } else {
                    showError('login-error', 'Invalid admin credentials');
                    setLoading('login-btn', false);
                    return;
                }
            }
            
            // Regular user login
            auth.signInWithEmailAndPassword(email, pwd)
                .then(res => {
                    return db.collection('users').doc(res.user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                return { user: res.user, data: doc.data() };
                            } else {
                                // Create minimal user document
                                return db.collection('users').doc(res.user.uid).set({
                                    name: email,
                                    email: email,
                                    role: 'user',
                                    status: 'active',
                                    balance: 0,
                                    referralBalance: 0,
                                    referrals: 0,
                                    commissionRate: 0.15,
                                    twoFA: false,
                                    enrolled: false,
                                    whatsappNumber: '',
                                    enrollmentDate: null,
                                    joined: firebase.firestore.FieldValue.serverTimestamp()
                                }).then(() => ({ user: res.user, data: { role: 'user' } }));
                            }
                        });
                })
                .then(({ user, data }) => {
                    if (data.twoFA) {
                        return auth.sendSignInLinkToEmail(email, {
                            url: window.location.href,
                            handleCodeInApp: true
                        }).then(() => {
                            alert('2FA verification link sent to your email.');
                            db.collection('users').doc(user.uid).update({
                                twoFALinkSent: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            throw '2FA pending';
                        });
                    }
                    return { user, data };
                })
                .then(({ user, data }) => {
                    currentUser = user;
                    isAdmin = data.role === 'admin';
                    userCache[user.uid] = data;
                    return logEvent(user.uid, 'login');
                })
                .then(() => {
                    initApp();
                })
                .catch(err => {
                    if (typeof err !== 'string') {
                        console.error("Login error:", err);
                        showError('login-error', err.message);
                    }
                })
                .finally(() => {
                    setLoading('login-btn', false);
                });
        }

        // Check for existing admin session on page load
        function checkAdminSession() {
            const session = localStorage.getItem('adminSession');
            if (session) {
                const sessionData = JSON.parse(session);
                // Check if session is still valid (1 hour expiration)
                const now = new Date().getTime();
                if ((now - sessionData.timestamp) < 3600000) { // 1 hour
                    currentUser = {
                        uid: 'admin-uid',
                        email: sessionData.email,
                        displayName: "Admin User"
                    };
                    
                    userCache['admin-uid'] = {
                        name: "Admin User",
                        email: sessionData.email,
                        role: 'admin',
                        status: 'active',
                        balance: 0,
                        referralBalance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: true,
                        whatsappNumber: 'admin',
                        enrollmentDate: new Date()
                    };
                    
                    isAdmin = true;
                    return true;
                }
            }
            return false;
        }

        // Auth state handler with offline support
        auth.onAuthStateChanged(u => {
            // Check if we have a valid admin session first
            if (checkAdminSession()) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initApp();
                return;
            }
            
            if (u) {
                currentUser = u;
                
                // If not in cache, try to get from Firestore
                db.collection('users').doc(u.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        userCache[u.uid] = data;
                        isAdmin = data.role === 'admin';
                        initApp();
                        processOfflineLogs();
                    } else {
                        // Create minimal user data for offline use
                        const minimalData = {
                            name: u.email,
                            email: u.email,
                            role: 'user',
                            status: 'active',
                            balance: 0,
                            referralBalance: 0,
                            referrals: 0,
                            commissionRate: 0.15,
                            twoFA: false,
                            enrolled: false,
                            whatsappNumber: '',
                            enrollmentDate: null
                        };
                        userCache[u.uid] = minimalData;
                        isAdmin = false;
                        initApp();
                        
                        // Try to save to Firestore if online
                        db.collection('users').doc(u.uid).set(minimalData)
                            .catch(err => console.log("Offline - user data not saved to Firestore"));
                    }
                })
                .catch(err => {
                    console.error("Auth state error:", err);
                    // Offline - use minimal data
                    const minimalData = {
                        name: u.email,
                        email: u.email,
                        role: 'user',
                        status: 'active',
                        balance: 0,
                        referralBalance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: false,
                        whatsappNumber: '',
                        enrollmentDate: null
                    };
                    userCache[u.uid] = minimalData;
                    isAdmin = false;
                    initApp();
                });
            }
        });
        
        function logout() {
            // Clear admin session if exists
            localStorage.removeItem('adminSession');
            
            // Firebase logout for regular users
            if (currentUser && currentUser.uid !== 'admin-uid') {
                auth.signOut();
            }
            
            // Reset state
            currentUser = null;
            isAdmin = false;
            userCache = {};
            window.location.reload();
        }

        // Initialize app UI
        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Use cached user data if available
            if (currentUser && userCache[currentUser.uid]) {
                const name = userCache[currentUser.uid].name || currentUser.email;
                document.getElementById('user-name').innerText = name;
                
                // Set user avatar initials
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('user-avatar').textContent = initials;
            }
            
            buildNavigation();
            const first = isAdmin ? 'Overview' : 'Dashboard';
            setActiveTab(first);
            loadTab(first);
        }

        // Navigation setup
        const adminTabs = [
            { name: 'Overview', icon: 'fa-tachometer-alt' },
            { name: 'Tokens', icon: 'fa-key' },
            { name: 'Users', icon: 'fa-users' },
            { name: 'Enrollments', icon: 'fa-user-plus' },
            { name: 'Withdrawals', icon: 'fa-money-check-alt' },
            { name: 'Settings', icon: 'fa-cog' },
            { name: 'Content', icon: 'fa-file-alt' }
        ];
        
        const userTabs = [
            { name: 'Dashboard', icon: 'fa-tachometer-alt' },
            { name: 'Referrals', icon: 'fa-user-friends' },
            { name: 'Withdrawals', icon: 'fa-money-check-alt' },
            { name: 'Account', icon: 'fa-user-cog' }
        ];
        
        function buildNavigation() {
            const navList = document.getElementById('nav-list');
            navList.innerHTML = '';
            
            const tabs = isAdmin ? adminTabs : userTabs;
            tabs.forEach(tab => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.dataset.tab = tab.name;
                navItem.innerHTML = `
                    <i class="fas ${tab.icon}"></i>
                    <span>${tab.name}</span>
                `;
                navItem.onclick = () => { 
                    setActiveTab(tab.name); 
                    loadTab(tab.name); 
                };
                navList.appendChild(navItem);
            });
        }
        
        function setActiveTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tab);
            });
            
            // Update page title
            const tabData = [...adminTabs, ...userTabs].find(t => t.name === tab);
            if (tabData) {
                document.querySelector('.page-title-icon').innerHTML = `<i class="fas ${tabData.icon}"></i>`;
                document.querySelector('.page-title').innerHTML = `
                    <div class="page-title-icon"><i class="fas ${tabData.icon}"></i></div>
                    <div>${tab}</div>
                `;
            }
        }
        
        function loadTab(tab) {
            document.getElementById('content').innerHTML = '';
            isAdmin ? loadAdminTab(tab) : loadUserTab(tab);
        }

        // Admin Functions
        function loadAdminTab(tab) {
            switch(tab) {
                case 'Overview': return adminOverview();
                case 'Tokens': return adminTokens();
                case 'Users': return adminUsers();
                case 'Enrollments': return adminEnrollments();
                case 'Withdrawals': return adminWithdrawals();
                case 'Settings': return adminSettings();
                case 'Content': return adminContent();
            }
        }

        function adminOverview() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <div class="page-title-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div>System Overview</div>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-trend"><i class="fas fa-arrow-up"></i> 12% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="stat-earnings">$0</div>
                        <div class="stat-label">Total Earnings</div>
                        <div class="stat-trend"><i class="fas fa-arrow-up"></i> 8% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="stat-pending">$0</div>
                        <div class="stat-label">Pending Withdrawals</div>
                        <div class="stat-trend down"><i class="fas fa-arrow-down"></i> 5% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-key"></i></div>
                        <div class="stat-value" id="stat-enrollments">0</div>
                        <div class="stat-label">Active Enrollments</div>
                        <div class="stat-trend"><i class="fas fa-arrow-up"></i> 22% from last month</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-exclamation-circle"></i> Recent Activities</div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline">View All</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div id="recent-activities"></div>
                    </div>
                </div>
            `;
            
            // Live stats from Firestore
            const updateStats = () => {
                // Users count
                db.collection('users').onSnapshot(snap => {
                    document.getElementById('stat-users').textContent = snap.size;
                });
                
                // Earnings and pending withdrawals
                db.collection('transactions').onSnapshot(snap => {
                    let earnings = 0;
                    let pending = 0;
                    
                    snap.forEach(doc => {
                        const t = doc.data();
                        if (t.type === 'earn') earnings += t.amount;
                        if (t.status === 'pending') pending += t.amount;
                    });
                    
                    document.getElementById('stat-earnings').textContent = '$' + earnings.toFixed(2);
                    document.getElementById('stat-pending').textContent = '$' + pending.toFixed(2);
                });
                
                // Active enrollments count
                db.collection('users').where('enrolled', '==', true).onSnapshot(snap => {
                    document.getElementById('stat-enrollments').textContent = snap.size;
                });
                
                // Recent activities
                logs.orderBy('timestamp', 'desc').limit(10).onSnapshot(snap => {
                    let html = '<table class="table"><tr><th>User</th><th>Action</th><th>Time</th></tr>';
                    
                    if (snap.empty) {
                        html = '<tr><td colspan="3" style="text-align:center;padding:20px;">No recent activities found</td></tr>';
                    } else {
                        snap.forEach(doc => {
                            const d = doc.data();
                            html += `
                                <tr>
                                    <td>${d.uid}</td>
                                    <td>${d.action}</td>
                                    <td>${d.timestamp?.toDate().toLocaleString() || '-'}</td>
                                </tr>
                            `;
                        });
                    }
                    html += '</table>';
                    
                    document.getElementById('recent-activities').innerHTML = html;
                });
            };
            
            updateStats();
            logEvent(currentUser.uid, 'view_admin_overview');
        }

        // User Functions
        function loadUserTab(tab) {
            switch(tab) {
                case 'Dashboard': return userDashboard();
                case 'Referrals': return userReferrals();
                case 'Withdrawals': return userWithdrawals();
                case 'Account': return userAccount();
            }
        }

        function userDashboard() {
            const c = document.getElementById('content');
            
            if (currentUser && userCache[currentUser.uid] && !userCache[currentUser.uid].enrolled) {
                // Show enrollment page for non-enrolled users
                c.innerHTML = `
                    <div class="page-header">
                        <div class="page-title">
                            <div class="page-title-icon"><i class="fas fa-tachometer-alt"></i></div>
                            <div>Dashboard</div>
                        </div>
                    </div>
                    
                    <div class="enrollment-section">
                        <h2>WhatsApp Lead Generation Program</h2>
                        <p>You need to enroll in the program to access the dashboard</p>
                        <div class="enrollment-count" id="enrollment-count">0</div>
                        <p>people have already enrolled</p>
                    </div>
                    
                    <div class="cta-banner">
                        <h3>Imagine getting <span id="enrolled-count" style="font-weight:bold;">0</span> as your customers!</h3>
                        <p>Start generating leads today with our proven WhatsApp system</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fab fa-whatsapp"></i> Enroll Now</div>
                        </div>
                        <p>Enter your WhatsApp number to enroll in our lead generation program</p>
                        
                        <div class="form-group" style="margin-top:20px;">
                            <div class="input-group">
                                <input type="tel" id="whatsapp-number" class="form-control" placeholder="Your WhatsApp number with country code">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="openTokenModal()">
                            <i class="fas fa-user-plus"></i> Enroll
                        </button>
                        
                        <div id="enrollment-message" class="alert hidden" style="margin-top:20px;"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-bullhorn"></i> Announcement</div>
                        </div>
                        <div id="announcement-content"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-download"></i> Download Resource</div>
                        </div>
                        <div id="download-content"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="fas fa-video"></i> Training Video</div>
                        </div>
                        <div id="video-content"></div>
                    </div>
                `;
                
                // Load enrollment count
                db.collection('users').where('enrolled', '==', true).onSnapshot(snap => {
                    document.getElementById('enrollment-count').textContent = snap.size;
                    document.getElementById('enrolled-count').textContent = snap.size;
                });
                
                // Load announcement
                db.collection('content').doc('announcement').onSnapshot(doc => {
                    if (doc.exists) {
                        document.getElementById('announcement-content').innerHTML = doc.data().text || '<p>No announcements yet.</p>';
                    }
                });
                
                // Load video
                db.collection('content').doc('video').onSnapshot(doc => {
                    if (doc.exists && doc.data().url) {
                        const url = doc.data().url;
                        let embedHtml = '';
                        
                        if (url.includes('youtube.com') || url.includes('youtu.be')) {
                            // YouTube embed
                            const videoId = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
                            if (videoId && videoId[1]) {
                                embedHtml = `
                                    <div class="video-container">
                                        <iframe src="https://www.youtube.com/embed/${videoId[1]}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                `;
                            } else {
                                embedHtml = `<p><a href="${url}" target="_blank">Watch Video</a></p>`;
                            }
                        } else {
                            // Generic video link
                            embedHtml = `<p><a href="${url}" target="_blank">Watch Video</a></p>`;
                        }
                        
                        document.getElementById('video-content').innerHTML = embedHtml;
                    } else {
                        document.getElementById('video-content').innerHTML = '<p>No video available yet.</p>';
                    }
                });
                
                // Load downloadable file
                db.collection('content').doc('file').onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('download-content').innerHTML = `
                            <a href="${data.url}" class="btn btn-primary" target="_blank" style="display:inline-flex;align-items:center;gap:8px;">
                                <i class="fas fa-download"></i> Download ${data.name}
                            </a>
                        `;
                    } else {
                        document.getElementById('download-content').innerHTML = '<p>No file available for download yet.</p>';
                    }
                });
                
                return;
            }
            
            // Regular dashboard for enrolled users
            c.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <div class="page-title-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div>Dashboard</div>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                        <div class="stat-value" id="stat-balance">$0</div>
                        <div class="stat-label">Account Balance</div>
                        <div class="stat-trend"><i class="fas fa-arrow-up"></i> 15% from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-friends"></i></div>
                        <div class="stat-value" id="stat-referrals">0</div>
                        <div class="stat-label">Referrals</div>
                        <div class="stat-trend"><i class="fas fa-arrow-up"></i> 8% from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="stat-ref-balance">$0</div>
                        <div class="stat-label">Referral Balance</div>
                        <div class="stat-trend"><i class="fas fa-arrow-up"></i> 22% from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="stat-leads">0</div>
                        <div class="stat-label">Leads Generated</div>
                        <div class="stat-trend down"><i class="fas fa-arrow-down"></i> 5% from last week</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-chart-bar"></i> Performance Overview</div>
                        <div class="card-actions">
                            <select class="form-control" style="width:auto;">
                                <option>Last 7 Days</option>
                                <option>Last 30 Days</option>
                                <option>Last 90 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-placeholder"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-history"></i> Recent Activity</div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline">View All</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div id="user-activity"></div>
                    </div>
                </div>
            `;
            
            if (currentUser && userCache[currentUser.uid]) {
                const d = userCache[currentUser.uid];
                const bal = d.balance || 0;
                const refBal = d.referralBalance || 0;
                const refs = d.referrals || 0;
                
                document.getElementById('stat-balance').textContent = '$' + bal.toFixed(2);
                document.getElementById('stat-referrals').textContent = refs;
                document.getElementById('stat-ref-balance').textContent = '$' + refBal.toFixed(2);
            }
            
            // Load recent activity
            try {
                logs.where('uid', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get()
                    .then(snap => {
                        let html = '<table class="table"><tr><th>Action</th><th>Time</th></tr>';
                        
                        if (snap.empty) {
                            html = '<tr><td colspan="2" style="text-align:center;padding:20px;">No recent activity</td></tr>';
                        } else {
                            snap.forEach(doc => {
                                const d = doc.data();
                                html += `
                                    <tr>
                                        <td>${d.action}</td>
                                        <td>${d.timestamp.toDate().toLocaleString()}</td>
                                    </tr>
                                `;
                            });
                        }
                        html += '</table>';
                        
                        document.getElementById('user-activity').innerHTML = html;
                    });
            } catch (e) {
                document.getElementById('user-activity').innerHTML = 
                    '<div class="alert alert-primary">Offline mode - recent activity not available</div>';
            }
        }

        function openTokenModal() {
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim();
            const msgEl = document.getElementById('enrollment-message');
            
            if (!whatsappNumber) {
                msgEl.innerText = 'Please enter your WhatsApp number';
                msgEl.className = 'alert alert-danger';
                msgEl.style.display = 'block';
                return;
            }
            
            document.getElementById('tokenMessage').className = 'alert hidden';
            document.getElementById('tokenMessage').style.display = 'none';
            document.getElementById('enrollmentToken').value = '';
            openModal('tokenModal');
        }

        function verifyEnrollmentToken() {
            const token = document.getElementById('enrollmentToken').value.trim();
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim();
            const msgEl = document.getElementById('tokenMessage');
            
            if (!token) {
                msgEl.innerText = 'Please enter a token';
                msgEl.className = 'alert alert-danger';
                msgEl.style.display = 'block';
                return;
            }
            
            msgEl.innerText = 'Verifying token...';
            msgEl.className = 'alert alert-primary';
            msgEl.style.display = 'block';
            
            // Check token in Firestore
            db.collection('tokens').where('token', '==', token).where('status', '==', 'unused').limit(1).get()
                .then(snap => {
                    if (snap.empty) {
                        throw new Error('Invalid or already used token');
                    }
                    
                    const tokenDoc = snap.docs[0];
                    const tokenData = tokenDoc.data();
                    
                    // Update token status
                    return db.collection('tokens').doc(tokenDoc.id).update({
                        status: 'used',
                        usedBy: currentUser.uid,
                        usedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        // Update user enrollment status
                        return db.collection('users').doc(currentUser.uid).update({
                            enrolled: true,
                            whatsappNumber: whatsappNumber,
                            enrollmentDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                })
                .then(() => {
                    // Update local cache
                    userCache[currentUser.uid].enrolled = true;
                    userCache[currentUser.uid].whatsappNumber = whatsappNumber;
                    userCache[currentUser.uid].enrollmentDate = new Date();
                    
                    msgEl.innerText = 'Enrollment successful! Welcome to the program.';
                    msgEl.className = 'alert alert-success';
                    
                    logEvent(currentUser.uid, 'enrollment_success', { token, whatsappNumber });
                    
                    setTimeout(() => {
                        closeModal('tokenModal');
                        loadTab('Dashboard');
                    }, 2000);
                })
                .catch(err => {
                    msgEl.innerText = 'Error: ' + err.message;
                    msgEl.className = 'alert alert-danger';
                    logEvent(currentUser.uid, 'enrollment_failed', { error: err.message });
                });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                localStorage.setItem('referralCode', refCode);
            }
            
            // Initialize offline logs processing
            processOfflineLogs();
        });
    </script>
</body>
</html>
