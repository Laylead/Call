<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Camsilo â€¢ Models â€” Single File</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* ---------- THEME & LAYOUT (WhatsApp-like inspired) ---------- */
:root{
  --primary:#ff6f2d; --accent:#ff4b98; --muted:#9aa2b2; --bg:#071024; --card:#0f1724;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial;margin:0;min-height:100vh;background:linear-gradient(180deg,#071024 0%, #071a2a 100%);color:#e6eef6}
header{position:fixed;top:0;left:0;right:0;background:rgba(6,10,18,0.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.03);padding:14px 18px;z-index:40}
.nav{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;gap:12px;align-items:center}
.mark{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
.controls{display:flex;gap:10px;align-items:center}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit;cursor:pointer}

/* container */
.container{max-width:1200px;margin:88px auto 60px;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:18px}
@media(max-width:980px){ .container{grid-template-columns:1fr;padding:12px} .admin-panel{order:2} }

/* gallery */
.models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
.model-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(2,6,23,0.6);transition:transform .25s}
.model-card:hover{transform:translateY(-8px)}
.model-media{position:relative;overflow:hidden;height:360px}
.model-media img, .model-media video{width:100%;height:100%;object-fit:cover;display:block;transition:transform .35s}
.model-card:hover .model-media img{transform:scale(1.04)}
.badge{position:absolute;top:12px;right:12px;background:rgba(0,0,0,0.55);padding:6px 10px;border-radius:20px;font-size:13px;display:flex;gap:8px;align-items:center}
.model-body{padding:12px;display:flex;flex-direction:column;gap:10px}
.model-name{display:flex;align-items:center;gap:8px;font-weight:700}
.verified{color:#1da1f2;font-size:15px}
.model-stats{display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px solid rgba(255,255,255,0.03)}
.actions{display:flex;gap:8px;align-items:center}
.like-btn,.comment-btn{background:transparent;border:none;color:inherit;cursor:pointer;font-size:18px;padding:8px;border-radius:8px}
.book-btn{background:linear-gradient(45deg,var(--primary),var(--accent));padding:10px 12px;border-radius:10px;border:none;color:#fff;cursor:pointer}

/* admin panel */
.admin-panel{background:linear-gradient(180deg,#071427,#061025);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.admin-panel h3{background:linear-gradient(45deg,var(--primary),var(--accent));-webkit-background-clip:text;color:transparent;margin:6px 0}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
input,textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit;width:100%}
textarea{min-height:80px}

/* modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.72);z-index:120}
.modal.open{display:flex}
.modal .box{background:#07101a;padding:18px;border-radius:12px;max-width:720px;width:94%;color:#e6eef6}
.sexy-popup .box{background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid var(--primary);box-shadow:0 10px 30px rgba(233,30,99,0.2)}

/* small */
.small{font-size:13px;color:var(--muted)}
.top-badge{display:flex;gap:8px;align-items:center;padding:6px 10px;background:rgba(255,255,255,0.02);border-radius:999px}
.comment-list{margin-top:8px;font-size:13px;color:var(--muted)}
.kbd{background:#0b1220;padding:6px 8px;border-radius:6px;font-weight:600}

/* responsive adjustments */
@media(max-width:600px){ .model-media{height:260px} .nav .nav-links{display:none} }
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="logo">
      <div class="mark">MG</div>
      <div>
        <div style="font-weight:800">Camsilo</div>
        <div class="small">Models Â· Private shows Â· Bookings</div>
      </div>
    </div>

    <div class="controls">
      <div id="authInfo" class="small">Signing inâ€¦</div>
      <button id="openUserLogin" class="ghost">Login</button>
      <button id="openAdminLogin" class="ghost">Admin</button>
      <button id="signOutBtn" class="ghost" style="display:none">Sign Out</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- left: gallery -->
  <section>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 style="font-size:22px">Featured Models</h2>
      <div class="top-badge small" id="latestPostBadge" style="display:none"></div>
    </div>

    <div class="models-grid" id="modelsGrid"></div>

    <section id="privateSection" style="margin-top:22px;display:none">
      <h3 style="font-size:18px;margin-bottom:12px">Exclusive Members</h3>
      <div class="models-grid" id="privateGrid"></div>
    </section>
  </section>

  <!-- right: admin -->
  <aside class="admin-panel" id="adminPanel" style="display:none">
    <h3>Admin Control Panel</h3>

    <label>Upload Photo / Video</label>
    <input id="adminFile" type="file" accept="image/*,video/*">

    <label style="margin-top:8px">Model name</label>
    <input id="adminName" placeholder="Model name">

    <div class="form-row" style="margin-top:8px">
      <div>
        <label>Verified</label>
        <select id="adminVerified"><option value="true">Yes</option><option value="false" selected>No</option></select>
      </div>
      <div>
        <label>Private content</label>
        <select id="adminPrivate"><option value="false">No</option><option value="true">Yes</option></select>
      </div>
    </div>

    <label style="margin-top:8px">Likes (simulated)</label>
    <input id="adminLikes" placeholder="e.g. 1200">

    <label style="margin-top:8px">Comments (one per line)</label>
    <textarea id="adminComments" placeholder="Nice ðŸ˜"></textarea>

    <label style="margin-top:8px">Booking link</label>
    <input id="adminBooking" placeholder="https://zoom.us/..." />

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="saveModelBtn" class="book-btn" style="flex:1">Save Model</button>
      <button id="clearModelBtn" class="ghost">Clear</button>
    </div>

    <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)">

    <label>Broadcast post</label>
    <textarea id="adminPost" placeholder="Message to all users..."></textarea>
    <button id="pushPostBtn" class="book-btn" style="margin-top:8px">Push to Users</button>

    <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)">

    <label>Create user (server recommended)</label>
    <input id="newUserEmail" placeholder="user@example.com">
    <input id="newUserPassword" placeholder="initial password" style="margin-top:8px">
    <button id="createUserBtn" class="book-btn" style="margin-top:8px">Create User (server)</button>

    <div style="margin-top:12px" class="small">Use the Admin SDK on your server (not the client) to create users & set admin claims.</div>
  </aside>
</main>

<!-- subscription modal -->
<div id="subscriptionModal" class="modal sexy-popup">
  <div class="box">
    <div style="display:flex;gap:12px;align-items:center">
      <img src="https://images.unsplash.com/photo-1519699047748-de8e457a634e?auto=format&fit=crop&w=500&q=80" style="width:120px;height:120px;border-radius:10px;object-fit:cover;border:3px solid var(--primary)" />
      <div>
        <h2 style="color:var(--primary)">Unlock Exclusive Content</h2>
        <p class="small">Darling, subscribe now to like, comment and access private shows.</p>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="ghost" onclick="closeModal('subscriptionModal')">Maybe Later</button>
          <button class="book-btn" onclick="redirectToSubscribe()">Yes, Subscribe</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- renewal modal -->
<div id="renewalModal" class="modal sexy-popup">
  <div class="box" id="renewalBox">
    <div style="text-align:center">
      <img id="renewalImg" src="" style="width:180px;height:180px;border-radius:12px;object-fit:cover;border:3px solid var(--primary)" />
      <h2 style="color:var(--primary)">Renew Your Membership</h2>
      <p class="small">Your access expired â€” renew to continue.</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
        <button class="ghost" onclick="closeModal('renewalModal')">Not now</button>
        <button class="book-btn" onclick="redirectToRenew()">Renew</button>
      </div>
    </div>
  </div>
</div>

<!-- booking modal -->
<div id="bookingModal" class="modal">
  <div class="box">
    <h3>Book a Private Video Call</h3>
    <label class="small">Choose option</label>
    <select id="bookingOption"></select>
    <label class="small" style="margin-top:8px">Your email</label>
    <input id="bookingEmail" type="email" placeholder="you@example.com" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="ghost" onclick="closeModal('bookingModal')">Cancel</button>
      <button class="book-btn" onclick="confirmBooking()">Proceed</button>
    </div>
  </div>
</div>

<!-- comment modal -->
<div id="commentModal" class="modal">
  <div class="box">
    <h3>Add Comment</h3>
    <textarea id="commentText" rows="4" placeholder="Write your comment..."></textarea>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="ghost" onclick="closeModal('commentModal')">Cancel</button>
      <button class="book-btn" onclick="submitComment()">Post Comment</button>
    </div>
  </div>
</div>

<!-- admin login modal -->
<div id="adminLoginModal" class="modal">
  <div class="box">
    <h3>Admin Login</h3>
    <label class="small">Email</label>
    <input id="adminEmail" type="email" placeholder="admin@example.com">
    <label class="small" style="margin-top:8px">Password</label>
    <input id="adminPassword" type="password" placeholder="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="ghost" onclick="closeModal('adminLoginModal')">Cancel</button>
      <button class="book-btn" onclick="adminLogin()">Login</button>
    </div>
  </div>
</div>

<!-- user login modal -->
<div id="userLoginModal" class="modal">
  <div class="box">
    <h3>User Login</h3>
    <label class="small">Email</label><input id="userEmail" type="email">
    <label class="small" style="margin-top:8px">Password</label><input id="userPass" type="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="ghost" onclick="closeModal('userLoginModal')">Cancel</button>
      <button class="book-btn" onclick="userLogin()">Login</button>
    </div>
  </div>
</div>

<!-- simplified admin chat modal -->
<div id="adminChatModal" class="modal">
  <div class="box">
    <h3>Chat Management</h3>
    <div style="display:flex;gap:12px">
      <div style="flex:1"><div id="conversationsList" style="max-height:320px;overflow:auto"></div></div>
      <div style="flex:2">
        <div id="noChat" class="small">Select a conversation</div>
        <div id="chatWindow" style="display:none">
          <div id="chatMessages" style="max-height:260px;overflow:auto;margin-bottom:8px"></div>
          <input id="adminChatInput" placeholder="Type message" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="ghost" onclick="closeModal('adminChatModal')">Close</button>
            <button class="book-btn" onclick="sendAdminChat()">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<!-- load external config (YOU MUST create this file next to index.html) -->
<script src="configuration.js"></script>

<script>
/*
  Single-file app logic
  - Expects window.FIREBASE_CONFIG in configuration.js
  - Uses Firestore collections: models, users, settings, posts, bookings, chats, conversations
  - Admin accounts must have custom claim admin:true (set via Admin SDK on server)
*/
(async function(){
  if(!window.FIREBASE_CONFIG){
    document.body.innerHTML = '<div style="padding:20px;font-family:Inter">Missing configuration.js â€” create it and export window.FIREBASE_CONFIG. See comments in file.</div>';
    return;
  }

  // Initialize Firebase
  firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // DOM refs
  const modelsGrid = document.getElementById('modelsGrid');
  const privateGrid = document.getElementById('privateGrid');
  const privateSection = document.getElementById('privateSection');
  const authInfo = document.getElementById('authInfo');
  const openAdminLogin = document.getElementById('openAdminLogin');
  const openUserLogin = document.getElementById('openUserLogin');
  const signOutBtn = document.getElementById('signOutBtn');

  const adminPanel = document.getElementById('adminPanel');
  const adminFile = document.getElementById('adminFile');
  const adminName = document.getElementById('adminName');
  const adminVerified = document.getElementById('adminVerified');
  const adminPrivate = document.getElementById('adminPrivate');
  const adminLikes = document.getElementById('adminLikes');
  const adminComments = document.getElementById('adminComments');
  const adminBooking = document.getElementById('adminBooking');
  const saveModelBtn = document.getElementById('saveModelBtn');
  const clearModelBtn = document.getElementById('clearModelBtn');
  const adminPost = document.getElementById('adminPost');
  const pushPostBtn = document.getElementById('pushPostBtn');
  const createUserBtn = document.getElementById('createUserBtn');
  const newUserEmail = document.getElementById('newUserEmail');
  const newUserPassword = document.getElementById('newUserPassword');

  // modals & inputs
  const subscriptionModal = document.getElementById('subscriptionModal');
  const renewalModal = document.getElementById('renewalModal');
  const bookingModal = document.getElementById('bookingModal');
  const bookingOption = document.getElementById('bookingOption');
  const bookingEmail = document.getElementById('bookingEmail');
  const commentModal = document.getElementById('commentModal');
  const commentText = document.getElementById('commentText');
  const adminLoginModal = document.getElementById('adminLoginModal');
  const adminEmail = document.getElementById('adminEmail');
  const adminPassword = document.getElementById('adminPassword');
  const userLoginModal = document.getElementById('userLoginModal');
  const userEmailIn = document.getElementById('userEmail');
  const userPassIn = document.getElementById('userPass');

  const adminChatModal = document.getElementById('adminChatModal');
  const conversationsList = document.getElementById('conversationsList');
  const chatWindow = document.getElementById('chatWindow');
  const chatMessages = document.getElementById('chatMessages');
  const adminChatInput = document.getElementById('adminChatInput');

  const latestPostBadge = document.getElementById('latestPostBadge');

  // state
  let currentUser = null;
  let isAdmin = false;
  let modelsUnsub = null;
  let settings = {};
  let selectedModelForComment = null;
  let selectedModelForBooking = null;
  let currentConversationId = null;
  let chatUnsub = null;

  // utility
  function el(tag, props={}, ...kids){ const e=document.createElement(tag); Object.keys(props).forEach(k=>{ if(k in e) e[k]=props[k]; else e.setAttribute(k, props[k]); }); kids.forEach(k=>{ if(k==null) return; if(k instanceof Node) e.appendChild(k); else e.appendChild(document.createTextNode(k)); }); return e; }
  function openModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.add('open'); m.style.display='flex'; }
  function closeModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.remove('open'); m.style.display='none'; }
  function showToast(msg){ try{ if(window.toastr) toastr.info(msg); else alert(msg); }catch(e){ console.log(msg); } }
  window.openModal = openModal; window.closeModal = closeModal; window.redirectToSubscribe = ()=>{ window.open(settings.subscriptionLink || '#','_blank') }; window.redirectToRenew = ()=>{ window.open(settings.renewalLink || '#','_blank') };

  // admin login
  window.adminLogin = async function(){
    const email = adminEmail.value.trim(); const pass = adminPassword.value;
    if(!email||!pass) return alert('Enter credentials');
    try { await auth.signInWithEmailAndPassword(email, pass); closeModal('adminLoginModal'); } catch(e){ alert('Admin login failed: '+e.message); }
  };
  window.userLogin = async function(){ const e=userEmailIn.value.trim(), p=userPassIn.value; if(!e||!p) return alert('Enter credentials'); try { await auth.signInWithEmailAndPassword(e,p); closeModal('userLoginModal'); } catch(e){ alert('Login failed: '+e.message); } };

  // sign out to anonymous
  signOutBtn.addEventListener('click', async ()=>{ await auth.signOut(); await auth.signInAnonymously(); });

  // initial settings loader
  async function loadSettings(){
    try{
      const snap = await db.collection('settings').doc('site').get();
      if(snap.exists) settings = snap.data();
      else { settings = { subscriptionLink:'#', renewalLink:'#', renewalImage:'' }; await db.collection('settings').doc('site').set(settings); }
      if(settings.latestPost){ latestPostBadge.style.display='flex'; latestPostBadge.textContent = settings.latestPost; setTimeout(()=> latestPostBadge.style.display='none', 8000); }
      if(settings.renewalImage) document.getElementById('renewalImg').src = settings.renewalImage;
    }catch(e){ console.error('settings load', e); }
  }

  // auth state change
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ try{ await auth.signInAnonymously(); return; }catch(e){ console.error(e); return; } }
    currentUser = user;
    try{
      const tokenRes = await user.getIdTokenResult(true);
      isAdmin = !!(tokenRes && tokenRes.claims && tokenRes.claims.admin);
    }catch(e){ console.error('token', e); }
    updateUIForAuth();
    if(!isAdmin){
      const udoc = await db.collection('users').doc(user.uid).get();
      if(!udoc.exists){ const expires = firebase.firestore.Timestamp.fromDate(new Date(Date.now()+30*24*3600*1000)); await db.collection('users').doc(user.uid).set({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), expiresAt: expires, banned:false, subscribed:false }); }
      else {
        const data = udoc.data();
        if(data.banned){ showToast('Your account is banned'); }
        else if(data.expiresAt && data.expiresAt.toDate && new Date() > data.expiresAt.toDate()){ openModal('renewalModal'); }
      }
    }
    listenModels();
    loadSettings();
  });

  function updateUIForAuth(){
    if(isAdmin){
      authInfo.textContent = `Admin: ${currentUser.email || currentUser.uid.slice(0,6)}`;
      adminPanel.style.display = 'block';
      openAdminLogin.style.display = 'none';
      openUserLogin.style.display = 'none';
      signOutBtn.style.display = 'inline-block';
    } else {
      authInfo.textContent = currentUser.isAnonymous ? `Guest: anon-${currentUser.uid.slice(0,6)}` : `User: ${currentUser.email || currentUser.uid}`;
      adminPanel.style.display = 'none';
      openAdminLogin.style.display = 'inline-block';
      openUserLogin.style.display = 'inline-block';
      signOutBtn.style.display = currentUser.isAnonymous ? 'none' : 'inline-block';
    }
  }

  // Listen models
  function listenModels(){
    if(modelsUnsub) modelsUnsub();
    modelsUnsub = db.collection('models').orderBy('createdAt','desc').onSnapshot(snapshot=>{
      modelsGrid.innerHTML = ''; privateGrid.innerHTML = '';
      snapshot.forEach(doc=>{
        const m = { id: doc.id, ...doc.data() };
        renderModelCard(m);
      });
      privateSection.style.display = privateGrid.children.length ? 'block' : 'none';
    });
  }

  // Render model card
  function renderModelCard(m){
    const card = el('article',{className:'model-card'});
    const mediaNode = el('div',{className:'model-media'});
    if(m.mediaURL){
      if(m.mediaType && m.mediaType.startsWith('video/')){
        const v = el('video',{src:m.mediaURL, controls:true});
        mediaNode.appendChild(v);
      } else {
        const img = el('img',{src:m.mediaURL, alt:m.name});
        mediaNode.appendChild(img);
      }
    } else {
      const img = el('img',{src:'https://images.unsplash.com/photo-1511285605577-4d62fb50d2f7?auto=format&fit=crop&w=800&q=80', alt:m.name});
      mediaNode.appendChild(img);
    }
    mediaNode.appendChild(el('div',{className:'badge'}, m.private ? 'Premium' : 'Public'));

    const body = el('div',{className:'model-body'});
    const nameRow = el('div',{className:'model-name'}, m.name || 'Unnamed', m.verified ? el('span',{className:'verified'}, el('i',{className:'fas fa-check-circle'})) : null);

    const commentsCount = (m.comments||[]).length;
    const statsRow = el('div',{className:'model-stats'},
      el('div',{className:'actions'},
        el('button',{className:'like-btn', onclick: ()=> onLikeClicked(m)}, el('i',{className:'fas fa-heart'})),
        el('span',{className:'small'}, m.likes || 0),
        el('button',{className:'comment-btn', onclick: ()=> onCommentClicked(m), style:'margin-left:12px'}, el('i',{className:'fas fa-comment'})),
        el('span',{className:'small'}, commentsCount)
      ),
      el('div',{}, el('div',{style:'display:flex;gap:8px'}, createBookingControls(m)))
    );

    body.appendChild(nameRow);
    if(m.embedVideo) body.appendChild(el('div',{}, el('iframe',{src:m.embedVideo, width:'100%', height:'180', frameborder:'0', allowfullscreen:true})));
    body.appendChild(statsRow);
    if(m.comments && m.comments.length){
      const list = el('div',{className:'comment-list'}, ...m.comments.slice(0,3).map(c => el('div',{}, c)));
      body.appendChild(list);
    }
    if(isAdmin){
      const adminOps = el('div', {style:'display:flex;gap:8px;margin-top:8px'}, 
        el('button',{className:'ghost', onclick: ()=> boostLikes(m.id)}, 'Boost Likes'),
        el('button',{className:'ghost', onclick: ()=> editModel(m.id)}, 'Edit')
      );
      body.appendChild(adminOps);
    }

    card.appendChild(mediaNode);
    card.appendChild(body);

    if(m.private) privateGrid.appendChild(card); else modelsGrid.appendChild(card);

    // click media open
    mediaNode.addEventListener('click', ()=>{
      if(m.private && (!currentUser || currentUser.isAnonymous)){ openModal('subscriptionModal'); return; }
      if(m.mediaType && m.mediaType.startsWith('video/')){
        const v = el('video',{controls:true, autoplay:true, style:'max-width:90vw;max-height:80vh'}); v.src = m.mediaURL; showModalContent(v);
      } else {
        const img = el('img',{src:m.mediaURL, style:'max-width:90vw;max-height:80vh'});
        showModalContent(img);
      }
    });
  }

  function createBookingControls(m){
    const select = el('select',{className:'booking-select'});
    const defaultOpt = el('option',{value:''}, 'Choose');
    select.appendChild(defaultOpt);
    if(m.bookingOptions && m.bookingOptions.length){
      m.bookingOptions.forEach(o => select.appendChild(el('option',{value:o.value}, o.label)));
    } else if(m.bookingLink){
      select.appendChild(el('option',{value:m.bookingLink}, 'Standard'));
    }
    const bookBtn = el('button',{className:'book-btn', onclick: ()=> { openBookingModalFor(m.id); }}, 'Book');
    const wrapper = el('div',{}, select, bookBtn);
    // store selection element for later reading
    wrapper.selectEl = select;
    return wrapper;
  }

  function showModalContent(node){
    const wrapper = el('div',{}, node, el('div',{style:'text-align:right;margin-top:10px'}, el('button',{className:'ghost', onclick: ()=> closeModalElement(node)}, 'Close')));
    const tmpId = '__tmp_modal';
    const box = el('div',{className:'box'}); box.appendChild(wrapper);
    const modalEl = el('div',{className:'modal open', id:tmpId}); modalEl.appendChild(box);
    document.body.appendChild(modalEl);
    modalEl.addEventListener('click', (e)=> { if(e.target === modalEl){ modalEl.remove(); } });
  }
  function closeModalElement(node){ const ancestor = node.closest('.modal'); if(ancestor) ancestor.remove(); }

  // like clicked
  async function onLikeClicked(model){
    if(isAdmin){
      const n = prompt('Set likes for '+model.name, String(model.likes||0));
      if(n!=null) await db.collection('models').doc(model.id).update({ likes: parseInt(n)||0 });
      return;
    }
    // check subscription status
    const u = (await db.collection('users').doc(currentUser.uid).get()).data();
    if(!u || !u.subscribed){ openModal('subscriptionModal'); return; }
    showToast('Likes are controlled by admin. Contact support to request a like change.');
  }

  function onCommentClicked(model){
    if(isAdmin){
      const txt = prompt('Admin: add simulated comment'); if(txt) { db.collection('models').doc(model.id).update({ comments: firebase.firestore.FieldValue.arrayUnion(txt) }); }
      return;
    }
    db.collection('users').doc(currentUser.uid).get().then(snap=>{
      const u = snap.data();
      if(!u || !u.subscribed){ openModal('subscriptionModal'); return; }
      selectedModelForComment = model; commentText.value=''; openModal('commentModal');
    });
  }

  window.submitComment = async function(){
    const text = commentText.value.trim(); if(!text) return alert('Write a comment');
    const modelId = selectedModelForComment.id;
    const doc = await db.collection('models').doc(modelId).get(); const m = doc.data();
    const arr = m.comments || []; arr.unshift(text);
    await db.collection('models').doc(modelId).update({ comments: arr });
    closeModal('commentModal');
  };

  function boostLikes(id){ if(!isAdmin) return alert('Admin only'); const inc = parseInt(prompt('Boost by how many?', '100'))||0; db.collection('models').doc(id).update({ likes: firebase.firestore.FieldValue.increment(inc) }); }
  function editModel(id){ if(!isAdmin) return; const newName = prompt('New name'); if(newName!=null) db.collection('models').doc(id).update({ name:newName }); }

  // booking
  function openBookingModalFor(modelId){
    selectedModelForBooking = modelId;
    db.collection('models').doc(modelId).get().then(snap=>{
      const m = snap.data();
      bookingOption.innerHTML = '';
      if(m.bookingOptions && m.bookingOptions.length) m.bookingOptions.forEach(o=> bookingOption.appendChild(el('option',{value:o.value}, o.label)));
      else if(m.bookingLink) bookingOption.appendChild(el('option',{value:m.bookingLink}, 'Standard'));
      else bookingOption.appendChild(el('option',{value:''}, 'No booking'));
      bookingEmail.value = '';
      openModal('bookingModal');
    });
  }
  window.confirmBooking = async function(){
    const link = bookingOption.value; const email = bookingEmail.value.trim(); if(!link) return alert('Choose option'); if(!email) return alert('Enter email');
    await db.collection('bookings').add({ modelId:selectedModelForBooking, email, link, createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: currentUser.uid || null });
    window.open(link.includes('?') ? `${link}&email=${encodeURIComponent(email)}` : `${link}?email=${encodeURIComponent(email)}`, '_blank');
    closeModal('bookingModal');
  };

  // Save model (admin)
  saveModelBtn.addEventListener('click', async ()=>{
    if(!isAdmin) return alert('Admin only');
    const file = adminFile.files[0];
    const name = adminName.value.trim() || 'Unnamed';
    const verified = adminVerified.value === 'true';
    const priv = adminPrivate.value === 'true';
    const likes = parseInt(adminLikes.value||'0')||0;
    const comments = adminComments.value ? adminComments.value.split(/\n/).map(s=>s.trim()).filter(Boolean) : [];
    const bookingLink = adminBooking.value.trim();

    let mediaURL=''; let mediaType='';
    try{
      if(file){
        const path = `models/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
        const ref = storage.ref().child(path);
        await ref.put(file);
        mediaURL = await ref.getDownloadURL();
        mediaType = file.type;
      }
      await db.collection('models').add({
        name, verified, private:priv, likes, comments, bookingLink, mediaURL, mediaType, bookingOptions: bookingLink ? [{label:'Standard', value:bookingLink}] : [], createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showToast('Model saved');
      adminFile.value=''; adminName.value=''; adminLikes.value=''; adminComments.value=''; adminBooking.value='';
    }catch(e){ console.error(e); alert('Save failed: '+e.message); }
  });

  // Push post
  pushPostBtn.addEventListener('click', async ()=>{
    if(!isAdmin) return alert('Admin only');
    const txt = adminPost.value.trim(); if(!txt) return alert('Write message');
    await db.collection('posts').add({ text:txt, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('settings').doc('site').set({ latestPost: txt }, { merge:true });
    adminPost.value=''; showToast('Post pushed');
  });

  // Create user (client -> instruct server)
  createUserBtn.addEventListener('click', ()=> alert('Run admin-utils/create_user.js on your server (service account required) to securely create users & set admin claims.'));

  // subscription modal helper
  function openSubscribePopup(){ openModal('subscriptionModal'); }
  window.redirectToSubscribe = ()=> { window.open(settings.subscriptionLink || '#','_blank'); };

  // renewal check
  async function checkUserExpiry(uid){
    const snap = await db.collection('users').doc(uid).get();
    if(!snap.exists) return;
    const u = snap.data();
    if(u.banned){ alert('Your account is banned'); }
    else if(u.expiresAt && u.expiresAt.toDate && new Date() > u.expiresAt.toDate()){ openModal('renewalModal'); }
  }

  // admin chat simplified: list conversations & open chat
  async function loadConversations(){
    if(!isAdmin) return;
    conversationsList.innerHTML = '';
    const snap = await db.collection('conversations').orderBy('lastUpdated','desc').get();
    snap.forEach(doc=>{
      const c = doc.data();
      const div = el('div',{}, el('div',{}, c.displayName || ('user-'+doc.id.slice(0,6))), el('div',{className:'small'}, c.lastMessage || ''));
      div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)'; div.style.cursor='pointer';
      div.addEventListener('click', ()=> openConversation(doc.id));
      conversationsList.appendChild(div);
    });
  }
  async function openConversation(convId){
    currentConversationId = convId; chatMessages.innerHTML=''; chatWindow.style.display='block'; document.getElementById('noChat').style.display='none';
    if(chatUnsub) chatUnsub();
    chatUnsub = db.collection('chats').where('conversationId','==',convId).orderBy('timestamp').onSnapshot(snapshot=>{
      chatMessages.innerHTML=''; snapshot.forEach(d=>{
        const m = d.data();
        chatMessages.appendChild(el('div',{}, el('div',{className:'small'}, m.sender||''), el('div',{}, m.text || '')));
      }); chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }
  window.sendAdminChat = async function(){ if(!currentConversationId) return alert('Select conversation'); const t = adminChatInput.value.trim(); if(!t) return; await db.collection('chats').add({ conversationId: currentConversationId, text: t, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp() }); adminChatInput.value=''; };

  // Load settings
  await loadSettings();

  // Hook login buttons
  openAdminLogin.addEventListener('click', ()=> openModal('adminLoginModal'));
  openUserLogin.addEventListener('click', ()=> openModal('userLoginModal'));

  // small UI utilities exposed globally
  window.closeModal = closeModal;

  console.log('Single-file app initialized');
})();
</script>

</body>
</html>
