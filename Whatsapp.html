<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamLive - Adult Video Platform</title>
    
    <!-- External Configuration -->
    <script src="configuration.js"></script>
    
    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTCSDK-4.10.0.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            overflow-x: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: flex !important;
        }
        
        /* Age Verification Modal */
        .age-verification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .age-verification-content {
            background: #252525;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }
        
        .age-verification-content h2 {
            color: #f5a623;
            margin-bottom: 25px;
            font-size: 28px;
        }
        
        .age-verification-content p {
            margin-bottom: 30px;
            line-height: 1.6;
            color: #ddd;
            font-size: 18px;
        }
        
        .verification-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .verification-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .confirm-btn {
            background: #4caf50;
            color: white;
        }
        
        .confirm-btn:hover {
            background: #3d8b40;
            transform: translateY(-2px);
        }
        
        .leave-btn {
            background: #f44336;
            color: white;
        }
        
        .leave-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        /* Admin stealth mode indicator */
        .stealth-indicator {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: #4caf50;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            border: 1px solid #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        /* Authentication Screen */
        #auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #1a1a1a 100%);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .auth-container {
            background-color: rgba(30, 30, 30, 0.9);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
        }
        
        .auth-container h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #f5a623;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .form-input {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 12px 15px;
            color: white;
            font-size: 16px;
        }
        
        .auth-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .auth-btn:hover {
            background-color: #357ae8;
        }
        
        .auth-switch {
            margin-top: 15px;
            color: #aaa;
            cursor: pointer;
        }
        
        .auth-switch:hover {
            color: #fff;
            text-decoration: underline;
        }
        
        /* Main Application */
        #main-app {
            display: grid;
            grid-template-columns: 240px 1fr 320px;
            grid-template-rows: 60px 1fr;
            grid-template-areas: 
                "sidebar header header"
                "sidebar main chat";
            height: 100vh;
        }
        
        /* Header */
        .header {
            grid-area: header;
            background-color: #252525;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #333;
            justify-content: space-between;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f5a623;
        }
        
        .search-container {
            position: relative;
            margin: 0 20px;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px;
            padding-left: 40px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 20px;
            color: white;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #252525;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }
        
        .search-result-item:hover {
            background-color: #2a2a2a;
        }
        
        .search-result-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .tokens {
            background-color: #f5a623;
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background-color: #1e1e1e;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #333;
            padding: 0 10px;
        }
        
        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #aaa;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .tab-btn.active {
            color: #f5a623;
            border-bottom: 2px solid #f5a623;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .sidebar-title {
            padding: 15px 20px 10px;
            font-size: 1.2rem;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }
        
        .online-broadcaster {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .online-broadcaster:hover {
            background-color: #2a2a2a;
        }
        
        .broadcaster-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .broadcaster-info {
            flex: 1;
        }
        
        .broadcaster-name {
            font-weight: bold;
        }
        
        .broadcaster-viewers {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .private-badge {
            background-color: #f5a623;
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .home-section {
            padding: 15px;
        }
        
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #f5a623;
        }
        
        .followed-broadcasts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .broadcast-card {
            background-color: #252525;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .broadcast-card:hover {
            transform: translateY(-3px);
        }
        
        .card-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background-color: #1a1a1a;
        }
        
        .card-content {
            padding: 10px;
        }
        
        .card-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-info {
            display: flex;
            justify-content: space-between;
            color: #aaa;
            font-size: 0.8rem;
        }
        
        /* Main Content */
        .main-content {
            grid-area: main;
            background-color: #141414;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .stream-placeholder {
            text-align: center;
            color: #888;
            padding: 20px;
        }
        
        .stream-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #444;
        }
        
        .stream-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }
        
        .broadcaster-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 50px;
        }
        
        .control-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .control-btn i {
            font-size: 20px;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding: 0 20px;
        }
        
        .audio-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .audio-btn.active {
            background-color: #4caf50;
        }
        
        /* Chat Container */
        .chat-container {
            grid-area: chat;
            background-color: #1e1e1e;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
        }
        
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background-color: #2a2a2a;
            max-width: 80%;
            align-self: flex-start;
        }
        
        .message.admin {
            background-color: #4285F430;
            border-left: 3px solid #4285F4;
            align-self: flex-end;
        }
        
        .message.user {
            background-color: #f5a62330;
            border-left: 3px solid #f5a623;
        }
        
        .message-sender {
            font-weight: bold;
            color: #f5a623;
            margin-right: 5px;
        }
        
        .message-tip {
            background-color: #f5a62330;
            border-left: 3px solid #f5a623;
        }
        
        .tipper {
            color: #4caf50 !important;
        }
        
        .tip-amount {
            background-color: #4caf50;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
        }
        
        .send-tip-btn {
            background-color: #f5a623;
            color: black;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Token Purchase Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .token-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .token-packages {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .token-package {
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .token-package:hover {
            border-color: #f5a623;
        }
        
        .token-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f5a623;
        }
        
        .token-price {
            margin-top: 5px;
            color: #aaa;
        }
        
        .token-bonus {
            margin-top: 5px;
            font-size: 0.9rem;
            color: #4caf50;
        }
        
        /* Admin Dashboard */
        .admin-container {
            padding: 20px;
            overflow-y: auto;
        }
        
        .admin-section {
            background-color: #252525;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .admin-section h2 {
            margin-bottom: 15px;
            color: #f5a623;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .admin-table th, .admin-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        
        .admin-table th {
            background-color: #2a2a2a;
        }
        
        .admin-action-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .admin-action-btn.delete {
            background-color: #f44336;
        }
        
        /* Passkey Modal */
        .passkey-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }
        
        .passkey-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
        }
        
        /* Profile Modal */
        .profile-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .profile-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .stat {
            background-color: #2a2a2a;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .follow-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .follow-btn.following {
            background-color: #4caf50;
        }
        
        /* Booking Modal */
        .booking-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
        }
        
        .booking-options {
            margin: 15px 0;
        }
        
        .booking-option {
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .booking-option:hover {
            border-color: #f5a623;
        }
        
        .booking-option.selected {
            border-color: #f5a623;
            background-color: rgba(245, 166, 35, 0.1);
        }
        
        .booking-duration {
            font-weight: bold;
            color: #f5a623;
        }
        
        .booking-price {
            margin-top: 5px;
            color: #aaa;
        }
        
        /* Withdrawal Modal */
        .withdrawal-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
        }
        
        .withdrawal-form {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            color: #aaa;
        }
        
        /* Private Session Modal */
        .private-session-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
        }
        
        .session-info {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .session-link {
            display: flex;
            margin-top: 10px;
        }
        
        .link-input {
            flex: 1;
            background-color: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px 0 0 4px;
            padding: 8px 12px;
            color: white;
        }
        
        .copy-link {
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 0 12px;
            cursor: pointer;
        }
        
        /* Support Chat Modal */
        .support-chat-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .support-chat-messages {
            flex: 1;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 8px;
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .support-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background-color: #1e1e1e;
            max-width: 80%;
        }
        
        .support-message.admin {
            background-color: #4285F430;
            border-left: 3px solid #4285F4;
            align-self: flex-end;
        }
        
        .support-message.user {
            background-color: #f5a62330;
            border-left: 3px solid #f5a623;
            align-self: flex-start;
        }
        
        .fund-wallet-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .fund-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .fund-btn {
            background-color: #4caf50;
            color: white;
        }
        
        .debit-btn {
            background-color: #f44336;
            color: white;
        }
        
        .close-chat-btn {
            background-color: #4285F4;
            color: white;
        }
        
        /* Broadcaster Approval Modal */
        .approval-modal {
            background-color: #252525;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
        }
        
        .approval-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .approval-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        
        .approval-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            #main-app {
                grid-template-columns: 180px 1fr 280px;
            }
        }
        
        @media (max-width: 768px) {
            #main-app {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr 300px;
                grid-template-areas: 
                    "header"
                    "sidebar"
                    "main"
                    "chat";
            }
            
            .sidebar {
                overflow-x: auto;
                white-space: nowrap;
                padding: 10px 0;
            }
            
            .online-broadcasters {
                display: flex;
                overflow-x: auto;
            }
            
            .online-broadcaster {
                flex-direction: column;
                text-align: center;
                padding: 10px;
            }
            
            .broadcaster-avatar {
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .search-container {
                display: none;
            }
        }

        /* Stealth Chat Window */
        .stealth-chat-window {
            position: fixed;
            bottom: 60px;
            right: 15px;
            width: 300px;
            height: 300px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #4caf50;
            border-radius: 8px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        
        .stealth-chat-header {
            background: #252525;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #4caf50;
        }
        
        .stealth-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .stealth-message {
            margin-bottom: 8px;
            padding: 6px;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .stealth-chat-input-container {
            padding: 10px;
            border-top: 1px solid #333;
            display: flex;
        }
        
        .stealth-chat-input {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px;
            color: white;
            font-size: 12px;
        }
        
        .stealth-chat-send {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0 12px;
            margin-left: 5px;
            cursor: pointer;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #f5a623;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error Message */
        .error-message {
            background-color: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        
        /* Success Message */
        .success-message {
            background-color: #4caf50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Age Verification Modal -->
    <div class="age-verification-modal" id="age-verification">
        <div class="age-verification-content">
            <h2>Age Verification Required</h2>
            <p>This content is intended for adults only and contains age-restricted material. You must be at least 18 years of age (or the age of majority in your jurisdiction) to access this platform. By entering, you acknowledge that you meet the age requirement and consent to viewing adult content.</p>
            <div class="verification-buttons">
                <button class="verification-btn leave-btn" id="leave-site">Leave</button>
                <button class="verification-btn confirm-btn" id="confirm-age">I Am 18+</button>
            </div>
        </div>
    </div>

    <!-- Admin Stealth Mode Indicator -->
    <div class="stealth-indicator" id="stealth-indicator">
        Stealth Mode Active
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="hidden">
        <div class="auth-container">
            <h1>StreamLive</h1>
            <p>Watch and broadcast live adult content</p>
            
            <div class="auth-form" id="login-form">
                <input type="email" class="form-input" id="login-email" placeholder="Email">
                <input type="password" class="form-input" id="login-password" placeholder="Password">
                <button id="login-btn" class="auth-btn">
                    <i class="material-icons">login</i>
                    Sign In
                </button>
                <div class="auth-switch" id="show-signup">Don't have an account? Sign up</div>
            </div>
            
            <div class="auth-form hidden" id="signup-form">
                <input type="text" class="form-input" id="signup-name" placeholder="Display Name">
                <input type="email" class="form-input" id="signup-email" placeholder="Email">
                <input type="password" class="form-input" id="signup-password" placeholder="Password">
                <input type="password" class="form-input" id="signup-confirm" placeholder="Confirm Password">
                
                <div style="margin: 15px 0; text-align: left;">
                    <label>
                        <input type="checkbox" id="signup-broadcaster">
                        I want to be a broadcaster
                    </label>
                </div>
                
                <button id="signup-btn" class="auth-btn">
                    <i class="material-icons">person_add</i>
                    Sign Up
                </button>
                <div class="auth-switch" id="show-login">Already have an account? Sign in</div>
            </div>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="logo">StreamLive</div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <i class="material-icons search-icon">search</i>
                <input type="text" class="search-input" id="search-input" placeholder="Search broadcasters...">
                <div class="search-results" id="search-results"></div>
            </div>
            
            <div class="user-info">
                <div class="tokens" id="user-tokens">100 tokens</div>
                <button id="admin-btn" class="control-btn hidden">
                    <i class="material-icons">admin_panel_settings</i>
                </button>
                <button id="profile-btn" class="control-btn">
                    <i class="material-icons">person</i>
                </button>
                <button id="sign-out" class="control-btn">
                    <i class="material-icons">logout</i>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="broadcasters">
                    <i class="material-icons">live_tv</i>
                    Live
                </button>
                <button class="tab-btn" data-tab="home">
                    <i class="material-icons">home</i>
                    Home
                </button>
                <button class="tab-btn" data-tab="following">
                    <i class="material-icons">favorite</i>
                    Following
                </button>
            </div>
            
            <!-- Broadcasters Tab -->
            <div class="tab-content active" id="broadcasters-tab">
                <div class="sidebar-title">Online Broadcasters</div>
                <div class="online-broadcasters" id="broadcasters-list">
                    <!-- Broadcasters will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Home Tab -->
            <div class="tab-content" id="home-tab">
                <div class="home-section">
                    <div class="section-title">Followed Broadcasters</div>
                    <div class="followed-broadcasts" id="followed-broadcasts">
                        <!-- Followed broadcasts will be populated here -->
                    </div>
                    
                    <div class="section-title" style="margin-top: 20px;">Recommended</div>
                    <div class="followed-broadcasts" id="recommended-broadcasts">
                        <!-- Recommended broadcasts will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Following Tab -->
            <div class="tab-content" id="following-tab">
                <div class="home-section">
                    <div class="section-title">Broadcasters You Follow</div>
                    <div id="following-list">
                        <!-- Following list will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- My Account Section -->
            <div class="sidebar-title" style="margin-top: 20px;">My Account</div>
            <button id="start-broadcast" class="auth-btn" style="margin: 10px 20px;">
                <i class="material-icons">video_call</i>
                Start Broadcast
            </button>
            <div id="broadcaster-pending-msg" class="hidden" style="color: #f5a623; padding: 0 20px; margin-bottom: 10px;">
                Your broadcaster account is pending approval
            </div>
            <div style="padding: 0 20px;">
                <label>
                    <input type="checkbox" id="private-broadcast">
                    Make broadcast private
                </label>
            </div>
            <div class="audio-controls">
                <button class="audio-btn" id="enable-audio">Enable Audio</button>
                <button class="audio-btn" id="mute-audio" style="display: none;">Mute Audio</button>
            </div>
            <button id="manage-passkeys" class="auth-btn" style="margin: 10px 20px; background-color: #4caf50;">
                <i class="material-icons">vpn_key</i>
                Manage Passkeys
            </button>
            <button id="buy-tokens" class="auth-btn" style="margin: 0 20px; background-color: #f5a623;">
                <i class="material-icons">attach_money</i>
                Buy Tokens
            </button>
            <button id="withdraw-earnings" class="auth-btn" style="margin: 10px 20px; background-color: #4285F4;">
                <i class="material-icons">account_balance</i>
                Withdraw Earnings
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="video-container">
                <div class="stream-placeholder" id="stream-placeholder">
                    <i class="material-icons">play_circle_filled</i>
                    <p>Select a broadcaster to start watching</p>
                </div>
                <div id="video-streams"></div>
            </div>
            
            <div class="broadcaster-controls hidden" id="broadcaster-controls">
                <button class="control-btn" id="camera-toggle">
                    <i class="material-icons">videocam</i>
                </button>
                <button class="control-btn" id="mic-toggle">
                    <i class="material-icons">mic</i>
                </button>
                <button class="control-btn" id="end-broadcast">
                    <i class="material-icons">call_end</i>
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header">
                <span>Chat</span>
                <span id="viewer-count">0 viewers</span>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message">
                    <span class="message-sender">System:</span>
                    <span>Welcome to the chat! Be nice to the broadcaster.</span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
                <button class="send-tip-btn" id="send-tip">
                    <i class="material-icons">attach_money</i>
                    Tip
                </button>
            </div>
        </div>
    </div>

    <!-- Token Purchase Modal -->
    <div class="modal-backdrop hidden" id="token-modal">
        <div class="token-modal">
            <div class="modal-header">
                <h2>Buy Tokens</h2>
                <button class="close-modal" id="close-token-modal">&times;</button>
            </div>
            <div class="token-packages">
                <div class="token-package">
                    <div class="token-amount">100 tokens</div>
                    <div class="token-price">$10.00</div>
                </div>
                <div class="token-package">
                    <div class="token-amount">210 tokens</div>
                    <div class="token-price">$20.00</div>
                    <div class="token-bonus">5% bonus</div>
                </div>
                <div class="token-package">
                    <div class="token-amount">550 tokens</div>
                    <div class="token-price">$50.00</div>
                    <div class="token-bonus">10% bonus</div>
                </div>
                <div class="token-package">
                    <div class="token-amount">1200 tokens</div>
                    <div class="token-price">$100.00</div>
                    <div class="token-bonus">20% bonus</div>
                </div>
            </div>
            <button class="auth-btn" id="fund-wallet-btn" style="margin-top: 20px;">
                <i class="material-icons">payment</i>
                Fund Wallet
            </button>
        </div>
    </div>

    <!-- Passkey Modal -->
    <div class="modal-backdrop hidden" id="passkey-modal">
        <div class="passkey-modal">
            <div class="modal-header">
                <h2>Enter Passkey</h2>
                <button class="close-modal" id="close-passkey-modal">&times;</button>
            </div>
            <p>This is a private broadcast. Please enter the passkey to join.</p>
            <input type="text" class="passkey-input" id="passkey-input" placeholder="Enter passkey">
            <button class="auth-btn" id="submit-passkey">
                <i class="material-icons">vpn_key</i>
                Join Broadcast
            </button>
        </div>
    </div>

    <!-- Passkey Management Modal -->
    <div class="modal-backdrop hidden" id="passkey-management-modal">
        <div class="token-modal">
            <div class="modal-header">
                <h2>Manage Passkeys</h2>
                <button class="close-modal" id="close-passkey-management-modal">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <p>Generate passkeys for your private broadcasts. Each passkey can be used only once.</p>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <input type="number" min="1" max="100" value="1" class="form-input" id="passkey-count" style="width: 80px;">
                    <button class="auth-btn" id="generate-passkeys">
                        <i class="material-icons">add</i>
                        Generate Passkeys
                    </button>
                </div>
            </div>
            <div>
                <h3>Active Passkeys</h3>
                <div id="passkey-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- Passkeys will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div class="modal-backdrop hidden" id="admin-modal">
        <div class="token-modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Admin Dashboard</h2>
                <button class="close-modal" id="close-admin-modal">&times;</button>
            </div>
            
            <div class="admin-container">
                <div class="admin-section">
                    <h2>Withdrawal Requests</h2>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawal-requests">
                            <!-- Withdrawal requests will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="admin-section">
                    <h2>Broadcaster Approval</h2>
                    <button class="auth-btn" id="manage-broadcaster-approvals" style="margin-bottom: 15px;">
                        <i class="material-icons">how_to_reg</i>
                        Manage Broadcaster Approvals
                    </button>
                    <div id="broadcaster-approval-status">
                        <!-- Broadcaster approval status will be shown here -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <h2>User Management</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" class="form-input" id="user-search" placeholder="Search user by email">
                        <button class="auth-btn" id="search-user">Search</button>
                    </div>
                    <div id="user-management-results">
                        <!-- User management results will be shown here -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <h2>Wallet Funding Configuration</h2>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="funding-method" value="redirect" checked> Redirect to external website
                        </label>
                        <label style="display: block;">
                            <input type="radio" name="funding-method" value="chat"> Use chat system
                        </label>
                    </div>
                    <div id="redirect-config" style="margin-bottom: 15px;">
                        <label class="form-label">Redirect URL</label>
                        <input type="text" class="form-input" id="redirect-url" value="www.fundadultwallet.com/2773737373738">
                    </div>
                    <button class="auth-btn" id="save-funding-config">
                        <i class="material-icons">save</i>
                        Save Configuration
                    </button>
                </div>
                
                <div class="admin-section">
                    <h2>Support Chats</h2>
                    <div id="support-chats-list">
                        <!-- Support chats will be listed here -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <h2>Live Broadcasts</h2>
                    <div id="admin-broadcast-list">
                        <!-- Live broadcasts will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Broadcaster Approval Modal -->
    <div class="modal-backdrop hidden" id="broadcaster-approval-modal">
        <div class="approval-modal">
            <div class="modal-header">
                <h2>Broadcaster Approval Requests</h2>
                <button class="close-modal" id="close-approval-modal">&times;</button>
            </div>
            <div class="approval-list" id="approval-list">
                <!-- Approval requests will be listed here -->
            </div>
        </div>
    </div>

    <!-- Support Chat Modal -->
    <div class="modal-backdrop hidden" id="support-chat-modal">
        <div class="support-chat-modal">
            <div class="modal-header">
                <h2>Support Chat</h2>
                <button class="close-modal" id="close-support-chat-modal">&times;</button>
            </div>
            <div class="support-chat-messages" id="support-chat-messages">
                <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="support-chat-input" placeholder="Type your message...">
                <button class="send-tip-btn" id="send-support-message">
                    <i class="material-icons">send</i>
                    Send
                </button>
            </div>
            <div class="fund-wallet-actions">
                <button class="fund-action-btn fund-btn" id="fund-user-btn">
                    <i class="material-icons">add</i>
                    Fund User
                </button>
                <button class="fund-action-btn debit-btn" id="debit-user-btn">
                    <i class="material-icons">remove</i>
                    Debit User
                </button>
                <button class="fund-action-btn close-chat-btn" id="close-chat-btn">
                    <i class="material-icons">check</i>
                    Mark as Done
                </button>
            </div>
            <div id="fund-actions" class="hidden" style="margin-top: 15px;">
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-input" id="fund-amount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <input type="text" class="form-input" id="fund-reason" placeholder="Enter reason">
                </div>
                <button class="auth-btn" id="confirm-fund-action">
                    <i class="material-icons">check_circle</i>
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Configuration Script -->
    <script id="configuration.js">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlh428ba5aSFt6x2pPkVjeEk5D6AbIU7Y",
            authDomain: "kheemz-fb9b6.firebaseapp.com",
            projectId: "kheemz-fb9b6",
            storageBucket: "kheemz-fb9b6.firebasestorage.app",
            messagingSenderId: "593310501630",
            appId: "1:593310501630:web:c241a05e0d7c4a810173af",
            measurementId: "G-Q50WK6G76P"
        };

        // Agora Configuration
        const agoraConfig = {
            appId: "974f4c7b124940a1a6ee5e526175118d",
            token: null // Tokens should be generated on your server for production
        };
    </script>

    <!-- Agora Script -->
    <script id="agora.js">
        // Agora-related functionality
        let agoraClient = null;
        let localStream = null;
        let remoteStreams = [];
        let rtmClient = null;
        let channel = null;

        // Initialize Agora RTC
        function initializeAgoraRTC() {
            if (!agoraConfig.appId) {
                console.error("Agora App ID is not configured");
                return;
            }

            try {
                agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                console.log("Agora RTC client initialized");
            } catch (error) {
                console.error("Failed to initialize Agora RTC client:", error);
            }
        }

        // Initialize Agora RTM
        function initializeAgoraRTM() {
            if (!agoraConfig.appId) {
                console.error("Agora App ID is not configured");
                return;
            }

            try {
                rtmClient = AgoraRTM.createInstance(agoraConfig.appId);
                console.log("Agora RTM client initialized");
            } catch (error) {
                console.error("Failed to initialize Agora RTM client:", error);
            }
        }

        // Join a channel
        async function joinChannel(channelName, token = null, uid = null) {
            if (!agoraClient) {
                console.error("Agora client is not initialized");
                return;
            }

            try {
                await agoraClient.join(agoraConfig.appId, channelName, token || null, uid || null);
                console.log("Joined channel successfully:", channelName);
                
                // Create and publish local stream
                localStream = AgoraRTC.createStream({
                    streamID: uid || agoraClient.uid,
                    audio: true,
                    video: true,
                    screen: false
                });
                
                await localStream.init();
                await agoraClient.publish(localStream);
                console.log("Local stream published");
                
                return true;
            } catch (error) {
                console.error("Failed to join channel:", error);
                return false;
            }
        }

        // Leave channel
        async function leaveChannel() {
            if (localStream) {
                localStream.close();
                localStream = null;
            }
            
            if (agoraClient) {
                await agoraClient.leave();
                console.log("Left channel");
            }
            
            if (rtmClient) {
                await rtmClient.logout();
                console.log("Logged out from RTM");
            }
        }

        // Subscribe to remote streams
        function setupRemoteStreamHandlers() {
            if (!agoraClient) return;

            agoraClient.on("stream-added", (evt) => {
                const remoteStream = evt.stream;
                console.log("New stream added:", remoteStream.getId());
                agoraClient.subscribe(remoteStream, (error) => {
                    if (error) {
                        console.error("Subscribe failed:", error);
                    }
                });
            });

            agoraClient.on("stream-subscribed", (evt) => {
                const remoteStream = evt.stream;
                console.log("Subscribed to remote stream:", remoteStream.getId());
                remoteStreams.push(remoteStream);
                // Add remote stream to video container
                addRemoteVideoStream(remoteStream);
            });

            agoraClient.on("stream-removed", (evt) => {
                const remoteStream = evt.stream;
                console.log("Stream removed:", remoteStream.getId());
                removeRemoteVideoStream(remoteStream);
            });
        }

        // Add remote video stream to UI
        function addRemoteVideoStream(remoteStream) {
            const videoContainer = document.getElementById('video-streams');
            if (!videoContainer) return;

            const streamId = remoteStream.getId();
            let videoElement = document.getElementById(`remote-video-${streamId}`);
            
            if (!videoElement) {
                videoElement = document.createElement('div');
                videoElement.id = `remote-video-${streamId}`;
                videoElement.className = 'stream-video';
                videoContainer.appendChild(videoElement);
            }
            
            remoteStream.play(`remote-video-${streamId}`);
        }

        // Remove remote video stream from UI
        function removeRemoteVideoStream(remoteStream) {
            const streamId = remoteStream.getId();
            const videoElement = document.getElementById(`remote-video-${streamId}`);
            if (videoElement) {
                videoElement.remove();
            }
            
            // Remove from remoteStreams array
            remoteStreams = remoteStreams.filter(stream => stream.getId() !== streamId);
        }

        // Initialize Agora services
        function initializeAgora() {
            initializeAgoraRTC();
            initializeAgoraRTM();
            setupRemoteStreamHandlers();
            console.log("Agora services initialized");
        }

        // Export functions for use in main application
        window.agoraService = {
            initializeAgora,
            joinChannel,
            leaveChannel,
            addRemoteVideoStream,
            removeRemoteVideoStream
        };
    </script>

    <!-- Main Application Script -->
    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const signOutBtn = document.getElementById('sign-out');
        const userTokensEl = document.getElementById('user-tokens');
        const broadcastersList = document.getElementById('broadcasters-list');
        const streamPlaceholder = document.getElementById('stream-placeholder');
        const videoStreams = document.getElementById('video-streams');
        const broadcasterControls = document.getElementById('broadcaster-controls');
        const cameraToggle = document.getElementById('camera-toggle');
        const micToggle = document.getElementById('mic-toggle');
        const endBroadcast = document.getElementById('end-broadcast');
        const startBroadcastBtn = document.getElementById('start-broadcast');
        const privateBroadcastCheckbox = document.getElementById('private-broadcast');
        const managePasskeysBtn = document.getElementById('manage-passkeys');
        const buyTokensBtn = document.getElementById('buy-tokens');
        const tokenModal = document.getElementById('token-modal');
        const closeTokenModal = document.getElementById('close-token-modal');
        const passkeyModal = document.getElementById('passkey-modal');
        const closePasskeyModal = document.getElementById('close-passkey-modal');
        const passkeyInput = document.getElementById('passkey-input');
        const submitPasskey = document.getElementById('submit-passkey');
        const passkeyManagementModal = document.getElementById('passkey-management-modal');
        const closePasskeyManagementModal = document.getElementById('close-passkey-management-modal');
        const passkeyCount = document.getElementById('passkey-count');
        const generatePasskeysBtn = document.getElementById('generate-passkeys');
        const passkeyList = document.getElementById('passkey-list');
        const adminBtn = document.getElementById('admin-btn');
        const adminModal = document.getElementById('admin-modal');
        const closeAdminModal = document.getElementById('close-admin-modal');
        const withdrawalRequests = document.getElementById('withdrawal-requests');
        const userSearch = document.getElementById('user-search');
        const searchUserBtn = document.getElementById('search-user');
        const userManagementResults = document.getElementById('user-management-results');
        const adminBroadcastList = document.getElementById('admin-broadcast-list');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendTipBtn = document.getElementById('send-tip');
        const viewerCountEl = document.getElementById('viewer-count');
        const broadcasterPendingMsg = document.getElementById('broadcaster-pending-msg');
        const signupBroadcasterCheckbox = document.getElementById('signup-broadcaster');
        const manageBroadcasterApprovalsBtn = document.getElementById('manage-broadcaster-approvals');
        const broadcasterApprovalModal = document.getElementById('broadcaster-approval-modal');
        const closeApprovalModal = document.getElementById('close-approval-modal');
        const approvalList = document.getElementById('approval-list');
        const fundWalletBtn = document.getElementById('fund-wallet-btn');
        const supportChatModal = document.getElementById('support-chat-modal');
        const closeSupportChatModal = document.getElementById('close-support-chat-modal');
        const supportChatMessages = document.getElementById('support-chat-messages');
        const supportChatInput = document.getElementById('support-chat-input');
        const sendSupportMessageBtn = document.getElementById('send-support-message');
        const fundUserBtn = document.getElementById('fund-user-btn');
        const debitUserBtn = document.getElementById('debit-user-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const fundActions = document.getElementById('fund-actions');
        const fundAmount = document.getElementById('fund-amount');
        const fundReason = document.getElementById('fund-reason');
        const confirmFundAction = document.getElementById('confirm-fund-action');
        const supportChatsList = document.getElementById('support-chats-list');
        const fundingMethodRadios = document.querySelectorAll('input[name="funding-method"]');
        const redirectUrlInput = document.getElementById('redirect-url');
        const redirectConfig = document.getElementById('redirect-config');
        const saveFundingConfigBtn = document.getElementById('save-funding-config');
        
        // New element references for added features
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const profileBtn = document.getElementById('profile-btn');
        const enableAudioBtn = document.getElementById('enable-audio');
        const muteAudioBtn = document.getElementById('mute-audio');
        const withdrawEarningsBtn = document.getElementById('withdraw-earnings');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const followedBroadcasts = document.getElementById('followed-broadcasts');
        const recommendedBroadcasts = document.getElementById('recommended-broadcasts');
        const followingList = document.getElementById('following-list');

        // Age verification elements
        const ageVerificationModal = document.getElementById('age-verification');
        const confirmAgeBtn = document.getElementById('confirm-age');
        const leaveSiteBtn = document.getElementById('leave-site');
        const stealthIndicator = document.getElementById('stealth-indicator');

        // Application state
        let currentUser = null;
        let currentBroadcastId = null;
        let isBroadcasting = false;
        let isAdmin = false;
        let activePasskeys = [];
        let followedBroadcasters = [];
        let viewerTipHistory = {};
        let audioEnabled = false;
        let fundingMethod = 'redirect';
        let currentSupportChat = null;
        let currentActionType = 'fund'; // 'fund' or 'debit'
        let isStealthMode = false;
        let stealthChatWindow = null;
        let currentProfileUserId = null;
        let selectedBookingOption = null;

        // Initialize the application
        function init() {
            // Check if age is verified first
            const ageVerified = getCookie('ageVerified');
            if (!ageVerified) {
                showAgeVerification();
            } else {
                initApp();
            }
        }
        
        function showAgeVerification() {
            ageVerificationModal.style.display = 'flex';
            
            confirmAgeBtn.addEventListener('click', () => {
                setCookie('ageVerified', 'true', 30); // Remember for 30 days
                ageVerificationModal.style.display = 'none';
                initApp();
            });
            
            leaveSiteBtn.addEventListener('click', () => {
                window.location.href = 'https://www.google.com';
            });
        }
        
        function initApp() {
            // Set up authentication listeners
            auth.onAuthStateChanged(handleAuthStateChange);
            
            // Initialize Agora
            if (window.agoraService) {
                window.agoraService.initializeAgora();
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Load broadcasters
            loadBroadcasters();
            
            // Set up real-time listener for broadcasts
            db.collection('broadcasts').where('isLive', '==', true)
                .onSnapshot(snapshot => {
                    loadBroadcasters();
                    if (isAdmin) {
                        loadAdminBroadcasts();
                    }
                });
                
            // Load funding configuration
            loadFundingConfig();
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Authentication
            showSignup.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            });
            
            showLogin.addEventListener('click', () => {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            
            loginBtn.addEventListener('click', signInWithEmail);
            signupBtn.addEventListener('click', signUpWithEmail);
            signOutBtn.addEventListener('click', signOut);
            
            // Broadcasting
            startBroadcastBtn.addEventListener('click', startBroadcast);
            cameraToggle.addEventListener('click', toggleCamera);
            micToggle.addEventListener('click', toggleMic);
            endBroadcast.addEventListener('click', endBroadcastHandler);
            
            // Modals
            buyTokensBtn.addEventListener('click', () => tokenModal.classList.add('visible'));
            closeTokenModal.addEventListener('click', () => tokenModal.classList.remove('visible'));
            managePasskeysBtn.addEventListener('click', () => passkeyManagementModal.classList.add('visible'));
            closePasskeyManagementModal.addEventListener('click', () => passkeyManagementModal.classList.remove('visible'));
            generatePasskeysBtn.addEventListener('click', generatePasskeys);
            submitPasskey.addEventListener('click', validatePasskey);
            closePasskeyModal.addEventListener('click', () => passkeyModal.classList.remove('visible'));
            adminBtn.addEventListener('click', () => adminModal.classList.add('visible'));
            closeAdminModal.addEventListener('click', () => adminModal.classList.remove('visible'));
            
            // Search and user management
            searchUserBtn.addEventListener('click', searchUser);
            searchInput.addEventListener('input', handleSearch);
            
            // Chat
            sendTipBtn.addEventListener('click', sendTip);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Audio controls
            enableAudioBtn.addEventListener('click', enableAudio);
            muteAudioBtn.addEventListener('click', muteAudio);
            
            // Withdrawal
            withdrawEarningsBtn.addEventListener('click', showWithdrawalModal);
            
            // Tab navigation
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
            
            // Profile
            profileBtn.addEventListener('click', () => showUserProfile());
            
            // Broadcaster approval system
            manageBroadcasterApprovalsBtn.addEventListener('click', () => {
                broadcasterApprovalModal.classList.add('visible');
                loadBroadcasterApprovals();
            });
            
            closeApprovalModal.addEventListener('click', () => {
                broadcasterApprovalModal.classList.remove('visible');
            });
            
            // Wallet funding system
            fundWalletBtn.addEventListener('click', handleWalletFunding);
            
            // Support chat system
            closeSupportChatModal.addEventListener('click', () => {
                supportChatModal.classList.remove('visible');
            });
            
            sendSupportMessageBtn.addEventListener('click', sendSupportMessage);
            
            supportChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendSupportMessage();
                }
            });
            
            fundUserBtn.addEventListener('click', () => {
                currentActionType = 'fund';
                fundActions.classList.remove('hidden');
            });
            
            debitUserBtn.addEventListener('click', () => {
                currentActionType = 'debit';
                fundActions.classList.remove('hidden');
            });
            
            confirmFundAction.addEventListener('click', processFundAction);
            
            closeChatBtn.addEventListener('click', closeSupportChat);
            
            // Funding configuration
            fundingMethodRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    fundingMethod = e.target.value;
                    if (fundingMethod === 'redirect') {
                        redirectConfig.style.display = 'block';
                    } else {
                        redirectConfig.style.display = 'none';
                    }
                });
            });
            
            saveFundingConfigBtn.addEventListener('click', saveFundingConfig);
        }

        // Cookie functions for age verification
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Authentication handlers
        function handleAuthStateChange(user) {
            if (user) {
                // User is signed in
                currentUser = user;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // Load user data
                loadUserData(user.uid);
                
                // Check if user is admin
                checkIfAdmin(user.uid);
                
                // Load followed broadcasters
                loadFollowedBroadcasters(user.uid);
            } else {
                // User is signed out
                currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        }

        function signInWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then((result) => {
                    console.log('Signed in as:', result.user.email);
                })
                .catch((error) => {
                    console.error('Authentication error:', error);
                    alert('Error signing in: ' + error.message);
                });
        }

        function signUpWithEmail() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const wantsToBeBroadcaster = signupBroadcasterCheckbox.checked;
            
            if (!name || !email || !password || !confirm) {
                alert('Please fill all fields');
                return;
            }
            
            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }
            
            // Generate search keywords for the user
            const keywords = [];
            for (let i = 1; i <= name.length; i++) {
                keywords.push(name.substring(0, i).toLowerCase());
            }
            keywords.push(email.toLowerCase());
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((result) => {
                    // Save user to Firestore
                    return db.collection('users').doc(result.user.uid).set({
                        uid: result.user.uid,
                        displayName: name,
                        email: email,
                        photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
                        tokens: 100,
                        isBroadcaster: wantsToBeBroadcaster,
                        broadcasterApproved: false, // Admin needs to approve
                        isAdmin: false,
                        keywords: keywords,
                        followerCount: 0,
                        totalEarnings: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    console.log('User created successfully');
                })
                .catch((error) => {
                    console.error('Authentication error:', error);
                    alert('Error creating account: ' + error.message);
                });
        }

        function signOut() {
            if (isBroadcasting) {
                endBroadcastHandler();
            }
            
            if (isStealthMode) {
                exitStealthMode(null);
            }
            
            if (window.agoraService) {
                window.agoraService.leaveChannel();
            }
            
            auth.signOut().then(() => {
                console.log('User signed out');
            });
        }

        // User data management
        function loadUserData(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    userTokensEl.textContent = `${userData.tokens} tokens`;
                    
                    // Show admin button if user is admin
                    if (userData.isAdmin) {
                        adminBtn.classList.remove('hidden');
                        isAdmin = true;
                        loadAdminData();
                    } else {
                        adminBtn.classList.add('hidden');
                        isAdmin = false;
                    }
                    
                    // Handle broadcaster approval status
                    if (userData.isBroadcaster) {
                        if (userData.broadcasterApproved) {
                            startBroadcastBtn.disabled = false;
                            startBroadcastBtn.textContent = 'Start Broadcast';
                            broadcasterPendingMsg.classList.add('hidden');
                        } else {
                            startBroadcastBtn.disabled = true;
                            startBroadcastBtn.textContent = 'Pending Approval';
                            broadcasterPendingMsg.classList.remove('hidden');
                        }
                    }
                }
            });
        }

        function checkIfAdmin(uid) {
            db.collection('users').doc(uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().isAdmin) {
                        isAdmin = true;
                        adminBtn.classList.remove('hidden');
                        loadAdminData();
                    }
                });
        }

        // Search functionality
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            db.collection('users')
                .where('keywords', 'array-contains', query.toLowerCase())
                .limit(10)
                .get()
                .then(snapshot => {
                    searchResults.innerHTML = '';
                    
                    if (snapshot.empty) {
                        searchResults.innerHTML = '<div class="search-result-item">No broadcasters found</div>';
                        searchResults.style.display = 'block';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        div.innerHTML = `
                            <img src="${user.photoURL}" class="search-result-avatar" alt="Avatar">
                            <div>${user.displayName}</div>
                        `;
                        div.addEventListener('click', () => {
                            showUserProfile(user.uid);
                            searchResults.style.display = 'none';
                            searchInput.value = '';
                        });
                        searchResults.appendChild(div);
                    });
                    
                    searchResults.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                });
        }

        // Show user profile
        function showUserProfile(userId = null) {
            const profileId = userId || currentUser.uid;
            currentProfileUserId = profileId;
            
            db.collection('users').doc(profileId).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    
                    // Create profile modal if it doesn't exist
                    if (!document.getElementById('profile-modal')) {
                        createProfileModal();
                    }
                    
                    const profileModal = document.getElementById('profile-modal');
                    const profileAvatar = document.getElementById('profile-avatar');
                    const profileName = document.getElementById('profile-name');
                    const profileFollowers = document.getElementById('profile-followers');
                    const profileTips = document.getElementById('profile-tips');
                    const followBtn = document.getElementById('follow-btn');
                    const bookSessionBtn = document.getElementById('book-session-btn');
                    const profileBio = document.getElementById('profile-bio');
                    
                    profileAvatar.src = userData.photoURL;
                    profileName.textContent = userData.displayName;
                    profileFollowers.textContent = `${userData.followerCount || 0} followers`;
                    profileTips.textContent = `${userData.totalEarnings || 0} tokens received`;
                    
                    // Check if current user is following this profile
                    if (currentUser && profileId !== currentUser.uid) {
                        db.collection('users').doc(currentUser.uid)
                            .collection('following').doc(profileId).get()
                            .then(followDoc => {
                                if (followDoc.exists) {
                                    followBtn.innerHTML = '<i class="material-icons">check</i> Following';
                                    followBtn.classList.add('following');
                                } else {
                                    followBtn.innerHTML = '<i class="material-icons">favorite</i> Follow';
                                    followBtn.classList.remove('following');
                                }
                                followBtn.style.display = 'flex';
                            });
                    } else {
                        followBtn.style.display = 'none';
                    }
                    
                    // Show/hide book session button
                    if (currentUser && profileId !== currentUser.uid && userData.isBroadcaster) {
                        bookSessionBtn.style.display = 'flex';
                    } else {
                        bookSessionBtn.style.display = 'none';
                    }
                    
                    // Load bio
                    profileBio.innerHTML = userData.bio || '<p>No bio available</p>';
                    
                    profileModal.classList.add('visible');
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                });
        }

        function createProfileModal() {
            const profileModal = document.createElement('div');
            profileModal.id = 'profile-modal';
            profileModal.className = 'modal-backdrop hidden';
            profileModal.innerHTML = `
                <div class="profile-modal">
                    <div class="modal-header">
                        <h2>Profile</h2>
                        <button class="close-modal" id="close-profile-modal">&times;</button>
                    </div>
                    <div class="profile-header">
                        <img src="" class="profile-avatar" id="profile-avatar" alt="Avatar">
                        <div class="profile-info">
                            <div class="profile-name" id="profile-name"></div>
                            <div class="profile-stats">
                                <div class="stat" id="profile-followers"></div>
                                <div class="stat" id="profile-tips"></div>
                            </div>
                            <div class="profile-actions">
                                <button class="follow-btn" id="follow-btn"></button>
                                <button class="auth-btn" id="book-session-btn" style="display: none;">
                                    <i class="material-icons">event</i>
                                    Book Private Session
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="profile-bio" id="profile-bio"></div>
                </div>
            `;
            document.body.appendChild(profileModal);
            
            document.getElementById('close-profile-modal').addEventListener('click', () => {
                profileModal.classList.remove('visible');
            });
            
            document.getElementById('follow-btn').addEventListener('click', toggleFollow);
            document.getElementById('book-session-btn').addEventListener('click', showBookingModal);
        }

        // Toggle follow/unfollow
        function toggleFollow() {
            if (!currentUser) return;
            
            const followBtn = document.getElementById('follow-btn');
            const isFollowing = followBtn.classList.contains('following');
            
            if (isFollowing) {
                // Unfollow
                db.collection('users').doc(currentUser.uid)
                    .collection('following').doc(currentProfileUserId).delete()
                    .then(() => {
                        // Decrement follower count
                        db.collection('users').doc(currentProfileUserId).update({
                            followerCount: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        followBtn.innerHTML = '<i class="material-icons">favorite</i> Follow';
                        followBtn.classList.remove('following');
                    });
            } else {
                // Follow
                db.collection('users').doc(currentUser.uid)
                    .collection('following').doc(currentProfileUserId).set({
                        followedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        // Increment follower count
                        db.collection('users').doc(currentProfileUserId).update({
                            followerCount: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        followBtn.innerHTML = '<i class="material-icons">check</i> Following';
                        followBtn.classList.add('following');
                    });
            }
        }

        // Show booking modal
        function showBookingModal() {
            // Create booking modal if it doesn't exist
            if (!document.getElementById('booking-modal')) {
                createBookingModal();
            }
            
            db.collection('users').doc(currentProfileUserId).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    document.getElementById('booking-model-name').textContent = userData.displayName;
                    document.getElementById('booking-modal').classList.add('visible');
                });
        }

        function createBookingModal() {
            const bookingModal = document.createElement('div');
            bookingModal.id = 'booking-modal';
            bookingModal.className = 'modal-backdrop hidden';
            bookingModal.innerHTML = `
                <div class="booking-modal">
                    <div class="modal-header">
                        <h2>Book Private Session</h2>
                        <button class="close-modal" id="close-booking-modal">&times;</button>
                    </div>
                    <p>Book a private session with <span id="booking-model-name"></span></p>
                    <div class="booking-options">
                        <div class="booking-option" data-duration="15" data-price="50">
                            <div class="booking-duration">15 minutes</div>
                            <div class="booking-price">50 tokens</div>
                        </div>
                        <div class="booking-option" data-duration="30" data-price="90">
                            <div class="booking-duration">30 minutes</div>
                            <div class="booking-price">90 tokens</div>
                        </div>
                        <div class="booking-option" data-duration="60" data-price="150">
                            <div class="booking-duration">60 minutes</div>
                            <div class="booking-price">150 tokens</div>
                        </div>
                    </div>
                    <button class="auth-btn" id="confirm-booking">
                        <i class="material-icons">event_available</i>
                        Confirm Booking
                    </button>
                </div>
            `;
            document.body.appendChild(bookingModal);
            
            document.getElementById('close-booking-modal').addEventListener('click', () => {
                bookingModal.classList.remove('visible');
            });
            
            // Booking options selection
            bookingModal.querySelectorAll('.booking-option').forEach(option => {
                option.addEventListener('click', () => {
                    bookingModal.querySelectorAll('.booking-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedBookingOption = {
                        duration: option.getAttribute('data-duration'),
                        price: option.getAttribute('data-price')
                    };
                });
            });
            
            document.getElementById('confirm-booking').addEventListener('click', confirmBookingHandler);
        }

        // Confirm booking
        function confirmBookingHandler() {
            if (!selectedBookingOption || !currentUser) return;
            
            const price = parseInt(selectedBookingOption.price);
            const duration = parseInt(selectedBookingOption.duration);
            
            // Check if user has enough tokens
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    if (userData.tokens < price) {
                        alert('You do not have enough tokens to book this session');
                        return;
                    }
                    
                    // Deduct tokens from viewer
                    db.collection('users').doc(currentUser.uid).update({
                        tokens: firebase.firestore.FieldValue.increment(-price)
                    });
                    
                    // Add 50% to model's earnings
                    const modelEarnings = price * 0.5;
                    db.collection('users').doc(currentProfileUserId).update({
                        tokens: firebase.firestore.FieldValue.increment(modelEarnings),
                        totalEarnings: firebase.firestore.FieldValue.increment(modelEarnings)
                    });
                    
                    // Create booking record
                    const bookingId = db.collection('bookings').doc().id;
                    const privateSessionLink = `${window.location.origin}/private-session/${bookingId}`;
                    
                    db.collection('bookings').doc(bookingId).set({
                        bookingId: bookingId,
                        modelId: currentProfileUserId,
                        viewerId: currentUser.uid,
                        duration: duration,
                        price: price,
                        sessionLink: privateSessionLink,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    });
                    
                    // Show private session modal with link
                    showPrivateSessionModal(bookingId);
                });
        }

        function showPrivateSessionModal(bookingId) {
            // Create private session modal if it doesn't exist
            if (!document.getElementById('private-session-modal')) {
                createPrivateSessionModal();
            }
            
            const privateSessionModal = document.getElementById('private-session-modal');
            const sessionModelName = document.getElementById('session-model-name');
            const sessionDuration = document.getElementById('session-duration');
            const sessionLinkInput = document.getElementById('session-link-input');
            
            db.collection('users').doc(currentProfileUserId).get()
                .then(userDoc => {
                    if (!userDoc.exists) return;
                    
                    const userData = userDoc.data();
                    sessionModelName.textContent = userData.displayName;
                });
            
            sessionDuration.textContent = selectedBookingOption.duration;
            sessionLinkInput.value = `${window.location.origin}/private-session/${bookingId}`;
            
            document.getElementById('booking-modal').classList.remove('visible');
            privateSessionModal.classList.add('visible');
        }

        function createPrivateSessionModal() {
            const privateSessionModal = document.createElement('div');
            privateSessionModal.id = 'private-session-modal';
            privateSessionModal.className = 'modal-backdrop hidden';
            privateSessionModal.innerHTML = `
                <div class="private-session-modal">
                    <div class="modal-header">
                        <h2>Private Session Booked</h2>
                        <button class="close-modal" id="close-private-session-modal">&times;</button>
                    </div>
                    <p>Your private session with <span id="session-model-name"></span> for <span id="session-duration"></span> minutes has been booked!</p>
                    <div class="session-info">
                        <p>Share this link with the model to start your private session:</p>
                        <div class="session-link">
                            <input type="text" class="link-input" id="session-link-input" readonly>
                            <button class="copy-link" id="copy-session-link">
                                <i class="material-icons">content_copy</i>
                            </button>
                        </div>
                    </div>
                    <button class="auth-btn" id="join-private-session">
                        <i class="material-icons">video_call</i>
                        Join Private Session
                    </button>
                </div>
            `;
            document.body.appendChild(privateSessionModal);
            
            document.getElementById('close-private-session-modal').addEventListener('click', () => {
                privateSessionModal.classList.remove('visible');
            });
            
            document.getElementById('copy-session-link').addEventListener('click', copySessionLinkToClipboard);
            document.getElementById('join-private-session').addEventListener('click', joinPrivateSessionHandler);
        }

        // Show withdrawal modal
        function showWithdrawalModal() {
            // Create withdrawal modal if it doesn't exist
            if (!document.getElementById('withdrawal-modal')) {
                createWithdrawalModal();
            }
            
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    document.getElementById('available-balance').textContent = userData.tokens || 0;
                    document.getElementById('withdrawal-amount').max = userData.tokens || 0;
                    document.getElementById('withdrawal-modal').classList.add('visible');
                });
        }

        function createWithdrawalModal() {
            const withdrawalModal = document.createElement('div');
            withdrawalModal.id = 'withdrawal-modal';
            withdrawalModal.className = 'modal-backdrop hidden';
            withdrawalModal.innerHTML = `
                <div class="withdrawal-modal">
                    <div class="modal-header">
                        <h2>Withdraw Earnings</h2>
                        <button class="close-modal" id="close-withdrawal-modal">&times;</button>
                    </div>
                    <p>Available balance: <span id="available-balance"></span> tokens</p>
                    <div class="withdrawal-form">
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select class="form-input" id="payment-method">
                                <option value="bank">Bank Transfer</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Cryptocurrency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Details</label>
                            <input type="text" class="form-input" id="account-details" placeholder="Account number, PayPal email, or crypto address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount to Withdraw (Min: 100 tokens)</label>
                            <input type="number" class="form-input" id="withdrawal-amount" placeholder="Enter amount" min="100">
                        </div>
                        <button class="auth-btn" id="submit-withdrawal">
                            <i class="material-icons">account_balance</i>
                            Submit Withdrawal Request
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(withdrawalModal);
            
            document.getElementById('close-withdrawal-modal').addEventListener('click', () => {
                withdrawalModal.classList.remove('visible');
            });
            
            document.getElementById('submit-withdrawal').addEventListener('click', submitWithdrawalRequest);
        }

        // Submit withdrawal request
        function submitWithdrawalRequest() {
            const amount = parseInt(document.getElementById('withdrawal-amount').value);
            const method = document.getElementById('payment-method').value;
            const details = document.getElementById('account-details').value.trim();
            
            if (!amount || amount < 100) {
                alert('Minimum withdrawal is 100 tokens');
                return;
            }
            
            if (!details) {
                alert('Please enter your account details');
                return;
            }
            
            // Check if user has enough tokens
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    if (userData.tokens < amount) {
                        alert('You do not have enough tokens for this withdrawal');
                        return;
                    }
                    
                    // Deduct tokens
                    db.collection('users').doc(currentUser.uid).update({
                        tokens: firebase.firestore.FieldValue.increment(-amount)
                    });
                    
                    // Create withdrawal request
                    db.collection('withdrawals').add({
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        amount: amount,
                        paymentMethod: method,
                        accountDetails: details,
                        status: 'pending',
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Withdrawal request submitted successfully!');
                    document.getElementById('withdrawal-modal').classList.remove('visible');
                });
        }

        // Audio controls
        function enableAudio() {
            // In a real app, this would enable audio for the broadcaster
            audioEnabled = true;
            enableAudioBtn.style.display = 'none';
            muteAudioBtn.style.display = 'block';
            console.log('Audio enabled');
        }

        function muteAudio() {
            // In a real app, this would mute audio for the broadcaster
            audioEnabled = false;
            muteAudioBtn.style.display = 'none';
            enableAudioBtn.style.display = 'block';
            console.log('Audio muted');
        }

        // Copy session link to clipboard
        function copySessionLinkToClipboard() {
            const sessionLinkInput = document.getElementById('session-link-input');
            sessionLinkInput.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        }

        // Join private session
        function joinPrivateSessionHandler() {
            const sessionLinkInput = document.getElementById('session-link-input');
            window.open(sessionLinkInput.value, '_blank');
            document.getElementById('private-session-modal').classList.remove('visible');
        }

        // Tab navigation
        function switchTab(tab) {
            // Update active tab button
            tabBtns.forEach(btn => {
                if (btn.getAttribute('data-tab') === tab) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show active tab content
            tabContents.forEach(content => {
                if (content.id === `${tab}-tab`) {
                    content.classList.add('active');
                    
                    // Load content based on tab
                    if (tab === 'home') {
                        loadHomeContent();
                    } else if (tab === 'following') {
                        loadFollowingList();
                    }
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Load home content
        function loadHomeContent() {
            if (!currentUser) return;
            
            // Load followed broadcasts
            db.collection('broadcasts')
                .where('isLive', '==', true)
                .where('broadcasterId', 'in', followedBroadcasters)
                .get()
                .then(snapshot => {
                    followedBroadcasts.innerHTML = '';
                    
                    if (snapshot.empty) {
                        followedBroadcasts.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No followed broadcasters are live</div>';
                    } else {
                        snapshot.forEach(doc => {
                            const broadcast = doc.data();
                            const card = createBroadcastCard(broadcast, doc.id);
                            followedBroadcasts.appendChild(card);
                        });
                    }
                });
            
            // Load recommended broadcasts
            db.collection('broadcasts')
                .where('isLive', '==', true)
                .orderBy('viewers', 'desc')
                .limit(4)
                .get()
                .then(snapshot => {
                    recommendedBroadcasts.innerHTML = '';
                    
                    if (snapshot.empty) {
                        recommendedBroadcasts.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No live broadcasts</div>';
                    } else {
                        snapshot.forEach(doc => {
                            const broadcast = doc.data();
                            const card = createBroadcastCard(broadcast, doc.id);
                            recommendedBroadcasts.appendChild(card);
                        });
                    }
                });
        }

        // Create broadcast card
        function createBroadcastCard(broadcast, broadcastId) {
            const card = document.createElement('div');
            card.className = 'broadcast-card';
            card.innerHTML = `
                <div class="card-thumbnail" style="background-color: #${Math.floor(Math.random()*16777215).toString(16)}"></div>
                <div class="card-content">
                    <div class="card-title">${broadcast.broadcasterName}</div>
                    <div class="card-info">
                        <span>${broadcast.viewers || 0} viewers</span>
                        <span>${broadcast.isPrivate ? 'Private' : 'Public'}</span>
                    </div>
                </div>
            `;
            card.addEventListener('click', () => {
                if (broadcast.isPrivate && !isAdmin) {
                    currentBroadcastId = broadcastId;
                    passkeyModal.classList.add('visible');
                } else {
                    joinBroadcast(broadcastId);
                }
                switchTab('broadcasters');
            });
            return card;
        }

        // Load following list
        function loadFollowingList() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid)
                .collection('following').get()
                .then(snapshot => {
                    followingList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        followingList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">You are not following any broadcasters</div>';
                        return;
                    }
                    
                    const broadcasterIds = [];
                    snapshot.forEach(doc => {
                        broadcasterIds.push(doc.id);
                    });
                    
                    // Get broadcaster details
                    db.collection('users').where('uid', 'in', broadcasterIds).get()
                        .then(userSnapshot => {
                            userSnapshot.forEach(userDoc => {
                                const userData = userDoc.data();
                                const div = document.createElement('div');
                                div.className = 'online-broadcaster';
                                div.innerHTML = `
                                    <img src="${userData.photoURL}" class="broadcaster-avatar" alt="Avatar">
                                    <div class="broadcaster-info">
                                        <div class="broadcaster-name">${userData.displayName}</div>
                                        <div class="broadcaster-viewers">${userData.followerCount || 0} followers</div>
                                    </div>
                                `;
                                div.addEventListener('click', () => {
                                    showUserProfile(userData.uid);
                                });
                                followingList.appendChild(div);
                            });
                        });
                });
        }

        // Load followed broadcasters
        function loadFollowedBroadcasters(userId) {
            db.collection('users').doc(userId)
                .collection('following').get()
                .then(snapshot => {
                    followedBroadcasters = [];
                    snapshot.forEach(doc => {
                        followedBroadcasters.push(doc.id);
                    });
                });
        }

        // Broadcasters list
        function loadBroadcasters() {
            db.collection('broadcasts')
                .where('isLive', '==', true)
                .get()
                .then(snapshot => {
                    broadcastersList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        broadcastersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No live broadcasts</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const broadcast = doc.data();
                        const div = document.createElement('div');
                        div.className = 'online-broadcaster';
                        div.innerHTML = `
                            <img src="${broadcast.broadcasterImage || 'https://via.placeholder.com/40'}" class="broadcaster-avatar" alt="Avatar">
                            <div class="broadcaster-info">
                                <div class="broadcaster-name">
                                    ${broadcast.broadcasterName}
                                    ${broadcast.isPrivate ? '<span class="private-badge">Private</span>' : ''}
                                </div>
                                <div class="broadcaster-viewers">${broadcast.viewers || 0} viewers</div>
                            </div>
                        `;
                        div.addEventListener('click', () => {
                            if (broadcast.isPrivate && !isAdmin) {
                                currentBroadcastId = doc.id;
                                passkeyModal.classList.add('visible');
                            } else {
                                joinBroadcast(doc.id);
                            }
                        });
                        broadcastersList.appendChild(div);
                    });
                });
        }

        // Admin stealth viewing function
        function joinBroadcastStealth(broadcastId) {
            if (!isAdmin) return;
            
            isStealthMode = true;
            stealthIndicator.style.display = 'block';
            
            // Store current broadcast ID if any
            const previousBroadcast = currentBroadcastId;
            
            // Join the broadcast without updating viewer count
            currentBroadcastId = broadcastId;
            streamPlaceholder.classList.add('hidden');
            
            // Add stealth video element
            videoStreams.innerHTML = `
                <div class="stream-video" id="stealth-stream">
                    <div style="color: white; text-align: center; padding-top: 20px;">
                        Stealth Viewing: Broadcaster video would appear here<br>
                        <i class="material-icons" style="font-size: 48px; margin-top: 20px;">visibility_off</i>
                        <div style="font-size: 12px; margin-top: 10px;">Your viewing is not visible to others</div>
                    </div>
                </div>
            `;
            
            // Listen to chat without appearing as a viewer
            listenToBroadcastChat(broadcastId);
            
            // Add stealth exit button
            const stealthExit = document.createElement('button');
            stealthExit.innerHTML = '<i class="material-icons">close</i> Exit Stealth';
            stealthExit.style.position = 'absolute';
            stealthExit.style.top = '10px';
            stealthExit.style.right = '10px';
            stealthExit.style.zIndex = '100';
            stealthExit.classList.add('auth-btn');
            stealthExit.style.backgroundColor = '#f44336';
            stealthExit.onclick = () => {
                exitStealthMode(previousBroadcast);
            };
            document.getElementById('stealth-stream').appendChild(stealthExit);
        }
        
        function exitStealthMode(previousBroadcast) {
            isStealthMode = false;
            stealthIndicator.style.display = 'none';
            
            // Clear stealth stream
            videoStreams.innerHTML = '';
            
            // Remove stealth chat window if it exists
            if (stealthChatWindow) {
                stealthChatWindow.remove();
                stealthChatWindow = null;
            }
            
            // Return to previous broadcast or show placeholder
            if (previousBroadcast) {
                joinBroadcast(previousBroadcast);
            } else {
                streamPlaceholder.classList.remove('hidden');
            }
            
            currentBroadcastId = previousBroadcast;
        }
        
        function listenToBroadcastChat(broadcastId) {
            // Create stealth chat window
            createStealthChatWindow();
            
            // Listen to chat messages without appearing as a user
            db.collection('chats').doc(broadcastId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            displayStealthMessage(message);
                        }
                    });
                });
        }
        
        function createStealthChatWindow() {
            stealthChatWindow = document.createElement('div');
            stealthChatWindow.className = 'stealth-chat-window';
            stealthChatWindow.innerHTML = `
                <div class="stealth-chat-header">
                    <span>Stealth Chat</span>
                    <button class="close-modal" style="background: none; border: none; color: #fff; cursor: pointer;">×</button>
                </div>
                <div class="stealth-chat-messages" id="stealth-chat-messages"></div>
                <div class="stealth-chat-input-container">
                    <input type="text" class="stealth-chat-input" id="stealth-chat-input" placeholder="Type message as broadcaster...">
                    <button class="stealth-chat-send" id="stealth-chat-send">Send</button>
                </div>
            `;
            document.body.appendChild(stealthChatWindow);
            
            // Add event listeners
            stealthChatWindow.querySelector('.close-modal').addEventListener('click', () => {
                stealthChatWindow.style.display = 'none';
            });
            
            const stealthChatInput = document.getElementById('stealth-chat-input');
            const stealthChatSend = document.getElementById('stealth-chat-send');
            
            stealthChatSend.addEventListener('click', () => {
                const message = stealthChatInput.value.trim();
                if (message) {
                    sendMessageAsBroadcaster(message);
                    stealthChatInput.value = '';
                }
            });
            
            stealthChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const message = stealthChatInput.value.trim();
                    if (message) {
                        sendMessageAsBroadcaster(message);
                        stealthChatInput.value = '';
                    }
                }
            });
        }
        
        function displayStealthMessage(message) {
            const stealthChatMessages = document.getElementById('stealth-chat-messages');
            if (!stealthChatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'stealth-message';
            messageDiv.innerHTML = `<strong>${message.sender}:</strong> ${message.text}`;
            stealthChatMessages.appendChild(messageDiv);
            stealthChatMessages.scrollTop = stealthChatMessages.scrollHeight;
        }
        
        // Admin impersonation function
        function sendMessageAsBroadcaster(messageText) {
            if (!isAdmin || !currentBroadcastId) {
                alert('Admin privileges required');
                return;
            }
            
            // Get broadcaster info
            db.collection('broadcasts').doc(currentBroadcastId).get()
                .then(broadcastDoc => {
                    if (broadcastDoc.exists) {
                        const broadcastData = broadcastDoc.data();
                        
                        // Add message as if from broadcaster
                        db.collection('chats').doc(currentBroadcastId).collection('messages').add({
                            sender: broadcastData.broadcasterName,
                            text: messageText,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            isAdminImpersonation: true, // Hidden flag
                            actualAdminId: currentUser.uid
                        });
                        
                        // Also add to visible chat
                        addMessageToChat(broadcastData.broadcasterName, messageText);
                    }
                });
        }

        // Broadcaster approval system
        function loadBroadcasterApprovals() {
            db.collection('users')
                .where('isBroadcaster', '==', true)
                .where('broadcasterApproved', '==', false)
                .get()
                .then(snapshot => {
                    approvalList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        approvalList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No pending approvals</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const div = document.createElement('div');
                        div.className = 'approval-item';
                        div.innerHTML = `
                            <div>
                                <div class="broadcaster-name">${user.displayName}</div>
                                <div class="broadcaster-viewers">${user.email}</div>
                            </div>
                            <div class="approval-actions">
                                <button class="admin-action-btn approve-broadcaster" data-id="${doc.id}">Approve</button>
                                <button class="admin-action-btn delete reject-broadcaster" data-id="${doc.id}">Reject</button>
                            </div>
                        `;
                        approvalList.appendChild(div);
                    });
                    
                    // Add event listeners
                    const approveButtons = approvalList.querySelectorAll('.approve-broadcaster');
                    const rejectButtons = approvalList.querySelectorAll('.reject-broadcaster');
                    
                    approveButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.target.getAttribute('data-id');
                            approveBroadcaster(userId);
                        });
                    });
                    
                    rejectButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.target.getAttribute('data-id');
                            rejectBroadcaster(userId);
                        });
                    });
                });
        }

        function approveBroadcaster(userId) {
            db.collection('users').doc(userId).update({
                broadcasterApproved: true
            })
            .then(() => {
                loadBroadcasterApprovals();
                alert('Broadcaster approved successfully');
            })
            .catch(error => {
                console.error('Error approving broadcaster:', error);
                alert('Error approving broadcaster: ' + error.message);
            });
        }

        function rejectBroadcaster(userId) {
            db.collection('users').doc(userId).update({
                isBroadcaster: false
            })
            .then(() => {
                loadBroadcasterApprovals();
                alert('Broadcaster rejected');
            })
            .catch(error => {
                console.error('Error rejecting broadcaster:', error);
                alert('Error rejecting broadcaster: ' + error.message);
            });
        }

        // Passkey functions
        function generatePasskeys() {
            const count = parseInt(passkeyCount.value) || 1;
            const passkeys = [];
            
            for (let i = 0; i < count; i++) {
                const passkey = generateRandomPasskey();
                passkeys.push({
                    passkey: passkey,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    used: false,
                    broadcastId: currentUser.uid // For future use when broadcasting
                });
            }
            
            // Save to Firestore
            const batch = db.batch();
            passkeys.forEach(passkey => {
                const ref = db.collection('passkeys').doc();
                batch.set(ref, passkey);
            });
            
            batch.commit()
                .then(() => {
                    alert(`${count} passkey(s) generated successfully!`);
                    loadUserPasskeys();
                })
                .catch(error => {
                    console.error('Error generating passkeys:', error);
                    alert('Error generating passkeys: ' + error.message);
                });
        }

        function generateRandomPasskey() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function loadUserPasskeys() {
            if (!currentUser) return;
            
            db.collection('passkeys')
                .where('broadcastId', '==', currentUser.uid)
                .where('used', '==', false)
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    passkeyList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        passkeyList.innerHTML = '<div style="padding: 10px; text-align: center; color: #888;">No active passkeys</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const passkeyData = doc.data();
                        const div = document.createElement('div');
                        div.style.padding = '8px';
                        div.style.borderBottom = '1px solid #333';
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${passkeyData.passkey}</span>
                                <button class="admin-action-btn delete" data-id="${doc.id}">Delete</button>
                            </div>
                        `;
                        passkeyList.appendChild(div);
                    });
                    
                    // Add event listeners to delete buttons
                    const deleteButtons = passkeyList.querySelectorAll('.admin-action-btn.delete');
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const passkeyId = e.target.getAttribute('data-id');
                            deletePasskey(passkeyId);
                        });
                    });
                });
        }

        function deletePasskey(passkeyId) {
            db.collection('passkeys').doc(passkeyId).delete()
                .then(() => {
                    loadUserPasskeys();
                })
                .catch(error => {
                    console.error('Error deleting passkey:', error);
                    alert('Error deleting passkey: ' + error.message);
                });
        }

        function validatePasskey() {
            const passkey = passkeyInput.value.trim();
            if (!passkey) return;
            
            db.collection('passkeys')
                .where('passkey', '==', passkey)
                .where('used', '==', false)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('Invalid or used passkey');
                        return;
                    }
                    
                    // Mark passkey as used
                    const doc = snapshot.docs[0];
                    db.collection('passkeys').doc(doc.id).update({
                        used: true,
                        usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        usedBy: currentUser.uid
                    });
                    
                    // Join the broadcast
                    passkeyModal.classList.remove('visible');
                    joinBroadcast(currentBroadcastId);
                })
                .catch(error => {
                    console.error('Error validating passkey:', error);
                    alert('Error validating passkey: ' + error.message);
                });
        }

        // Broadcast functions
        function startBroadcast() {
            const user = auth.currentUser;
            if (!user) return;
            
            const isPrivate = privateBroadcastCheckbox.checked;
            
            isBroadcasting = true;
            currentBroadcastId = user.uid;
            
            // Update UI
            streamPlaceholder.classList.add('hidden');
            broadcasterControls.classList.remove('hidden');
            startBroadcastBtn.textContent = 'Broadcasting...';
            startBroadcastBtn.disabled = true;
            
            // Create broadcast document
            db.collection('broadcasts').doc(user.uid).set({
                broadcasterId: user.uid,
                broadcasterName: user.displayName,
                broadcasterImage: user.photoURL,
                title: 'My Live Broadcast',
                startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                viewers: 0,
                isLive: true,
                isPrivate: isPrivate,
                tokensReceived: 0
            })
            .then(() => {
                // Add local video element (mock for demonstration)
                videoStreams.innerHTML = `
                    <div class="stream-video" id="local-stream">
                        <div style="color: white; text-align: center; padding-top: 20px;">
                            Your live stream would appear here<br>
                            <i class="material-icons" style="font-size: 48px; margin-top: 20px;">videocam</i>
                        </div>
                    </div>
                `;
                
                // Simulate viewer count update
                let viewers = 0;
                const viewerInterval = setInterval(() => {
                    if (!isBroadcasting) {
                        clearInterval(viewerInterval);
                        return;
                    }
                    viewers += Math.floor(Math.random() * 5);
                    viewerCountEl.textContent = `${viewers} viewers`;
                    
                    // Update viewer count in Firestore
                    db.collection('broadcasts').doc(user.uid).update({
                        viewers: viewers
                    });
                }, 3000);
            })
            .catch(error => {
                console.error('Error starting broadcast:', error);
                alert('Error starting broadcast: ' + error.message);
            });
        }

        function endBroadcastHandler() {
            if (!currentUser) return;
            
            isBroadcasting = false;
            
            // Update Firestore
            db.collection('broadcasts').doc(currentUser.uid).update({
                isLive: false,
                endedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update UI
            streamPlaceholder.classList.remove('hidden');
            broadcasterControls.classList.add('hidden');
            startBroadcastBtn.textContent = 'Start Broadcast';
            startBroadcastBtn.disabled = false;
            videoStreams.innerHTML = '';
            viewerCountEl.textContent = '0 viewers';
        }

        function joinBroadcast(broadcastId) {
            if (isBroadcasting) {
                alert('Please end your current broadcast before joining another.');
                return;
            }
            
            currentBroadcastId = broadcastId;
            streamPlaceholder.classList.add('hidden');
            
            // In a real app, we would join the Agora channel
            console.log("Joining broadcast:", broadcastId);
            
            // Add remote video element (mock for demonstration)
            videoStreams.innerHTML = `
                <div class="stream-video" id="remote-stream">
                    <div style="color: white; text-align: center; padding-top: 20px;">
                        Broadcaster video would appear here<br>
                        <i class="material-icons" style="font-size: 48px; margin-top: 20px;">videocam</i>
                    </div>
                </div>
            `;
            
            // Update viewer count
            db.collection('broadcasts').doc(broadcastId).update({
                viewers: firebase.firestore.FieldValue.increment(1)
            });
            
            // Simulate chat messages
            simulateChat();
        }

        function toggleCamera() {
            // In a real app, this would enable/disable the camera
            console.log("Toggling camera");
            const icon = cameraToggle.querySelector('i');
            if (icon.textContent === 'videocam') {
                icon.textContent = 'videocam_off';
            } else {
                icon.textContent = 'videocam';
            }
        }

        function toggleMic() {
            // In a real app, this would enable/disable the microphone
            console.log("Toggling microphone");
            const icon = micToggle.querySelector('i');
            if (icon.textContent === 'mic') {
                icon.textContent = 'mic_off';
            } else {
                icon.textContent = 'mic';
            }
        }

        // Admin functions
        function loadAdminData() {
            if (!isAdmin) return;
            
            loadWithdrawalRequests();
            loadAdminBroadcasts();
            loadSupportChats();
        }

        function loadWithdrawalRequests() {
            db.collection('withdrawals')
                .where('status', '==', 'pending')
                .get()
                .then(snapshot => {
                    withdrawalRequests.innerHTML = '';
                    
                    if (snapshot.empty) {
                        withdrawalRequests.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 10px;">No pending withdrawal requests</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const withdrawal = doc.data();
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${withdrawal.userEmail}</td>
                            <td>${withdrawal.amount} tokens</td>
                            <td>${withdrawal.status}</td>
                            <td>
                                <button class="admin-action-btn approve" data-id="${doc.id}">Approve</button>
                                <button class="admin-action-btn delete decline" data-id="${doc.id}">Decline</button>
                            </td>
                        `;
                        withdrawalRequests.appendChild(tr);
                    });
                    
                    // Add event listeners to action buttons
                    const approveButtons = withdrawalRequests.querySelectorAll('.approve');
                    const declineButtons = withdrawalRequests.querySelectorAll('.decline');
                    
                    approveButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const withdrawalId = e.target.getAttribute('data-id');
                            processWithdrawal(withdrawalId, 'approved');
                        });
                    });
                    
                    declineButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const withdrawalId = e.target.getAttribute('data-id');
                            processWithdrawal(withdrawalId, 'declined');
                        });
                    });
                });
        }

        function processWithdrawal(withdrawalId, status) {
            db.collection('withdrawals').doc(withdrawalId).update({
                status: status,
                processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: currentUser.uid
            })
            .then(() => {
                loadWithdrawalRequests();
            })
            .catch(error => {
                console.error('Error processing withdrawal:', error);
                alert('Error processing withdrawal: ' + error.message);
            });
        }

        function searchUser() {
            const email = userSearch.value.trim();
            if (!email) return;
            
            db.collection('users')
                .where('email', '==', email)
                .get()
                .then(snapshot => {
                    userManagementResults.innerHTML = '';
                    
                    if (snapshot.empty) {
                        userManagementResults.innerHTML = '<div style="padding: 10px; text-align: center; color: #888;">User not found</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.border = '1px solid #444';
                        div.style.borderRadius = '4px';
                        div.style.marginTop = '10px';
                        div.innerHTML = `
                            <h3>${user.displayName} (${user.email})</h3>
                            <p>Tokens: ${user.tokens}</p>
                            <p>Status: ${user.banned ? 'Banned' : 'Active'}</p>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="admin-action-btn" id="adjust-balance">Adjust Balance</button>
                                <button class="admin-action-btn ${user.banned ? 'approve' : 'delete'}" id="toggle-ban">
                                    ${user.banned ? 'Unban User' : 'Ban User'}
                                </button>
                            </div>
                            <div id="adjust-balance-form" style="margin-top: 10px; display: none;">
                                <input type="number" class="form-input" id="balance-adjustment" placeholder="Amount">
                                <button class="admin-action-btn" id="submit-balance-adjustment">Submit</button>
                            </div>
                        `;
                        userManagementResults.appendChild(div);
                        
                        // Add event listeners
                        const adjustBalanceBtn = div.querySelector('#adjust-balance');
                        const toggleBanBtn = div.querySelector('#toggle-ban');
                        const balanceForm = div.querySelector('#adjust-balance-form');
                        const balanceInput = div.querySelector('#balance-adjustment');
                        const submitBalanceBtn = div.querySelector('#submit-balance-adjustment');
                        
                        adjustBalanceBtn.addEventListener('click', () => {
                            balanceForm.style.display = balanceForm.style.display === 'none' ? 'block' : 'none';
                        });
                        
                        toggleBanBtn.addEventListener('click', () => {
                            toggleUserBan(doc.id, !user.banned);
                        });
                        
                        submitBalanceBtn.addEventListener('click', () => {
                            const amount = parseInt(balanceInput.value);
                            if (!isNaN(amount)) {
                                adjustUserBalance(doc.id, amount);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error searching user:', error);
                    alert('Error searching user: ' + error.message);
                });
        }

        function toggleUserBan(userId, ban) {
            db.collection('users').doc(userId).update({
                banned: ban
            })
            .then(() => {
                searchUser(); // Refresh results
            })
            .catch(error => {
                console.error('Error toggling user ban:', error);
                alert('Error toggling user ban: ' + error.message);
            });
        }

        function adjustUserBalance(userId, amount) {
            db.collection('users').doc(userId).update({
                tokens: firebase.firestore.FieldValue.increment(amount)
            })
            .then(() => {
                alert(`Balance adjusted by ${amount} tokens`);
                searchUser(); // Refresh results
            })
            .catch(error => {
                console.error('Error adjusting balance:', error);
                alert('Error adjusting balance: ' + error.message);
            });
        }

        function loadAdminBroadcasts() {
            db.collection('broadcasts')
                .where('isLive', '==', true)
                .get()
                .then(snapshot => {
                    adminBroadcastList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        adminBroadcastList.innerHTML = '<div style="padding: 10px; text-align: center; color: #888;">No live broadcasts</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const broadcast = doc.data();
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.border = '1px solid #444';
                        div.style.borderRadius = '4px';
                        div.style.marginTop = '10px';
                        div.innerHTML = `
                            <h3>${broadcast.broadcasterName}</h3>
                            <p>Viewers: ${broadcast.viewers || 0}</p>
                            <p>Private: ${broadcast.isPrivate ? 'Yes' : 'No'}</p>
                            <div style="display: flex; gap: 5px; margin-top: 10px;">
                                <button class="admin-action-btn watch-broadcast" data-id="${doc.id}">Watch Broadcast</button>
                                <button class="admin-action-btn stealth-watch" data-id="${doc.id}" style="background-color: #4caf50;">Stealth Watch</button>
                                <button class="admin-action-btn impersonate-chat" data-id="${doc.id}" data-name="${broadcast.broadcasterName}" style="background-color: #9c27b0;">Impersonate in Chat</button>
                            </div>
                            <div class="impersonation-form" style="margin-top: 10px; display: none;">
                                <input type="text" class="form-input impersonation-message" placeholder="Type message as ${broadcast.broadcasterName}">
                                <button class="admin-action-btn send-impersonation" data-id="${doc.id}">Send</button>
                            </div>
                        `;
                        adminBroadcastList.appendChild(div);
                        
                        // Add event listeners
                        const watchBtn = div.querySelector('.watch-broadcast');
                        const stealthBtn = div.querySelector('.stealth-watch');
                        const impersonateBtn = div.querySelector('.impersonate-chat');
                        const impersonationForm = div.querySelector('.impersonation-form');
                        const sendBtn = div.querySelector('.send-impersonation');
                        const messageInput = div.querySelector('.impersonation-message');
                        
                        watchBtn.addEventListener('click', () => {
                            joinBroadcast(doc.id);
                            adminModal.classList.remove('visible');
                        });
                        
                        stealthBtn.addEventListener('click', () => {
                            joinBroadcastStealth(doc.id);
                            adminModal.classList.remove('visible');
                        });
                        
                        impersonateBtn.addEventListener('click', () => {
                            if (impersonationForm.style.display === 'none') {
                                impersonationForm.style.display = 'block';
                            } else {
                                impersonationForm.style.display = 'none';
                            }
                        });
                        
                        sendBtn.addEventListener('click', () => {
                            const message = messageInput.value.trim();
                            if (message) {
                                sendMessageAsBroadcaster(message);
                                messageInput.value = '';
                                impersonationForm.style.display = 'none';
                            }
                        });
                    });
                });
        }

        // Wallet funding system
        function handleWalletFunding() {
            if (fundingMethod === 'redirect') {
                // Redirect to external URL
                const url = redirectUrlInput.value;
                if (!url.startsWith('http')) {
                    window.open('https://' + url, '_blank');
                } else {
                    window.open(url, '_blank');
                }
                tokenModal.classList.remove('visible');
            } else {
                // Open support chat
                tokenModal.classList.remove('visible');
                openSupportChat();
            }
        }

        function openSupportChat() {
            // Create or get existing support chat
            db.collection('supportChats')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'open')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // Create new chat
                        const chatId = db.collection('supportChats').doc().id;
                        currentSupportChat = chatId;
                        
                        db.collection('supportChats').doc(chatId).set({
                            chatId: chatId,
                            userId: currentUser.uid,
                            userEmail: currentUser.email,
                            userName: currentUser.displayName,
                            status: 'open',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            messages: [{
                                sender: 'user',
                                text: 'I want to fund my wallet',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }]
                        })
                        .then(() => {
                            supportChatModal.classList.add('visible');
                            loadSupportChat(chatId);
                        });
                    } else {
                        // Use existing chat
                        const chat = snapshot.docs[0].data();
                        currentSupportChat = chat.chatId;
                        supportChatModal.classList.add('visible');
                        loadSupportChat(chat.chatId);
                    }
                });
        }

        function loadSupportChat(chatId) {
            db.collection('supportChats').doc(chatId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const chat = doc.data();
                        supportChatMessages.innerHTML = '';
                        
                        if (chat.messages && chat.messages.length > 0) {
                            chat.messages.forEach(message => {
                                const messageDiv = document.createElement('div');
                                messageDiv.className = `support-message ${message.sender}`;
                                messageDiv.innerHTML = `
                                    <div><strong>${message.sender === 'admin' ? 'Admin' : chat.userName}:</strong> ${message.text}</div>
                                    <div style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">
                                        ${new Date(message.timestamp?.toDate()).toLocaleString()}
                                    </div>
                                `;
                                supportChatMessages.appendChild(messageDiv);
                            });
                            
                            supportChatMessages.scrollTop = supportChatMessages.scrollHeight;
                        }
                    }
                });
        }

        function sendSupportMessage() {
            const message = supportChatInput.value.trim();
            if (!message || !currentSupportChat) return;
            
            db.collection('supportChats').doc(currentSupportChat)
                .update({
                    messages: firebase.firestore.FieldValue.arrayUnion({
                        sender: 'user',
                        text: message,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    })
                })
                .then(() => {
                    supportChatInput.value = '';
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                });
        }

        function processFundAction() {
            const amount = parseInt(fundAmount.value);
            const reason = fundReason.value.trim();
            
            if (!amount || amount <= 0 || !reason) {
                alert('Please enter a valid amount and reason');
                return;
            }
            
            // Get user ID from the chat
            db.collection('supportChats').doc(currentSupportChat).get()
                .then(doc => {
                    if (doc.exists) {
                        const chat = doc.data();
                        const userId = chat.userId;
                        
                        if (currentActionType === 'fund') {
                            // Fund user wallet
                            db.collection('users').doc(userId).update({
                                tokens: firebase.firestore.FieldValue.increment(amount)
                            })
                            .then(() => {
                                // Record transaction
                                db.collection('transactions').add({
                                    userId: userId,
                                    type: 'fund',
                                    amount: amount,
                                    reason: reason,
                                    adminId: currentUser.uid,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                // Add message to chat
                                return db.collection('supportChats').doc(currentSupportChat)
                                    .update({
                                        messages: firebase.firestore.FieldValue.arrayUnion({
                                            sender: 'admin',
                                            text: `Funded ${amount} tokens. Reason: ${reason}`,
                                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                        })
                                    });
                            })
                            .then(() => {
                                fundAmount.value = '';
                                fundReason.value = '';
                                fundActions.classList.add('hidden');
                                alert('User funded successfully');
                            });
                        } else {
                            // Debit user wallet
                            db.collection('users').doc(userId).get()
                                .then(userDoc => {
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        if (userData.tokens < amount) {
                                            alert('User does not have enough tokens');
                                            return;
                                        }
                                        
                                        db.collection('users').doc(userId).update({
                                            tokens: firebase.firestore.FieldValue.increment(-amount)
                                        })
                                        .then(() => {
                                            // Record transaction
                                            db.collection('transactions').add({
                                                userId: userId,
                                                type: 'debit',
                                                amount: amount,
                                                reason: reason,
                                                adminId: currentUser.uid,
                                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                            });
                                            
                                            // Add message to chat
                                            return db.collection('supportChats').doc(currentSupportChat)
                                                .update({
                                                    messages: firebase.firestore.FieldValue.arrayUnion({
                                                        sender: 'admin',
                                                        text: `Debited ${amount} tokens. Reason: ${reason}`,
                                                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                                    })
                                                });
                                        })
                                        .then(() => {
                                            fundAmount.value = '';
                                            fundReason.value = '';
                                            fundActions.classList.add('hidden');
                                            alert('User debited successfully');
                                        });
                                    }
                                });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error processing fund action:', error);
                    alert('Error processing fund action: ' + error.message);
                });
        }

        function closeSupportChat() {
            if (!currentSupportChat) return;
            
            db.collection('supportChats').doc(currentSupportChat)
                .update({
                    status: 'closed',
                    closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    closedBy: currentUser.uid
                })
                .then(() => {
                    supportChatModal.classList.remove('visible');
                    currentSupportChat = null;
                    alert('Chat marked as done');
                })
                .catch(error => {
                    console.error('Error closing chat:', error);
                });
        }

        function loadFundingConfig() {
            // In a real app, this would load from Firestore
            // For demo purposes, we'll use default values
            fundingMethod = 'redirect';
            document.querySelector('input[name="funding-method"][value="redirect"]').checked = true;
            redirectConfig.style.display = 'block';
        }

        function saveFundingConfig() {
            fundingMethod = document.querySelector('input[name="funding-method"]:checked').value;
            const url = redirectUrlInput.value;
            
            // In a real app, this would save to Firestore
            alert('Funding configuration saved successfully');
        }

        function loadSupportChats() {
            if (!isAdmin) return;
            
            db.collection('supportChats')
                .where('status', '==', 'open')
                .get()
                .then(snapshot => {
                    supportChatsList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        supportChatsList.innerHTML = '<div style="padding: 10px; text-align: center; color: #888;">No open support chats</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const chat = doc.data();
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.border = '1px solid #444';
                        div.style.borderRadius = '4px';
                        div.style.marginTop = '10px';
                        div.innerHTML = `
                            <h3>${chat.userName} (${chat.userEmail})</h3>
                            <p>Status: ${chat.status}</p>
                            <p>Created: ${new Date(chat.createdAt?.toDate()).toLocaleString()}</p>
                            <button class="admin-action-btn view-chat-btn" data-id="${chat.chatId}">
                                View Chat
                            </button>
                        `;
                        supportChatsList.appendChild(div);
                        
                        // Add event listener
                        const viewChatBtn = div.querySelector('.view-chat-btn');
                        viewChatBtn.addEventListener('click', (e) => {
                            currentSupportChat = e.target.getAttribute('data-id');
                            supportChatModal.classList.add('visible');
                            loadSupportChat(currentSupportChat);
                            adminModal.classList.remove('visible');
                        });
                    });
                });
        }

        // Chat functions
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            const user = auth.currentUser;
            if (!user) return;
            
            // In a real app, we would send this via Agora RTM or Firebase
            addMessageToChat(user.displayName, message);
            
            // Clear input
            chatInput.value = '';
        }

        function sendTip() {
            const user = auth.currentUser;
            if (!user || !currentBroadcastId) return;
            
            // In a real app, we would show a modal to select tip amount
            const tipAmount = Math.floor(Math.random() * 50) + 5; // Random tip amount for demo
            
            // Check if user has enough tokens
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    if (userData.tokens < tipAmount) {
                        alert('You do not have enough tokens to send this tip');
                        return;
                    }
                    
                    // Deduct full amount from viewer
                    db.collection('users').doc(user.uid).update({
                        tokens: firebase.firestore.FieldValue.increment(-tipAmount)
                    });
                    
                    // Add 50% to broadcaster's tokens
                    const broadcasterAmount = Math.floor(tipAmount * 0.5);
                    db.collection('broadcasts').doc(currentBroadcastId).get()
                        .then(broadcastDoc => {
                            if (broadcastDoc.exists) {
                                const broadcasterId = broadcastDoc.data().broadcasterId;
                                db.collection('users').doc(broadcasterId).update({
                                    tokens: firebase.firestore.FieldValue.increment(broadcasterAmount),
                                    totalEarnings: firebase.firestore.FieldValue.increment(broadcasterAmount)
                                });
                                
                                // Update broadcast tokens received
                                db.collection('broadcasts').doc(currentBroadcastId).update({
                                    tokensReceived: firebase.firestore.FieldValue.increment(broadcasterAmount)
                                });
                                
                                // Record transaction with platform fee
                                db.collection('transactions').add({
                                    from: user.uid,
                                    to: broadcasterId,
                                    amount: tipAmount,
                                    broadcasterAmount: broadcasterAmount,
                                    platformFee: tipAmount - broadcasterAmount,
                                    type: 'tip',
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                // Update viewer tip history
                                if (!viewerTipHistory[user.uid]) {
                                    viewerTipHistory[user.uid] = 0;
                                }
                                viewerTipHistory[user.uid] += tipAmount;
                                
                                // Add message to chat with special styling for tippers
                                addMessageToChat(user.displayName, `sent ${tipAmount} tokens!`, true, tipAmount);
                            }
                        });
                });
        }

        function addMessageToChat(sender, message, isTip = false, tipAmount = 0) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isTip ? 'message-tip' : ''}`;
            
            // Check if user is a tipper and add special styling
            const isTipper = viewerTipHistory[sender] > 0;
            const senderClass = isTipper ? 'tipper' : '';
            
            messageDiv.innerHTML = `
                <span class="message-sender ${senderClass}">${sender}:</span>
                <span>${message}</span>
                ${isTipper && !isTip ? `<span class="tip-amount">${viewerTipHistory[sender]} tipped</span>` : ''}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function simulateChat() {
            // Simulate chat messages for demonstration
            const mockUsers = ['User123', 'Viewer456', 'Fan789', 'Guest001'];
            const mockMessages = [
                'Hello everyone!',
                'Looking good!',
                'How are you today?',
                'Can you do something special?',
                'I love your show!',
                'More please!'
            ];
            
            setInterval(() => {
                if (currentBroadcastId && !isBroadcasting) {
                    const user = mockUsers[Math.floor(Math.random() * mockUsers.length)];
                    const message = mockMessages[Math.floor(Math.random() * mockMessages.length)];
                    addMessageToChat(user, message);
                    
                    // Occasionally simulate tips
                    if (Math.random() < 0.2) {
                        const tipUser = mockUsers[Math.floor(Math.random() * mockUsers.length)];
                        const tipAmount = Math.floor(Math.random() * 50) + 5;
                        setTimeout(() => {
                            addMessageToChat(tipUser, `sent ${tipAmount} tokens!`, true, tipAmount);
                        }, 1000);
                    }
                }
            }, 5000);
        }

        // Initialize the app when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
