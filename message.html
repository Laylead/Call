<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectX - Professional Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Add all the CSS styles from the previous version here */
        /* They remain the same but are included for completeness */
        
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --gray-color: #6c757d;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-color: #333333;
            --message-sent: #4361ee;
            --message-received: #f0f0f0;
            --input-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* Add all other CSS styles from the previous version */
        /* ... (Include all the CSS from the previous version) ... */

    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>ConnectX Messages</h1>
        </div>
        <div class="header-actions">
            <i class="fas fa-cog" id="settingsBtn"></i>
            <a href="home.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home"></i>
            </a>
            <div style="position: relative;">
                <i class="fas fa-bell" id="notificationsBtn"></i>
                <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Sidebar with Chat List -->
        <div class="sidebar">
            <!-- User Profiles Section -->
            <div class="user-profiles-section" id="userProfilesSection">
                <div class="user-profiles-scroll" id="userProfilesScroll">
                    <!-- User profiles will be populated here -->
                </div>
            </div>
            
            <div class="chat-list" id="chatList">
                <!-- Chat list will be populated here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <h3>No conversation selected</h3>
                <p>Select a conversation from the list or start a new chat to begin messaging.</p>
            </div>
            
            <!-- Conversation View (hidden by default) -->
            <div class="conversation-view" id="conversationView" style="display: none;">
                <!-- Conversation Header -->
                <div class="conversation-header">
                    <div class="conversation-user-info">
                        <button class="conversation-back-btn" id="conversationBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="conversation-avatar" id="conversationAvatar">
                            <!-- Avatar will be loaded here -->
                        </div>
                        <div class="conversation-user-details">
                            <h3 id="conversationUserName">User Name</h3>
                            <p id="conversationUserStatus">
                                <span class="status-indicator status-online"></span>
                                <span id="statusText">Online</span>
                            </p>
                        </div>
                    </div>
                    <div class="conversation-actions">
                        <button class="conversation-action-btn" id="viewProfileBtn" title="View Profile">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="balance-info">
                        <i class="fas fa-wallet"></i>
                        <span>Balance: <span class="balance-amount" id="balanceAmount">₦0</span></span>
                    </div>
                    
                    <!-- Pricing Display -->
                    <div class="pricing-display" id="pricingDisplay" style="display: none;">
                        <div class="pricing-item">
                            <div class="pricing-type">Text Message</div>
                            <div class="pricing-amount" id="textPriceDisplay">₦0</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-type">Voice Message</div>
                            <div class="pricing-amount" id="voicePriceDisplay">₦0/min</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-type">Image Message</div>
                            <div class="pricing-amount" id="imagePriceDisplay">₦0</div>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="input-action-btn" id="attachBtn" title="Attach File">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="input-action-btn" id="voiceBtn" title="Record Voice">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <button class="send-btn" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="word-counter" id="wordCounter">0/35 words • ₦0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Search Widget -->
    <div class="floating-search" id="floatingSearch">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search users...">
    </div>
    
    <!-- Voice Recorder -->
    <div class="voice-recorder" id="voiceRecorder">
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <span>Recording</span>
        </div>
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="voice-waveform" id="voiceWaveform">
            <!-- Voice bars will be generated here -->
        </div>
        <div class="recording-actions">
            <button class="record-action-btn cancel" id="cancelRecordingBtn">
                <i class="fas fa-times"></i>
            </button>
            <button class="record-action-btn send" id="sendRecordingBtn">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>
    
    <!-- Voice Preview -->
    <div class="voice-preview" id="voicePreview">
        <div class="recording-timer" id="voicePreviewDuration">00:00</div>
        <div class="voice-preview-controls">
            <button class="voice-preview-play-btn" id="voicePreviewPlayBtn">
                <i class="fas fa-play"></i>
            </button>
            <div class="voice-preview-waveform" id="voicePreviewWaveform">
                <!-- Voice bars will be generated here -->
            </div>
        </div>
        <div class="voice-preview-actions">
            <button class="voice-preview-action-btn delete" id="deleteVoiceBtn">Delete</button>
            <button class="voice-preview-action-btn send" id="sendVoiceBtn">Send</button>
        </div>
    </div>
    
    <!-- Media Preview -->
    <div class="media-preview" id="mediaPreview">
        <div class="media-preview-content">
            <img id="mediaPreviewImage" src="" alt="Preview">
            <div>
                <div id="mediaPreviewName">image.jpg</div>
                <div class="media-preview-actions">
                    <button class="preview-action-btn send" id="sendMediaBtn">Send</button>
                    <button class="preview-action-btn cancel" id="cancelMediaBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu for Blocking Users -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="blockUserBtn">
            <i class="fas fa-ban"></i>
            <span>Block User</span>
        </div>
        <div class="context-menu-item danger" id="reportUserBtn">
            <i class="fas fa-flag"></i>
            <span>Report User</span>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat Settings</h2>
                <i class="fas fa-times close-modal" id="closeSettingsModal"></i>
            </div>
            
            <!-- Earnings Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-chart-line"></i>
                    Earnings Overview
                </h3>
                <div class="earnings-info">
                    <div class="earnings-item">
                        <span class="earnings-label">Total Earnings</span>
                        <span class="earnings-value" id="totalEarnings">₦0</span>
                    </div>
                    <div class="earnings-item">
                        <span class="earnings-label">Available for Withdrawal</span>
                        <span class="earnings-value" id="availableEarnings">₦0</span>
                    </div>
                </div>
            </div>
            
            <!-- Monetization Settings -->
            <div class="settings-section" id="monetizationSettings">
                <h3 class="settings-section-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Monetization Settings
                </h3>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-comment-alt"></i>
                        <h4>Text Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per 35 words</div>
                            <input type="number" id="textMessagePrice" min="5" max="1000" value="10">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-microphone"></i>
                        <h4>Voice Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per minute</div>
                            <input type="number" id="voiceMessagePrice" min="10" max="5000" value="30">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-image"></i>
                        <h4>Image Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per image</div>
                            <input type="number" id="imageMessagePrice" min="5" max="1000" value="15">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="savePricingBtn">Save Pricing</button>
            </div>
            
            <!-- General Settings -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-sliders-h"></i>
                    General Settings
                </h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="onlineStatus">Online Status</label>
                        <select id="onlineStatus">
                            <option value="online">Online</option>
                            <option value="away">Away</option>
                            <option value="busy">Busy</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageSounds">Message Sounds</label>
                        <select id="messageSounds">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="browserNotifications">Browser Notifications</label>
                        <select id="browserNotifications">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>

    <!-- External Configuration -->
    <script src="configuration.js"></script>
    <script src="agora.js"></script>

    <!-- External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Main Application Script -->
    <script>
        // Professional Chat Application with All Features Working
        class ConnectXChat {
            constructor() {
                this.state = {
                    currentUser: null,
                    conversations: [],
                    activeConversation: null,
                    messages: [],
                    userProfile: null,
                    mediaFile: null,
                    isRecording: false,
                    recordingTimer: null,
                    recordingStartTime: null,
                    audioChunks: [],
                    mediaRecorder: null,
                    voiceNote: null,
                    conversationId: null,
                    isInConversationView: false,
                    balance: 0,
                    freeMessagesRemaining: 3,
                    settings: {
                        onlineStatus: 'online',
                        messageSounds: 'enabled',
                        browserNotifications: 'enabled'
                    },
                    audioContext: null,
                    analyser: null,
                    dataArray: null,
                    animationId: null,
                    networkUsers: [],
                    searchResults: [],
                    isVoicePreview: false,
                    audioPlayer: null,
                    isPlaying: false,
                    lastScrollTop: 0,
                    isSearchActive: false,
                    blockedUsers: [],
                    contextMenu: {
                        targetUser: null,
                        targetElement: null
                    },
                    notificationSound: null
                };

                this.init();
            }

            async init() {
                try {
                    console.log('Initializing ConnectX Chat...');
                    
                    // Check if Firebase is available
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase not loaded');
                    }

                    // Initialize Firebase
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }

                    this.setupDOMReferences();
                    this.setupEventListeners();
                    await this.checkAuthStatus();
                    await this.loadUserProfile();
                    await this.loadConversations();
                    await this.loadNetworkUsers();
                    await this.handleURLParameters();
                    
                    this.setupScrollBehavior();
                    this.setupContextMenu();
                    this.setupBrowserNotifications();
                    
                    console.log('ConnectX Chat initialized successfully');
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    this.showError('Failed to initialize chat application');
                }
            }

            setupDOMReferences() {
                this.elements = {
                    mainContainer: document.getElementById('mainContainer'),
                    settingsBtn: document.getElementById('settingsBtn'),
                    notificationsBtn: document.getElementById('notificationsBtn'),
                    notificationBadge: document.getElementById('notificationBadge'),
                    chatList: document.getElementById('chatList'),
                    userProfilesScroll: document.getElementById('userProfilesScroll'),
                    userProfilesSection: document.getElementById('userProfilesSection'),
                    floatingSearch: document.getElementById('floatingSearch'),
                    searchInput: document.getElementById('searchInput'),
                    chatArea: document.getElementById('chatArea'),
                    emptyState: document.getElementById('emptyState'),
                    conversationView: document.getElementById('conversationView'),
                    conversationBackBtn: document.getElementById('conversationBackBtn'),
                    conversationAvatar: document.getElementById('conversationAvatar'),
                    conversationUserName: document.getElementById('conversationUserName'),
                    conversationUserStatus: document.getElementById('conversationUserStatus'),
                    statusText: document.getElementById('statusText'),
                    viewProfileBtn: document.getElementById('viewProfileBtn'),
                    messagesArea: document.getElementById('messagesArea'),
                    chatInput: document.getElementById('chatInput'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    attachBtn: document.getElementById('attachBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    wordCounter: document.getElementById('wordCounter'),
                    balanceAmount: document.getElementById('balanceAmount'),
                    pricingDisplay: document.getElementById('pricingDisplay'),
                    textPriceDisplay: document.getElementById('textPriceDisplay'),
                    voicePriceDisplay: document.getElementById('voicePriceDisplay'),
                    imagePriceDisplay: document.getElementById('imagePriceDisplay'),
                    voiceRecorder: document.getElementById('voiceRecorder'),
                    recordingTimer: document.getElementById('recordingTimer'),
                    voiceWaveform: document.getElementById('voiceWaveform'),
                    cancelRecordingBtn: document.getElementById('cancelRecordingBtn'),
                    sendRecordingBtn: document.getElementById('sendRecordingBtn'),
                    voicePreview: document.getElementById('voicePreview'),
                    voicePreviewDuration: document.getElementById('voicePreviewDuration'),
                    voicePreviewWaveform: document.getElementById('voicePreviewWaveform'),
                    voicePreviewPlayBtn: document.getElementById('voicePreviewPlayBtn'),
                    deleteVoiceBtn: document.getElementById('deleteVoiceBtn'),
                    sendVoiceBtn: document.getElementById('sendVoiceBtn'),
                    mediaPreview: document.getElementById('mediaPreview'),
                    mediaPreviewImage: document.getElementById('mediaPreviewImage'),
                    mediaPreviewName: document.getElementById('mediaPreviewName'),
                    sendMediaBtn: document.getElementById('sendMediaBtn'),
                    cancelMediaBtn: document.getElementById('cancelMediaBtn'),
                    settingsModal: document.getElementById('settingsModal'),
                    closeSettingsModal: document.getElementById('closeSettingsModal'),
                    onlineStatus: document.getElementById('onlineStatus'),
                    messageSounds: document.getElementById('messageSounds'),
                    browserNotifications: document.getElementById('browserNotifications'),
                    saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                    totalEarnings: document.getElementById('totalEarnings'),
                    availableEarnings: document.getElementById('availableEarnings'),
                    monetizationSettings: document.getElementById('monetizationSettings'),
                    textMessagePrice: document.getElementById('textMessagePrice'),
                    voiceMessagePrice: document.getElementById('voiceMessagePrice'),
                    imageMessagePrice: document.getElementById('imageMessagePrice'),
                    savePricingBtn: document.getElementById('savePricingBtn'),
                    contextMenu: document.getElementById('contextMenu'),
                    blockUserBtn: document.getElementById('blockUserBtn'),
                    reportUserBtn: document.getElementById('reportUserBtn')
                };
            }

            setupEventListeners() {
                // Navigation
                this.elements.conversationBackBtn.addEventListener('click', () => this.exitConversationView());
                this.elements.viewProfileBtn.addEventListener('click', () => this.viewUserProfile());
                
                // Settings
                this.elements.settingsBtn.addEventListener('click', () => this.showSettingsModal());
                this.elements.closeSettingsModal.addEventListener('click', () => this.hideSettingsModal());
                this.elements.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
                this.elements.savePricingBtn.addEventListener('click', () => this.saveCustomPricing());
                
                // Message Input
                this.elements.chatInput.addEventListener('input', () => {
                    this.handleInputResize();
                    this.updateWordCounter();
                });
                
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.elements.sendMessageBtn.addEventListener('click', () => this.sendMessage());
                this.elements.attachBtn.addEventListener('click', () => this.handleAttachFile());
                this.elements.voiceBtn.addEventListener('click', () => this.startRecording());
                
                // Voice Recording
                this.elements.cancelRecordingBtn.addEventListener('click', () => this.cancelRecording());
                this.elements.sendRecordingBtn.addEventListener('click', () => this.stopRecording());
                
                // Voice Preview
                this.elements.voicePreviewPlayBtn.addEventListener('click', () => this.toggleVoicePlayback());
                this.elements.deleteVoiceBtn.addEventListener('click', () => this.deleteVoicePreview());
                this.elements.sendVoiceBtn.addEventListener('click', () => this.sendVoiceMessage());
                
                // Media Preview
                this.elements.sendMediaBtn.addEventListener('click', () => this.sendMediaMessage());
                this.elements.cancelMediaBtn.addEventListener('click', () => this.cancelMedia());
                
                // Context Menu
                this.elements.blockUserBtn.addEventListener('click', () => this.blockUser());
                this.elements.reportUserBtn.addEventListener('click', () => this.reportUser());
                
                // Close context menu when clicking elsewhere
                document.addEventListener('click', (e) => {
                    if (!this.elements.contextMenu.contains(e.target)) {
                        this.hideContextMenu();
                    }
                });

                // Notifications
                this.elements.notificationsBtn.addEventListener('click', () => this.requestNotificationPermission());
            }

            setupScrollBehavior() {
                const chatList = this.elements.chatList;
                let lastScrollTop = 0;
                
                chatList.addEventListener('scroll', () => {
                    const scrollTop = chatList.scrollTop;
                    const userProfilesSection = this.elements.userProfilesSection;
                    
                    if (scrollTop > lastScrollTop && scrollTop > 50) {
                        // Scrolling down - hide user profiles
                        userProfilesSection.style.transform = 'translateY(-100%)';
                        userProfilesSection.style.opacity = '0';
                    } else {
                        // Scrolling up - show user profiles
                        userProfilesSection.style.transform = 'translateY(0)';
                        userProfilesSection.style.opacity = '1';
                    }
                    
                    lastScrollTop = scrollTop;
                });
            }

            setupContextMenu() {
                // Add context menu to chat list items
                this.elements.chatList.addEventListener('contextmenu', (e) => {
                    const chatItem = e.target.closest('.chat-list-item');
                    if (chatItem) {
                        e.preventDefault();
                        this.showContextMenu(e, chatItem);
                    }
                });

                this.elements.userProfilesScroll.addEventListener('contextmenu', (e) => {
                    const userProfile = e.target.closest('.user-profile-item');
                    if (userProfile) {
                        e.preventDefault();
                        this.showContextMenu(e, userProfile);
                    }
                });
            }

            showContextMenu(e, element) {
                const userId = element.getAttribute('data-user-id');
                
                if (!userId) return;

                this.state.contextMenu.targetUser = userId;
                this.state.contextMenu.targetElement = element;

                this.elements.contextMenu.style.left = e.pageX + 'px';
                this.elements.contextMenu.style.top = e.pageY + 'px';
                this.elements.contextMenu.classList.add('active');
            }

            hideContextMenu() {
                this.elements.contextMenu.classList.remove('active');
                this.state.contextMenu.targetUser = null;
                this.state.contextMenu.targetElement = null;
            }

            async blockUser() {
                const userId = this.state.contextMenu.targetUser;
                if (!userId) return;

                try {
                    // Add to blocked users list
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            blockedUsers: firebase.firestore.FieldValue.arrayUnion(userId)
                        });

                    this.state.blockedUsers.push(userId);
                    this.hideContextMenu();
                    this.showNotification('User Blocked', 'This user can no longer message you');
                    
                    // Remove from UI
                    if (this.state.contextMenu.targetElement) {
                        this.state.contextMenu.targetElement.remove();
                    }
                    
                } catch (error) {
                    console.error('Error blocking user:', error);
                    this.showError('Failed to block user');
                }
            }

            async reportUser() {
                const userId = this.state.contextMenu.targetUser;
                if (!userId) return;

                const reason = prompt('Please enter the reason for reporting this user:');
                if (!reason) return;

                try {
                    await firebase.firestore()
                        .collection('reports')
                        .add({
                            reporterId: this.state.currentUser.uid,
                            reportedUserId: userId,
                            reason: reason,
                            timestamp: new Date().toISOString(),
                            status: 'pending'
                        });

                    this.hideContextMenu();
                    this.showNotification('User Reported', 'Thank you for your report. We will review it shortly.');
                    
                } catch (error) {
                    console.error('Error reporting user:', error);
                    this.showError('Failed to report user');
                }
            }

            setupBrowserNotifications() {
                if (!("Notification" in window)) {
                    console.log("This browser does not support notifications");
                    return;
                }

                // Create notification sound
                this.state.notificationSound = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA");
            }

            async requestNotificationPermission() {
                if (Notification.permission === "granted") {
                    this.showNotification('Notifications', 'Notifications are already enabled');
                    return;
                }

                if (Notification.permission !== "denied") {
                    try {
                        const permission = await Notification.requestPermission();
                        if (permission === "granted") {
                            this.showNotification('Notifications Enabled', 'You will now receive notifications for new messages');
                        }
                    } catch (error) {
                        console.error('Error requesting notification permission:', error);
                    }
                }
            }

            showBrowserNotification(title, body) {
                if (Notification.permission !== "granted") return;
                if (!document.hidden) return;

                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon.png',
                    badge: '/badge-icon.png'
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };

                setTimeout(() => notification.close(), 5000);
                
                // Play notification sound
                if (this.state.settings.messageSounds === 'enabled' && this.state.notificationSound) {
                    this.state.notificationSound.play().catch(() => {});
                }
            }

            async checkAuthStatus() {
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                            console.log('User authenticated:', user.uid);
                            resolve();
                        } else {
                            console.log('No user signed in, redirecting to login...');
                            window.location.href = 'index.html';
                        }
                    });
                });
            }

            async loadUserProfile() {
                if (!this.state.currentUser) return;

                try {
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .get();

                    if (userDoc.exists) {
                        this.state.userProfile = userDoc.data();
                        this.state.balance = this.state.userProfile.balance || 0;
                        this.state.freeMessagesRemaining = 3 - (this.state.userProfile.freeMessagesUsed || 0);
                        this.state.blockedUsers = this.state.userProfile.blockedUsers || [];
                        
                        this.elements.balanceAmount.textContent = `₦${this.state.balance}`;
                        
                        // Update earnings
                        const totalEarnings = this.state.userProfile.totalEarnings || 0;
                        const availableEarnings = this.state.userProfile.availableEarnings || 0;
                        this.elements.totalEarnings.textContent = `₦${totalEarnings}`;
                        this.elements.availableEarnings.textContent = `₦${availableEarnings}`;
                        
                        // Load pricing
                        if (this.state.userProfile.customPricing) {
                            this.elements.textMessagePrice.value = this.state.userProfile.customPricing.text || 10;
                            this.elements.voiceMessagePrice.value = this.state.userProfile.customPricing.voice || 30;
                            this.elements.imageMessagePrice.value = this.state.userProfile.customPricing.image || 15;
                        }
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async loadNetworkUsers() {
                if (!this.state.currentUser) return;
                
                try {
                    // Create mock network users for demonstration
                    this.state.networkUsers = [
                        {
                            id: 'user1',
                            name: 'John Doe',
                            profilePicture: null,
                            onlineStatus: 'online',
                            isMentor: true,
                            isVerified: false
                        },
                        {
                            id: 'user2', 
                            name: 'Jane Smith',
                            profilePicture: null,
                            onlineStatus: 'away',
                            isMentor: false,
                            isVerified: true
                        },
                        {
                            id: 'user3',
                            name: 'Mike Johnson',
                            profilePicture: null,
                            onlineStatus: 'offline',
                            isMentor: true,
                            isVerified: true
                        }
                    ];
                    
                    this.renderNetworkUsers();
                } catch (error) {
                    console.error('Error loading network users:', error);
                }
            }

            renderNetworkUsers() {
                const usersHTML = this.state.networkUsers.map(user => {
                    let statusBadges = '';
                    if (user.isMentor) {
                        statusBadges += '<span class="status-badge mentor"><i class="fas fa-graduation-cap"></i></span>';
                    }
                    if (user.isVerified) {
                        statusBadges += '<span class="status-badge verified"><i class="fas fa-check"></i></span>';
                    }
                    
                    return `
                        <div class="user-profile-item" data-user-id="${user.id}">
                            <div class="user-profile-avatar">
                                ${user.name.charAt(0).toUpperCase()}
                                <div class="status-indicator status-${user.onlineStatus}"></div>
                            </div>
                            <div class="user-profile-name">${user.name}${statusBadges}</div>
                        </div>
                    `;
                }).join('');
                
                this.elements.userProfilesScroll.innerHTML = usersHTML;
                
                // Add event listeners
                this.elements.userProfilesScroll.querySelectorAll('.user-profile-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const userId = item.getAttribute('data-user-id');
                        this.startConversation(userId);
                    });
                });
            }

            async loadConversations() {
                if (!this.state.currentUser) return;

                try {
                    // Create mock conversations for demonstration
                    this.state.conversations = [
                        {
                            id: 'conv1',
                            participants: [this.state.currentUser.uid, 'user1'],
                            participantsData: {
                                [this.state.currentUser.uid]: {
                                    name: this.state.userProfile?.name || 'You',
                                    profilePicture: null,
                                    onlineStatus: 'online'
                                },
                                'user1': {
                                    name: 'John Doe',
                                    profilePicture: null,
                                    onlineStatus: 'online',
                                    isMentor: true
                                }
                            },
                            lastMessage: 'Hello there!',
                            lastMessageType: 'text',
                            lastMessageSender: 'user1',
                            lastMessageAt: new Date(Date.now() - 300000).toISOString(), // 5 minutes ago
                            unreadCount: {
                                [this.state.currentUser.uid]: 1
                            }
                        },
                        {
                            id: 'conv2',
                            participants: [this.state.currentUser.uid, 'user2'],
                            participantsData: {
                                [this.state.currentUser.uid]: {
                                    name: this.state.userProfile?.name || 'You',
                                    profilePicture: null,
                                    onlineStatus: 'online'
                                },
                                'user2': {
                                    name: 'Jane Smith',
                                    profilePicture: null,
                                    onlineStatus: 'away',
                                    isVerified: true
                                }
                            },
                            lastMessage: 'Can you help me with this?',
                            lastMessageType: 'text',
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                            unreadCount: {
                                [this.state.currentUser.uid]: 0
                            }
                        }
                    ];
                    
                    this.renderConversations();
                    this.setupConversationsListener();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            setupConversationsListener() {
                // Simulate real-time updates
                setInterval(() => {
                    this.updateNotificationBadge();
                }, 5000);
            }

            updateNotificationBadge() {
                const totalUnread = this.state.conversations.reduce((total, conversation) => {
                    return total + (conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0);
                }, 0);
                
                if (totalUnread > 0) {
                    this.elements.notificationBadge.textContent = totalUnread;
                    this.elements.notificationBadge.style.display = 'flex';
                } else {
                    this.elements.notificationBadge.style.display = 'none';
                }
            }

            renderConversations() {
                const conversationsHTML = this.state.conversations.map(conversation => {
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const isActive = this.state.activeConversation && this.state.activeConversation.id === conversation.id;
                    const unreadCount = conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0;
                    
                    let statusBadges = '';
                    if (otherParticipant && otherParticipant.isMentor) {
                        statusBadges += '<span class="status-badge mentor"><i class="fas fa-graduation-cap"></i></span>';
                    }
                    if (otherParticipant && otherParticipant.isVerified) {
                        statusBadges += '<span class="status-badge verified"><i class="fas fa-check"></i></span>';
                    }
                    
                    return `
                        <div class="chat-list-item ${isActive ? 'active' : ''}" data-conversation-id="${conversation.id}" data-user-id="${otherParticipantId}">
                            <div class="chat-avatar">
                                ${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}
                                <div class="status-indicator ${otherParticipant ? `status-${otherParticipant.onlineStatus}` : 'status-offline'}"></div>
                            </div>
                            <div class="chat-info">
                                <div class="chat-header-info">
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}${statusBadges}</div>
                                    <div class="chat-time">${this.formatTime(conversation.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    ${conversation.lastMessageType === 'voice' ? '<i class="fas fa-microphone"></i> Voice message' : 
                                      conversation.lastMessageType === 'image' ? '<i class="fas fa-image"></i> Image' : conversation.lastMessage}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.elements.chatList.innerHTML = conversationsHTML;
                
                // Add event listeners
                this.elements.chatList.querySelectorAll('.chat-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        this.loadConversation(conversationId);
                    });
                });
            }

            async loadConversation(conversationId) {
                try {
                    console.log('Loading conversation:', conversationId);
                    
                    // Find conversation in state
                    const conversation = this.state.conversations.find(conv => conv.id === conversationId);
                    if (!conversation) {
                        this.showError('Conversation not found');
                        return;
                    }
                    
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Update URL
                    this.updateURLWithConversation(conversationId);
                    
                    // Get user data
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData[otherParticipantId];
                    
                    this.state.activeConversation.user = {
                        id: otherParticipantId,
                        ...otherParticipant
                    };
                    
                    // Check if paid conversation
                    if (otherParticipant.isMentor || otherParticipant.isVerified) {
                        this.state.recipientPricing = {
                            text: appConfig.textMessagePrice,
                            voice: appConfig.voiceMessagePrice,
                            image: appConfig.imageMessagePrice
                        };
                        this.showPricingDisplay();
                    } else {
                        this.hidePricingDisplay();
                    }
                    
                    // Load messages
                    await this.loadMessages();
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    
                    // Mark as read
                    await this.markAsRead();
                    
                    // Highlight active conversation
                    this.highlightActiveConversation(conversationId);
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    this.showError('Failed to load conversation');
                }
            }

            async loadMessages() {
                if (!this.state.conversationId) return;

                try {
                    // Create mock messages for demonstration
                    this.state.messages = [
                        {
                            id: '1',
                            senderId: 'user1',
                            content: 'Hello! How can I help you today?',
                            type: 'text',
                            createdAt: new Date(Date.now() - 300000).toISOString()
                        },
                        {
                            id: '2', 
                            senderId: this.state.currentUser.uid,
                            content: 'I need some advice about your services',
                            type: 'text',
                            createdAt: new Date(Date.now() - 240000).toISOString()
                        },
                        {
                            id: '3',
                            senderId: 'user1',
                            content: 'Sure, I\'d be happy to help! What would you like to know?',
                            type: 'text',
                            createdAt: new Date(Date.now() - 180000).toISOString()
                        }
                    ];
                    
                    this.renderMessages();
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            renderMessages() {
                if (!this.state.messages.length) {
                    this.elements.messagesArea.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-alt"></i>
                            <h3>No messages yet</h3>
                            <p>Send a message to start the conversation.</p>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = this.state.messages.map(message => {
                    const isSent = message.senderId === this.state.currentUser.uid;
                    
                    let messageContent = '';
                    
                    if (message.type === 'text') {
                        messageContent = `<div class="message-text">${message.content}</div>`;
                    } else if (message.type === 'image') {
                        messageContent = `
                            <div class="message-media">
                                <img src="${message.mediaUrl}" alt="Shared image">
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        messageContent = `
                            <div class="voice-message">
                                <button class="voice-play-btn">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="voice-waveform">
                                    ${this.generateVoiceWaveform()}
                                </div>
                                <div class="voice-duration">${message.duration || '0:00'}</div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            ${messageContent}
                            <div class="message-time">${this.formatTime(message.createdAt)}</div>
                        </div>
                    `;
                }).join('');
                
                this.elements.messagesArea.innerHTML = messagesHTML;
                this.scrollToBottom();
            }

            async startConversation(userId) {
                try {
                    console.log('Starting conversation with user:', userId);
                    
                    // Check if conversation already exists
                    const existingConversation = this.state.conversations.find(conv => 
                        conv.participants.includes(userId)
                    );
                    
                    if (existingConversation) {
                        await this.loadConversation(existingConversation.id);
                        return;
                    }
                    
                    // Find user data
                    const user = this.state.networkUsers.find(u => u.id === userId);
                    if (!user) {
                        this.showError('User not found');
                        return;
                    }
                    
                    // Create new conversation
                    const conversationId = 'conv_' + Date.now();
                    const conversation = {
                        id: conversationId,
                        participants: [this.state.currentUser.uid, userId],
                        participantsData: {
                            [this.state.currentUser.uid]: {
                                name: this.state.userProfile?.name || 'You',
                                profilePicture: null,
                                onlineStatus: 'online'
                            },
                            [userId]: {
                                ...user
                            }
                        },
                        messages: [],
                        lastMessage: '',
                        lastMessageType: '',
                        lastMessageSender: '',
                        lastMessageAt: new Date().toISOString(),
                        unreadCount: {
                            [this.state.currentUser.uid]: 0,
                            [userId]: 0
                        }
                    };
                    
                    this.state.conversations.unshift(conversation);
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Update URL
                    this.updateURLWithConversation(conversationId);
                    
                    // Check if paid conversation
                    if (user.isMentor || user.isVerified) {
                        this.state.recipientPricing = {
                            text: appConfig.textMessagePrice,
                            voice: appConfig.voiceMessagePrice,
                            image: appConfig.imageMessagePrice
                        };
                        this.showPricingDisplay();
                    } else {
                        this.hidePricingDisplay();
                    }
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    
                    // Render conversations to show new one
                    this.renderConversations();
                    this.highlightActiveConversation(conversationId);
                    
                } catch (error) {
                    console.error('Error starting conversation:', error);
                    this.showError('Failed to start conversation');
                }
            }

            async sendMessage() {
                const content = this.elements.chatInput.value.trim();
                if (!content && !this.state.mediaFile && !this.state.voiceNote) return;

                try {
                    let message = {
                        id: Date.now().toString(),
                        senderId: this.state.currentUser.uid,
                        content: content,
                        type: 'text',
                        createdAt: new Date().toISOString()
                    };

                    // Handle media files
                    if (this.state.mediaFile) {
                        message.type = 'image';
                        message.mediaUrl = URL.createObjectURL(this.state.mediaFile);
                        message.content = '';
                    }

                    // Handle voice notes
                    if (this.state.voiceNote) {
                        message.type = 'voice';
                        message.mediaUrl = this.state.voiceNote.url;
                        message.duration = this.state.voiceNote.duration;
                        message.content = '';
                    }

                    // Add message to conversation
                    this.state.messages.push(message);
                    
                    // Update conversation last message
                    if (this.state.activeConversation) {
                        this.state.activeConversation.lastMessage = content || (message.type === 'voice' ? 'Voice message' : 'Media');
                        this.state.activeConversation.lastMessageType = message.type;
                        this.state.activeConversation.lastMessageSender = this.state.currentUser.uid;
                        this.state.activeConversation.lastMessageAt = new Date().toISOString();
                    }

                    // Re-render
                    this.renderMessages();
                    this.renderConversations();

                    // Clear input and reset state
                    this.elements.chatInput.value = '';
                    this.state.mediaFile = null;
                    this.state.voiceNote = null;
                    this.hideMediaPreview();
                    this.hideVoicePreview();
                    this.handleInputResize();
                    this.updateWordCounter();

                    // Show browser notification to recipient (simulated)
                    if (this.state.activeConversation && this.state.activeConversation.user) {
                        this.showBrowserNotification(
                            `New message from ${this.state.userProfile?.name || 'You'}`,
                            content || (message.type === 'voice' ? 'Sent a voice message' : 'Sent a media file')
                        );
                    }

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message');
                }
            }

            async markAsRead() {
                if (!this.state.conversationId) return;

                try {
                    // Mark conversation as read in UI
                    const conversation = this.state.conversations.find(conv => conv.id === this.state.conversationId);
                    if (conversation && conversation.unreadCount) {
                        conversation.unreadCount[this.state.currentUser.uid] = 0;
                        this.renderConversations();
                        this.updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }

            // Voice Recording
            async startRecording() {
                try {
                    console.log('Starting voice recording...');
                    
                    // Use Agora audio manager if available
                    if (typeof agoraAudioManager !== 'undefined') {
                        await agoraAudioManager.startRecording();
                    } else {
                        await this.startStandardRecording();
                    }
                    
                    this.state.isRecording = true;
                    this.state.recordingStartTime = Date.now();
                    
                    // Show voice recorder UI
                    this.elements.voiceRecorder.classList.add('active');
                    
                    // Start timer
                    this.state.recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        this.elements.recordingTimer.textContent = this.formatAudioTime(elapsed);
                        this.animateWaveform();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Could not access microphone');
                }
            }

            async startStandardRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    this.state.audioChunks = [];
                    this.state.mediaRecorder = new MediaRecorder(stream);
                    
                    this.state.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.state.audioChunks.push(event.data);
                        }
                    };
                    
                    this.state.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/webm' });
                        const duration = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        
                        this.state.voiceNote = {
                            blob: audioBlob,
                            duration: this.formatAudioTime(duration),
                            url: URL.createObjectURL(audioBlob)
                        };
                        
                        // Stop stream
                        stream.getTracks().forEach(track => track.stop());
                        this.showVoicePreview();
                    };
                    
                    this.state.mediaRecorder.start();
                    
                } catch (error) {
                    console.error('Error in standard recording:', error);
                    throw error;
                }
            }

            animateWaveform() {
                if (!this.state.isRecording) return;
                
                this.elements.voiceWaveform.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 20) + 5;
                    const bar = document.createElement('div');
                    bar.className = 'voice-bar';
                    bar.style.height = `${height}px`;
                    this.elements.voiceWaveform.appendChild(bar);
                }
            }

            async stopRecording() {
                if (this.state.isRecording) {
                    if (typeof agoraAudioManager !== 'undefined' && agoraAudioManager.isRecording) {
                        this.state.voiceNote = await agoraAudioManager.stopRecording();
                    } else if (this.state.mediaRecorder) {
                        this.state.mediaRecorder.stop();
                    }
                    
                    this.state.isRecording = false;
                    this.elements.voiceRecorder.classList.remove('active');
                    
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                        this.state.recordingTimer = null;
                    }
                }
            }

            cancelRecording() {
                this.stopRecording();
                this.state.voiceNote = null;
                this.hideVoicePreview();
            }

            showVoicePreview() {
                if (!this.state.voiceNote) return;
                
                this.elements.voicePreviewDuration.textContent = this.state.voiceNote.duration;
                this.elements.voicePreview.classList.add('active');
                this.generateVoicePreviewWaveform();
            }

            hideVoicePreview() {
                this.elements.voicePreview.classList.remove('active');
                this.state.voiceNote = null;
            }

            generateVoicePreviewWaveform() {
                this.elements.voicePreviewWaveform.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 30) + 10;
                    const bar = document.createElement('div');
                    bar.className = 'voice-preview-bar';
                    bar.style.height = `${height}px`;
                    this.elements.voicePreviewWaveform.appendChild(bar);
                }
            }

            toggleVoicePlayback() {
                if (!this.state.voiceNote) return;
                
                if (!this.state.audioPlayer) {
                    this.state.audioPlayer = new Audio(this.state.voiceNote.url);
                    this.state.audioPlayer.addEventListener('ended', () => {
                        this.state.isPlaying = false;
                        this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                    });
                }
                
                if (this.state.isPlaying) {
                    this.state.audioPlayer.pause();
                    this.state.isPlaying = false;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    this.state.audioPlayer.play();
                    this.state.isPlaying = true;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                }
            }

            deleteVoicePreview() {
                if (this.state.audioPlayer) {
                    this.state.audioPlayer.pause();
                    this.state.audioPlayer = null;
                }
                this.state.isPlaying = false;
                this.hideVoicePreview();
            }

            sendVoiceMessage() {
                this.sendMessage();
            }

            // Media Handling
            handleAttachFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.previewMedia(file);
                    }
                };
                input.click();
            }

            previewMedia(file) {
                this.state.mediaFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.elements.mediaPreviewImage.src = e.target.result;
                    this.elements.mediaPreviewName.textContent = file.name;
                    this.elements.mediaPreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }

            sendMediaMessage() {
                this.sendMessage();
            }

            cancelMedia() {
                this.state.mediaFile = null;
                this.hideMediaPreview();
            }

            hideMediaPreview() {
                this.elements.mediaPreview.classList.remove('active');
            }

            // UI Methods
            enterConversationView() {
                this.state.isInConversationView = true;
                this.elements.mainContainer.classList.add('conversation-view');
                this.elements.conversationView.style.display = 'block';
                this.elements.emptyState.style.display = 'none';
                this.elements.floatingSearch.style.display = 'none';
            }

            exitConversationView() {
                this.state.isInConversationView = false;
                this.elements.mainContainer.classList.remove('conversation-view');
                this.elements.conversationView.style.display = 'none';
                this.elements.emptyState.style.display = 'flex';
                this.elements.floatingSearch.style.display = 'flex';
                this.state.activeConversation = null;
                this.state.conversationId = null;
                
                // Remove conversation from URL
                const url = new URL(window.location);
                url.searchParams.delete('conversation');
                window.history.replaceState({}, '', url);
                
                // Remove active highlights
                this.removeActiveHighlights();
            }

            updateConversationHeader() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                
                const user = this.state.activeConversation.user;
                this.elements.conversationUserName.textContent = user.name;
                this.elements.conversationAvatar.textContent = user.name.charAt(0).toUpperCase();
                
                const status = user.onlineStatus || 'offline';
                this.elements.conversationUserStatus.innerHTML = `
                    <span class="status-indicator status-${status}"></span>
                    <span id="statusText">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
            }

            highlightActiveConversation(conversationId) {
                this.removeActiveHighlights();
                
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
                
                if (this.state.activeConversation && this.state.activeConversation.user) {
                    const userProfile = document.querySelector(`[data-user-id="${this.state.activeConversation.user.id}"]`);
                    if (userProfile) {
                        userProfile.classList.add('active');
                    }
                }
            }

            removeActiveHighlights() {
                document.querySelectorAll('.user-profile-item, .chat-list-item').forEach(item => {
                    item.classList.remove('active');
                });
            }

            handleInputResize() {
                const textarea = this.elements.chatInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            updateWordCounter() {
                const content = this.elements.chatInput.value.trim();
                if (!content || !this.state.recipientPricing) {
                    this.elements.wordCounter.style.display = 'none';
                    return;
                }
                
                const wordCount = content.split(/\s+/).length;
                const cost = this.state.recipientPricing.text;
                
                this.elements.wordCounter.textContent = `${wordCount}/35 words • ₦${cost}`;
                this.elements.wordCounter.style.display = 'block';
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
                }, 100);
            }

            viewUserProfile() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                this.showNotification('Profile', `Viewing profile of ${this.state.activeConversation.user.name}`);
            }

            showPricingDisplay() {
                if (this.state.recipientPricing) {
                    this.elements.textPriceDisplay.textContent = `₦${this.state.recipientPricing.text}`;
                    this.elements.voicePriceDisplay.textContent = `₦${this.state.recipientPricing.voice}/min`;
                    this.elements.imagePriceDisplay.textContent = `₦${this.state.recipientPricing.image}`;
                    this.elements.pricingDisplay.style.display = 'flex';
                }
            }

            hidePricingDisplay() {
                this.elements.pricingDisplay.style.display = 'none';
            }

            updateURLWithConversation(conversationId) {
                const url = new URL(window.location);
                url.searchParams.set('conversation', conversationId);
                window.history.replaceState({}, '', url);
            }

            async handleURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const conversationId = urlParams.get('conversation');
                
                if (conversationId) {
                    await this.loadConversation(conversationId);
                }
            }

            // Settings Methods
            showSettingsModal() {
                this.elements.onlineStatus.value = this.state.settings.onlineStatus;
                this.elements.messageSounds.value = this.state.settings.messageSounds;
                this.elements.browserNotifications.value = this.state.settings.browserNotifications;
                this.elements.settingsModal.classList.add('active');
            }

            hideSettingsModal() {
                this.elements.settingsModal.classList.remove('active');
            }

            async saveSettings() {
                try {
                    this.state.settings.onlineStatus = this.elements.onlineStatus.value;
                    this.state.settings.messageSounds = this.elements.messageSounds.value;
                    this.state.settings.browserNotifications = this.elements.browserNotifications.value;
                    
                    this.showNotification('Settings Saved', 'Your settings have been updated');
                    this.hideSettingsModal();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Failed to save settings');
                }
            }

            async saveCustomPricing() {
                try {
                    const textPrice = parseInt(this.elements.textMessagePrice.value);
                    const voicePrice = parseInt(this.elements.voiceMessagePrice.value);
                    const imagePrice = parseInt(this.elements.imageMessagePrice.value);
                    
                    // Validate prices
                    if (textPrice < 5 || textPrice > 1000 || voicePrice < 10 || voicePrice > 5000 || imagePrice < 5 || imagePrice > 1000) {
                        this.showError('Please enter valid prices within the allowed ranges');
                        return;
                    }
                    
                    this.showNotification('Pricing Updated', 'Your custom pricing has been saved');
                } catch (error) {
                    console.error('Error saving custom pricing:', error);
                    this.showError('Failed to save custom pricing');
                }
            }

            // Utility Methods
            formatTime(timestamp) {
                if (!timestamp) return 'Just now';
                const now = new Date();
                const time = new Date(timestamp);
                const diff = now - time;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (days > 0) return `${days}d ago`;
                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return 'Just now';
            }

            formatAudioTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            generateVoiceWaveform() {
                let waveform = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 20) + 5;
                    waveform += `<div class="voice-bar" style="height: ${height}px;"></div>`;
                }
                return waveform;
            }

            showError(message) {
                this.showNotification('Error', message, 'error');
            }

            showNotification(title, message, type = 'success') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'error' ? 'var(--warning-color)' : 'var(--primary-color)'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideInRight 0.3s ease;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">${title}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${message}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
                
                @keyframes glowPulse {
                    0% { 
                        transform: scale(1);
                        box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
                    }
                    50% { 
                        transform: scale(1.05);
                        box-shadow: 0 0 20px rgba(67, 97, 238, 0.8);
                    }
                    100% { 
                        transform: scale(1);
                        box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
                    }
                }
                
                .user-profile-item.active,
                .chat-list-item.active {
                    animation: glowPulse 2s infinite;
                }
            `;
            document.head.appendChild(style);

            // Initialize chat application
            window.connectXChat = new ConnectXChat();
        });
    </script>
</body>
</html>
