<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectX - Messages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --gray-color: #6c757d;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-color: #333333;
            --message-sent: #4361ee;
            --message-received: #f0f0f0;
            --input-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 24px;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-actions i {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .header-actions i:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        .new-chat-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .new-chat-btn:hover {
            transform: scale(1.05);
        }

        .search-container {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: var(--body-bg);
            border-radius: 20px;
            padding: 12px 15px;
            transition: var(--transition);
        }

        .search-box:focus-within {
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .search-box i {
            color: var(--gray-color);
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            flex: 1;
            color: var(--text-color);
            font-size: 15px;
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-hover);
            z-index: 10;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-dropdown.active {
            display: block;
        }

        .search-dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .search-dropdown-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .search-dropdown-item:last-child {
            border-bottom: none;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-list-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .chat-list-item.active {
            background-color: rgba(67, 97, 238, 0.08);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            position: relative;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        .status-online {
            background-color: #4ade80;
        }

        .status-away {
            background-color: #f59e0b;
        }

        .status-offline {
            background-color: #9ca3af;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: var(--gray-color);
            font-size: 12px;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            color: var(--gray-color);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        /* User Profiles Section */
        .user-profiles-section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-profiles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-profiles-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .user-profiles-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 5px;
            scrollbar-width: thin;
        }

        .user-profiles-scroll::-webkit-scrollbar {
            height: 5px;
        }

        .user-profiles-scroll::-webkit-scrollbar-thumb {
            background-color: var(--gray-color);
            border-radius: 10px;
        }

        .user-profile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            min-width: 70px;
        }

        .user-profile-item:hover {
            transform: translateY(-2px);
        }

        .user-profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            position: relative;
        }

        .user-profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile-name {
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            position: relative;
        }

        /* Conversation Header */
        .conversation-header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .conversation-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-back-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            margin-right: 5px;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .conversation-user-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .conversation-user-details p {
            color: var(--gray-color);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .conversation-actions {
            display: flex;
            gap: 10px;
        }

        .conversation-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-color);
            background: none;
            border: none;
        }

        .conversation-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23f0f2f5' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.2s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--message-sent);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--message-received);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-media {
            margin-top: 8px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .message-media img {
            width: 100%;
            display: block;
        }

        /* Voice Message */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            margin-top: 8px;
        }

        .message.received .voice-message {
            background: rgba(0,0,0,0.05);
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message.received .voice-play-btn {
            background: rgba(0,0,0,0.1);
            color: var(--text-color);
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.6);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .message.received .voice-bar {
            background: rgba(0,0,0,0.3);
        }

        .voice-duration {
            font-size: 12px;
            min-width: 40px;
            text-align: center;
            opacity: 0.8;
        }

        /* Input Area */
        .input-area {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .balance-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .chat-input-wrapper {
            flex: 1;
            background-color: var(--input-bg);
            border-radius: 24px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            display: flex;
            align-items: flex-end;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            line-height: 1.4;
            max-height: 120px;
            min-height: 24px;
            resize: none;
            padding: 4px 0;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: var(--gray-color);
        }

        .input-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .input-action-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            transform: none;
        }

        /* Voice Recorder */
        .voice-recorder {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 200px;
        }

        .voice-recorder.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning-color);
            font-weight: 600;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-timer {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .recording-actions {
            display: flex;
            gap: 15px;
        }

        .record-action-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .record-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .record-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        .record-action-btn:hover {
            transform: scale(1.1);
        }

        /* Voice Preview */
        .voice-preview {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 250px;
        }

        .voice-preview.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        .voice-preview-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .voice-preview-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .voice-preview-play-btn:hover {
            transform: scale(1.05);
        }

        .voice-preview-waveform {
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-preview-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .voice-preview-duration {
            font-size: 14px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
        }

        .voice-preview-actions {
            display: flex;
            gap: 10px;
        }

        .voice-preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .voice-preview-action-btn.delete {
            background-color: var(--warning-color);
            color: white;
        }

        .voice-preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        /* Media Preview */
        .media-preview {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .media-preview.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .media-preview-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .media-preview img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .media-preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .preview-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .empty-state p {
            max-width: 300px;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background-color: var(--message-received);
            border-radius: 18px;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-bottom: 8px;
            max-width: 70px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Word Counter */
        .word-counter {
            font-size: 12px;
            color: var(--gray-color);
            text-align: right;
            margin-top: 5px;
            display: none;
        }

        .word-counter.near-limit {
            color: var(--warning-color);
        }

        /* Settings Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: translateY(20px) scale(0.95);
            transition: var(--transition);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .close-modal {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .close-modal:hover {
            color: var(--warning-color);
            background-color: rgba(247, 37, 133, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 15px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .pricing-info, .earnings-info {
            background: rgba(67, 97, 238, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .pricing-item, .earnings-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .pricing-item:last-child, .earnings-item:last-child {
            margin-bottom: 0;
        }

        .pricing-label, .earnings-label {
            color: var(--gray-color);
        }

        .pricing-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .earnings-value {
            font-weight: 600;
            color: var(--success-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                height: 100%;
            }
            
            .chat-area {
                width: 100%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .conversation-header {
                padding: 12px 15px;
            }
            
            .messages-area {
                padding: 15px;
            }
            
            .input-area {
                padding: 12px 15px;
            }
        }

        /* Hide elements when in conversation view */
        .conversation-view header,
        .conversation-view .sidebar {
            display: none;
        }

        .conversation-view .chat-area {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>ConnectX Messages</h1>
        </div>
        <div class="header-actions">
            <i class="fas fa-cog" id="settingsBtn"></i>
            <a href="home.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home"></i>
            </a>
            <div style="position: relative;">
                <i class="fas fa-bell" id="notificationsBtn"></i>
                <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Sidebar with Chat List -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Conversations</h2>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box" id="searchBox">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchChats" placeholder="Search conversations...">
                </div>
                <div class="search-dropdown" id="searchDropdown">
                    <!-- Search results will be populated here -->
                </div>
            </div>
            
            <!-- User Profiles Section -->
            <div class="user-profiles-section">
                <div class="user-profiles-header">
                    <h3>Your Network</h3>
                    <i class="fas fa-ellipsis-h"></i>
                </div>
                <div class="user-profiles-scroll" id="userProfilesScroll">
                    <!-- User profiles will be populated here -->
                </div>
            </div>
            
            <div class="chat-list" id="chatList">
                <!-- Chat list will be populated here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <h3>No conversation selected</h3>
                <p>Select a conversation from the list or start a new chat to begin messaging.</p>
            </div>
            
            <!-- Conversation View (hidden by default) -->
            <div class="conversation-view" id="conversationView" style="display: none;">
                <!-- Conversation Header -->
                <div class="conversation-header">
                    <div class="conversation-user-info">
                        <button class="conversation-back-btn" id="conversationBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="conversation-avatar" id="conversationAvatar">
                            <!-- Avatar will be loaded here -->
                        </div>
                        <div class="conversation-user-details">
                            <h3 id="conversationUserName">User Name</h3>
                            <p id="conversationUserStatus">
                                <span class="status-indicator status-online"></span>
                                <span id="statusText">Online</span>
                            </p>
                        </div>
                    </div>
                    <div class="conversation-actions">
                        <button class="conversation-action-btn" id="viewProfileBtn" title="View Profile">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="balance-info">
                        <i class="fas fa-wallet"></i>
                        <span>Balance: <span class="balance-amount" id="balanceAmount">₦0</span></span>
                        <span>• Text: ₦10 (35 words) • Voice: ₦30/min</span>
                    </div>
                    
                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="input-action-btn" id="attachBtn" title="Attach File">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="input-action-btn" id="voiceBtn" title="Record Voice">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <button class="send-btn" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="word-counter" id="wordCounter">0/35 words • ₦10</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voice Recorder -->
    <div class="voice-recorder" id="voiceRecorder">
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <span>Recording</span>
        </div>
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="voice-waveform" id="voiceWaveform">
            <!-- Voice bars will be generated here -->
        </div>
        <div class="recording-actions">
            <button class="record-action-btn cancel" id="cancelRecordingBtn">
                <i class="fas fa-times"></i>
            </button>
            <button class="record-action-btn send" id="sendRecordingBtn">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>
    
    <!-- Voice Preview -->
    <div class="voice-preview" id="voicePreview">
        <div class="recording-timer" id="voicePreviewDuration">00:00</div>
        <div class="voice-preview-controls">
            <button class="voice-preview-play-btn" id="voicePreviewPlayBtn">
                <i class="fas fa-play"></i>
            </button>
            <div class="voice-preview-waveform" id="voicePreviewWaveform">
                <!-- Voice bars will be generated here -->
            </div>
        </div>
        <div class="voice-preview-actions">
            <button class="voice-preview-action-btn delete" id="deleteVoiceBtn">Delete</button>
            <button class="voice-preview-action-btn send" id="sendVoiceBtn">Send</button>
        </div>
    </div>
    
    <!-- Media Preview -->
    <div class="media-preview" id="mediaPreview">
        <div class="media-preview-content">
            <img id="mediaPreviewImage" src="" alt="Preview">
            <div>
                <div id="mediaPreviewName">image.jpg</div>
                <div class="media-preview-actions">
                    <button class="preview-action-btn send" id="sendMediaBtn">Send</button>
                    <button class="preview-action-btn cancel" id="cancelMediaBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat Settings</h2>
                <i class="fas fa-times close-modal" id="closeSettingsModal"></i>
            </div>
            
            <div class="pricing-info">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Current Pricing</h3>
                <div class="pricing-item">
                    <span class="pricing-label">Text Message (35 words)</span>
                    <span class="pricing-value" id="currentTextPrice">₦10</span>
                </div>
                <div class="pricing-item">
                    <span class="pricing-label">Voice Message (per minute)</span>
                    <span class="pricing-value" id="currentVoicePrice">₦30</span>
                </div>
            </div>
            
            <div class="earnings-info">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Your Earnings</h3>
                <div class="earnings-item">
                    <span class="earnings-label">Total Earnings</span>
                    <span class="earnings-value" id="totalEarnings">₦0</span>
                </div>
                <div class="earnings-item">
                    <span class="earnings-label">Available for Withdrawal</span>
                    <span class="earnings-value" id="availableEarnings">₦0</span>
                </div>
            </div>
            
            <div id="customPricingSection" style="display: none;">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Custom Pricing</h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color);">
                    You've reached the eligibility criteria! You can now set your own pricing.
                </p>
                
                <div class="form-group">
                    <label for="textMessagePrice">Text Message Price (₦)</label>
                    <input type="number" id="textMessagePrice" min="5" max="100" value="10">
                </div>
                
                <div class="form-group">
                    <label for="voiceMessagePrice">Voice Message Price per Minute (₦)</label>
                    <input type="number" id="voiceMessagePrice" min="10" max="200" value="30">
                </div>
                
                <button class="btn btn-primary" id="savePricingBtn">Save Pricing</button>
            </div>
            
            <div class="form-group">
                <label for="onlineStatus">Online Status</label>
                <select id="onlineStatus">
                    <option value="online">Online</option>
                    <option value="away">Away</option>
                    <option value="busy">Busy</option>
                    <option value="offline">Offline</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="messageSounds">Message Sounds</label>
                <select id="messageSounds">
                    <option value="enabled">Enabled</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="browserNotifications">Browser Notifications</label>
                <select id="browserNotifications">
                    <option value="enabled">Enabled</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
            
            <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>

    <!-- External Configuration -->
    <script src="configuration.js"></script>
    <script src="agora.js"></script>

    <!-- External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Chat Script -->
    <script>
        // Professional Chat Application
        class ConnectXChat {
            constructor() {
                this.state = {
                    currentUser: null,
                    conversations: [],
                    activeConversation: null,
                    messages: [],
                    userProfile: null,
                    mediaFile: null,
                    isRecording: false,
                    recordingTimer: null,
                    recordingStartTime: null,
                    audioChunks: [],
                    mediaRecorder: null,
                    voiceNote: null,
                    conversationId: null,
                    isInConversationView: false,
                    balance: 0,
                    freeMessagesRemaining: 3,
                    settings: {
                        onlineStatus: 'online',
                        messageSounds: 'enabled',
                        browserNotifications: 'enabled',
                        textMessagePrice: 10,
                        voiceMessagePrice: 30
                    },
                    audioContext: null,
                    analyser: null,
                    dataArray: null,
                    animationId: null,
                    networkUsers: [],
                    searchResults: [],
                    isVoicePreview: false,
                    audioPlayer: null,
                    isPlaying: false
                };

                this.init();
            }

            async init() {
                try {
                    // Check if external configuration is loaded
                    if (typeof firebaseConfig === 'undefined') {
                        console.error('Configuration not loaded.');
                        this.showError('Configuration Error');
                        return;
                    }
                    
                    // Initialize Firebase if not already initialized
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    this.setupDOMReferences();
                    this.setupEventListeners();
                    await this.checkAuthStatus();
                    await this.loadUserProfile();
                    await this.loadConversations();
                    await this.loadNetworkUsers();
                    await this.handleURLParameters();
                    
                    console.log('ConnectX Chat initialized successfully');
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    this.showError('Initialization Error');
                }
            }

            setupDOMReferences() {
                this.elements = {
                    // Main container
                    mainContainer: document.getElementById('mainContainer'),
                    
                    // Header elements
                    settingsBtn: document.getElementById('settingsBtn'),
                    notificationsBtn: document.getElementById('notificationsBtn'),
                    notificationBadge: document.getElementById('notificationBadge'),
                    
                    // Sidebar elements
                    chatList: document.getElementById('chatList'),
                    searchChats: document.getElementById('searchChats'),
                    searchBox: document.getElementById('searchBox'),
                    searchDropdown: document.getElementById('searchDropdown'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    userProfilesScroll: document.getElementById('userProfilesScroll'),
                    
                    // Chat area elements
                    chatArea: document.getElementById('chatArea'),
                    emptyState: document.getElementById('emptyState'),
                    
                    // Conversation view elements
                    conversationView: document.getElementById('conversationView'),
                    conversationBackBtn: document.getElementById('conversationBackBtn'),
                    conversationAvatar: document.getElementById('conversationAvatar'),
                    conversationUserName: document.getElementById('conversationUserName'),
                    conversationUserStatus: document.getElementById('conversationUserStatus'),
                    statusText: document.getElementById('statusText'),
                    viewProfileBtn: document.getElementById('viewProfileBtn'),
                    messagesArea: document.getElementById('messagesArea'),
                    chatInput: document.getElementById('chatInput'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    attachBtn: document.getElementById('attachBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    wordCounter: document.getElementById('wordCounter'),
                    balanceAmount: document.getElementById('balanceAmount'),
                    
                    // Voice recording elements
                    voiceRecorder: document.getElementById('voiceRecorder'),
                    recordingTimer: document.getElementById('recordingTimer'),
                    voiceWaveform: document.getElementById('voiceWaveform'),
                    cancelRecordingBtn: document.getElementById('cancelRecordingBtn'),
                    sendRecordingBtn: document.getElementById('sendRecordingBtn'),
                    
                    // Voice preview elements
                    voicePreview: document.getElementById('voicePreview'),
                    voicePreviewDuration: document.getElementById('voicePreviewDuration'),
                    voicePreviewWaveform: document.getElementById('voicePreviewWaveform'),
                    voicePreviewPlayBtn: document.getElementById('voicePreviewPlayBtn'),
                    deleteVoiceBtn: document.getElementById('deleteVoiceBtn'),
                    sendVoiceBtn: document.getElementById('sendVoiceBtn'),
                    
                    // Media preview elements
                    mediaPreview: document.getElementById('mediaPreview'),
                    mediaPreviewImage: document.getElementById('mediaPreviewImage'),
                    mediaPreviewName: document.getElementById('mediaPreviewName'),
                    sendMediaBtn: document.getElementById('sendMediaBtn'),
                    cancelMediaBtn: document.getElementById('cancelMediaBtn'),
                    
                    // Settings modal elements
                    settingsModal: document.getElementById('settingsModal'),
                    closeSettingsModal: document.getElementById('closeSettingsModal'),
                    onlineStatus: document.getElementById('onlineStatus'),
                    messageSounds: document.getElementById('messageSounds'),
                    browserNotifications: document.getElementById('browserNotifications'),
                    saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                    currentTextPrice: document.getElementById('currentTextPrice'),
                    currentVoicePrice: document.getElementById('currentVoicePrice'),
                    totalEarnings: document.getElementById('totalEarnings'),
                    availableEarnings: document.getElementById('availableEarnings'),
                    customPricingSection: document.getElementById('customPricingSection'),
                    textMessagePrice: document.getElementById('textMessagePrice'),
                    voiceMessagePrice: document.getElementById('voiceMessagePrice'),
                    savePricingBtn: document.getElementById('savePricingBtn')
                };
            }

            setupEventListeners() {
                // Navigation
                this.elements.newChatBtn.addEventListener('click', () => this.startNewChat());
                this.elements.conversationBackBtn.addEventListener('click', () => this.exitConversationView());
                this.elements.viewProfileBtn.addEventListener('click', () => this.viewUserProfile());
                
                // Settings
                this.elements.settingsBtn.addEventListener('click', () => this.showSettingsModal());
                this.elements.closeSettingsModal.addEventListener('click', () => this.hideSettingsModal());
                this.elements.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
                this.elements.savePricingBtn.addEventListener('click', () => this.saveCustomPricing());
                
                // Search
                this.elements.searchChats.addEventListener('input', () => this.handleSearch());
                this.elements.searchBox.addEventListener('click', () => {
                    this.elements.searchDropdown.classList.toggle('active');
                });
                
                // Message Input
                this.elements.chatInput.addEventListener('input', () => {
                    this.handleInputResize();
                    this.updateWordCounter();
                });
                
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.elements.sendMessageBtn.addEventListener('click', () => this.sendMessage());
                this.elements.attachBtn.addEventListener('click', () => this.handleAttachFile());
                this.elements.voiceBtn.addEventListener('click', () => this.startRecording());
                
                // Voice Recording
                this.elements.cancelRecordingBtn.addEventListener('click', () => this.cancelRecording());
                this.elements.sendRecordingBtn.addEventListener('click', () => this.stopRecording());
                
                // Voice Preview
                this.elements.voicePreviewPlayBtn.addEventListener('click', () => this.toggleVoicePlayback());
                this.elements.deleteVoiceBtn.addEventListener('click', () => this.deleteVoicePreview());
                this.elements.sendVoiceBtn.addEventListener('click', () => this.sendVoiceMessage());
                
                // Media Preview
                this.elements.sendMediaBtn.addEventListener('click', () => this.sendMediaMessage());
                this.elements.cancelMediaBtn.addEventListener('click', () => this.cancelMedia());
                
                // Close search dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.elements.searchBox.contains(e.target)) {
                        this.elements.searchDropdown.classList.remove('active');
                    }
                });
            }

            async handleURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const conversationId = urlParams.get('conversation');
                const userId = urlParams.get('user');
                
                if (conversationId) {
                    await this.loadConversation(conversationId);
                } else if (userId) {
                    await this.startConversation(userId);
                }
            }

            async checkAuthStatus() {
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                        } else {
                            window.location.href = 'index.html';
                        }
                        resolve();
                    });
                });
            }

            async loadUserProfile() {
                if (!this.state.currentUser) return;

                try {
                    // Set up real-time listener for user profile
                    firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                this.state.userProfile = doc.data();
                                this.state.balance = this.state.userProfile.balance || 0;
                                this.state.freeMessagesRemaining = 3 - (this.state.userProfile.freeMessagesUsed || 0);
                                
                                // Update UI
                                this.elements.balanceAmount.textContent = `₦${this.state.balance}`;
                                
                                // Check if user is eligible for custom pricing
                                this.checkCustomPricingEligibility();
                                
                                // Update settings with user's custom pricing if available
                                if (this.state.userProfile.customPricing) {
                                    this.state.settings.textMessagePrice = this.state.userProfile.customPricing.text || 10;
                                    this.state.settings.voiceMessagePrice = this.state.userProfile.customPricing.voice || 30;
                                }
                                
                                // Update pricing display
                                this.elements.currentTextPrice.textContent = `₦${this.state.settings.textMessagePrice}`;
                                this.elements.currentVoicePrice.textContent = `₦${this.state.settings.voiceMessagePrice}`;
                                
                                // Update earnings
                                const totalEarnings = this.state.userProfile.totalEarnings || 0;
                                const availableEarnings = this.state.userProfile.availableEarnings || 0;
                                this.elements.totalEarnings.textContent = `₦${totalEarnings}`;
                                this.elements.availableEarnings.textContent = `₦${availableEarnings}`;
                            }
                        }, error => {
                            console.error('Error loading user profile:', error);
                        });
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async loadNetworkUsers() {
                if (!this.state.currentUser) return;
                
                try {
                    // Load user's followers, following, and contacts
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const followers = userData.followers || [];
                        const following = userData.following || [];
                        
                        // Combine and deduplicate
                        const allUserIds = [...new Set([...followers, ...following])];
                        
                        // Fetch user data for each ID
                        const userPromises = allUserIds.map(userId => 
                            firebase.firestore().collection('users').doc(userId).get()
                        );
                        
                        const userDocs = await Promise.all(userPromises);
                        this.state.networkUsers = userDocs
                            .filter(doc => doc.exists)
                            .map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                        
                        this.renderNetworkUsers();
                    }
                } catch (error) {
                    console.error('Error loading network users:', error);
                }
            }

            renderNetworkUsers() {
                if (!this.state.networkUsers.length) {
                    this.elements.userProfilesScroll.innerHTML = `
                        <div style="text-align: center; width: 100%; color: var(--gray-color); font-size: 14px;">
                            No users in your network yet
                        </div>
                    `;
                    return;
                }

                this.elements.userProfilesScroll.innerHTML = this.state.networkUsers.map(user => `
                    <div class="user-profile-item" data-user-id="${user.id}">
                        <div class="user-profile-avatar">
                            ${user.profilePicture ? 
                                `<img src="${user.profilePicture}" alt="${user.name}" loading="lazy">` :
                                `${user.name.charAt(0).toUpperCase()}`
                            }
                            <div class="status-indicator ${`status-${user.onlineStatus || 'offline'}`}"></div>
                        </div>
                        <div class="user-profile-name">${user.name}</div>
                    </div>
                `).join('');
                
                // Add event listeners to user profile items
                this.elements.userProfilesScroll.querySelectorAll('.user-profile-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const userId = item.getAttribute('data-user-id');
                        this.startConversation(userId);
                    });
                });
            }

            async handleSearch() {
                const query = this.elements.searchChats.value.toLowerCase().trim();
                
                if (!query) {
                    this.elements.searchDropdown.innerHTML = '';
                    this.elements.searchDropdown.classList.remove('active');
                    return;
                }
                
                try {
                    // Search conversations
                    const conversationsSnapshot = await firebase.firestore()
                        .collection('conversations')
                        .where('participants', 'array-contains', this.state.currentUser.uid)
                        .get();
                    
                    const conversationResults = conversationsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(conversation => {
                            const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                            const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                            
                            if (!otherParticipant) return false;
                            
                            return otherParticipant.name.toLowerCase().includes(query) || 
                                   (otherParticipant.username && otherParticipant.username.toLowerCase().includes(query));
                        });
                    
                    // Search users
                    const usersSnapshot = await firebase.firestore()
                        .collection('users')
                        .where('name', '>=', query)
                        .where('name', '<=', query + '\uf8ff')
                        .limit(10)
                        .get();
                    
                    const userResults = usersSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(user => user.id !== this.state.currentUser.uid);
                    
                    this.state.searchResults = [...conversationResults, ...userResults];
                    this.renderSearchResults();
                    
                } catch (error) {
                    console.error('Error searching:', error);
                }
            }

            renderSearchResults() {
                if (!this.state.searchResults.length) {
                    this.elements.searchDropdown.innerHTML = `
                        <div style="padding: 15px; text-align: center; color: var(--gray-color);">
                            No results found
                        </div>
                    `;
                    return;
                }
                
                this.elements.searchDropdown.innerHTML = this.state.searchResults.map(result => {
                    if (result.participants) {
                        // This is a conversation
                        const otherParticipantId = result.participants.find(id => id !== this.state.currentUser.uid);
                        const otherParticipant = result.participantsData ? result.participantsData[otherParticipantId] : null;
                        
                        return `
                            <div class="search-dropdown-item" data-conversation-id="${result.id}">
                                <div class="chat-avatar">
                                    ${otherParticipant && otherParticipant.profilePicture ? 
                                        `<img src="${otherParticipant.profilePicture}" alt="${otherParticipant.name}" loading="lazy">` :
                                        `${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}`
                                    }
                                </div>
                                <div>
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}</div>
                                    <div class="chat-preview">${result.lastMessage || 'No messages yet'}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // This is a user
                        return `
                            <div class="search-dropdown-item" data-user-id="${result.id}">
                                <div class="chat-avatar">
                                    ${result.profilePicture ? 
                                        `<img src="${result.profilePicture}" alt="${result.name}" loading="lazy">` :
                                        `${result.name.charAt(0).toUpperCase()}`
                                    }
                                </div>
                                <div>
                                    <div class="chat-name">${result.name}</div>
                                    <div class="chat-preview">${result.username || 'User'}</div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                
                // Add event listeners to search results
                this.elements.searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        const userId = item.getAttribute('data-user-id');
                        
                        if (conversationId) {
                            this.loadConversation(conversationId);
                        } else if (userId) {
                            this.startConversation(userId);
                        }
                        
                        this.elements.searchDropdown.classList.remove('active');
                        this.elements.searchChats.value = '';
                    });
                });
            }

            checkCustomPricingEligibility() {
                if (!this.state.userProfile) return false;
                
                const followers = this.state.userProfile.followers ? this.state.userProfile.followers.length : 0;
                const totalComments = this.state.userProfile.totalComments || 0;
                const totalLikes = this.state.userProfile.totalLikes || 0;
                
                const isEligible = followers >= 1000 && totalComments >= 200 && totalLikes >= 500;
                
                if (isEligible) {
                    this.elements.customPricingSection.style.display = 'block';
                    return true;
                } else {
                    this.elements.customPricingSection.style.display = 'none';
                    return false;
                }
            }

            async loadConversations() {
                if (!this.state.currentUser) return;

                try {
                    const conversationsSnapshot = await firebase.firestore()
                        .collection('conversations')
                        .where('participants', 'array-contains', this.state.currentUser.uid)
                        .orderBy('lastMessageAt', 'desc')
                        .get();
                    
                    this.state.conversations = conversationsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    this.renderConversations();
                    
                    // Set up real-time listener for conversations
                    this.setupConversationsListener();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            setupConversationsListener() {
                if (!this.state.currentUser) return;
                
                firebase.firestore()
                    .collection('conversations')
                    .where('participants', 'array-contains', this.state.currentUser.uid)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added' || change.type === 'modified') {
                                const conversation = {
                                    id: change.doc.id,
                                    ...change.doc.data()
                                };
                                
                                // Update conversation in state
                                const index = this.state.conversations.findIndex(c => c.id === conversation.id);
                                if (index !== -1) {
                                    this.state.conversations[index] = conversation;
                                } else {
                                    this.state.conversations.unshift(conversation);
                                }
                                
                                // Re-render conversations
                                this.renderConversations();
                                
                                // Update notification badge
                                this.updateNotificationBadge();
                                
                                // Play notification sound if enabled
                                if (this.state.settings.messageSounds === 'enabled' && 
                                    change.type === 'added' && 
                                    conversation.lastMessageSender !== this.state.currentUser.uid) {
                                    this.playNotificationSound();
                                }
                                
                                // Show browser notification if enabled
                                if (this.state.settings.browserNotifications === 'enabled' && 
                                    change.type === 'added' && 
                                    conversation.lastMessageSender !== this.state.currentUser.uid &&
                                    document.hidden) {
                                    this.showBrowserNotification(conversation);
                                }
                            }
                        });
                    }, error => {
                        console.error('Error in conversations listener:', error);
                    });
            }

            updateNotificationBadge() {
                const totalUnread = this.state.conversations.reduce((total, conversation) => {
                    return total + (conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0);
                }, 0);
                
                if (totalUnread > 0) {
                    this.elements.notificationBadge.textContent = totalUnread;
                    this.elements.notificationBadge.style.display = 'flex';
                } else {
                    this.elements.notificationBadge.style.display = 'none';
                }
            }

            playNotificationSound() {
                const audio = new Audio('notification.mp3'); // You'll need to add this file
                audio.play().catch(e => console.log('Could not play notification sound:', e));
            }

            showBrowserNotification(conversation) {
                if (!("Notification" in window)) return;
                
                if (Notification.permission === "granted") {
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const notification = new Notification(`New message from ${otherParticipant ? otherParticipant.name : 'Unknown User'}`, {
                        body: conversation.lastMessage || 'New message',
                        icon: otherParticipant && otherParticipant.profilePicture ? otherParticipant.profilePicture : '/icon.png'
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        this.loadConversation(conversation.id);
                    };
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            this.showBrowserNotification(conversation);
                        }
                    });
                }
            }

            renderConversations() {
                if (!this.state.conversations.length) {
                    this.elements.chatList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Start a new chat to connect with others.</p>
                        </div>
                    `;
                    return;
                }

                this.elements.chatList.innerHTML = this.state.conversations.map(conversation => {
                    // Get the other participant's ID
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const isActive = this.state.activeConversation && this.state.activeConversation.id === conversation.id;
                    const unreadCount = conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0;
                    
                    return `
                        <div class="chat-list-item ${isActive ? 'active' : ''}" data-conversation-id="${conversation.id}">
                            <div class="chat-avatar">
                                ${otherParticipant && otherParticipant.profilePicture ? 
                                    `<img src="${otherParticipant.profilePicture}" alt="${otherParticipant.name}" loading="lazy">` :
                                    `${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}`
                                }
                                <div class="status-indicator ${otherParticipant ? `status-${otherParticipant.onlineStatus || 'offline'}` : 'status-offline'}"></div>
                            </div>
                            <div class="chat-info">
                                <div class="chat-header-info">
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}</div>
                                    <div class="chat-time">${this.formatTime(conversation.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    ${conversation.lastMessageType === 'voice' ? '<i class="fas fa-microphone"></i> Voice message' : 
                                      conversation.lastMessageType === 'image' ? '<i class="fas fa-image"></i> Image' :
                                      conversation.lastMessage || 'No messages yet'}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners to conversation items
                this.elements.chatList.querySelectorAll('.chat-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        this.loadConversation(conversationId);
                    });
                });
            }

            async loadConversation(conversationId) {
                try {
                    this.showLoading();
                    
                    const conversationDoc = await firebase.firestore()
                        .collection('conversations')
                        .doc(conversationId)
                        .get();
                    
                    if (!conversationDoc.exists) {
                        this.showError('Conversation not found');
                        return;
                    }
                    
                    const conversation = {
                        id: conversationDoc.id,
                        ...conversationDoc.data()
                    };
                    
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Get the other participant's ID
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    
                    // Get user data for the other participant
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(otherParticipantId)
                        .get();
                    
                    if (userDoc.exists) {
                        this.state.activeConversation.user = {
                            id: otherParticipantId,
                            ...userDoc.data()
                        };
                    }
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    this.setupMessagesListener();
                    
                    // Mark conversation as read
                    await this.markAsRead();
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    this.showError('Failed to load conversation');
                }
            }

            async startConversation(userId) {
                try {
                    this.showLoading();
                    
                    // Check if conversation already exists
                    const existingConversation = this.state.conversations.find(conv => 
                        conv.participants.includes(userId)
                    );
                    
                    if (existingConversation) {
                        await this.loadConversation(existingConversation.id);
                        return;
                    }
                    
                    // Get user data
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(userId)
                        .get();
                    
                    if (!userDoc.exists) {
                        this.showError('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Create new conversation
                    const conversationData = {
                        participants: [this.state.currentUser.uid, userId],
                        participantsData: {
                            [this.state.currentUser.uid]: {
                                name: this.state.userProfile.name,
                                profilePicture: this.state.userProfile.profilePicture,
                                onlineStatus: 'online'
                            },
                            [userId]: {
                                name: userData.name,
                                profilePicture: userData.profilePicture,
                                onlineStatus: userData.onlineStatus || 'offline'
                            }
                        },
                        messages: [],
                        lastMessage: '',
                        lastMessageType: '',
                        lastMessageSender: '',
                        lastMessageAt: new Date().toISOString(),
                        createdAt: new Date().toISOString(),
                        unreadCount: {
                            [this.state.currentUser.uid]: 0,
                            [userId]: 0
                        }
                    };
                    
                    const conversationRef = await firebase.firestore()
                        .collection('conversations')
                        .add(conversationData);
                    
                    this.state.activeConversation = {
                        id: conversationRef.id,
                        ...conversationData,
                        user: {
                            id: userId,
                            ...userData
                        }
                    };
                    
                    this.state.conversationId = conversationRef.id;
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    this.setupMessagesListener();
                    
                } catch (error) {
                    console.error('Error starting conversation:', error);
                    this.showError('Failed to start conversation');
                }
            }

            async loadMessages() {
                if (!this.state.conversationId) return;

                try {
                    const conversationDoc = await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .get();
                    
                    if (conversationDoc.exists) {
                        const conversation = conversationDoc.data();
                        this.state.messages = conversation.messages || [];
                        this.renderMessages();
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            setupMessagesListener() {
                if (!this.state.conversationId) return;
                
                // Listen for new messages in real-time
                firebase.firestore()
                    .collection('conversations')
                    .doc(this.state.conversationId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const conversation = doc.data();
                            this.state.messages = conversation.messages || [];
                            this.renderMessages();
                            
                            // Mark as read if it's not our message
                            if (conversation.lastMessageSender !== this.state.currentUser.uid) {
                                this.markAsRead();
                            }
                        }
                    }, error => {
                        console.error('Error in messages listener:', error);
                    });
            }

            renderMessages() {
                if (!this.state.messages.length) {
                    this.elements.messagesArea.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-alt"></i>
                            <h3>No messages yet</h3>
                            <p>Send a message to start the conversation.</p>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = this.state.messages.map(message => {
                    const isSent = message.senderId === this.state.currentUser.uid;
                    
                    let messageContent = '';
                    
                    if (message.type === 'text') {
                        messageContent = `
                            <div class="message-text">${message.content}</div>
                        `;
                    } else if (message.type === 'image') {
                        messageContent = `
                            <div class="message-media">
                                <img src="${message.mediaUrl}" alt="Shared image" loading="lazy">
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        messageContent = `
                            <div class="voice-message">
                                <button class="voice-play-btn" data-audio="${message.mediaUrl}">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="voice-waveform">
                                    ${this.generateVoiceWaveform()}
                                </div>
                                <div class="voice-duration">${message.duration || '0:00'}</div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${message.id}">
                            ${messageContent}
                            <div class="message-time">${this.formatTime(message.createdAt)}</div>
                        </div>
                    `;
                }).join('');
                
                this.elements.messagesArea.innerHTML = messagesHTML;
                
                // Add event listeners to voice messages
                this.elements.messagesArea.querySelectorAll('.voice-play-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const audioUrl = e.target.closest('.voice-play-btn').getAttribute('data-audio');
                        this.playVoiceMessage(audioUrl, e.target.closest('.voice-message'));
                    });
                });
                
                // Scroll to bottom
                this.scrollToBottom();
            }

            generateVoiceWaveform() {
                let waveform = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 20) + 5;
                    waveform += `<div class="voice-bar" style="height: ${height}px;"></div>`;
                }
                return waveform;
            }

            async sendMessage() {
                const content = this.elements.chatInput.value.trim();
                if (!content && !this.state.mediaFile && !this.state.voiceNote) return;

                try {
                    // Calculate cost
                    let cost = 0;
                    let messageType = 'text';
                    let mediaUrl = null;
                    let duration = null;

                    if (this.state.mediaFile) {
                        messageType = 'image';
                        cost = this.state.settings.textMessagePrice;
                    } else if (this.state.voiceNote) {
                        messageType = 'voice';
                        const minutes = Math.ceil(this.parseDuration(this.state.voiceNote.duration) / 60);
                        cost = minutes * this.state.settings.voiceMessagePrice;
                        duration = this.state.voiceNote.duration;
                    } else {
                        // Text message - check word count and calculate cost
                        const wordCount = content.split(/\s+/).length;
                        const baseWords = 35;
                        const baseCost = this.state.settings.textMessagePrice;
                        
                        if (wordCount <= baseWords) {
                            cost = baseCost;
                        } else {
                            // Additional cost for extra words
                            const extraWords = wordCount - baseWords;
                            const extraCost = Math.ceil(extraWords / 10) * (baseCost / 3); // 1/3 of base cost per 10 extra words
                            cost = baseCost + extraCost;
                        }
                    }

                    // Check if user has enough balance or free messages
                    if (this.state.freeMessagesRemaining > 0 && messageType === 'text') {
                        // Use a free message for text only
                        this.state.freeMessagesRemaining--;
                    } else if (this.state.balance < cost) {
                        this.showError(`Insufficient balance. You need ₦${cost} to send this message.`);
                        return;
                    }

                    // Deduct balance if applicable
                    if (cost > 0 && this.state.freeMessagesRemaining <= 0) {
                        const newBalance = this.state.balance - cost;
                        await firebase.firestore().collection('users').doc(this.state.currentUser.uid).update({
                            balance: newBalance,
                            freeMessagesUsed: 3 - this.state.freeMessagesRemaining
                        });
                        
                        this.state.balance = newBalance;
                        this.elements.balanceAmount.textContent = `₦${newBalance}`;
                        
                        // Add earnings to the receiver (50% of cost)
                        const earnings = Math.floor(cost * 0.5);
                        const otherParticipantId = this.state.activeConversation.participants.find(id => id !== this.state.currentUser.uid);
                        
                        await firebase.firestore().collection('users').doc(otherParticipantId).update({
                            totalEarnings: firebase.firestore.FieldValue.increment(earnings),
                            availableEarnings: firebase.firestore.FieldValue.increment(earnings)
                        });
                    }

                    let message = {
                        id: Date.now().toString(),
                        senderId: this.state.currentUser.uid,
                        content: content,
                        type: messageType,
                        createdAt: new Date().toISOString()
                    };

                    // Handle media files
                    if (this.state.mediaFile) {
                        const fileRef = firebase.storage().ref().child(`messages/${this.state.currentUser.uid}/${Date.now()}_${this.state.mediaFile.name}`);
                        await fileRef.put(this.state.mediaFile);
                        mediaUrl = await fileRef.getDownloadURL();
                        
                        message.mediaUrl = mediaUrl;
                        message.content = '';
                    }

                    // Handle voice notes
                    if (this.state.voiceNote) {
                        const fileRef = firebase.storage().ref().child(`voice/${this.state.currentUser.uid}/${Date.now()}_voice.wav`);
                        await fileRef.put(this.state.voiceNote.blob);
                        mediaUrl = await fileRef.getDownloadURL();
                        
                        message.mediaUrl = mediaUrl;
                        message.duration = duration;
                        message.content = '';
                    }

                    // Add message to conversation
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayUnion(message),
                            lastMessage: content || (messageType === 'voice' ? 'Voice message' : 'Media'),
                            lastMessageType: messageType,
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date().toISOString(),
                            [`unreadCount.${this.state.activeConversation.user.id}`]: firebase.firestore.FieldValue.increment(1)
                        });

                    // Clear input and reset state
                    this.elements.chatInput.value = '';
                    this.state.mediaFile = null;
                    this.state.voiceNote = null;
                    this.hideMediaPreview();
                    this.hideVoicePreview();
                    this.handleInputResize();
                    this.updateWordCounter();

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message');
                }
            }

            async markAsRead() {
                if (!this.state.conversationId) return;

                try {
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            [`unreadCount.${this.state.currentUser.uid}`]: 0
                        });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }

            // Voice Recording
            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Set up audio analysis for waveform
                    this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.state.analyser = this.state.audioContext.createAnalyser();
                    const source = this.state.audioContext.createMediaStreamSource(stream);
                    source.connect(this.state.analyser);
                    
                    this.state.analyser.fftSize = 256;
                    const bufferLength = this.state.analyser.frequencyBinCount;
                    this.state.dataArray = new Uint8Array(bufferLength);
                    
                    this.state.audioChunks = [];
                    this.state.mediaRecorder = new MediaRecorder(stream);
                    
                    this.state.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.state.audioChunks.push(event.data);
                        }
                    };
                    
                    this.state.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/wav' });
                        const duration = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        
                        this.state.voiceNote = {
                            blob: audioBlob,
                            duration: this.formatAudioTime(duration),
                            url: URL.createObjectURL(audioBlob)
                        };
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Stop animation
                        if (this.state.animationId) {
                            cancelAnimationFrame(this.state.animationId);
                        }
                        
                        // Show voice preview
                        this.showVoicePreview();
                    };
                    
                    this.state.mediaRecorder.start();
                    this.state.isRecording = true;
                    this.state.recordingStartTime = Date.now();
                    
                    // Show voice recorder UI
                    this.elements.voiceRecorder.classList.add('active');
                    
                    // Start timer
                    this.state.recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        this.elements.recordingTimer.textContent = this.formatAudioTime(elapsed);
                    }, 1000);
                    
                    // Start waveform animation
                    this.animateWaveform();
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Could not access microphone');
                }
            }

            animateWaveform() {
                if (!this.state.isRecording) return;
                
                this.state.analyser.getByteFrequencyData(this.state.dataArray);
                
                // Clear previous waveform
                this.elements.voiceWaveform.innerHTML = '';
                
                // Create new waveform bars
                const barCount = 20;
                const sliceWidth = Math.floor(this.state.dataArray.length / barCount);
                
                for (let i = 0; i < barCount; i++) {
                    const barValue = this.state.dataArray[i * sliceWidth] || 0;
                    const barHeight = Math.max(5, (barValue / 256) * 30);
                    const bar = document.createElement('div');
                    bar.className = 'voice-bar';
                    bar.style.height = `${barHeight}px`;
                    this.elements.voiceWaveform.appendChild(bar);
                }
                
                this.state.animationId = requestAnimationFrame(() => this.animateWaveform());
            }

            stopRecording() {
                if (this.state.mediaRecorder && this.state.isRecording) {
                    this.state.mediaRecorder.stop();
                    this.state.isRecording = false;
                    
                    // Hide voice recorder UI
                    this.elements.voiceRecorder.classList.remove('active');
                    
                    // Clear timer
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                        this.state.recordingTimer = null;
                    }
                }
            }

            cancelRecording() {
                this.stopRecording();
                this.state.voiceNote = null;
                this.hideVoicePreview();
            }

            showVoicePreview() {
                this.state.isVoicePreview = true;
                this.elements.voicePreviewDuration.textContent = this.state.voiceNote.duration;
                this.elements.voicePreview.classList.add('active');
                
                // Generate preview waveform
                this.generateVoicePreviewWaveform();
            }

            hideVoicePreview() {
                this.state.isVoicePreview = false;
                this.elements.voicePreview.classList.remove('active');
                this.state.voiceNote = null;
            }

            generateVoicePreviewWaveform() {
                this.elements.voicePreviewWaveform.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 30) + 10;
                    const bar = document.createElement('div');
                    bar.className = 'voice-preview-bar';
                    bar.style.height = `${height}px`;
                    this.elements.voicePreviewWaveform.appendChild(bar);
                }
            }

            toggleVoicePlayback() {
                if (!this.state.voiceNote) return;
                
                if (!this.state.audioPlayer) {
                    this.state.audioPlayer = new Audio(this.state.voiceNote.url);
                    
                    this.state.audioPlayer.addEventListener('ended', () => {
                        this.state.isPlaying = false;
                        this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                    });
                    
                    this.state.audioPlayer.addEventListener('timeupdate', () => {
                        const progress = this.state.audioPlayer.currentTime / this.state.audioPlayer.duration;
                        
                        // Animate voice bars during playback
                        const bars = this.elements.voicePreviewWaveform.querySelectorAll('.voice-preview-bar');
                        bars.forEach((bar, index) => {
                            const baseHeight = 10 + (index % 3) * 5;
                            const animation = Math.sin((Date.now() / 100) + index) * 8;
                            bar.style.height = `${baseHeight + animation}px`;
                        });
                    });
                }
                
                if (this.state.isPlaying) {
                    this.state.audioPlayer.pause();
                    this.state.isPlaying = false;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    this.state.audioPlayer.play();
                    this.state.isPlaying = true;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                }
            }

            deleteVoicePreview() {
                if (this.state.audioPlayer) {
                    this.state.audioPlayer.pause();
                    this.state.audioPlayer = null;
                }
                this.state.isPlaying = false;
                this.hideVoicePreview();
            }

            sendVoiceMessage() {
                this.sendMessage();
            }

            playVoiceMessage(audioUrl, voiceElement) {
                const audio = new Audio(audioUrl);
                const playBtn = voiceElement.querySelector('.voice-play-btn');
                const voiceBars = voiceElement.querySelectorAll('.voice-bar');
                
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                audio.addEventListener('timeupdate', () => {
                    const progress = audio.currentTime / audio.duration;
                    
                    // Animate voice bars during playback
                    voiceBars.forEach((bar, index) => {
                        const baseHeight = 5 + (index % 3) * 3;
                        const animation = Math.sin((Date.now() / 100) + index) * 5;
                        bar.style.height = `${baseHeight + animation}px`;
                    });
                });
                
                audio.addEventListener('ended', () => {
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    // Reset voice bars
                    voiceBars.forEach(bar => {
                        bar.style.height = '10px';
                    });
                });
                
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            }

            // Media Handling
            handleAttachFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.previewMedia(file);
                    }
                };
                input.click();
            }

            previewMedia(file) {
                this.state.mediaFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.elements.mediaPreviewImage.src = e.target.result;
                    this.elements.mediaPreviewName.textContent = file.name;
                    this.elements.mediaPreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }

            sendMediaMessage() {
                this.sendMessage();
            }

            cancelMedia() {
                this.state.mediaFile = null;
                this.hideMediaPreview();
            }

            hideMediaPreview() {
                this.elements.mediaPreview.classList.remove('active');
            }

            // UI Methods
            enterConversationView() {
                this.state.isInConversationView = true;
                this.elements.mainContainer.classList.add('conversation-view');
                this.elements.conversationView.style.display = 'block';
                this.elements.emptyState.style.display = 'none';
            }

            exitConversationView() {
                this.state.isInConversationView = false;
                this.elements.mainContainer.classList.remove('conversation-view');
                this.elements.conversationView.style.display = 'none';
                this.elements.emptyState.style.display = 'flex';
                this.state.activeConversation = null;
                this.state.conversationId = null;
                
                // Update URL to remove conversation parameter
                const url = new URL(window.location);
                url.searchParams.delete('conversation');
                url.searchParams.delete('user');
                window.history.replaceState({}, '', url);
            }

            showLoading() {
                this.elements.conversationUserName.textContent = 'Loading...';
                this.elements.statusText.textContent = '';
            }

            updateConversationHeader() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                
                const user = this.state.activeConversation.user;
                
                this.elements.conversationUserName.textContent = user.name;
                
                if (user.profilePicture) {
                    this.elements.conversationAvatar.innerHTML = `<img src="${user.profilePicture}" alt="${user.name}" loading="lazy">`;
                } else {
                    this.elements.conversationAvatar.textContent = user.name.charAt(0).toUpperCase();
                }
                
                const status = user.onlineStatus || 'offline';
                this.elements.conversationUserStatus.innerHTML = `
                    <span class="status-indicator status-${status}"></span>
                    <span id="statusText">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
            }

            handleInputResize() {
                const textarea = this.elements.chatInput;
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, 120);
                textarea.style.height = newHeight + 'px';
                
                // Adjust input area padding based on height
                const inputArea = document.querySelector('.input-area');
                if (newHeight > 60) {
                    inputArea.style.paddingBottom = '20px';
                } else {
                    inputArea.style.paddingBottom = '15px';
                }
            }

            updateWordCounter() {
                const content = this.elements.chatInput.value.trim();
                if (!content) {
                    this.elements.wordCounter.style.display = 'none';
                    return;
                }
                
                const wordCount = content.split(/\s+/).length;
                const baseWords = 35;
                const baseCost = this.state.settings.textMessagePrice;
                
                let cost = baseCost;
                let extraInfo = '';
                
                if (wordCount > baseWords) {
                    const extraWords = wordCount - baseWords;
                    const extraCost = Math.ceil(extraWords / 10) * (baseCost / 3);
                    cost = baseCost + extraCost;
                    extraInfo = ` (+₦${extraCost} for ${extraWords} extra words)`;
                }
                
                this.elements.wordCounter.textContent = `${wordCount}/35 words • ₦${cost}${extraInfo}`;
                this.elements.wordCounter.style.display = 'block';
                
                if (wordCount > baseWords) {
                    this.elements.wordCounter.classList.add('near-limit');
                } else {
                    this.elements.wordCounter.classList.remove('near-limit');
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
                }, 100);
            }

            viewUserProfile() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                const userId = this.state.activeConversation.user.id;
                window.location.href = `profile.html?user=${userId}`;
            }

            async startNewChat() {
                const username = prompt('Enter username to start a chat:');
                if (!username) return;
                
                try {
                    // Search for user by username
                    const usersSnapshot = await firebase.firestore()
                        .collection('users')
                        .where('username', '==', username)
                        .limit(1)
                        .get();
                    
                    if (usersSnapshot.empty) {
                        this.showError('User not found');
                        return;
                    }
                    
                    const userDoc = usersSnapshot.docs[0];
                    this.startConversation(userDoc.id);
                } catch (error) {
                    console.error('Error starting new chat:', error);
                    this.showError('Failed to start new chat');
                }
            }

            // Settings Methods
            showSettingsModal() {
                // Load current settings
                this.elements.onlineStatus.value = this.state.settings.onlineStatus;
                this.elements.messageSounds.value = this.state.settings.messageSounds;
                this.elements.browserNotifications.value = this.state.settings.browserNotifications;
                
                // Show custom pricing if eligible
                if (this.checkCustomPricingEligibility()) {
                    this.elements.textMessagePrice.value = this.state.settings.textMessagePrice;
                    this.elements.voiceMessagePrice.value = this.state.settings.voiceMessagePrice;
                }
                
                this.elements.settingsModal.classList.add('active');
            }

            hideSettingsModal() {
                this.elements.settingsModal.classList.remove('active');
            }

            async saveSettings() {
                try {
                    this.state.settings.onlineStatus = this.elements.onlineStatus.value;
                    this.state.settings.messageSounds = this.elements.messageSounds.value;
                    this.state.settings.browserNotifications = this.elements.browserNotifications.value;
                    
                    // Update user's online status in Firestore
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            onlineStatus: this.state.settings.onlineStatus
                        });
                    
                    this.showNotification('Settings Saved', 'Your chat settings have been updated');
                    this.hideSettingsModal();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Failed to save settings');
                }
            }

            async saveCustomPricing() {
                try {
                    const textPrice = parseInt(this.elements.textMessagePrice.value);
                    const voicePrice = parseInt(this.elements.voiceMessagePrice.value);
                    
                    if (textPrice < 5 || textPrice > 100) {
                        this.showError('Text message price must be between ₦5 and ₦100');
                        return;
                    }
                    
                    if (voicePrice < 10 || voicePrice > 200) {
                        this.showError('Voice message price must be between ₦10 and ₦200 per minute');
                        return;
                    }
                    
                    this.state.settings.textMessagePrice = textPrice;
                    this.state.settings.voiceMessagePrice = voicePrice;
                    
                    // Save to user profile
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            customPricing: {
                                text: textPrice,
                                voice: voicePrice
                            }
                        });
                    
                    // Update UI
                    this.elements.currentTextPrice.textContent = `₦${textPrice}`;
                    this.elements.currentVoicePrice.textContent = `₦${voicePrice}`;
                    
                    this.showNotification('Pricing Updated', 'Your custom pricing has been saved');
                } catch (error) {
                    console.error('Error saving custom pricing:', error);
                    this.showError('Failed to save custom pricing');
                }
            }

            // Utility Methods
            formatTime(timestamp) {
                if (!timestamp) return 'Just now';
                
                const now = new Date();
                const postTime = new Date(timestamp);
                const diff = now - postTime;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (days > 0) return `${days}d ago`;
                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return 'Just now';
            }

            formatAudioTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            parseDuration(durationStr) {
                // Parse duration string like "01:25" to seconds
                const parts = durationStr.split(':');
                if (parts.length !== 2) return 0;
                
                const minutes = parseInt(parts[0]);
                const seconds = parseInt(parts[1]);
                
                return (minutes * 60) + seconds;
            }

            showError(message) {
                alert(message);
            }

            showNotification(title, message) {
                // Simple notification - in production, use a proper notification system
                alert(`${title}: ${message}`);
            }
        }

        // Initialize the chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.connectXChat = new ConnectXChat();
        });
    </script>
</body>
</html>
