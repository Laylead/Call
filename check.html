<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BetMaster - CPA Betting Platform</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
    }
    .game, .dashboard {
      display: none;
    }
    .visible {
      display: block !important;
    }
    .game-container, .dashboard-container {
      padding: 20px;
    }
    .popup {
      background: rgba(0,0,0,0.9);
      color: #fff;
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -30%);
      padding: 20px;
      z-index: 1000;
      border: 2px solid #fff;
    }
    .wheel {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 10px solid #fff;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="auth" class="container text-center mt-5">
    <h1>🎲 BetMaster</h1>
    <input id="email" type="email" placeholder="Email" class="form-control mb-2" />
    <input id="password" type="password" placeholder="Password" class="form-control mb-2" />
    <button onclick="login()" class="btn btn-success">Login</button>
    <button onclick="signup()" class="btn btn-warning">Sign Up</button>
  </div>

  <div id="dashboard" class="dashboard container dashboard-container">
    <h2>Welcome, <span id="userName">User</span></h2>
    <p>Balance: <span id="balance">0</span> credits</p>
    <button onclick="playGame('wheel')" class="btn btn-primary">🎡 Spin the Wheel</button>
    <button onclick="playGame('limbo')" class="btn btn-secondary">🪂 Limbo</button>
    <button onclick="playGame('guess')" class="btn btn-danger">🎁 Guess the Box</button>
    <button onclick="playGame('dodge')" class="btn btn-info">🌀 Dodge Game</button>
    <button onclick="withdraw()" class="btn btn-success mt-3">💸 Withdraw</button>
  </div>

  <div id="withdrawPanel" class="popup" style="display:none">
    <h4>Withdrawal</h4>
    <select id="withdrawMethod" class="form-control mb-2">
      <option value="bank">Bank Transfer</option>
      <option value="usdt">TRC20 USDT</option>
    </select>
    <input id="withdrawName" class="form-control mb-2" placeholder="Your Full Name" />
    <input id="withdrawAccount" class="form-control mb-2" placeholder="Account Number or Wallet" />
    <input id="withdrawBank" class="form-control mb-2" placeholder="Bank Name or 'TRC20'" />
    <button onclick="submitWithdrawal()" class="btn btn-warning">Submit</button>
  </div>

  <audio id="sfx" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js"></script>
  <script src="configuration.js"></script>
  <script>
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;

    function login() {
      const email = email.value;
      const password = password.value;
      auth.signInWithEmailAndPassword(email, password).then(userCred => {
        currentUser = userCred.user;
        initDashboard();
      });
    }

    function signup() {
      const email = email.value;
      const password = password.value;
      auth.createUserWithEmailAndPassword(email, password).then(userCred => {
        currentUser = userCred.user;
        db.collection("users").doc(currentUser.uid).set({
          balance: 30,
          gamesPlayed: 0,
          cpaClick: null,
          device: navigator.userAgent,
          cpaAnswer: null
        });
        initDashboard();
      });
    }

    function initDashboard() {
      document.getElementById("auth").style.display = "none";
      document.getElementById("dashboard").classList.add("visible");
      db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
        const data = doc.data();
        userName.innerText = currentUser.email;
        balance.innerText = data.balance;
        if (data.gamesPlayed >= 4 && !data.cpaClick) triggerCPA();
      });
    }

    function playGame(game) {
      document.getElementById("sfx").play();
      const ref = db.collection("users").doc(currentUser.uid);
      ref.get().then(doc => {
        let { balance, gamesPlayed } = doc.data();
        let reward = Math.floor(Math.random() * 10) + 5;
        let difficulty = gamesPlayed >= 10 ? 0.3 : 1;
        if (Math.random() < difficulty) {
          ref.update({
            balance: balance + reward,
            gamesPlayed: gamesPlayed + 1
          });
          alert(`You won ${reward} credits!`);
        } else {
          ref.update({ gamesPlayed: gamesPlayed + 1 });
          alert("You lost this round. Try again!");
        }
      });
    }

    function triggerCPA() {
      db.doc("settings/cpaConfig").get().then(doc => {
        const offerUrl = doc.data().offerUrl;
        const clickTime = Date.now();
        const device = navigator.userAgent;
        db.collection("users").doc(currentUser.uid).update({
          cpaClick: clickTime,
          device: device
        });
        const confirm = window.confirm("Access restricted. Complete quick task to continue. Continue?");
        if (confirm) window.open(offerUrl, '_blank');
        setTimeout(() => {
          const answer = window.confirm("Did you complete the task?");
          db.collection("users").doc(currentUser.uid).update({
            cpaAnswer: answer ? "Yes" : "No"
          });
          if (!answer) alert("Fake attempts may lead to bans.");
        }, 10000);
      });
    }

    function withdraw() {
      withdrawPanel.style.display = "block";
    }

    function submitWithdrawal() {
      const method = withdrawMethod.value;
      const name = withdrawName.value;
      const account = withdrawAccount.value;
      const bank = withdrawBank.value;
      db.collection("withdrawals").add({
        uid: currentUser.uid,
        method, name, account, bank,
        time: Date.now(),
        status: "pending"
      }).then(() => {
        alert("Request submitted. Processing...");
        withdrawPanel.style.display = "none";
      });
    }
  </script>
</body>
</html>
