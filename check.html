<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketConnect Pro - E-commerce & Affiliate Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="configuration.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --dark: #14213d;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --card-bg: #ffffff;
            --bg: #f0f2f5;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --elevation: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }
        
        .hidden {
            display: none !important;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
            font-weight: 500;
        }
        
        .tab:hover {
            background: rgba(67, 97, 238, 0.1);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .card {
            background: var(--card-bg);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge.success {
            background: rgba(76, 201, 240, 0.15);
            color: #4cc9f0;
        }
        
        .badge.warning {
            background: rgba(247, 37, 133, 0.15);
            color: #f72585;
        }
        
        .badge.info {
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary);
        }
        
        .badge.danger {
            background: rgba(230, 57, 70, 0.15);
            color: var(--danger);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover td {
            background: rgba(67, 97, 238, 0.03);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        button {
            padding: 12px 25px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.25);
        }
        
        button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button i {
            margin-right: 8px;
        }
        
        button.danger {
            background: var(--danger);
        }
        
        button.danger:hover {
            background: #c1121f;
            box-shadow: 0 4px 8px rgba(230, 57, 70, 0.25);
        }
        
        button.success {
            background: var(--success);
        }
        
        button.success:hover {
            background: #3a9fc7;
            box-shadow: 0 4px 8px rgba(76, 201, 240, 0.25);
        }
        
        button.admin {
            background: var(--warning);
        }
        
        button.admin:hover {
            background: #d21e6f;
        }
        
        .buy-token-btn {
            background: var(--warning);
        }
        
        .buy-token-btn:hover {
            background: #d21e6f;
            box-shadow: 0 4px 8px rgba(247, 37, 133, 0.25);
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .alert.info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .alert.success {
            background: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .alert.danger {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .stat-card .icon.users {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .stat-card .icon.earnings {
            background: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .stat-card .icon.pending {
            background: rgba(247, 37, 133, 0.1);
            color: #f72585;
        }
        
        .stat-card .icon.tokens {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .stat-card h3 {
            font-size: 1.8rem;
            margin: 5px 0;
        }
        
        .stat-card p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .page-title {
            margin: 20px 0;
            font-size: 1.8rem;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-right: 10px;
            background: rgba(67, 97, 238, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        
        .section {
            margin: 30px 0;
        }
        
        .section-title {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .input-group {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        /* E-commerce specific styles */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--elevation);
        }
        
        .product-image {
            height: 200px;
            width: 100%;
            background-size: cover;
            background-position: center;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .product-price {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
            margin: 10px 0;
        }
        
        .product-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .shop-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .shop-card:hover {
            transform: translateY(-3px);
        }
        
        .shop-logo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            margin-right: 20px;
            border: 2px solid var(--primary);
        }
        
        .shop-info {
            flex: 1;
        }
        
        .shop-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .shop-stats {
            display: flex;
            gap: 15px;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .shop-stats span {
            display: flex;
            align-items: center;
        }
        
        .shop-stats i {
            margin-right: 5px;
        }
        
        .follow-btn {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 15px;
        }
        
        .follow-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .social-share {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .social-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .social-btn:hover {
            transform: translateY(-3px);
        }
        
        .social-fb {
            background: #3b5998;
        }
        
        .social-wa {
            background: #25D366;
        }
        
        .social-tw {
            background: #1DA1F2;
        }
        
        .social-ig {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }
        
        .social-tt {
            background: #000000;
        }
        
        .quick-signup {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--elevation);
            position: relative;
            max-width: 500px;
            margin: 20px auto;
        }
        
        .product-detail {
            display: flex;
            gap: 25px;
            margin: 30px 0;
        }
        
        .product-gallery {
            flex: 1;
        }
        
        .main-image {
            height: 400px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .thumbnails {
            display: flex;
            gap: 10px;
        }
        
        .thumbnail {
            width: 80px;
            height: 80px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .thumbnail.active {
            border-color: var(--primary);
        }
        
        .product-details {
            flex: 1;
        }
        
        .product-title-lg {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .product-price-lg {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0;
        }
        
        .product-description {
            margin: 20px 0;
            line-height: 1.8;
            color: #555;
        }
        
        .product-meta {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            font-size: 0.9rem;
            color: #666;
        }
        
        .product-meta div {
            display: flex;
            align-items: center;
        }
        
        .product-meta i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .add-to-cart {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            background: #f8f9fa;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .quantity-input {
            width: 50px;
            height: 40px;
            text-align: center;
            border: none;
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }
        
        .cart-btn {
            flex: 1;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cart-btn:hover {
            background: var(--secondary);
        }
        
        .affiliate-section {
            background: rgba(67, 97, 238, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }
        
        .affiliate-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .referral-link {
            display: flex;
            margin: 15px 0;
        }
        
        .referral-link input {
            flex: 1;
            margin: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        
        .referral-link button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin: 0;
        }
        
        .referral-code-box {
            background: white;
            border: 2px dashed #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 15px 0;
        }
        
        .commission-rate {
            font-size: 1.1rem;
            margin: 10px 0;
            color: var(--primary);
            font-weight: 600;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .filter-select {
            flex: 1;
            min-width: 200px;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 45%;
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 90%;
                margin: 20% auto;
            }

            .whatsapp-input {
                flex-direction: column;
            }
            
            .commission-input {
                width: 100% !important;
                margin-left: 0;
                margin-top: 10px;
            }
            
            .product-detail {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .tab {
                flex: 1 0 100%;
            }

            .enrollment-section h2 {
                font-size: 1.5rem;
            }

            .enrollment-section p {
                font-size: 1rem;
            }

            .enrollment-count {
                font-size: 2rem;
            }
            
            .product-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .add-to-cart {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="container">
        <div class="card" style="max-width:500px;margin:40px auto;">
            <div style="text-align:center;margin-bottom:20px;">
                <h1 style="color:var(--primary);margin-bottom:10px;">MarketConnect Pro</h1>
                <p>E-commerce Platform with Affiliate System</p>
            </div>
            
            <div class="tabs">
                <div id="to-login" class="tab active">Login</div>
                <div id="to-register" class="tab">Register</div>
            </div>
            
            <div id="login-form">
                <div class="section">
                    <input type="email" id="login-email" placeholder="Email Address">
                    
                    <div class="input-group">
                        <input type="password" id="login-password" placeholder="Password">
                        <span class="password-toggle" id="password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                        <div>
                            <input type="checkbox" id="remember">
                            <label for="remember">Remember me</label>
                        </div>
                        <a href="#" style="color:var(--primary);text-decoration:none;" onclick="showPasswordReset()">Forgot password?</a>
                    </div>
                    
                    <button id="login-btn" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    
                    <div id="login-error" class="alert danger hidden" style="margin-top:15px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        <span id="error-msg"></span>
                    </div>
                </div>
            </div>
            
            <div id="register-form" class="hidden">
                <div class="section">
                    <div class="form-row">
                        <div>
                            <input type="text" id="reg-name" placeholder="Full Name">
                        </div>
                        <div>
                            <input type="text" id="reg-phone" placeholder="Phone Number">
                        </div>
                    </div>
                    
                    <input type="email" id="reg-email" placeholder="Email Address">
                    
                    <div class="input-group">
                        <input type="password" id="reg-password" placeholder="Password">
                        <span class="password-toggle" id="reg-password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <div class="input-group">
                        <input type="password" id="reg-confirm-password" placeholder="Confirm Password">
                        <span class="password-toggle" id="reg-confirm-password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <label>Register as:</label>
                    <select id="reg-role">
                        <option value="user">Regular User</option>
                        <option value="shop_owner">Shop Owner</option>
                    </select>
                    
                    <input type="text" id="reg-ref" placeholder="Referral Code (optional)">
                    
                    <button id="register-btn" onclick="register()">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                    <div id="register-error" class="alert danger hidden" style="margin-top:15px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        <span id="register-error-msg"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="container hidden">
        <header>
            <h1 id="app-title"><i class="fas fa-store"></i> Marketplace</h1>
            <div>
                <span id="user-name" style="margin-right:15px;"></span>
                <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>
        
        <div class="tabs" id="tabs"></div>
        
        <div id="content"></div>
    </div>

    <!-- Product Quick Signup Modal -->
    <div id="quickSignupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('quickSignupModal')">&times;</span>
            <h2>Complete Signup to Access Product</h2>
            <p>Create an account to add this product to your cart and access exclusive features</p>
            
            <div class="section">
                <input type="text" id="qs-name" placeholder="Full Name">
                <input type="email" id="qs-email" placeholder="Email Address">
                <input type="password" id="qs-password" placeholder="Password">
                
                <button onclick="quickSignup()">Sign Up & Continue</button>
                
                <p style="text-align:center;margin-top:15px;">Already have an account? <a href="#" onclick="switchToLogin()">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('shareModal')">&times;</span>
            <h2>Share Product</h2>
            <p>Share this product with your followers and earn commissions</p>
            
            <div class="social-share" style="justify-content:center;margin:25px 0;">
                <div class="social-btn social-fb" onclick="shareProduct('facebook')">
                    <i class="fab fa-facebook-f"></i>
                </div>
                <div class="social-btn social-wa" onclick="shareProduct('whatsapp')">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <div class="social-btn social-tw" onclick="shareProduct('twitter')">
                    <i class="fab fa-twitter"></i>
                </div>
                <div class="social-btn social-ig" onclick="shareProduct('instagram')">
                    <i class="fab fa-instagram"></i>
                </div>
                <div class="social-btn social-tt" onclick="shareProduct('tiktok')">
                    <i class="fab fa-tiktok"></i>
                </div>
            </div>
            
            <div class="affiliate-box">
                <h3>Your Affiliate Link</h3>
                <div class="referral-link">
                    <input type="text" id="share-link" readonly>
                    <button onclick="copyShareLink()"><i class="fas fa-copy"></i></button>
                </div>
                <p class="commission-rate">Earn 15% commission on each sale</p>
            </div>
        </div>
    </div>

    <!-- Floating Contact Widget -->
    <div class="floating-widget" id="contact-widget">
        <i class="fas fa-headset"></i>
    </div>

    <script>
        // Initialize Firebase from external configuration.js
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        let currentUser = null;
        let isAdmin = false;
        let isShopOwner = false;
        let userCache = {};
        let loadingStates = {};
        let currentEditUserId = null;
        let currentProductId = null;
        let currentShopId = null;

        // Mock data for demonstration
        const mockProducts = [
            {
                id: "prod1",
                name: "Wireless Bluetooth Headphones",
                price: 129.99,
                description: "Premium sound quality with noise cancellation and 30-hour battery life. Perfect for travel and daily use.",
                image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8aGVhZHBob25lc3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60",
                category: "Electronics",
                shopId: "shop1",
                stock: 50,
                commissionRate: 15
            },
            {
                id: "prod2",
                name: "Leather Wallet",
                price: 59.99,
                description: "Genuine leather wallet with multiple card slots and RFID protection. Handcrafted for durability.",
                image: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8d2FsbGV0fGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60",
                category: "Accessories",
                shopId: "shop2",
                stock: 100,
                commissionRate: 12
            },
            {
                id: "prod3",
                name: "Smart Fitness Watch",
                price: 199.99,
                description: "Track your heart rate, steps, sleep, and more. Water-resistant with 7-day battery life.",
                image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8d2F0Y2h8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60",
                category: "Electronics",
                shopId: "shop1",
                stock: 30,
                commissionRate: 18
            },
            {
                id: "prod4",
                name: "Organic Cotton T-Shirt",
                price: 29.99,
                description: "Soft, comfortable t-shirt made from 100% organic cotton. Available in multiple colors.",
                image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dHNoaXJ0fGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60",
                category: "Clothing",
                shopId: "shop3",
                stock: 200,
                commissionRate: 10
            }
        ];

        const mockShops = [
            {
                id: "shop1",
                name: "TechGadgets",
                logo: "https://images.unsplash.com/photo-1550009158-9ebf69173e03?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dGVjaCUyMGxvZ298ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60",
                description: "Your one-stop shop for the latest tech gadgets and accessories",
                ownerId: "owner1",
                followers: 2450,
                products: 32
            },
            {
                id: "shop2",
                name: "LeatherCraft",
                logo: "https://images.unsplash.com/photo-1605733513597-a8f8341084e6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bGVhdGhlciUyMGxvZ298ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60",
                description: "Handcrafted leather goods for everyday use",
                ownerId: "owner2",
                followers: 1250,
                products: 15
            },
            {
                id: "shop3",
                name: "EcoWear",
                logo: "https://images.unsplash.com/photo-1567401893414-76b7b1e5a7a5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8Y2xvdGhpbmclMjBsb2dvfGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60",
                description: "Sustainable fashion for conscious consumers",
                ownerId: "owner3",
                followers: 3850,
                products: 48
            }
        ];

        // Password visibility toggle
        document.getElementById('password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('login-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        
        document.getElementById('reg-password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('reg-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        
        document.getElementById('reg-confirm-password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('reg-confirm-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Modal functions
        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function showPasswordReset() {
            document.getElementById('reset-message').className = 'alert hidden';
            document.getElementById('reset-message').style.display = 'none';
            document.getElementById('reset-email').value = '';
            openModal('passwordResetModal');
        }

        // UI toggles
        document.getElementById('to-login').onclick = () => switchForms('login');
        document.getElementById('to-register').onclick = () => switchForms('register');
        
        function switchForms(mode) {
            document.getElementById('to-login').classList.toggle('active', mode === 'login');
            document.getElementById('to-register').classList.toggle('active', mode === 'register');
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', mode !== 'register');
        }

        // Set loading state for buttons
        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (isLoading) {
                loadingStates[buttonId] = button.innerHTML;
                button.innerHTML = '<div class="loading"></div> Processing...';
                button.disabled = true;
            } else {
                if (loadingStates[buttonId]) {
                    button.innerHTML = loadingStates[buttonId];
                }
                button.disabled = false;
            }
        }
        
        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.remove('hidden');
            errorElement.querySelector('span').textContent = message;
        }
        
        // Hide error message
        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // Generate unique referral code
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Registration with validation and proper error handling
        function register() {
            hideError('register-error');
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pwd = document.getElementById('reg-password').value;
            const confirmPwd = document.getElementById('reg-confirm-password').value;
            const role = document.getElementById('reg-role').value;
            const ref = document.getElementById('reg-ref').value.trim();
            
            if (!name) return showError('register-error', 'Please enter your full name');
            if (!email || !validateEmail(email)) return showError('register-error', 'Please enter a valid email address');
            if (!phone) return showError('register-error', 'Please enter your phone number');
            if (pwd.length < 8) return showError('register-error', 'Password must be at least 8 characters');
            if (pwd !== confirmPwd) return showError('register-error', 'Passwords do not match');
            
            setLoading('register-btn', true);
            
            // Generate unique referral code for the new user
            const referralCode = generateReferralCode();
            
            auth.createUserWithEmailAndPassword(email, pwd)
                .then(userCredential => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name,
                        email,
                        phone,
                        role,
                        ref,
                        referralCode,
                        joined: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'active',
                        balance: 0,
                        referrals: [],
                        commissionAmount: 0,
                        twoFA: false,
                        shopId: role === 'shop_owner' ? generateShopId() : null
                    }).then(() => userCredential.user);
                })
                .then(user => {
                    currentUser = user;
                    userCache[user.uid] = {
                        name,
                        email,
                        phone,
                        role,
                        ref,
                        referralCode,
                        status: 'active',
                        balance: 0,
                        referrals: [],
                        commissionAmount: 0,
                        twoFA: false
                    };
                    isAdmin = false;
                    isShopOwner = role === 'shop_owner';
                    
                    // Track referral if code exists
                    if (ref) {
                        trackReferral(ref, user.uid);
                    }
                    
                    initApp();
                })
                .catch(err => {
                    console.error("Registration error:", err);
                    showError('register-error', `Registration failed: ${err.message}`);
                })
                .finally(() => {
                    setLoading('register-btn', false);
                });
        }
        
        function generateShopId() {
            return 'shop' + Math.random().toString(36).substr(2, 9);
        }
        
        // Track referral when user registers
        function trackReferral(referralCode, newUserId) {
            db.collection('users').where('referralCode', '==', referralCode).get()
                .then(snap => {
                    if (!snap.empty) {
                        const referrerDoc = snap.docs[0];
                        const referrerId = referrerDoc.id;
                        const referrerData = referrerDoc.data();
                        
                        // Get fixed commission amount from admin settings
                        db.collection('settings').doc('system').get().then(settingsDoc => {
                            if (settingsDoc.exists) {
                                const settings = settingsDoc.data();
                                const fixedCommission = settings.fixedReferralCommission || 1000; // Default 1000
                                
                                // Update referrer
                                db.collection('users').doc(referrerId).update({
                                    referrals: firebase.firestore.FieldValue.arrayUnion(newUserId),
                                    balance: firebase.firestore.FieldValue.increment(fixedCommission)
                                });
                                
                                // Update new user
                                db.collection('users').doc(newUserId).update({
                                    referredBy: referrerId
                                });
                                
                                // Log transaction
                                db.collection('transactions').add({
                                    userId: referrerId,
                                    type: 'referral',
                                    amount: fixedCommission,
                                    details: `Referral from ${newUserId}`,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        });
                    }
                });
        }

        // Email validation
        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Login function
        function login() {
            hideError('login-error');
            const email = document.getElementById('login-email').value.trim();
            const pwd = document.getElementById('login-password').value;
            
            if (!email || !validateEmail(email)) return showError('login-error', 'Please enter a valid email address');
            if (!pwd) return showError('login-error', 'Please enter your password');
            
            setLoading('login-btn', true);
            
            auth.signInWithEmailAndPassword(email, pwd)
                .then(res => {
                    return db.collection('users').doc(res.user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                return { user: res.user, data: doc.data() };
                            } else {
                                // Create minimal user document
                                return db.collection('users').doc(res.user.uid).set({
                                    name: email,
                                    email: email,
                                    role: 'user',
                                    status: 'active',
                                    balance: 0,
                                    referrals: [],
                                    commissionAmount: 0,
                                    twoFA: false,
                                    joined: firebase.firestore.FieldValue.serverTimestamp()
                                }).then(() => ({ user: res.user, data: { role: 'user' } }));
                            }
                        });
                })
                .then(({ user, data }) => {
                    currentUser = user;
                    isAdmin = data.role === 'admin';
                    isShopOwner = data.role === 'shop_owner';
                    userCache[user.uid] = data;
                    initApp();
                })
                .catch(err => {
                    console.error("Login error:", err);
                    showError('login-error', err.message);
                })
                .finally(() => {
                    setLoading('login-btn', false);
                });
        }
        
        function sendPasswordReset() {
            const email = document.getElementById('reset-email').value.trim();
            const msgEl = document.getElementById('reset-message');
            
            if (!email || !validateEmail(email)) {
                msgEl.innerText = 'Please enter a valid email address';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    msgEl.innerText = 'Password reset email sent! Check your inbox.';
                    msgEl.className = 'alert success';
                    msgEl.style.display = 'block';
                })
                .catch(err => {
                    msgEl.innerText = 'Error: ' + err.message;
                    msgEl.className = 'alert danger';
                    msgEl.style.display = 'block';
                });
        }
        
        function logout() {
            auth.signOut();
            currentUser = null;
            isAdmin = false;
            isShopOwner = false;
            userCache = {};
            window.location.reload();
        }

        // Auth state handler
        auth.onAuthStateChanged(u => {
            if (u) {
                currentUser = u;
                
                // Get user data from Firestore
                db.collection('users').doc(u.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        userCache[u.uid] = data;
                        isAdmin = data.role === 'admin';
                        isShopOwner = data.role === 'shop_owner';
                        initApp();
                    } else {
                        // Create minimal user data
                        const minimalData = {
                            name: u.email,
                            email: u.email,
                            role: 'user',
                            status: 'active',
                            balance: 0,
                            referrals: [],
                            commissionAmount: 0,
                            twoFA: false
                        };
                        userCache[u.uid] = minimalData;
                        isAdmin = false;
                        isShopOwner = false;
                        initApp();
                        
                        // Save to Firestore
                        db.collection('users').doc(u.uid).set(minimalData);
                    }
                })
                .catch(err => {
                    console.error("Auth state error:", err);
                });
            }
        });
        
        // Initialize app UI
        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Use cached user data if available
            if (currentUser && userCache[currentUser.uid]) {
                document.getElementById('user-name').innerText = userCache[currentUser.uid].name || currentUser.email;
            }
            
            buildTabs();
            const first = isAdmin ? 'Overview' : 'Marketplace';
            setActiveTab(first);
            loadTab(first);
            
            // Initialize contact widget
            initContactWidget();
        }

        // Tabs setup
        const adminTabs = ['Overview', 'Tokens', 'Users', 'Enrollments', 'Withdrawals', 'Settings', 'Content'];
        const shopOwnerTabs = ['Dashboard', 'Products', 'Orders', 'Affiliates', 'Payouts'];
        const userTabs = ['Marketplace', 'Shops', 'Affiliate', 'Withdrawals', 'Account'];
        
        function buildTabs() {
            const tabsEl = document.getElementById('tabs');
            tabsEl.innerHTML = '';
            
            let tabs = userTabs;
            if (isAdmin) tabs = adminTabs;
            if (isShopOwner) tabs = shopOwnerTabs;
            
            tabs.forEach(t => {
                const div = document.createElement('div');
                div.innerText = t;
                div.className = 'tab';
                div.onclick = () => { setActiveTab(t); loadTab(t); };
                tabsEl.appendChild(div);
            });
        }
        
        function setActiveTab(tab) {
            document.getElementById('app-title').innerHTML = `<i class="fas ${getTabIcon(tab)}"></i> ${tab}`;
            document.querySelectorAll('.tabs .tab').forEach(el => {
                el.classList.toggle('active', el.innerText === tab);
            });
        }
        
        function getTabIcon(tab) {
            const icons = {
                'Overview': 'fa-tachometer-alt',
                'Dashboard': 'fa-tachometer-alt',
                'Tokens': 'fa-key',
                'Users': 'fa-users',
                'Enrollments': 'fa-user-plus',
                'Withdrawals': 'fa-money-check-alt',
                'Settings': 'fa-cog',
                'Affiliate': 'fa-user-friends',
                'Account': 'fa-user-cog',
                'Content': 'fa-file-alt',
                'Marketplace': 'fa-store',
                'Shops': 'fa-store-alt',
                'Products': 'fa-box-open',
                'Orders': 'fa-shopping-bag',
                'Affiliates': 'fa-hand-holding-usd',
                'Payouts': 'fa-money-bill-wave'
            };
            return icons[tab] || 'fa-file';
        }
        
        function loadTab(tab) {
            document.getElementById('content').innerHTML = '';
            if (isAdmin) {
                // Admin functions would go here
                adminOverview();
            } else if (isShopOwner) {
                loadShopOwnerTab(tab);
            } else {
                loadUserTab(tab);
            }
        }

        // Shop Owner Functions
        function loadShopOwnerTab(tab) {
            switch(tab) {
                case 'Dashboard': return shopOwnerDashboard();
                case 'Products': return shopOwnerProducts();
                case 'Orders': return shopOwnerOrders();
                case 'Affiliates': return shopOwnerAffiliates();
                case 'Payouts': return shopOwnerPayouts();
            }
        }

        function shopOwnerDashboard() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-tachometer-alt"></i> Shop Dashboard</h1>
                
                <div class="grid">
                    <div class="stat-card">
                        <div class="icon earnings"><i class="fas fa-chart-line"></i></div>
                        <h3>₦12,450</h3>
                        <p>Total Sales</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon users"><i class="fas fa-users"></i></div>
                        <h3>245</h3>
                        <p>Active Affiliates</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon pending"><i class="fas fa-clock"></i></div>
                        <h3>18</h3>
                        <p>Pending Orders</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon tokens"><i class="fas fa-box-open"></i></div>
                        <h3>32</h3>
                        <p>Products</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Sales Overview</h2>
                    <div style="height: 300px; display: flex; align-items: flex-end; justify-content: space-around; padding: 20px; background: #f8f9fa; border-radius: 12px; margin-top: 20px;">
                        <div style="width: 40px; background: var(--primary); height: 80%;"></div>
                        <div style="width: 40px; background: var(--success); height: 65%;"></div>
                        <div style="width: 40px; background: var(--warning); height: 45%;"></div>
                        <div style="width: 40px; background: var(--danger); height: 30%;"></div>
                        <div style="width: 40px; background: var(--primary); height: 75%;"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-clock"></i> Recent Orders</h2>
                    <table class="table">
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>#ORD-7832</td>
                            <td>John Smith</td>
                            <td>₦12,999</td>
                            <td><span class="badge success">Shipped</span></td>
                        </tr>
                        <tr>
                            <td>#ORD-7831</td>
                            <td>Sarah Johnson</td>
                            <td>₦8,450</td>
                            <td><span class="badge warning">Processing</span></td>
                        </tr>
                        <tr>
                            <td>#ORD-7829</td>
                            <td>Michael Brown</td>
                            <td>₦5,299</td>
                            <td><span class="badge success">Delivered</span></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function shopOwnerProducts() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-box-open"></i> Product Management</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-plus-circle"></i> Add New Product</h2>
                    <form id="product-form">
                        <div class="form-row">
                            <div>
                                <label>Product Name</label>
                                <input type="text" id="product-name" required>
                            </div>
                            <div>
                                <label>Price (₦)</label>
                                <input type="number" id="product-price" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>Category</label>
                                <select id="product-category" required>
                                    <option value="">Select Category</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="clothing">Clothing</option>
                                    <option value="home">Home & Kitchen</option>
                                    <option value="beauty">Beauty</option>
                                    <option value="sports">Sports</option>
                                </select>
                            </div>
                            <div>
                                <label>Stock Quantity</label>
                                <input type="number" id="product-stock" min="0" required>
                            </div>
                        </div>
                        
                        <label>Description</label>
                        <textarea id="product-description" rows="4" required></textarea>
                        
                        <label>Commission Rate (%)</label>
                        <input type="number" id="product-commission" min="0" max="100" value="15" required>
                        
                        <label>Product Images</label>
                        <input type="file" id="product-images" accept="image/*" multiple>
                        
                        <button type="submit">Add Product</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-list"></i> Your Products</h2>
                    <div class="product-grid" id="shop-products"></div>
                </div>
            `;
            
            // Render shop products
            const shopProducts = mockProducts.filter(p => p.shopId === "shop1");
            const productsContainer = document.getElementById('shop-products');
            
            shopProducts.forEach(product => {
                productsContainer.innerHTML += `
                    <div class="product-card">
                        <div class="product-image" style="background-image: url('${product.image}')"></div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-price">₦${product.price.toFixed(2)}</div>
                            <p>${product.description.substring(0, 80)}...</p>
                            <div class="product-actions">
                                <button><i class="fas fa-edit"></i> Edit</button>
                                <button class="success"><i class="fas fa-chart-line"></i> Stats</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function shopOwnerOrders() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-shopping-bag"></i> Order Management</h1>
                
                <div class="card">
                    <div class="filter-bar">
                        <select class="filter-select">
                            <option>All Orders</option>
                            <option>Pending</option>
                            <option>Shipped</option>
                            <option>Delivered</option>
                            <option>Cancelled</option>
                        </select>
                        <input type="date" class="filter-select">
                        <input type="text" placeholder="Search orders..." class="filter-select">
                    </div>
                    
                    <table class="table">
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        <tr>
                            <td>#ORD-7832</td>
                            <td>John Smith</td>
                            <td>Oct 12, 2023</td>
                            <td>₦12,999</td>
                            <td><span class="badge success">Shipped</span></td>
                            <td><button>View</button></td>
                        </tr>
                        <tr>
                            <td>#ORD-7831</td>
                            <td>Sarah Johnson</td>
                            <td>Oct 11, 2023</td>
                            <td>₦8,450</td>
                            <td><span class="badge warning">Processing</span></td>
                            <td><button>View</button></td>
                        </tr>
                        <tr>
                            <td>#ORD-7829</td>
                            <td>Michael Brown</td>
                            <td>Oct 10, 2023</td>
                            <td>₦5,299</td>
                            <td><span class="badge success">Delivered</span></td>
                            <td><button>View</button></td>
                        </tr>
                        <tr>
                            <td>#ORD-7825</td>
                            <td>Emily Davis</td>
                            <td>Oct 8, 2023</td>
                            <td>₦3,799</td>
                            <td><span class="badge danger">Cancelled</span></td>
                            <td><button>View</button></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function shopOwnerAffiliates() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-hand-holding-usd"></i> Affiliate Management</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-user-friends"></i> Top Affiliates</h2>
                    <table class="table">
                        <tr>
                            <th>Affiliate</th>
                            <th>Sales</th>
                            <th>Commission</th>
                            <th>Conversion</th>
                            <th>Actions</th>
                        </tr>
                        <tr>
                            <td>Sarah Johnson</td>
                            <td>42</td>
                            <td>₦12,450</td>
                            <td>8.2%</td>
                            <td><button>View</button></td>
                        </tr>
                        <tr>
                            <td>Michael Brown</td>
                            <td>28</td>
                            <td>₦8,320</td>
                            <td>6.7%</td>
                            <td><button>View</button></td>
                        </tr>
                        <tr>
                            <td>Emily Davis</td>
                            <td>19</td>
                            <td>₦5,670</td>
                            <td>5.1%</td>
                            <td><button>View</button></td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-cog"></i> Affiliate Settings</h2>
                    <div class="form-row">
                        <div>
                            <label>Default Commission Rate (%)</label>
                            <input type="number" value="15" min="0" max="50">
                        </div>
                        <div>
                            <label>Minimum Payout (₦)</label>
                            <input type="number" value="5000" min="0">
                        </div>
                    </div>
                    <button>Save Settings</button>
                </div>
            `;
        }

        function shopOwnerPayouts() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-money-bill-wave"></i> Payouts</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-wallet"></i> Request Payout</h2>
                    <div class="form-row">
                        <div>
                            <label>Amount (₦)</label>
                            <input type="number" id="payout-amount" min="5000">
                        </div>
                        <div>
                            <label>Payment Method</label>
                            <select id="payout-method">
                                <option>Bank Transfer</option>
                                <option>PayPal</option>
                                <option>Cryptocurrency</option>
                            </select>
                        </div>
                    </div>
                    <button>Request Payout</button>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-history"></i> Payout History</h2>
                    <table class="table">
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>Oct 5, 2023</td>
                            <td>₦42,500</td>
                            <td>Bank Transfer</td>
                            <td><span class="badge success">Completed</span></td>
                        </tr>
                        <tr>
                            <td>Sep 28, 2023</td>
                            <td>₦38,750</td>
                            <td>Bank Transfer</td>
                            <td><span class="badge success">Completed</span></td>
                        </tr>
                        <tr>
                            <td>Sep 21, 2023</td>
                            <td>₦35,200</td>
                            <td>PayPal</td>
                            <td><span class="badge success">Completed</span></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        // User Functions
        function loadUserTab(tab) {
            switch(tab) {
                case 'Marketplace': return userMarketplace();
                case 'Shops': return userShops();
                case 'Affiliate': return userAffiliate();
                case 'Withdrawals': return userWithdrawals();
                case 'Account': return userAccount();
            }
        }

        function userMarketplace() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-store"></i> Marketplace</h1>
                
                <div class="filter-bar">
                    <select class="filter-select">
                        <option>All Categories</option>
                        <option>Electronics</option>
                        <option>Clothing</option>
                        <option>Home & Kitchen</option>
                        <option>Beauty</option>
                        <option>Sports</option>
                    </select>
                    <select class="filter-select">
                        <option>Price: Low to High</option>
                        <option>Price: High to Low</option>
                        <option>Top Rated</option>
                        <option>Newest</option>
                    </select>
                    <input type="text" placeholder="Search products..." class="filter-select">
                </div>
                
                <div class="product-grid" id="marketplace-products"></div>
            `;
            
            // Render products
            const productsContainer = document.getElementById('marketplace-products');
            
            mockProducts.forEach(product => {
                const shop = mockShops.find(s => s.id === product.shopId);
                
                productsContainer.innerHTML += `
                    <div class="product-card" onclick="viewProduct('${product.id}')">
                        <div class="product-image" style="background-image: url('${product.image}')"></div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-price">₦${product.price.toFixed(2)}</div>
                            <div style="display: flex; align-items: center; margin: 10px 0;">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background-image: url('${shop.logo}'); background-size: cover; margin-right: 10px;"></div>
                                <span>${shop.name}</span>
                            </div>
                            <div class="product-actions">
                                <button onclick="event.stopPropagation(); openShareModal('${product.id}')"><i class="fas fa-share-alt"></i> Share</button>
                                <button class="success" onclick="event.stopPropagation(); addToCart('${product.id}')"><i class="fas fa-shopping-cart"></i> Cart</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function userShops() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-store-alt"></i> Featured Shops</h1>
                
                <div class="shop-grid" id="shops-container"></div>
            `;
            
            // Render shops
            const shopsContainer = document.getElementById('shops-container');
            
            mockShops.forEach(shop => {
                shopsContainer.innerHTML += `
                    <div class="shop-card" onclick="viewShop('${shop.id}')">
                        <div class="shop-logo" style="background-image: url('${shop.logo}')"></div>
                        <div class="shop-info">
                            <div class="shop-name">${shop.name}</div>
                            <p>${shop.description}</p>
                            <div class="shop-stats">
                                <span><i class="fas fa-users"></i> ${shop.followers.toLocaleString()} followers</span>
                                <span><i class="fas fa-box"></i> ${shop.products} products</span>
                            </div>
                        </div>
                        <button class="follow-btn"><i class="fas fa-plus"></i> Follow</button>
                    </div>
                `;
            });
        }

        function userAffiliate() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-user-friends"></i> Affiliate Program</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-trophy"></i> Your Performance</h2>
                    <div class="grid">
                        <div class="stat-card">
                            <div class="icon earnings"><i class="fas fa-money-bill-wave"></i></div>
                            <h3>₦8,450</h3>
                            <p>Total Earnings</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon users"><i class="fas fa-shopping-cart"></i></div>
                            <h3>28</h3>
                            <p>Sales Generated</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon pending"><i class="fas fa-link"></i></div>
                            <h3>1,245</h3>
                            <p>Clicks</p>
                        </div>
                        <div class="stat-card">
                            <div class="icon tokens"><i class="fas fa-percentage"></i></div>
                            <h3>15%</h3>
                            <p>Conversion Rate</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-star"></i> Top Performing Products</h2>
                    <div class="product-grid" id="affiliate-products"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Affiliate Links</h2>
                    <p>Share these links to earn commissions on sales</p>
                    <div id="affiliate-links"></div>
                </div>
            `;
            
            // Render top affiliate products
            const productsContainer = document.getElementById('affiliate-products');
            
            mockProducts.slice(0, 4).forEach(product => {
                productsContainer.innerHTML += `
                    <div class="product-card">
                        <div class="product-image" style="background-image: url('${product.image}')"></div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-price">₦${product.price.toFixed(2)}</div>
                            <p class="commission-rate">Earn ₦${(product.price * product.commissionRate/100).toFixed(2)} per sale</p>
                            <div class="product-actions">
                                <button onclick="openShareModal('${product.id}')"><i class="fas fa-share-alt"></i> Share</button>
                                <button class="success" onclick="copyAffiliateLink('${product.id}')"><i class="fas fa-copy"></i> Copy Link</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Render affiliate links
            const linksContainer = document.getElementById('affiliate-links');
            mockProducts.slice(0, 3).forEach(product => {
                linksContainer.innerHTML += `
                    <div class="affiliate-box" style="margin-top: 20px;">
                        <h3>${product.name}</h3>
                        <div class="referral-link">
                            <input type="text" value="https://marketconnect.com/product/${product.id}?ref=${currentUser.uid}" readonly>
                            <button onclick="copyAffiliateLink('${product.id}')"><i class="fas fa-copy"></i> Copy</button>
                        </div>
                        <p class="commission-rate">Commission: ${product.commissionRate}% (₦${(product.price * product.commissionRate/100).toFixed(2)} per sale)</p>
                    </div>
                `;
            });
        }

        function viewProduct(productId) {
            const product = mockProducts.find(p => p.id === productId);
            const shop = mockShops.find(s => s.id === product.shopId);
            
            if (!product) return;
            
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-box-open"></i> ${product.name}</h1>
                
                <div class="product-detail">
                    <div class="product-gallery">
                        <div class="main-image" style="background-image: url('${product.image}')"></div>
                        <div class="thumbnails">
                            <div class="thumbnail active" style="background-image: url('${product.image}')"></div>
                            <div class="thumbnail" style="background-image: url('${product.image}')"></div>
                            <div class="thumbnail" style="background-image: url('${product.image}')"></div>
                        </div>
                    </div>
                    
                    <div class="product-details">
                        <h2 class="product-title-lg">${product.name}</h2>
                        <div class="product-price-lg">₦${product.price.toFixed(2)}</div>
                        
                        <div class="product-meta">
                            <div><i class="fas fa-store"></i> ${shop.name}</div>
                            <div><i class="fas fa-box"></i> ${product.stock} in stock</div>
                            <div><i class="fas fa-star"></i> 4.8 (124 reviews)</div>
                        </div>
                        
                        <p class="product-description">${product.description}</p>
                        
                        <div class="add-to-cart">
                            <div class="quantity-control">
                                <button class="quantity-btn">-</button>
                                <input type="number" class="quantity-input" value="1" min="1">
                                <button class="quantity-btn">+</button>
                            </div>
                            <button class="cart-btn"><i class="fas fa-shopping-cart"></i> Add to Cart</button>
                        </div>
                        
                        <div class="social-share">
                            <div class="social-btn social-fb" onclick="shareProduct('facebook')">
                                <i class="fab fa-facebook-f"></i>
                            </div>
                            <div class="social-btn social-wa" onclick="shareProduct('whatsapp')">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <div class="social-btn social-tw" onclick="shareProduct('twitter')">
                                <i class="fab fa-twitter"></i>
                            </div>
                            <div class="social-btn social-ig" onclick="shareProduct('instagram')">
                                <i class="fab fa-instagram"></i>
                            </div>
                            <div class="social-btn social-tt" onclick="shareProduct('tiktok')">
                                <i class="fab fa-tiktok"></i>
                            </div>
                            <button onclick="openShareModal('${product.id}')" style="margin-left: auto;">Become Affiliate</button>
                        </div>
                        
                        <div class="affiliate-section">
                            <h3><i class="fas fa-hand-holding-usd"></i> Affiliate Program</h3>
                            <p>Earn ${product.commissionRate}% commission (₦${(product.price * product.commissionRate/100).toFixed(2)}) for each sale you refer</p>
                            <button onclick="openShareModal('${product.id}')">Get Affiliate Link</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-store"></i> More from ${shop.name}</h2>
                    <div class="product-grid" id="shop-products"></div>
                </div>
            `;
            
            // Render more products from this shop
            const shopProducts = mockProducts.filter(p => p.shopId === shop.id && p.id !== product.id);
            const productsContainer = document.getElementById('shop-products');
            
            shopProducts.slice(0, 4).forEach(p => {
                productsContainer.innerHTML += `
                    <div class="product-card" onclick="viewProduct('${p.id}')">
                        <div class="product-image" style="background-image: url('${p.image}')"></div>
                        <div class="product-info">
                            <h3 class="product-title">${p.name}</h3>
                            <div class="product-price">₦${p.price.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
            
            // Show quick signup modal if user is not logged in
            if (!currentUser) {
                setTimeout(() => {
                    openModal('quickSignupModal');
                }, 1000);
            }
        }

        function viewShop(shopId) {
            const shop = mockShops.find(s => s.id === shopId);
            if (!shop) return;
            
            const shopProducts = mockProducts.filter(p => p.shopId === shopId);
            
            const c = document.getElementById('content');
            c.innerHTML = `
                <div class="shop-card">
                    <div class="shop-logo" style="background-image: url('${shop.logo}')"></div>
                    <div class="shop-info">
                        <div class="shop-name">${shop.name}</div>
                        <p>${shop.description}</p>
                        <div class="shop-stats">
                            <span><i class="fas fa-users"></i> ${shop.followers.toLocaleString()} followers</span>
                            <span><i class="fas fa-box"></i> ${shop.products} products</span>
                            <span><i class="fas fa-star"></i> 4.8 (1,245 reviews)</span>
                        </div>
                    </div>
                    <button class="follow-btn"><i class="fas fa-plus"></i> Follow</button>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-box-open"></i> Products</h2>
                <div class="product-grid" id="shop-products"></div>
            `;
            
            // Render shop products
            const productsContainer = document.getElementById('shop-products');
            
            shopProducts.forEach(product => {
                productsContainer.innerHTML += `
                    <div class="product-card" onclick="viewProduct('${product.id}')">
                        <div class="product-image" style="background-image: url('${product.image}')"></div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-price">₦${product.price.toFixed(2)}</div>
                            <div class="product-actions">
                                <button onclick="event.stopPropagation(); openShareModal('${product.id}')"><i class="fas fa-share-alt"></i> Share</button>
                                <button class="success" onclick="event.stopPropagation(); addToCart('${product.id}')"><i class="fas fa-shopping-cart"></i> Cart</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function openShareModal(productId) {
            currentProductId = productId;
            const product = mockProducts.find(p => p.id === productId);
            
            if (!product) return;
            
            document.getElementById('share-link').value = `https://marketconnect.com/product/${productId}?ref=${currentUser ? currentUser.uid : 'REFCODE'}`;
            openModal('shareModal');
        }

        function copyShareLink() {
            const linkInput = document.getElementById('share-link');
            linkInput.select();
            document.execCommand('copy');
            alert('Affiliate link copied to clipboard!');
        }

        function copyAffiliateLink(productId) {
            const product = mockProducts.find(p => p.id === productId);
            if (!product) return;
            
            const link = `https://marketconnect.com/product/${productId}?ref=${currentUser ? currentUser.uid : 'REFCODE'}`;
            
            // Create temporary element to copy text
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            alert('Affiliate link copied to clipboard!');
        }

        function shareProduct(platform) {
            alert(`Sharing product on ${platform.charAt(0).toUpperCase() + platform.slice(1)}`);
            // In a real app, this would open the share dialog for the specific platform
        }

        function addToCart(productId) {
            if (!currentUser) {
                openModal('quickSignupModal');
                return;
            }
            
            const product = mockProducts.find(p => p.id === productId);
            if (!product) return;
            
            alert(`Added ${product.name} to cart!`);
        }

        function quickSignup() {
            const name = document.getElementById('qs-name').value.trim();
            const email = document.getElementById('qs-email').value.trim();
            const pwd = document.getElementById('qs-password').value;
            
            if (!name) return alert('Please enter your name');
            if (!email || !validateEmail(email)) return alert('Please enter a valid email address');
            if (!pwd || pwd.length < 8) return alert('Password must be at least 8 characters');
            
            // In a real app, this would create the user and log them in
            alert(`Account created for ${name}! You can now add products to cart.`);
            closeModal('quickSignupModal');
        }

        function switchToLogin() {
            closeModal('quickSignupModal');
            alert('Please login with your existing account');
            // In a real app, this would switch to the login form
        }

        function userWithdrawals() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-money-check-alt"></i> Withdraw Funds</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-hand-holding-usd"></i> Request Withdrawal</h2>
                    <p>Minimum withdrawal amount: ₦5,000</p>
                    
                    <div class="form-row">
                        <div>
                            <label>Amount (₦)</label>
                            <input type="number" id="wd-amount" min="5000" step="0.01">
                        </div>
                        <div>
                            <label>Payment Method</label>
                            <select id="wd-method">
                                <option value="bank">Bank Transfer</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Cryptocurrency</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="wd-details"></div>
                    
                    <button id="wd-request-btn" onclick="requestWithdrawal()">Request Withdrawal</button>
                    <div id="wd-msg" class="alert" style="display: none; margin-top: 15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-history"></i> Withdrawal History</h2>
                    <table class="table">
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>Oct 5, 2023</td>
                            <td>₦8,500</td>
                            <td>Bank Transfer</td>
                            <td><span class="badge success">Completed</span></td>
                        </tr>
                        <tr>
                            <td>Sep 28, 2023</td>
                            <td>₦6,250</td>
                            <td>PayPal</td>
                            <td><span class="badge success">Completed</span></td>
                        </tr>
                        <tr>
                            <td>Sep 21, 2023</td>
                            <td>₦5,200</td>
                            <td>Bank Transfer</td>
                            <td><span class="badge success">Completed</span></td>
                        </tr>
                    </table>
                </div>
            `;
            
            document.getElementById('wd-method').onchange = updatePaymentDetails;
            updatePaymentDetails();
        }
        
        function updatePaymentDetails() {
            const method = document.getElementById('wd-method').value;
            let html = '';
            
            switch(method) {
                case 'paypal':
                    html = '<label>PayPal Email</label><input type="email" id="wd-account" placeholder="your@paypal.com">';
                    break;
                case 'bank':
                    html = `
                        <div class="form-row">
                            <div>
                                <label>Account Holder Name</label>
                                <input type="text" id="wd-account-name" placeholder="Full name">
                            </div>
                            <div>
                                <label>Account Number</label>
                                <input type="text" id="wd-account-number" placeholder="Account number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Bank Name</label>
                                <input type="text" id="wd-bank-name" placeholder="Bank name">
                            </div>
                            <div>
                                <label>Bank Code</label>
                                <input type="text" id="wd-routing" placeholder="Bank code">
                            </div>
                        </div>
                    `;
                    break;
                case 'crypto':
                    html = '<label>Wallet Address</label><input type="text" id="wd-wallet" placeholder="Your wallet address">';
                    break;
            }
            
            document.getElementById('wd-details').innerHTML = html;
        }

        function userAccount() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-user-cog"></i> Account Settings</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-user"></i> Profile Information</h2>
                    <div class="form-row">
                        <div>
                            <label>Full Name</label>
                            <input type="text" id="acc-name" placeholder="Your full name">
                        </div>
                        <div>
                            <label>Phone Number</label>
                            <input type="tel" id="acc-phone" placeholder="Your phone number">
                        </div>
                    </div>
                    
                    <label>Email Address</label>
                    <input type="email" id="acc-email" placeholder="Your email" disabled>
                    
                    <button onclick="updateProfile()">Update Profile</button>
                    <div id="profile-msg" class="alert" style="display: none; margin-top: 15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-lock"></i> Security</h2>
                    <div>
                        <label>
                            <input type="checkbox" id="acc-2fa"> 
                            Enable Two-Factor Authentication
                        </label>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>Change Password</h3>
                        <input type="password" id="acc-old-pwd" placeholder="Current password">
                        <input type="password" id="acc-new-pwd" placeholder="New password">
                        <input type="password" id="acc-confirm-pwd" placeholder="Confirm new password">
                        
                        <button onclick="changePassword()">Change Password</button>
                        <div id="pwd-msg" class="alert" style="display: none; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-wallet"></i> Payment Information</h2>
                    <p>Set your preferred payment method for withdrawals</p>
                    <div id="payment-info">
                        <div class="form-row">
                            <div>
                                <label>Payment Method</label>
                                <select>
                                    <option>Bank Transfer</option>
                                    <option>PayPal</option>
                                    <option>Cryptocurrency</option>
                                </select>
                            </div>
                        </div>
                        <div id="payment-details"></div>
                        <button>Save Payment Info</button>
                    </div>
                </div>
            `;
            
            if (currentUser && userCache[currentUser.uid]) {
                const d = userCache[currentUser.uid];
                document.getElementById('acc-name').value = d.name || '';
                document.getElementById('acc-email').value = d.email || '';
                document.getElementById('acc-phone').value = d.phone || '';
                document.getElementById('acc-2fa').checked = d.twoFA || false;
            }
            
            document.getElementById('acc-2fa').onchange = update2FA;
        }
        
        function update2FA() {
            const enabled = document.getElementById('acc-2fa').checked;
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({ twoFA: enabled })
                    .then(() => {
                        const msg = `Two-Factor Authentication ${enabled ? 'enabled' : 'disabled'}`;
                        document.getElementById('profile-msg').innerText = msg;
                        document.getElementById('profile-msg').className = 'alert success';
                        document.getElementById('profile-msg').style.display = 'block';
                    });
            }
        }
        
        function updateProfile() {
            const name = document.getElementById('acc-name').value.trim();
            const phone = document.getElementById('acc-phone').value.trim();
            const msgEl = document.getElementById('profile-msg');
            
            if (!name) {
                msgEl.innerText = 'Please enter your name';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            // Update in cache
            if (currentUser && userCache[currentUser.uid]) {
                userCache[currentUser.uid].name = name;
                userCache[currentUser.uid].phone = phone;
                document.getElementById('user-name').innerText = name;
            }
            
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    name: name,
                    phone: phone
                })
                .then(() => {
                    document.getElementById('user-name').innerText = name;
                    msgEl.innerText = 'Profile updated successfully!';
                    msgEl.className = 'alert success';
                    msgEl.style.display = 'block';
                });
            }
        }
        
        function changePassword() {
            const oldPwd = document.getElementById('acc-old-pwd').value;
            const newPwd = document.getElementById('acc-new-pwd').value;
            const confirmPwd = document.getElementById('acc-confirm-pwd').value;
            const msgEl = document.getElementById('pwd-msg');
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                msgEl.innerText = 'Please fill all fields';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            if (newPwd !== confirmPwd) {
                msgEl.innerText = 'New passwords do not match';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            if (newPwd.length < 8) {
                msgEl.innerText = 'Password must be at least 8 characters';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            if (currentUser) {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email, 
                    oldPwd
                );
                
                user.reauthenticateWithCredential(credential)
                    .then(() => {
                        return user.updatePassword(newPwd);
                    })
                    .then(() => {
                        msgEl.innerText = 'Password changed successfully!';
                        msgEl.className = 'alert success';
                    })
                    .catch(err => {
                        msgEl.innerText = 'Error: ' + err.message;
                        msgEl.className = 'alert danger';
                    })
                    .finally(() => {
                        msgEl.style.display = 'block';
                    });
            }
        }

        // Floating contact widget
        function initContactWidget() {
            document.getElementById('contact-widget').onclick = () => {
                window.open('https://www.contactus.com/marketconnect', '_blank');
            };
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                localStorage.setItem('referralCode', refCode);
                document.getElementById('reg-ref').value = refCode;
            }
            
            // Check for product in URL
            const productId = urlParams.get('product');
            if (productId) {
                // In a real app, this would show the product directly
                setTimeout(() => {
                    if (!currentUser) {
                        openModal('quickSignupModal');
                    }
                }, 2000);
            }
        });
    </script>
</body>
</html>
