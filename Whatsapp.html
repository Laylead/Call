<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadConnect Pro - WhatsApp Lead Generation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <!-- External Firebase configuration -->
    <script src="configuration.js"></script>
    
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --dark: #14213d;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --card-bg: #ffffff;
            --bg: #f0f2f5;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .hidden {
            display: none !important;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
            font-weight: 500;
        }
        
        .tab:hover {
            background: rgba(67, 97, 238, 0.1);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .card {
            background: var(--card-bg);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge.success {
            background: rgba(76, 201, 240, 0.15);
            color: #4cc9f0;
        }
        
        .badge.warning {
            background: rgba(247, 37, 133, 0.15);
            color: #f72585;
        }
        
        .badge.info {
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary);
        }
        
        .badge.danger {
            background: rgba(230, 57, 70, 0.15);
            color: var(--danger);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover td {
            background: rgba(67, 97, 238, 0.03);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        button {
            padding: 12px 25px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.25);
        }
        
        button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button i {
            margin-right: 8px;
        }
        
        button.danger {
            background: var(--danger);
        }
        
        button.danger:hover {
            background: #c1121f;
            box-shadow: 0 4px 8px rgba(230, 57, 70, 0.25);
        }
        
        button.success {
            background: var(--success);
        }
        
        button.success:hover {
            background: #3a9fc7;
            box-shadow: 0 4px 8px rgba(76, 201, 240, 0.25);
        }
        
        button.admin {
            background: var(--warning);
        }
        
        button.admin:hover {
            background: #d21e6f;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .alert.info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .alert.success {
            background: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .alert.danger {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .stat-card .icon.users {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .stat-card .icon.earnings {
            background: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .stat-card .icon.pending {
            background: rgba(247, 37, 133, 0.1);
            color: #f72585;
        }
        
        .stat-card .icon.tokens {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .stat-card h3 {
            font-size: 1.8rem;
            margin: 5px 0;
        }
        
        .stat-card p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .page-title {
            margin: 20px 0;
            font-size: 1.8rem;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-right: 10px;
            background: rgba(67, 97, 238, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        
        .section {
            margin: 30px 0;
        }
        
        .section-title {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .input-group {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        /* Video container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            margin: 20px 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        /* Download button */
        .download-btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--success);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background-color: #3a9fc7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 201, 240, 0.25);
        }

        /* Enrollment section */
        .enrollment-section {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            margin: 30px 0;
        }

        .enrollment-section h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .enrollment-section p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .enrollment-count {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            color: var(--success);
        }

        /* WhatsApp input */
        .whatsapp-input {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .whatsapp-input input {
            flex: 1;
            margin: 0;
        }

        .whatsapp-input button {
            margin: 0;
        }

        /* Call to action */
        .cta-section {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: var(--shadow);
        }

        .cta-section h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 45%;
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 90%;
                margin: 20% auto;
            }

            .whatsapp-input {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .tab {
                flex: 1 0 100%;
            }

            .enrollment-section h2 {
                font-size: 1.5rem;
            }

            .enrollment-section p {
                font-size: 1rem;
            }

            .enrollment-count {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="container">
        <div class="card" style="max-width:500px;margin:40px auto;">
            <div style="text-align:center;margin-bottom:20px;">
                <h1 style="color:var(--primary);margin-bottom:10px;">LeadConnect Pro</h1>
                <p>WhatsApp Lead Generation Platform</p>
            </div>
            
            <div class="tabs">
                <div id="to-login" class="tab active">Login</div>
                <div id="to-register" class="tab">Register</div>
            </div>
            
            <div id="login-form">
                <div class="section">
                    <input type="email" id="login-email" placeholder="Email Address">
                    
                    <div class="input-group">
                        <input type="password" id="login-password" placeholder="Password">
                        <span class="password-toggle" id="password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                        <div>
                            <input type="checkbox" id="remember">
                            <label for="remember">Remember me</label>
                        </div>
                        <a href="#" style="color:var(--primary);text-decoration:none;" onclick="showPasswordReset()">Forgot password?</a>
                    </div>
                    
                    <button id="login-btn" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    
                    <div id="login-error" class="alert danger hidden" style="margin-top:15px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        <span id="error-msg"></span>
                    </div>
                </div>
            </div>
            
            <div id="register-form" class="hidden">
                <div class="section">
                    <div class="form-row">
                        <div>
                            <input type="text" id="reg-name" placeholder="Full Name">
                        </div>
                        <div>
                            <input type="text" id="reg-phone" placeholder="Phone Number">
                        </div>
                    </div>
                    
                    <input type="email" id="reg-email" placeholder="Email Address">
                    
                    <div class="input-group">
                        <input type="password" id="reg-password" placeholder="Password">
                        <span class="password-toggle" id="reg-password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <div class="input-group">
                        <input type="password" id="reg-confirm-password" placeholder="Confirm Password">
                        <span class="password-toggle" id="reg-confirm-password-toggle">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <input type="text" id="reg-ref" placeholder="Referral Code (optional)">
                    
                    <button id="register-btn" onclick="register()">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                    <div id="register-error" class="alert danger hidden" style="margin-top:15px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        <span id="register-error-msg"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="container hidden">
        <header>
            <h1 id="app-title"><i class="fas fa-chart-line"></i> Dashboard</h1>
            <div>
                <span id="user-name" style="margin-right:15px;"></span>
                <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>
        
        <div class="tabs" id="tabs"></div>
        
        <div id="content"></div>
    </div>

    <!-- Token Modal -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tokenModal')">&times;</span>
            <h2>Enter Enrollment Token</h2>
            <p>You need a valid token to enroll in the program</p>
            <input type="text" id="enrollmentToken" placeholder="Enter your token">
            <button onclick="verifyEnrollmentToken()">Verify Token</button>
            <div id="tokenMessage" class="alert hidden" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="passwordResetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('passwordResetModal')">&times;</span>
            <h2>Reset Password</h2>
            <p>Enter your email to reset your password</p>
            <input type="email" id="reset-email" placeholder="Your email address">
            <button onclick="sendPasswordReset()">Send Reset Link</button>
            <div id="reset-message" class="alert hidden" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- Edit Balance Modal -->
    <div id="editBalanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editBalanceModal')">&times;</span>
            <h2>Edit User Balance</h2>
            <p>User: <span id="edit-balance-user"></span></p>
            <div>
                <label>Current Balance:</label>
                <span id="current-balance"></span>
            </div>
            <div>
                <label>New Balance:</label>
                <input type="number" id="new-balance" step="0.01">
            </div>
            <button onclick="saveUserBalance()">Save</button>
            <div id="edit-balance-message" class="alert hidden" style="margin-top:15px;"></div>
        </div>
    </div>

    <script>
        // Initialize Firebase from external configuration.js
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        let currentUser = null;
        let isAdmin = false;
        let userCache = {};
        let loadingStates = {};
        let currentEditUserId = null;

        // Password visibility toggle
        document.getElementById('password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('login-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        
        document.getElementById('reg-password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('reg-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        
        document.getElementById('reg-confirm-password-toggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('reg-confirm-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Modal functions
        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function showPasswordReset() {
            document.getElementById('reset-message').className = 'alert hidden';
            document.getElementById('reset-message').style.display = 'none';
            document.getElementById('reset-email').value = '';
            openModal('passwordResetModal');
        }

        // UI toggles
        document.getElementById('to-login').onclick = () => switchForms('login');
        document.getElementById('to-register').onclick = () => switchForms('register');
        
        function switchForms(mode) {
            document.getElementById('to-login').classList.toggle('active', mode === 'login');
            document.getElementById('to-register').classList.toggle('active', mode === 'register');
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', mode !== 'register');
        }

        // Set loading state for buttons
        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (isLoading) {
                loadingStates[buttonId] = button.innerHTML;
                button.innerHTML = '<div class="loading"></div> Processing...';
                button.disabled = true;
            } else {
                if (loadingStates[buttonId]) {
                    button.innerHTML = loadingStates[buttonId];
                }
                button.disabled = false;
            }
        }
        
        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.remove('hidden');
            errorElement.querySelector('span').textContent = message;
        }
        
        // Hide error message
        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // Registration with validation and proper error handling
        function register() {
            hideError('register-error');
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pwd = document.getElementById('reg-password').value;
            const confirmPwd = document.getElementById('reg-confirm-password').value;
            const ref = document.getElementById('reg-ref').value.trim();
            
            if (!name) return showError('register-error', 'Please enter your full name');
            if (!email || !validateEmail(email)) return showError('register-error', 'Please enter a valid email address');
            if (!phone) return showError('register-error', 'Please enter your phone number');
            if (pwd.length < 8) return showError('register-error', 'Password must be at least 8 characters');
            if (pwd !== confirmPwd) return showError('register-error', 'Passwords do not match');
            
            setLoading('register-btn', true);
            
            auth.createUserWithEmailAndPassword(email, pwd)
                .then(userCredential => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name,
                        email,
                        phone,
                        ref,
                        joined: firebase.firestore.FieldValue.serverTimestamp(),
                        role: 'user',
                        status: 'active',
                        balance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: false,
                        whatsappNumber: '',
                        enrollmentDate: null
                    }).then(() => userCredential.user);
                })
                .then(user => {
                    currentUser = user;
                    userCache[user.uid] = {
                        name,
                        email,
                        phone,
                        ref,
                        role: 'user',
                        status: 'active',
                        balance: 0,
                        referrals: 0,
                        commissionRate: 0.15,
                        twoFA: false,
                        enrolled: false,
                        whatsappNumber: '',
                        enrollmentDate: null
                    };
                    isAdmin = false;
                    initApp();
                })
                .catch(err => {
                    console.error("Registration error:", err);
                    showError('register-error', `Registration failed: ${err.message}`);
                })
                .finally(() => {
                    setLoading('register-btn', false);
                });
        }

        // Email validation
        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Login function
        function login() {
            hideError('login-error');
            const email = document.getElementById('login-email').value.trim();
            const pwd = document.getElementById('login-password').value;
            
            if (!email || !validateEmail(email)) return showError('login-error', 'Please enter a valid email address');
            if (!pwd) return showError('login-error', 'Please enter your password');
            
            setLoading('login-btn', true);
            
            auth.signInWithEmailAndPassword(email, pwd)
                .then(res => {
                    return db.collection('users').doc(res.user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                return { user: res.user, data: doc.data() };
                            } else {
                                // Create minimal user document
                                return db.collection('users').doc(res.user.uid).set({
                                    name: email,
                                    email: email,
                                    role: 'user',
                                    status: 'active',
                                    balance: 0,
                                    referrals: 0,
                                    commissionRate: 0.15,
                                    twoFA: false,
                                    enrolled: false,
                                    whatsappNumber: '',
                                    enrollmentDate: null,
                                    joined: firebase.firestore.FieldValue.serverTimestamp()
                                }).then(() => ({ user: res.user, data: { role: 'user' } }));
                            }
                        });
                })
                .then(({ user, data }) => {
                    currentUser = user;
                    isAdmin = data.role === 'admin';
                    userCache[user.uid] = data;
                    initApp();
                })
                .catch(err => {
                    console.error("Login error:", err);
                    showError('login-error', err.message);
                })
                .finally(() => {
                    setLoading('login-btn', false);
                });
        }
        
        function sendPasswordReset() {
            const email = document.getElementById('reset-email').value.trim();
            const msgEl = document.getElementById('reset-message');
            
            if (!email || !validateEmail(email)) {
                msgEl.innerText = 'Please enter a valid email address';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    msgEl.innerText = 'Password reset email sent! Check your inbox.';
                    msgEl.className = 'alert success';
                    msgEl.style.display = 'block';
                })
                .catch(err => {
                    msgEl.innerText = 'Error: ' + err.message;
                    msgEl.className = 'alert danger';
                    msgEl.style.display = 'block';
                });
        }
        
        function logout() {
            auth.signOut();
            currentUser = null;
            isAdmin = false;
            userCache = {};
            window.location.reload();
        }

        // Auth state handler
        auth.onAuthStateChanged(u => {
            if (u) {
                currentUser = u;
                
                // Get user data from Firestore
                db.collection('users').doc(u.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        userCache[u.uid] = data;
                        isAdmin = data.role === 'admin';
                        initApp();
                    } else {
                        // Create minimal user data
                        const minimalData = {
                            name: u.email,
                            email: u.email,
                            role: 'user',
                            status: 'active',
                            balance: 0,
                            referrals: 0,
                            commissionRate: 0.15,
                            twoFA: false,
                            enrolled: false,
                            whatsappNumber: '',
                            enrollmentDate: null
                        };
                        userCache[u.uid] = minimalData;
                        isAdmin = false;
                        initApp();
                        
                        // Save to Firestore
                        db.collection('users').doc(u.uid).set(minimalData);
                    }
                })
                .catch(err => {
                    console.error("Auth state error:", err);
                });
            }
        });
        
        // Initialize app UI
        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Use cached user data if available
            if (currentUser && userCache[currentUser.uid]) {
                document.getElementById('user-name').innerText = userCache[currentUser.uid].name || currentUser.email;
            }
            
            buildTabs();
            const first = isAdmin ? 'Overview' : 'Dashboard';
            setActiveTab(first);
            loadTab(first);
        }

        // Tabs setup
        const adminTabs = ['Overview', 'Tokens', 'Users', 'Enrollments', 'Withdrawals', 'Settings', 'Content'];
        const userTabs = ['Dashboard', 'Referrals', 'Withdrawals', 'Account'];
        
        function buildTabs() {
            const tabsEl = document.getElementById('tabs');
            tabsEl.innerHTML = '';
            
            const tabs = isAdmin ? adminTabs : userTabs;
            tabs.forEach(t => {
                const div = document.createElement('div');
                div.innerText = t;
                div.className = 'tab';
                div.onclick = () => { setActiveTab(t); loadTab(t); };
                tabsEl.appendChild(div);
            });
        }
        
        function setActiveTab(tab) {
            document.getElementById('app-title').innerHTML = `<i class="fas ${getTabIcon(tab)}"></i> ${tab}`;
            document.querySelectorAll('.tabs .tab').forEach(el => {
                el.classList.toggle('active', el.innerText === tab);
            });
        }
        
        function getTabIcon(tab) {
            const icons = {
                'Overview': 'fa-tachometer-alt',
                'Dashboard': 'fa-tachometer-alt',
                'Tokens': 'fa-key',
                'Users': 'fa-users',
                'Enrollments': 'fa-user-plus',
                'Withdrawals': 'fa-money-check-alt',
                'Settings': 'fa-cog',
                'Referrals': 'fa-user-friends',
                'Account': 'fa-user-cog',
                'Content': 'fa-file-alt'
            };
            return icons[tab] || 'fa-file';
        }
        
        function loadTab(tab) {
            document.getElementById('content').innerHTML = '';
            isAdmin ? loadAdminTab(tab) : loadUserTab(tab);
        }

        // Admin Functions
        function loadAdminTab(tab) {
            switch(tab) {
                case 'Overview': return adminOverview();
                case 'Tokens': return adminTokens();
                case 'Users': return adminUsers();
                case 'Enrollments': return adminEnrollments();
                case 'Withdrawals': return adminWithdrawals();
                case 'Settings': return adminSettings();
                case 'Content': return adminContent();
            }
        }

        function adminOverview() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-tachometer-alt"></i> System Overview</h1>
                <div class="grid">
                    <div class="stat-card">
                        <div class="icon users"><i class="fas fa-users"></i></div>
                        <h3 id="stat-users">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon earnings"><i class="fas fa-chart-line"></i></div>
                        <h3 id="stat-earnings">₦0</h3>
                        <p>Total Earnings</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon pending"><i class="fas fa-clock"></i></div>
                        <h3 id="stat-pending">₦0</h3>
                        <p>Pending Withdrawals</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon tokens"><i class="fas fa-key"></i></div>
                        <h3 id="stat-enrollments">0</h3>
                        <p>Active Enrollments</p>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-exclamation-circle"></i> Recent Activities</h2>
                    <div id="recent-activities"></div>
                </div>
            `;
            
            // Live stats from Firestore
            // Users count
            db.collection('users').onSnapshot(snap => {
                document.getElementById('stat-users').textContent = snap.size;
            });
            
            // Earnings and pending withdrawals
            db.collection('transactions').onSnapshot(snap => {
                let earnings = 0;
                let pending = 0;
                
                snap.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'earn') earnings += t.amount;
                    if (t.status === 'pending') pending += t.amount;
                });
                
                document.getElementById('stat-earnings').textContent = '₦' + earnings.toFixed(2);
                document.getElementById('stat-pending').textContent = '₦' + pending.toFixed(2);
            });
            
            // Active enrollments count
            db.collection('users').where('enrolled', '==', true).onSnapshot(snap => {
                document.getElementById('stat-enrollments').textContent = snap.size;
            });
            
            // Recent activities
            db.collection('logs').orderBy('timestamp', 'desc').limit(10).onSnapshot(snap => {
                let html = '<table class="table"><tr><th>User</th><th>Action</th><th>Time</th></tr>';
                
                if (snap.empty) {
                    html = '<div class="alert info">No recent activities found</div>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `
                            <tr>
                                <td>${d.uid}</td>
                                <td>${d.action}</td>
                                <td>${d.timestamp?.toDate().toLocaleString() || '-'}</td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                }
                
                document.getElementById('recent-activities').innerHTML = html;
            });
        }

        function adminTokens() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-key"></i> Enrollment Tokens</h1>
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-plus-circle"></i> Generate Tokens</h2>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <button onclick="adminCreateToken('one-time')"><i class="fas fa-key"></i> One-Time Token</button>
                        <button onclick="adminCreateToken('reusable')"><i class="fas fa-redo"></i> Reusable Token</button>
                        <button onclick="adminBulkGenerate()"><i class="fas fa-bolt"></i> Bulk Generate</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-list"></i> Token List</h2>
                    <div style="margin-bottom: 15px;">
                        <label>Filter: </label>
                        <select id="token-filter" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="all">All Tokens</option>
                            <option value="unused">Unused Only</option>
                            <option value="used">Used Only</option>
                        </select>
                    </div>
                    <div id="tok-table"></div>
                </div>
            `;
            
            document.getElementById('token-filter').onchange = adminRefreshTokens;
            adminRefreshTokens();
        }
        
        function adminCreateToken(type) {
            const tok = Math.random().toString(36).substring(2, 14).toUpperCase();
            db.collection('tokens').add({
                token: tok,
                type: type,
                status: 'unused',
                created: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            }).then(() => {
                // Log event
                db.collection('logs').add({
                    uid: currentUser.uid,
                    action: 'create_token',
                    meta: { type: type, token: tok },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }).catch(err => {
                alert('Error creating token: ' + err.message);
            });
        }
        
        function adminBulkGenerate() {
            const count = parseInt(prompt('How many tokens to generate? (1-100)', '5'), 10);
            if (isNaN(count) || count < 1 || count > 100) return;
            
            const batch = db.batch();
            for (let i = 0; i < count; i++) {
                const ref = db.collection('tokens').doc();
                batch.set(ref, {
                    token: Math.random().toString(36).substring(2, 14).toUpperCase(),
                    type: 'one-time',
                    status: 'unused',
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });
            }
            
            batch.commit().then(() => {
                // Log event
                db.collection('logs').add({
                    uid: currentUser.uid,
                    action: 'bulk_tokens',
                    meta: { count: count },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }).catch(err => {
                alert('Error generating tokens: ' + err.message);
            });
        }
        
        function adminRefreshTokens() {
            const filter = document.getElementById('token-filter').value;
            let query = db.collection('tokens').orderBy('created', 'desc');
            
            if (filter !== 'all') {
                query = query.where('status', '==', filter);
            }
            
            query.onSnapshot(snap => {
                let html = `
                    <table class="table">
                        <tr>
                            <th>Token</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Used By</th>
                            <th>Actions</th>
                        </tr>
                `;
                
                if (snap.empty) {
                    html = '<tr><td colspan="6" style="text-align:center;">No tokens found</td></tr>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `
                            <tr>
                                <td><code>${d.token}</code></td>
                                <td>${d.type}</td>
                                <td><span class="badge ${d.status === 'used' ? 'success' : 'info'}">${d.status}</span></td>
                                <td>${d.created?.toDate().toLocaleString() || '-'}</td>
                                <td>${d.usedBy || '-'}</td>
                                <td>
                                    <button class="danger" onclick="adminDeleteToken('${doc.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += '</table>';
                document.getElementById('tok-table').innerHTML = html;
            });
        }
        
        function adminDeleteToken(id) {
            if (confirm('Are you sure you want to delete this token?')) {
                db.collection('tokens').doc(id).delete()
                    .then(() => {
                        // Log event
                        db.collection('logs').add({
                            uid: currentUser.uid,
                            action: 'delete_token',
                            meta: { id: id },
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    })
                    .catch(err => {
                        alert('Error deleting token: ' + err.message);
                    });
            }
        }

        function adminUsers() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-users"></i> User Management</h1>
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-search"></i> Search Users</h2>
                    <input id="user-search" placeholder="Search by name or email">
                </div>
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-list"></i> User List</h2>
                    <div id="user-table"></div>
                </div>
            `;
            
            document.getElementById('user-search').addEventListener('input', adminRefreshUsers);
            adminRefreshUsers();
        }
        
        function adminRefreshUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            
            db.collection('users').orderBy('joined', 'desc').onSnapshot(snap => {
                let html = `
                    <table class="table">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Joined</th>
                            <th>Status</th>
                            <th>Enrolled</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                `;
                
                if (snap.empty) {
                    html = '<tr><td colspan="7" style="text-align:center;">No users found</td></tr>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        if (searchTerm && !d.name.toLowerCase().includes(searchTerm) && !d.email.toLowerCase().includes(searchTerm)) {
                            return;
                        }
                        
                        html += `
                            <tr>
                                <td>${d.name}</td>
                                <td>${d.email}</td>
                                <td>${d.joined?.toDate().toLocaleDateString() || '-'}</td>
                                <td><span class="badge ${d.status === 'active' ? 'success' : 'warning'}">${d.status}</span></td>
                                <td><span class="badge ${d.enrolled ? 'success' : 'warning'}">${d.enrolled ? 'Yes' : 'No'}</span></td>
                                <td>₦${(d.balance || 0).toFixed(2)}</td>
                                <td>
                                    <button onclick="adminToggleUserStatus('${doc.id}', '${d.status}')">
                                        ${d.status === 'active' ? 'Suspend' : 'Activate'}
                                    </button>
                                    <button onclick="openEditBalanceModal('${doc.id}', '${d.name}', ${d.balance || 0})">
                                        Edit Balance
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += '</table>';
                document.getElementById('user-table').innerHTML = html;
            });
        }
        
        function adminToggleUserStatus(uid, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            
            db.collection('users').doc(uid).update({ status: newStatus })
                .then(() => {
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'toggle_user_status',
                        meta: { uid: uid, status: newStatus },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .catch(err => {
                    alert('Error updating user status: ' + err.message);
                });
        }
        
        function openEditBalanceModal(userId, userName, currentBalance) {
            currentEditUserId = userId;
            document.getElementById('edit-balance-user').textContent = userName;
            document.getElementById('current-balance').textContent = '₦' + currentBalance.toFixed(2);
            document.getElementById('new-balance').value = currentBalance;
            document.getElementById('edit-balance-message').className = 'alert hidden';
            openModal('editBalanceModal');
        }
        
        function saveUserBalance() {
            const newBalance = parseFloat(document.getElementById('new-balance').value);
            const msgEl = document.getElementById('edit-balance-message');
            
            if (isNaN(newBalance)) {
                msgEl.textContent = 'Please enter a valid number';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            db.collection('users').doc(currentEditUserId).update({
                balance: newBalance
            })
            .then(() => {
                msgEl.textContent = 'Balance updated successfully!';
                msgEl.className = 'alert success';
                msgEl.style.display = 'block';
                
                // Log event
                db.collection('logs').add({
                    uid: currentUser.uid,
                    action: 'edit_user_balance',
                    meta: { userId: currentEditUserId, balance: newBalance },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Refresh user table
                adminRefreshUsers();
                
                setTimeout(() => {
                    closeModal('editBalanceModal');
                }, 2000);
            })
            .catch(err => {
                msgEl.textContent = 'Error: ' + err.message;
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
            });
        }

        function adminEnrollments() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-user-plus"></i> Enrollment Management</h1>
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-filter"></i> Filter Enrollments</h2>
                    <div style="display: flex; gap: 15px;">
                        <select id="enrollment-filter" style="flex: 1;">
                            <option value="all">All Enrollments</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-list"></i> Enrolled Users</h2>
                    <div id="enrollment-table"></div>
                </div>
            `;
            
            document.getElementById('enrollment-filter').onchange = adminRefreshEnrollments;
            adminRefreshEnrollments();
        }
        
        function adminRefreshEnrollments() {
            const filter = document.getElementById('enrollment-filter').value;
            let query = db.collection('users').where('enrolled', '==', true).orderBy('enrollmentDate', 'desc');
            
            if (filter === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                query = query.where('enrollmentDate', '>=', today);
            } else if (filter === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                query = query.where('enrollmentDate', '>=', weekAgo);
            } else if (filter === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                query = query.where('enrollmentDate', '>=', monthAgo);
            }
            
            query.onSnapshot(snap => {
                let html = `
                    <table class="table">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>WhatsApp</th>
                            <th>Enrollment Date</th>
                            <th>Status</th>
                            <th>Balance</th>
                        </tr>
                `;
                
                if (snap.empty) {
                    html = '<tr><td colspan="6" style="text-align:center;">No enrollments found</td></tr>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `
                            <tr>
                                <td>${d.name}</td>
                                <td>${d.email}</td>
                                <td>${d.whatsappNumber || '-'}</td>
                                <td>${d.enrollmentDate?.toDate().toLocaleString() || '-'}</td>
                                <td><span class="badge ${d.status === 'active' ? 'success' : 'warning'}">${d.status}</span></td>
                                <td>₦${(d.balance || 0).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
                
                html += '</table>';
                document.getElementById('enrollment-table').innerHTML = html;
            });
        }

        function adminWithdrawals() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-money-check-alt"></i> Withdrawal Requests</h1>
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-filter"></i> Filter</h2>
                    <div style="display: flex; gap: 15px;">
                        <select id="wd-status" style="flex: 1;">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <input type="date" id="wd-date" style="flex: 1;">
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-list"></i> Requests</h2>
                    <div id="wd-table"></div>
                </div>
            `;
            
            document.getElementById('wd-status').onchange = adminRefreshWithdrawals;
            document.getElementById('wd-date').onchange = adminRefreshWithdrawals;
            adminRefreshWithdrawals();
        }
        
        function adminRefreshWithdrawals() {
            const status = document.getElementById('wd-status').value;
            const date = document.getElementById('wd-date').value;
            
            let query = db.collection('withdrawals').orderBy('requestedAt', 'desc');
            
            if (status !== 'all') {
                query = query.where('status', '==', status);
            }
            
            query.onSnapshot(snap => {
                let html = '<table class="table"><tr><th>User</th><th>Amount</th><th>Method</th><th>Date</th><th>Status</th><th>Actions</th></tr>';
                
                if (snap.empty) {
                    html = '<tr><td colspan="6" style="text-align:center;">No withdrawal requests found</td></tr>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        const requestDate = d.requestedAt?.toDate();
                        const dateStr = requestDate?.toLocaleDateString();
                        
                        if (date && requestDate?.toISOString().split('T')[0] !== date) {
                            return;
                        }
                        
                        html += `
                            <tr>
                                <td>${d.userName}</td>
                                <td>₦${d.amount.toFixed(2)}</td>
                                <td>${d.method}</td>
                                <td>${dateStr || '-'}</td>
                                <td><span class="badge ${d.status === 'pending' ? 'warning' : d.status === 'approved' ? 'success' : 'danger'}">${d.status}</span></td>
                                <td>
                                    ${d.status === 'pending' ? `
                                        <button class="success" onclick="adminProcessWithdrawal('${doc.id}', 'approved')">Approve</button>
                                        <button class="danger" onclick="adminProcessWithdrawal('${doc.id}', 'rejected')">Reject</button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += '</table>';
                document.getElementById('wd-table').innerHTML = html;
            });
        }
        
        function adminProcessWithdrawal(id, action) {
            if (confirm(`Are you sure you want to ${action} this withdrawal?`)) {
                db.collection('withdrawals').doc(id).update({ 
                    status: action,
                    processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    processedBy: currentUser.uid
                })
                .then(() => {
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: `withdrawal_${action}`,
                        meta: { id: id },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    if (action === 'approved') {
                        // Update user's balance if approved
                        db.collection('withdrawals').doc(id).get().then(doc => {
                            const data = doc.data();
                            db.collection('users').doc(data.userId).update({
                                balance: firebase.firestore.FieldValue.increment(-data.amount)
                            });
                        });
                    }
                })
                .catch(err => {
                    alert('Error processing withdrawal: ' + err.message);
                });
            }
        }

        function adminSettings() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-cog"></i> System Settings</h1>
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-sliders-h"></i> General Settings</h2>
                    <div class="form-row">
                        <div>
                            <label>System Currency</label>
                            <select id="sys-currency">
                                <option value="NGN">Naira (NGN)</option>
                                <option value="USD">US Dollar (USD)</option>
                                <option value="EUR">Euro (EUR)</option>
                                <option value="GBP">British Pound (GBP)</option>
                            </select>
                        </div>
                        <div>
                            <label>Session Timeout (minutes)</label>
                            <input type="number" id="sys-timeout" min="5" max="120">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div>
                            <label>Maximum Commission (%)</label>
                            <input type="number" id="sys-maxcom" min="0" max="50">
                        </div>
                        <div>
                            <label>System Status</label>
                            <select id="sys-status">
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="adminSaveSystemSettings()">Save Settings</button>
                    <div id="sys-settings-message" class="alert" style="display:none;margin-top:15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-shield-alt"></i> Security Settings</h2>
                    <div>
                        <label>
                            <input type="checkbox" id="sys-2fa"> 
                            Require 2FA for all users
                        </label>
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" id="sys-pwd"> 
                            Require strong passwords
                        </label>
                    </div>
                </div>
            `;
            
            // Load current system settings
            db.collection('settings').doc('system').get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('sys-currency').value = data.currency || 'NGN';
                    document.getElementById('sys-timeout').value = data.sessionTimeout || 30;
                    document.getElementById('sys-maxcom').value = data.maxCommission || 30;
                    document.getElementById('sys-status').value = data.status || 'active';
                    document.getElementById('sys-2fa').checked = data.require2FA || false;
                    document.getElementById('sys-pwd').checked = data.requireStrongPasswords || false;
                }
            });
        }
        
        function adminSaveSystemSettings() {
            const settings = {
                currency: document.getElementById('sys-currency').value,
                sessionTimeout: parseInt(document.getElementById('sys-timeout').value),
                maxCommission: parseFloat(document.getElementById('sys-maxcom').value),
                status: document.getElementById('sys-status').value,
                require2FA: document.getElementById('sys-2fa').checked,
                requireStrongPasswords: document.getElementById('sys-pwd').checked
            };
            
            db.collection('settings').doc('system').set(settings)
                .then(() => {
                    const msgEl = document.getElementById('sys-settings-message');
                    msgEl.textContent = 'System settings saved successfully!';
                    msgEl.className = 'alert success';
                    msgEl.style.display = 'block';
                    
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'save_system_settings',
                        meta: settings,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setTimeout(() => {
                        msgEl.style.display = 'none';
                    }, 3000);
                })
                .catch(err => {
                    const msgEl = document.getElementById('sys-settings-message');
                    msgEl.textContent = 'Error saving settings: ' + err.message;
                    msgEl.className = 'alert danger';
                    msgEl.style.display = 'block';
                });
        }

        function adminContent() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-file-alt"></i> Content Management</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-bullhorn"></i> Announcements</h2>
                    <textarea id="announcement-text" rows="5" placeholder="Enter announcement text"></textarea>
                    <button onclick="saveAnnouncement()">Save Announcement</button>
                    <div id="announcement-message" class="alert" style="display:none;margin-top:15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-video"></i> Video Content</h2>
                    <input type="text" id="video-url" placeholder="YouTube or video URL">
                    <button onclick="saveVideoUrl()">Save Video URL</button>
                    <div id="video-message" class="alert" style="display:none;margin-top:15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-file-download"></i> Downloadable File</h2>
                    <input type="file" id="file-upload">
                    <button onclick="uploadFile()">Upload File</button>
                    <div id="file-message" class="alert" style="display:none;margin-top:15px;"></div>
                    <div id="current-file" style="margin-top:15px;"></div>
                </div>
            `;
            
            // Load current content
            db.collection('content').doc('announcement').get().then(doc => {
                if (doc.exists) {
                    document.getElementById('announcement-text').value = doc.data().text || '';
                }
            });
            
            db.collection('content').doc('video').get().then(doc => {
                if (doc.exists) {
                    document.getElementById('video-url').value = doc.data().url || '';
                }
            });
            
            db.collection('content').doc('file').get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('current-file').innerHTML = `
                        <p>Current file: <strong>${data.name}</strong></p>
                        <a href="${data.url}" class="download-btn" target="_blank">
                            <i class="fas fa-download"></i> Download Current File
                        </a>
                    `;
                }
            });
        }
        
        function saveAnnouncement() {
            const text = document.getElementById('announcement-text').value;
            const msgEl = document.getElementById('announcement-message');
            
            db.collection('content').doc('announcement').set({ text })
                .then(() => {
                    msgEl.textContent = 'Announcement saved successfully!';
                    msgEl.className = 'alert success';
                    msgEl.style.display = 'block';
                    
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'save_announcement',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setTimeout(() => {
                        msgEl.style.display = 'none';
                    }, 3000);
                })
                .catch(err => {
                    msgEl.textContent = 'Error saving announcement: ' + err.message;
                    msgEl.className = 'alert danger';
                    msgEl.style.display = 'block';
                });
        }
        
        function saveVideoUrl() {
            const url = document.getElementById('video-url').value;
            const msgEl = document.getElementById('video-message');
            
            if (!url) {
                msgEl.textContent = 'Please enter a video URL';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            db.collection('content').doc('video').set({ url })
                .then(() => {
                    msgEl.textContent = 'Video URL saved successfully!';
                    msgEl.className = 'alert success';
                    msgEl.style.display = 'block';
                    
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'save_video_url',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setTimeout(() => {
                        msgEl.style.display = 'none';
                    }, 3000);
                })
                .catch(err => {
                    msgEl.textContent = 'Error saving video URL: ' + err.message;
                    msgEl.className = 'alert danger';
                    msgEl.style.display = 'block';
                });
        }
        
        function uploadFile() {
            const fileInput = document.getElementById('file-upload');
            const msgEl = document.getElementById('file-message');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                msgEl.textContent = 'Please select a file to upload';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            const file = fileInput.files[0];
            const storageRef = storage.ref('downloads/' + file.name);
            const uploadTask = storageRef.put(file);
            
            msgEl.textContent = 'Uploading file...';
            msgEl.className = 'alert info';
            msgEl.style.display = 'block';
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Progress monitoring can be added here
                }, 
                (error) => {
                    msgEl.textContent = 'Upload failed: ' + error.message;
                    msgEl.className = 'alert danger';
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        db.collection('content').doc('file').set({
                            name: file.name,
                            url: downloadURL,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .then(() => {
                            msgEl.textContent = 'File uploaded successfully!';
                            msgEl.className = 'alert success';
                            document.getElementById('current-file').innerHTML = `
                                <p>Current file: <strong>${file.name}</strong></p>
                                <a href="${downloadURL}" class="download-btn" target="_blank">
                                    <i class="fas fa-download"></i> Download Current File
                                </a>
                            `;
                            // Log event
                            db.collection('logs').add({
                                uid: currentUser.uid,
                                action: 'upload_file',
                                meta: { name: file.name },
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        })
                        .catch(err => {
                            msgEl.textContent = 'Error saving file info: ' + err.message;
                            msgEl.className = 'alert danger';
                        });
                    });
                }
            );
        }

        // User Functions
        function loadUserTab(tab) {
            switch(tab) {
                case 'Dashboard': return userDashboard();
                case 'Referrals': return userReferrals();
                case 'Withdrawals': return userWithdrawals();
                case 'Account': return userAccount();
            }
        }

        function userDashboard() {
            const c = document.getElementById('content');
            
            if (currentUser && userCache[currentUser.uid] && !userCache[currentUser.uid].enrolled) {
                // Show enrollment page for non-enrolled users
                c.innerHTML = `
                    <div class="enrollment-section">
                        <h2>WhatsApp Lead Generation Program</h2>
                        <p>You need to enroll in the program to access the dashboard</p>
                        <div class="enrollment-count" id="enrollment-count">0</div>
                        <p>people have already enrolled</p>
                    </div>
                    
                    <div class="cta-section">
                        <h3>Imagine getting <span id="enrolled-count" style="font-weight:bold;color:var(--primary);">0</span> as your customers.</h3>
                    </div>
                    
                    <div class="card">
                        <h2 class="section-title"><i class="fab fa-whatsapp"></i> Enroll Now</h2>
                        <p>Enter your WhatsApp number to enroll in our lead generation program</p>
                        
                        <div class="whatsapp-input">
                            <input type="tel" id="whatsapp-number" placeholder="Your WhatsApp number with country code">
                            <button onclick="openTokenModal()">Enroll</button>
                        </div>
                        
                        <div id="enrollment-message" class="alert hidden" style="margin-top:15px;"></div>
                    </div>
                    
                    <div class="card">
                        <h2 class="section-title"><i class="fas fa-bullhorn"></i> Announcement</h2>
                        <div id="announcement-content"></div>
                    </div>
                    
                    <div class="card">
                        <h2 class="section-title"><i class="fas fa-download"></i> Download Resource</h2>
                        <div id="download-content"></div>
                    </div>
                    
                    <div class="card">
                        <h2 class="section-title"><i class="fas fa-video"></i> Training Video</h2>
                        <div id="video-content"></div>
                    </div>
                `;
                
                // Load enrollment count
                db.collection('users').where('enrolled', '==', true).onSnapshot(snap => {
                    document.getElementById('enrollment-count').textContent = snap.size;
                    document.getElementById('enrolled-count').textContent = snap.size;
                });
                
                // Load announcement
                db.collection('content').doc('announcement').onSnapshot(doc => {
                    if (doc.exists) {
                        document.getElementById('announcement-content').innerHTML = doc.data().text || '<p>No announcements yet.</p>';
                    }
                });
                
                // Load video
                db.collection('content').doc('video').onSnapshot(doc => {
                    if (doc.exists && doc.data().url) {
                        const url = doc.data().url;
                        let embedHtml = '';
                        
                        if (url.includes('youtube.com') || url.includes('youtu.be')) {
                            // YouTube embed
                            const videoId = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
                            if (videoId && videoId[1]) {
                                embedHtml = `
                                    <div class="video-container">
                                        <iframe src="https://www.youtube.com/embed/${videoId[1]}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                `;
                            } else {
                                embedHtml = `<p><a href="${url}" target="_blank">Watch Video</a></p>`;
                            }
                        } else {
                            // Generic video link
                            embedHtml = `<p><a href="${url}" target="_blank">Watch Video</a></p>`;
                        }
                        
                        document.getElementById('video-content').innerHTML = embedHtml;
                    } else {
                        document.getElementById('video-content').innerHTML = '<p>No video available yet.</p>';
                    }
                });
                
                // Load downloadable file
                db.collection('content').doc('file').onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('download-content').innerHTML = `
                            <a href="${data.url}" class="download-btn" target="_blank">
                                <i class="fas fa-download"></i> Download ${data.name}
                            </a>
                        `;
                    } else {
                        document.getElementById('download-content').innerHTML = '<p>No file available for download yet.</p>';
                    }
                });
                
                return;
            }
            
            // Regular dashboard for enrolled users
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                
                <div class="grid">
                    <div class="card">
                        <h2 class="section-title"><i class="fas fa-wallet"></i> Account Summary</h2>
                        <div id="user-stats"></div>
                    </div>
                    
                    <div class="card">
                        <h2 class="section-title"><i class="fas fa-chart-bar"></i> Performance</h2>
                        <div style="text-align: center; padding: 20px;">
                            <div style="height:200px;display:flex;align-items:flex-end;justify-content:center;gap:20px;">
                                <div style="width:40px;background:var(--primary);height:80%;border-radius:5px;"></div>
                                <div style="width:40px;background:var(--success);height:60%;border-radius:5px;"></div>
                                <div style="width:40px;background:var(--warning);height:40%;border-radius:5px;"></div>
                                <div style="width:40px;background:var(--danger);height:30%;border-radius:5px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon tokens"><i class="fas fa-users"></i></div>
                        <h3 id="total-enrollments">0</h3>
                        <p>Total Enrollments</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-history"></i> Recent Activity</h2>
                    <div id="user-activity"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-bullhorn"></i> Announcement</h2>
                    <div id="announcement-content"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-download"></i> Download Resource</h2>
                    <div id="download-content"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-video"></i> Training Video</h2>
                    <div id="video-content"></div>
                </div>
            `;
            
            // Load total enrollments
            db.collection('users').where('enrolled', '==', true).onSnapshot(snap => {
                document.getElementById('total-enrollments').textContent = snap.size;
            });
            
            if (currentUser && userCache[currentUser.uid]) {
                const d = userCache[currentUser.uid];
                const bal = d.balance || 0;
                const refs = d.referrals || 0;
                const commissionRate = d.commissionRate || 0.15;
                
                document.getElementById('user-stats').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <p><strong>Account Balance:</strong></p>
                        <h2 style="color: var(--primary);">₦${bal.toFixed(2)}</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Referrals:</strong></p>
                            <p style="font-size: 1.5rem;">${refs}</p>
                        </div>
                        <div>
                            <p><strong>Commission Rate:</strong></p>
                            <p style="font-size: 1.5rem;">${(commissionRate * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="twofa-toggle" ${d.twoFA ? 'checked' : ''}> 
                            Enable Two-Factor Authentication
                        </label>
                    </div>
                `;
                
                document.getElementById('twofa-toggle').onchange = () => {
                    const on = document.getElementById('twofa-toggle').checked;
                    db.collection('users').doc(currentUser.uid).update({ twoFA: on }).then(() => {
                        alert(`Two-Factor Authentication ${on ? 'enabled' : 'disabled'}`);
                        // Log event
                        db.collection('logs').add({
                            uid: currentUser.uid,
                            action: 'toggle_2fa',
                            meta: { twoFA: on },
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                };
            }
            
            // Load announcement
            db.collection('content').doc('announcement').onSnapshot(doc => {
                if (doc.exists) {
                    document.getElementById('announcement-content').innerHTML = doc.data().text || '<p>No announcements yet.</p>';
                }
            });
            
            // Load video
            db.collection('content').doc('video').onSnapshot(doc => {
                if (doc.exists && doc.data().url) {
                    const url = doc.data().url;
                    let embedHtml = '';
                    
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        // YouTube embed
                        const videoId = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
                        if (videoId && videoId[1]) {
                            embedHtml = `
                                <div class="video-container">
                                    <iframe src="https://www.youtube.com/embed/${videoId[1]}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            `;
                        } else {
                            embedHtml = `<p><a href="${url}" target="_blank">Watch Video</a></p>`;
                        }
                    } else {
                        // Generic video link
                        embedHtml = `<p><a href="${url}" target="_blank">Watch Video</a></p>`;
                    }
                    
                    document.getElementById('video-content').innerHTML = embedHtml;
                } else {
                    document.getElementById('video-content').innerHTML = '<p>No video available yet.</p>';
                }
            });
            
            // Load downloadable file
            db.collection('content').doc('file').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('download-content').innerHTML = `
                        <a href="${data.url}" class="download-btn" target="_blank">
                            <i class="fas fa-download"></i> Download ${data.name}
                        </a>
                    `;
                } else {
                    document.getElementById('download-content').innerHTML = '<p>No file available for download yet.</p>';
                }
            });
            
            // Load recent activity
            db.collection('logs').where('uid', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(5)
                .onSnapshot(snap => {
                    let html = '<table class="table"><tr><th>Action</th><th>Time</th></tr>';
                    
                    if (snap.empty) {
                        html = '<p>No recent activity</p>';
                    } else {
                        snap.forEach(doc => {
                            const d = doc.data();
                            html += `
                                <tr>
                                    <td>${d.action}</td>
                                    <td>${d.timestamp.toDate().toLocaleString()}</td>
                                </tr>
                            `;
                        });
                        html += '</table>';
                    }
                    
                    document.getElementById('user-activity').innerHTML = html;
                });
        }

        function openTokenModal() {
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim();
            const msgEl = document.getElementById('enrollment-message');
            
            if (!whatsappNumber) {
                msgEl.innerText = 'Please enter your WhatsApp number';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            document.getElementById('tokenMessage').className = 'alert hidden';
            document.getElementById('tokenMessage').style.display = 'none';
            document.getElementById('enrollmentToken').value = '';
            openModal('tokenModal');
        }

        function verifyEnrollmentToken() {
            const token = document.getElementById('enrollmentToken').value.trim();
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim();
            const msgEl = document.getElementById('tokenMessage');
            
            if (!token) {
                msgEl.innerText = 'Please enter a token';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            msgEl.innerText = 'Verifying token...';
            msgEl.className = 'alert info';
            msgEl.style.display = 'block';
            
            // Check token in Firestore
            db.collection('tokens').where('token', '==', token).where('status', '==', 'unused').limit(1).get()
                .then(snap => {
                    if (snap.empty) {
                        throw new Error('Invalid or already used token');
                    }
                    
                    const tokenDoc = snap.docs[0];
                    const tokenData = tokenDoc.data();
                    
                    // Update token status
                    return db.collection('tokens').doc(tokenDoc.id).update({
                        status: 'used',
                        usedBy: currentUser.uid,
                        usedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        // Update user enrollment status
                        return db.collection('users').doc(currentUser.uid).update({
                            enrolled: true,
                            whatsappNumber: whatsappNumber,
                            enrollmentDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                })
                .then(() => {
                    // Update local cache
                    userCache[currentUser.uid].enrolled = true;
                    userCache[currentUser.uid].whatsappNumber = whatsappNumber;
                    userCache[currentUser.uid].enrollmentDate = new Date();
                    
                    msgEl.innerText = 'Enrollment successful! Welcome to the program.';
                    msgEl.className = 'alert success';
                    
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'enrollment_success',
                        meta: { token: token, whatsappNumber: whatsappNumber },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setTimeout(() => {
                        closeModal('tokenModal');
                        loadTab('Dashboard');
                    }, 2000);
                })
                .catch(err => {
                    msgEl.innerText = 'Error: ' + err.message;
                    msgEl.className = 'alert danger';
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'enrollment_failed',
                        meta: { error: err.message },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
        }

        function userReferrals() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-user-friends"></i> Referral Program</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-link"></i> Your Referral Link</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="referral-link" readonly style="flex: 1;">
                        <button onclick="copyReferralLink()"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                    
                    <div class="alert info">
                        <i class="fas fa-info-circle"></i> 
                        Earn ${isAdmin ? '15%' : '10%'} commission for each successful referral
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Referral Progress</h2>
                    <p>Complete your referral goals to unlock higher commission rates</p>
                    
                    <div class="progress">
                        <div id="ref-progress" class="progress-bar"></div>
                    </div>
                    <p id="ref-status" style="text-align: center; font-weight: 500;"></p>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-users"></i> Your Referrals</h2>
                    <div id="ref-table"></div>
                </div>
            `;
            
            document.getElementById('referral-link').value = window.location.origin + '?ref=' + currentUser.uid;
            
            if (currentUser && userCache[currentUser.uid]) {
                const d = userCache[currentUser.uid];
                const have = d.referrals || 0;
                const needed = 6;
                const pct = Math.min((have / needed) * 100, 100);
                
                document.getElementById('ref-progress').style.width = `${pct}%`;
                document.getElementById('ref-status').innerText = `Referrals: ${have}/${needed} (${Math.round(pct)}%)`;
            }
            
            reloadReferralsTable();
        }
        
        function copyReferralLink() {
            const url = document.getElementById('referral-link').value;
            navigator.clipboard.writeText(url).then(() => {
                alert('Referral link copied to clipboard!');
            });
        }
        
        function reloadReferralsTable() {
            const c = document.getElementById('ref-table');
            db.collection('users').where('ref', '==', currentUser.uid).onSnapshot(q => {
                let html = '';
                
                if (q.empty) {
                    html = '<div class="alert info"><i class="fas fa-info-circle"></i> You have no referrals yet</div>';
                } else {
                    html = '<table class="table"><tr><th>Name</th><th>Email</th><th>Joined</th><th>Status</th></tr>';
                    
                    q.forEach(doc => {
                        const d = doc.data();
                        html += `
                            <tr>
                                <td>${d.name}</td>
                                <td>${d.email}</td>
                                <td>${d.joined?.toDate().toLocaleDateString() || '-'}</td>
                                <td><span class="badge ${d.status === 'active' ? 'success' : 'warning'}">${d.status}</span></td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                }
                
                c.innerHTML = html;
            });
        }

        function userWithdrawals() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-money-check-alt"></i> Withdraw Funds</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-hand-holding-usd"></i> Request Withdrawal</h2>
                    <p>Minimum withdrawal amount: ₦5,000</p>
                    
                    <div class="form-row">
                        <div>
                            <label>Amount (₦)</label>
                            <input type="number" id="wd-amount" min="5000" step="0.01">
                        </div>
                        <div>
                            <label>Payment Method</label>
                            <select id="wd-method">
                                <option value="bank">Bank Transfer</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Cryptocurrency</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="wd-details"></div>
                    
                    <button id="wd-request-btn" onclick="requestWithdrawal()">Request Withdrawal</button>
                    <div id="wd-msg" class="alert" style="display: none; margin-top: 15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-history"></i> Withdrawal History</h2>
                    <div id="wd-history"></div>
                </div>
            `;
            
            document.getElementById('wd-method').onchange = updatePaymentDetails;
            updatePaymentDetails();
            loadWithdrawalHistory();
        }
        
        function updatePaymentDetails() {
            const method = document.getElementById('wd-method').value;
            let html = '';
            
            switch(method) {
                case 'paypal':
                    html = '<label>PayPal Email</label><input type="email" id="wd-account" placeholder="your@paypal.com">';
                    break;
                case 'bank':
                    html = `
                        <div class="form-row">
                            <div>
                                <label>Account Holder Name</label>
                                <input type="text" id="wd-account-name" placeholder="Full name">
                            </div>
                            <div>
                                <label>Account Number</label>
                                <input type="text" id="wd-account-number" placeholder="Account number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Bank Name</label>
                                <input type="text" id="wd-bank-name" placeholder="Bank name">
                            </div>
                            <div>
                                <label>Bank Code</label>
                                <input type="text" id="wd-routing" placeholder="Bank code">
                            </div>
                        </div>
                    `;
                    break;
                case 'crypto':
                    html = '<label>Wallet Address</label><input type="text" id="wd-wallet" placeholder="Your wallet address">';
                    break;
            }
            
            document.getElementById('wd-details').innerHTML = html;
        }
        
        function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('wd-amount').value);
            const method = document.getElementById('wd-method').value;
            const msgEl = document.getElementById('wd-msg');
            
            if (!amount || amount < 5000) {
                msgEl.innerText = 'Minimum withdrawal amount is ₦5,000';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            setLoading('wd-request-btn', true);
            msgEl.innerText = 'Processing your request...';
            msgEl.className = 'alert info';
            msgEl.style.display = 'block';
            
            let accountDetails = '';
            switch(method) {
                case 'paypal':
                    accountDetails = document.getElementById('wd-account').value;
                    break;
                case 'bank':
                    accountDetails = `
                        ${document.getElementById('wd-account-name').value},
                        ${document.getElementById('wd-account-number').value},
                        ${document.getElementById('wd-bank-name').value}
                    `;
                    break;
                case 'crypto':
                    accountDetails = document.getElementById('wd-wallet').value;
                    break;
            }
            
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                const userData = doc.data();
                
                return db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userName: userData.name,
                    amount: amount,
                    method: method,
                    accountDetails: accountDetails,
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            })
            .then(() => {
                msgEl.innerText = 'Withdrawal request submitted successfully!';
                msgEl.className = 'alert success';
                
                return db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-amount)
                });
            })
            .then(() => {
                // Log event
                db.collection('logs').add({
                    uid: currentUser.uid,
                    action: 'withdrawal_request',
                    meta: { amount: amount, method: method },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadWithdrawalHistory();
            })
            .catch(err => {
                msgEl.innerText = 'Error: ' + err.message;
                msgEl.className = 'alert danger';
            })
            .finally(() => {
                setLoading('wd-request-btn', false);
            });
        }
        
        function loadWithdrawalHistory() {
            const c = document.getElementById('wd-history');
            db.collection('withdrawals')
                .where('userId', '==', currentUser.uid)
                .orderBy('requestedAt', 'desc')
                .onSnapshot(q => {
                    let html = '';
                    
                    if (q.empty) {
                        html = '<p>No withdrawal history</p>';
                    } else {
                        html = '<table class="table"><tr><th>Amount</th><th>Method</th><th>Date</th><th>Status</th></tr>';
                        
                        q.forEach(doc => {
                            const d = doc.data();
                            html += `
                                <tr>
                                    <td>₦${d.amount.toFixed(2)}</td>
                                    <td>${d.method}</td>
                                    <td>${d.requestedAt.toDate().toLocaleDateString()}</td>
                                    <td><span class="badge ${d.status === 'pending' ? 'warning' : d.status === 'approved' ? 'success' : 'danger'}">${d.status}</span></td>
                                </tr>
                            `;
                        });
                        
                        html += '</table>';
                    }
                    
                    c.innerHTML = html;
                });
        }

        function userAccount() {
            const c = document.getElementById('content');
            c.innerHTML = `
                <h1 class="page-title"><i class="fas fa-user-cog"></i> Account Settings</h1>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-user"></i> Profile Information</h2>
                    <div class="form-row">
                        <div>
                            <label>Full Name</label>
                            <input type="text" id="acc-name" placeholder="Your full name">
                        </div>
                        <div>
                            <label>Phone Number</label>
                            <input type="tel" id="acc-phone" placeholder="Your phone number">
                        </div>
                    </div>
                    
                    <label>Email Address</label>
                    <input type="email" id="acc-email" placeholder="Your email" disabled>
                    
                    <button onclick="updateProfile()">Update Profile</button>
                    <div id="profile-msg" class="alert" style="display: none; margin-top: 15px;"></div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-lock"></i> Security</h2>
                    <div>
                        <label>
                            <input type="checkbox" id="acc-2fa"> 
                            Enable Two-Factor Authentication
                        </label>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>Change Password</h3>
                        <input type="password" id="acc-old-pwd" placeholder="Current password">
                        <input type="password" id="acc-new-pwd" placeholder="New password">
                        <input type="password" id="acc-confirm-pwd" placeholder="Confirm new password">
                        
                        <button onclick="changePassword()">Change Password</button>
                        <div id="pwd-msg" class="alert" style="display: none; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-wallet"></i> Payment Information</h2>
                    <p>Set your preferred payment method for withdrawals</p>
                    <div id="payment-info"></div>
                </div>
            `;
            
            if (currentUser && userCache[currentUser.uid]) {
                const d = userCache[currentUser.uid];
                document.getElementById('acc-name').value = d.name || '';
                document.getElementById('acc-email').value = d.email || '';
                document.getElementById('acc-phone').value = d.phone || '';
                document.getElementById('acc-2fa').checked = d.twoFA || false;
            }
            
            document.getElementById('acc-2fa').onchange = update2FA;
        }
        
        function update2FA() {
            const enabled = document.getElementById('acc-2fa').checked;
            db.collection('users').doc(currentUser.uid).update({ twoFA: enabled })
                .then(() => {
                    const msg = `Two-Factor Authentication ${enabled ? 'enabled' : 'disabled'}`;
                    document.getElementById('profile-msg').innerText = msg;
                    document.getElementById('profile-msg').className = 'alert success';
                    document.getElementById('profile-msg').style.display = 'block';
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'update_2fa',
                        meta: { enabled: enabled },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
        }
        
        function updateProfile() {
            const name = document.getElementById('acc-name').value.trim();
            const phone = document.getElementById('acc-phone').value.trim();
            const msgEl = document.getElementById('profile-msg');
            
            if (!name) {
                msgEl.innerText = 'Please enter your name';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            // Update in cache
            if (currentUser && userCache[currentUser.uid]) {
                userCache[currentUser.uid].name = name;
                userCache[currentUser.uid].phone = phone;
                document.getElementById('user-name').innerText = name;
            }
            
            db.collection('users').doc(currentUser.uid).update({
                name: name,
                phone: phone
            })
            .then(() => {
                document.getElementById('user-name').innerText = name;
                msgEl.innerText = 'Profile updated successfully!';
                msgEl.className = 'alert success';
                msgEl.style.display = 'block';
                // Log event
                db.collection('logs').add({
                    uid: currentUser.uid,
                    action: 'update_profile',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }
        
        function changePassword() {
            const oldPwd = document.getElementById('acc-old-pwd').value;
            const newPwd = document.getElementById('acc-new-pwd').value;
            const confirmPwd = document.getElementById('acc-confirm-pwd').value;
            const msgEl = document.getElementById('pwd-msg');
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                msgEl.innerText = 'Please fill all fields';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            if (newPwd !== confirmPwd) {
                msgEl.innerText = 'New passwords do not match';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            if (newPwd.length < 8) {
                msgEl.innerText = 'Password must be at least 8 characters';
                msgEl.className = 'alert danger';
                msgEl.style.display = 'block';
                return;
            }
            
            const user = auth.currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email, 
                oldPwd
            );
            
            user.reauthenticateWithCredential(credential)
                .then(() => {
                    return user.updatePassword(newPwd);
                })
                .then(() => {
                    msgEl.innerText = 'Password changed successfully!';
                    msgEl.className = 'alert success';
                    // Log event
                    db.collection('logs').add({
                        uid: currentUser.uid,
                        action: 'change_password',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .catch(err => {
                    msgEl.innerText = 'Error: ' + err.message;
                    msgEl.className = 'alert danger';
                })
                .finally(() => {
                    msgEl.style.display = 'block';
                });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                localStorage.setItem('referralCode', refCode);
            }
        });
    </script>
</body>
</html>
