<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectX - Messages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --gray-color: #6c757d;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-color: #333333;
            --message-sent: #4361ee;
            --message-received: #f0f0f0;
            --input-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 24px;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-actions i {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .header-actions i:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        .new-chat-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .new-chat-btn:hover {
            transform: scale(1.05);
        }

        .search-container {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: var(--body-bg);
            border-radius: 20px;
            padding: 12px 15px;
            transition: var(--transition);
        }

        .search-box:focus-within {
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .search-box i {
            color: var(--gray-color);
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            flex: 1;
            color: var(--text-color);
            font-size: 15px;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-list-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .chat-list-item.active {
            background-color: rgba(67, 97, 238, 0.08);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            position: relative;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        .status-online {
            background-color: #4ade80;
        }

        .status-away {
            background-color: #f59e0b;
        }

        .status-offline {
            background-color: #9ca3af;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: var(--gray-color);
            font-size: 12px;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            color: var(--gray-color);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            position: relative;
        }

        /* Conversation Header */
        .conversation-header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .conversation-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-back-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            margin-right: 5px;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .conversation-user-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .conversation-user-details p {
            color: var(--gray-color);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .conversation-actions {
            display: flex;
            gap: 10px;
        }

        .conversation-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-color);
            background: none;
            border: none;
        }

        .conversation-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23f0f2f5' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.2s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--message-sent);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--message-received);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-media {
            margin-top: 8px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .message-media img {
            width: 100%;
            display: block;
        }

        /* Voice Message */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            margin-top: 8px;
        }

        .message.received .voice-message {
            background: rgba(0,0,0,0.05);
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message.received .voice-play-btn {
            background: rgba(0,0,0,0.1);
            color: var(--text-color);
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
        }

        .voice-progress {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .message.received .voice-progress {
            background: rgba(0,0,0,0.1);
        }

        .voice-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .message.received .voice-progress-bar {
            background: var(--primary-color);
        }

        .voice-duration {
            font-size: 12px;
            min-width: 40px;
            text-align: center;
            opacity: 0.8;
        }

        /* Input Area */
        .input-area {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .chat-input-wrapper {
            flex: 1;
            background-color: var(--input-bg);
            border-radius: 24px;
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            display: flex;
            align-items: flex-end;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            line-height: 1.4;
            max-height: 120px;
            min-height: 24px;
            resize: none;
            padding: 4px 0;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: var(--gray-color);
        }

        .input-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .input-action-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            transform: none;
        }

        /* Voice Recorder */
        .voice-recorder {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 200px;
        }

        .voice-recorder.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning-color);
            font-weight: 600;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-timer {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .recording-actions {
            display: flex;
            gap: 15px;
        }

        .record-action-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .record-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .record-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        .record-action-btn:hover {
            transform: scale(1.1);
        }

        /* Media Preview */
        .media-preview {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .media-preview.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .media-preview-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .media-preview img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .media-preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .preview-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .empty-state p {
            max-width: 300px;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background-color: var(--message-received);
            border-radius: 18px;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-bottom: 8px;
            max-width: 70px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Word Counter */
        .word-counter {
            font-size: 12px;
            color: var(--gray-color);
            text-align: right;
            margin-top: 5px;
            display: none;
        }

        .word-counter.near-limit {
            color: var(--warning-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                height: 100%;
            }
            
            .chat-area {
                width: 100%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .conversation-header {
                padding: 12px 15px;
            }
            
            .messages-area {
                padding: 15px;
            }
            
            .input-area {
                padding: 12px 15px;
            }
        }

        /* Hide elements when in conversation view */
        .conversation-view header,
        .conversation-view .sidebar {
            display: none;
        }

        .conversation-view .chat-area {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>ConnectX Messages</h1>
        </div>
        <div class="header-actions">
            <i class="fas fa-cog" id="settingsBtn"></i>
            <a href="home.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home"></i>
            </a>
            <i class="fas fa-bell" id="notificationsBtn"></i>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Sidebar with Chat List -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Conversations</h2>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchChats" placeholder="Search conversations...">
                </div>
            </div>
            
            <div class="chat-list" id="chatList">
                <!-- Chat list will be populated here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <h3>No conversation selected</h3>
                <p>Select a conversation from the list or start a new chat to begin messaging.</p>
            </div>
            
            <!-- Conversation View (hidden by default) -->
            <div class="conversation-view" id="conversationView" style="display: none;">
                <!-- Conversation Header -->
                <div class="conversation-header">
                    <div class="conversation-user-info">
                        <button class="conversation-back-btn" id="conversationBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="conversation-avatar" id="conversationAvatar">
                            <!-- Avatar will be loaded here -->
                        </div>
                        <div class="conversation-user-details">
                            <h3 id="conversationUserName">User Name</h3>
                            <p id="conversationUserStatus">
                                <span class="status-indicator status-online"></span>
                                <span id="statusText">Online</span>
                            </p>
                        </div>
                    </div>
                    <div class="conversation-actions">
                        <button class="conversation-action-btn" id="viewProfileBtn" title="View Profile">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="input-action-btn" id="attachBtn" title="Attach File">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="input-action-btn" id="voiceBtn" title="Record Voice">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <button class="send-btn" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="word-counter" id="wordCounter">0/35 words</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voice Recorder -->
    <div class="voice-recorder" id="voiceRecorder">
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <span>Recording</span>
        </div>
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="recording-actions">
            <button class="record-action-btn cancel" id="cancelRecordingBtn">
                <i class="fas fa-times"></i>
            </button>
            <button class="record-action-btn send" id="sendRecordingBtn">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>
    
    <!-- Media Preview -->
    <div class="media-preview" id="mediaPreview">
        <div class="media-preview-content">
            <img id="mediaPreviewImage" src="" alt="Preview">
            <div>
                <div id="mediaPreviewName">image.jpg</div>
                <div class="media-preview-actions">
                    <button class="preview-action-btn send" id="sendMediaBtn">Send</button>
                    <button class="preview-action-btn cancel" id="cancelMediaBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- External Configuration -->
    <script src="configuration.js"></script>
    <script src="agora.js"></script>

    <!-- External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Chat Script -->
    <script>
        // Professional Chat Application
        class ConnectXChat {
            constructor() {
                this.state = {
                    currentUser: null,
                    conversations: [],
                    activeConversation: null,
                    messages: [],
                    userProfile: null,
                    mediaFile: null,
                    isRecording: false,
                    recordingTimer: null,
                    recordingStartTime: null,
                    audioChunks: [],
                    mediaRecorder: null,
                    voiceNote: null,
                    conversationId: null,
                    isInConversationView: false
                };

                this.init();
            }

            async init() {
                try {
                    // Check if external configuration is loaded
                    if (typeof firebaseConfig === 'undefined') {
                        console.error('Configuration not loaded.');
                        this.showError('Configuration Error');
                        return;
                    }
                    
                    // Initialize Firebase if not already initialized
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    this.setupDOMReferences();
                    this.setupEventListeners();
                    await this.checkAuthStatus();
                    await this.loadUserProfile();
                    await this.loadConversations();
                    await this.handleURLParameters();
                    
                    console.log('ConnectX Chat initialized successfully');
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    this.showError('Initialization Error');
                }
            }

            setupDOMReferences() {
                this.elements = {
                    // Main container
                    mainContainer: document.getElementById('mainContainer'),
                    
                    // Sidebar elements
                    chatList: document.getElementById('chatList'),
                    searchChats: document.getElementById('searchChats'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    
                    // Chat area elements
                    chatArea: document.getElementById('chatArea'),
                    emptyState: document.getElementById('emptyState'),
                    
                    // Conversation view elements
                    conversationView: document.getElementById('conversationView'),
                    conversationBackBtn: document.getElementById('conversationBackBtn'),
                    conversationAvatar: document.getElementById('conversationAvatar'),
                    conversationUserName: document.getElementById('conversationUserName'),
                    conversationUserStatus: document.getElementById('conversationUserStatus'),
                    statusText: document.getElementById('statusText'),
                    viewProfileBtn: document.getElementById('viewProfileBtn'),
                    messagesArea: document.getElementById('messagesArea'),
                    chatInput: document.getElementById('chatInput'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    attachBtn: document.getElementById('attachBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    wordCounter: document.getElementById('wordCounter'),
                    
                    // Voice recording elements
                    voiceRecorder: document.getElementById('voiceRecorder'),
                    recordingTimer: document.getElementById('recordingTimer'),
                    cancelRecordingBtn: document.getElementById('cancelRecordingBtn'),
                    sendRecordingBtn: document.getElementById('sendRecordingBtn'),
                    
                    // Media preview elements
                    mediaPreview: document.getElementById('mediaPreview'),
                    mediaPreviewImage: document.getElementById('mediaPreviewImage'),
                    mediaPreviewName: document.getElementById('mediaPreviewName'),
                    sendMediaBtn: document.getElementById('sendMediaBtn'),
                    cancelMediaBtn: document.getElementById('cancelMediaBtn')
                };
            }

            setupEventListeners() {
                // Navigation
                this.elements.newChatBtn.addEventListener('click', () => this.startNewChat());
                this.elements.conversationBackBtn.addEventListener('click', () => this.exitConversationView());
                this.elements.viewProfileBtn.addEventListener('click', () => this.viewUserProfile());
                
                // Search
                this.elements.searchChats.addEventListener('input', () => this.filterConversations());
                
                // Message Input
                this.elements.chatInput.addEventListener('input', () => {
                    this.handleInputResize();
                    this.updateWordCounter();
                });
                
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.elements.sendMessageBtn.addEventListener('click', () => this.sendMessage());
                this.elements.attachBtn.addEventListener('click', () => this.handleAttachFile());
                this.elements.voiceBtn.addEventListener('click', () => this.toggleVoiceRecording());
                
                // Voice Recording
                this.elements.cancelRecordingBtn.addEventListener('click', () => this.cancelRecording());
                this.elements.sendRecordingBtn.addEventListener('click', () => this.sendVoiceMessage());
                
                // Media Preview
                this.elements.sendMediaBtn.addEventListener('click', () => this.sendMediaMessage());
                this.elements.cancelMediaBtn.addEventListener('click', () => this.cancelMedia());
            }

            async handleURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const conversationId = urlParams.get('conversation');
                const userId = urlParams.get('user');
                
                if (conversationId) {
                    await this.loadConversation(conversationId);
                } else if (userId) {
                    await this.startConversation(userId);
                }
            }

            async checkAuthStatus() {
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                        } else {
                            window.location.href = 'index.html';
                        }
                        resolve();
                    });
                });
            }

            async loadUserProfile() {
                if (!this.state.currentUser) return;

                try {
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .get();
                    
                    if (userDoc.exists) {
                        this.state.userProfile = userDoc.data();
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async loadConversations() {
                if (!this.state.currentUser) return;

                try {
                    const conversationsSnapshot = await firebase.firestore()
                        .collection('conversations')
                        .where('participants', 'array-contains', this.state.currentUser.uid)
                        .orderBy('lastMessageAt', 'desc')
                        .get();
                    
                    this.state.conversations = conversationsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    this.renderConversations();
                    
                    // Set up real-time listener for conversations
                    this.setupConversationsListener();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            setupConversationsListener() {
                if (!this.state.currentUser) return;
                
                firebase.firestore()
                    .collection('conversations')
                    .where('participants', 'array-contains', this.state.currentUser.uid)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added' || change.type === 'modified') {
                                const conversation = {
                                    id: change.doc.id,
                                    ...change.doc.data()
                                };
                                
                                // Update conversation in state
                                const index = this.state.conversations.findIndex(c => c.id === conversation.id);
                                if (index !== -1) {
                                    this.state.conversations[index] = conversation;
                                } else {
                                    this.state.conversations.unshift(conversation);
                                }
                                
                                // Re-render conversations
                                this.renderConversations();
                            }
                        });
                    }, error => {
                        console.error('Error in conversations listener:', error);
                    });
            }

            renderConversations() {
                if (!this.state.conversations.length) {
                    this.elements.chatList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Start a new chat to connect with others.</p>
                        </div>
                    `;
                    return;
                }

                this.elements.chatList.innerHTML = this.state.conversations.map(conversation => {
                    // Get the other participant's ID
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const isActive = this.state.activeConversation && this.state.activeConversation.id === conversation.id;
                    const unreadCount = conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0;
                    
                    return `
                        <div class="chat-list-item ${isActive ? 'active' : ''}" data-conversation-id="${conversation.id}">
                            <div class="chat-avatar">
                                ${otherParticipant && otherParticipant.profilePicture ? 
                                    `<img src="${otherParticipant.profilePicture}" alt="${otherParticipant.name}" loading="lazy">` :
                                    `${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}`
                                }
                                <div class="status-indicator ${otherParticipant ? `status-${otherParticipant.onlineStatus || 'offline'}` : 'status-offline'}"></div>
                            </div>
                            <div class="chat-info">
                                <div class="chat-header-info">
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}</div>
                                    <div class="chat-time">${this.formatTime(conversation.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    ${conversation.lastMessageType === 'voice' ? '<i class="fas fa-microphone"></i> Voice message' : 
                                      conversation.lastMessageType === 'image' ? '<i class="fas fa-image"></i> Image' :
                                      conversation.lastMessage || 'No messages yet'}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners to conversation items
                this.elements.chatList.querySelectorAll('.chat-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        this.loadConversation(conversationId);
                    });
                });
            }

            filterConversations() {
                const query = this.elements.searchChats.value.toLowerCase();
                
                if (!query) {
                    this.renderConversations();
                    return;
                }
                
                const filteredConversations = this.state.conversations.filter(conversation => {
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    if (!otherParticipant) return false;
                    
                    return otherParticipant.name.toLowerCase().includes(query) || 
                           (otherParticipant.username && otherParticipant.username.toLowerCase().includes(query));
                });
                
                if (!filteredConversations.length) {
                    this.elements.chatList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No conversations found</h3>
                            <p>No conversations match your search.</p>
                        </div>
                    `;
                    return;
                }
                
                this.elements.chatList.innerHTML = filteredConversations.map(conversation => {
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const isActive = this.state.activeConversation && this.state.activeConversation.id === conversation.id;
                    const unreadCount = conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0;
                    
                    return `
                        <div class="chat-list-item ${isActive ? 'active' : ''}" data-conversation-id="${conversation.id}">
                            <div class="chat-avatar">
                                ${otherParticipant && otherParticipant.profilePicture ? 
                                    `<img src="${otherParticipant.profilePicture}" alt="${otherParticipant.name}" loading="lazy">` :
                                    `${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}`
                                }
                                <div class="status-indicator ${otherParticipant ? `status-${otherParticipant.onlineStatus || 'offline'}` : 'status-offline'}"></div>
                            </div>
                            <div class="chat-info">
                                <div class="chat-header-info">
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}</div>
                                    <div class="chat-time">${this.formatTime(conversation.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    ${conversation.lastMessageType === 'voice' ? '<i class="fas fa-microphone"></i> Voice message' : 
                                      conversation.lastMessageType === 'image' ? '<i class="fas fa-image"></i> Image' :
                                      conversation.lastMessage || 'No messages yet'}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners to filtered conversation items
                this.elements.chatList.querySelectorAll('.chat-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        this.loadConversation(conversationId);
                    });
                });
            }

            async loadConversation(conversationId) {
                try {
                    this.showLoading();
                    
                    const conversationDoc = await firebase.firestore()
                        .collection('conversations')
                        .doc(conversationId)
                        .get();
                    
                    if (!conversationDoc.exists) {
                        this.showError('Conversation not found');
                        return;
                    }
                    
                    const conversation = {
                        id: conversationDoc.id,
                        ...conversationDoc.data()
                    };
                    
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Get the other participant's ID
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    
                    // Get user data for the other participant
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(otherParticipantId)
                        .get();
                    
                    if (userDoc.exists) {
                        this.state.activeConversation.user = {
                            id: otherParticipantId,
                            ...userDoc.data()
                        };
                    }
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    this.setupMessagesListener();
                    
                    // Mark conversation as read
                    await this.markAsRead();
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    this.showError('Failed to load conversation');
                }
            }

            async startConversation(userId) {
                try {
                    this.showLoading();
                    
                    // Check if conversation already exists
                    const existingConversation = this.state.conversations.find(conv => 
                        conv.participants.includes(userId)
                    );
                    
                    if (existingConversation) {
                        await this.loadConversation(existingConversation.id);
                        return;
                    }
                    
                    // Get user data
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(userId)
                        .get();
                    
                    if (!userDoc.exists) {
                        this.showError('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Create new conversation
                    const conversationData = {
                        participants: [this.state.currentUser.uid, userId],
                        participantsData: {
                            [this.state.currentUser.uid]: {
                                name: this.state.userProfile.name,
                                profilePicture: this.state.userProfile.profilePicture,
                                onlineStatus: 'online'
                            },
                            [userId]: {
                                name: userData.name,
                                profilePicture: userData.profilePicture,
                                onlineStatus: userData.onlineStatus || 'offline'
                            }
                        },
                        messages: [],
                        lastMessage: '',
                        lastMessageType: '',
                        lastMessageSender: '',
                        lastMessageAt: new Date().toISOString(),
                        createdAt: new Date().toISOString(),
                        unreadCount: {
                            [this.state.currentUser.uid]: 0,
                            [userId]: 0
                        }
                    };
                    
                    const conversationRef = await firebase.firestore()
                        .collection('conversations')
                        .add(conversationData);
                    
                    this.state.activeConversation = {
                        id: conversationRef.id,
                        ...conversationData,
                        user: {
                            id: userId,
                            ...userData
                        }
                    };
                    
                    this.state.conversationId = conversationRef.id;
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    this.setupMessagesListener();
                    
                } catch (error) {
                    console.error('Error starting conversation:', error);
                    this.showError('Failed to start conversation');
                }
            }

            async loadMessages() {
                if (!this.state.conversationId) return;

                try {
                    const conversationDoc = await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .get();
                    
                    if (conversationDoc.exists) {
                        const conversation = conversationDoc.data();
                        this.state.messages = conversation.messages || [];
                        this.renderMessages();
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            setupMessagesListener() {
                if (!this.state.conversationId) return;
                
                // Listen for new messages in real-time
                firebase.firestore()
                    .collection('conversations')
                    .doc(this.state.conversationId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const conversation = doc.data();
                            this.state.messages = conversation.messages || [];
                            this.renderMessages();
                            
                            // Mark as read if it's not our message
                            if (conversation.lastMessageSender !== this.state.currentUser.uid) {
                                this.markAsRead();
                            }
                        }
                    }, error => {
                        console.error('Error in messages listener:', error);
                    });
            }

            renderMessages() {
                if (!this.state.messages.length) {
                    this.elements.messagesArea.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-alt"></i>
                            <h3>No messages yet</h3>
                            <p>Send a message to start the conversation.</p>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = this.state.messages.map(message => {
                    const isSent = message.senderId === this.state.currentUser.uid;
                    
                    let messageContent = '';
                    
                    if (message.type === 'text') {
                        messageContent = `
                            <div class="message-text">${message.content}</div>
                        `;
                    } else if (message.type === 'image') {
                        messageContent = `
                            <div class="message-media">
                                <img src="${message.mediaUrl}" alt="Shared image" loading="lazy">
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        messageContent = `
                            <div class="voice-message">
                                <button class="voice-play-btn" data-audio="${message.mediaUrl}">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="voice-progress">
                                    <div class="voice-progress-bar"></div>
                                </div>
                                <div class="voice-duration">${message.duration || '0:00'}</div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${message.id}">
                            ${messageContent}
                            <div class="message-time">${this.formatTime(message.createdAt)}</div>
                        </div>
                    `;
                }).join('');
                
                this.elements.messagesArea.innerHTML = messagesHTML;
                
                // Add event listeners to voice messages
                this.elements.messagesArea.querySelectorAll('.voice-play-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const audioUrl = e.target.closest('.voice-play-btn').getAttribute('data-audio');
                        this.playVoiceMessage(audioUrl, e.target.closest('.voice-message'));
                    });
                });
                
                // Scroll to bottom
                this.scrollToBottom();
            }

            async sendMessage() {
                const content = this.elements.chatInput.value.trim();
                if (!content && !this.state.mediaFile && !this.state.voiceNote) return;

                // Check word limit
                if (content) {
                    const wordCount = content.split(/\s+/).length;
                    if (wordCount > 35) {
                        this.showError('Message exceeds 35 word limit');
                        return;
                    }
                }

                try {
                    let message = {
                        id: Date.now().toString(),
                        senderId: this.state.currentUser.uid,
                        content: content,
                        type: 'text',
                        createdAt: new Date().toISOString()
                    };

                    // Handle media files
                    if (this.state.mediaFile) {
                        const fileRef = firebase.storage().ref().child(`messages/${this.state.currentUser.uid}/${Date.now()}_${this.state.mediaFile.name}`);
                        await fileRef.put(this.state.mediaFile);
                        const mediaUrl = await fileRef.getDownloadURL();
                        
                        message.type = 'image';
                        message.mediaUrl = mediaUrl;
                        message.content = '';
                    }

                    // Handle voice notes
                    if (this.state.voiceNote) {
                        const fileRef = firebase.storage().ref().child(`voice/${this.state.currentUser.uid}/${Date.now()}_voice.wav`);
                        await fileRef.put(this.state.voiceNote.blob);
                        const mediaUrl = await fileRef.getDownloadURL();
                        
                        message.type = 'voice';
                        message.mediaUrl = mediaUrl;
                        message.duration = this.state.voiceNote.duration;
                        message.content = '';
                    }

                    // Add message to conversation
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayUnion(message),
                            lastMessage: content || (message.type === 'voice' ? 'Voice message' : 'Media'),
                            lastMessageType: message.type,
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date().toISOString(),
                            [`unreadCount.${this.state.activeConversation.user.id}`]: firebase.firestore.FieldValue.increment(1)
                        });

                    // Clear input and reset state
                    this.elements.chatInput.value = '';
                    this.state.mediaFile = null;
                    this.state.voiceNote = null;
                    this.hideMediaPreview();
                    this.handleInputResize();
                    this.updateWordCounter();

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message');
                }
            }

            async markAsRead() {
                if (!this.state.conversationId) return;

                try {
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            [`unreadCount.${this.state.currentUser.uid}`]: 0
                        });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }

            // Voice Recording
            async toggleVoiceRecording() {
                if (this.state.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    this.state.audioChunks = [];
                    this.state.mediaRecorder = new MediaRecorder(stream);
                    
                    this.state.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.state.audioChunks.push(event.data);
                        }
                    };
                    
                    this.state.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/wav' });
                        const duration = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        
                        this.state.voiceNote = {
                            blob: audioBlob,
                            duration: this.formatAudioTime(duration)
                        };
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.state.mediaRecorder.start();
                    this.state.isRecording = true;
                    this.state.recordingStartTime = Date.now();
                    
                    // Show voice recorder UI
                    this.elements.voiceRecorder.classList.add('active');
                    
                    // Start timer
                    this.state.recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                        this.elements.recordingTimer.textContent = this.formatAudioTime(elapsed);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Could not access microphone');
                }
            }

            stopRecording() {
                if (this.state.mediaRecorder && this.state.isRecording) {
                    this.state.mediaRecorder.stop();
                    this.state.isRecording = false;
                    
                    // Hide voice recorder UI
                    this.elements.voiceRecorder.classList.remove('active');
                    
                    // Clear timer
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                        this.state.recordingTimer = null;
                    }
                }
            }

            cancelRecording() {
                this.stopRecording();
                this.state.voiceNote = null;
            }

            sendVoiceMessage() {
                this.stopRecording();
                this.sendMessage();
            }

            playVoiceMessage(audioUrl, voiceElement) {
                const audio = new Audio(audioUrl);
                const playBtn = voiceElement.querySelector('.voice-play-btn');
                const progressBar = voiceElement.querySelector('.voice-progress-bar');
                
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                audio.addEventListener('timeupdate', () => {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    progressBar.style.width = `${percent}%`;
                });
                
                audio.addEventListener('ended', () => {
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    progressBar.style.width = '0%';
                });
                
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            }

            // Media Handling
            handleAttachFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.previewMedia(file);
                    }
                };
                input.click();
            }

            previewMedia(file) {
                this.state.mediaFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.elements.mediaPreviewImage.src = e.target.result;
                    this.elements.mediaPreviewName.textContent = file.name;
                    this.elements.mediaPreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }

            sendMediaMessage() {
                this.sendMessage();
            }

            cancelMedia() {
                this.state.mediaFile = null;
                this.hideMediaPreview();
            }

            hideMediaPreview() {
                this.elements.mediaPreview.classList.remove('active');
            }

            // UI Methods
            enterConversationView() {
                this.state.isInConversationView = true;
                this.elements.mainContainer.classList.add('conversation-view');
                this.elements.conversationView.style.display = 'block';
                this.elements.emptyState.style.display = 'none';
            }

            exitConversationView() {
                this.state.isInConversationView = false;
                this.elements.mainContainer.classList.remove('conversation-view');
                this.elements.conversationView.style.display = 'none';
                this.elements.emptyState.style.display = 'flex';
                this.state.activeConversation = null;
                this.state.conversationId = null;
                
                // Update URL to remove conversation parameter
                const url = new URL(window.location);
                url.searchParams.delete('conversation');
                url.searchParams.delete('user');
                window.history.replaceState({}, '', url);
            }

            showLoading() {
                this.elements.conversationUserName.textContent = 'Loading...';
                this.elements.statusText.textContent = '';
            }

            updateConversationHeader() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                
                const user = this.state.activeConversation.user;
                
                this.elements.conversationUserName.textContent = user.name;
                
                if (user.profilePicture) {
                    this.elements.conversationAvatar.innerHTML = `<img src="${user.profilePicture}" alt="${user.name}" loading="lazy">`;
                } else {
                    this.elements.conversationAvatar.textContent = user.name.charAt(0).toUpperCase();
                }
                
                const status = user.onlineStatus || 'offline';
                this.elements.conversationUserStatus.innerHTML = `
                    <span class="status-indicator status-${status}"></span>
                    <span id="statusText">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
            }

            handleInputResize() {
                const textarea = this.elements.chatInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            updateWordCounter() {
                const content = this.elements.chatInput.value.trim();
                if (!content) {
                    this.elements.wordCounter.style.display = 'none';
                    return;
                }
                
                const wordCount = content.split(/\s+/).length;
                this.elements.wordCounter.textContent = `${wordCount}/35 words`;
                this.elements.wordCounter.style.display = 'block';
                
                if (wordCount > 30) {
                    this.elements.wordCounter.classList.add('near-limit');
                } else {
                    this.elements.wordCounter.classList.remove('near-limit');
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
                }, 100);
            }

            viewUserProfile() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                const userId = this.state.activeConversation.user.id;
                window.location.href = `profile.html?user=${userId}`;
            }

            async startNewChat() {
                const username = prompt('Enter username to start a chat:');
                if (!username) return;
                
                try {
                    // Search for user by username
                    const usersSnapshot = await firebase.firestore()
                        .collection('users')
                        .where('username', '==', username)
                        .limit(1)
                        .get();
                    
                    if (usersSnapshot.empty) {
                        this.showError('User not found');
                        return;
                    }
                    
                    const userDoc = usersSnapshot.docs[0];
                    this.startConversation(userDoc.id);
                } catch (error) {
                    console.error('Error starting new chat:', error);
                    this.showError('Failed to start new chat');
                }
            }

            // Utility Methods
            formatTime(timestamp) {
                if (!timestamp) return 'Just now';
                
                const now = new Date();
                const postTime = new Date(timestamp);
                const diff = now - postTime;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (days > 0) return `${days}d ago`;
                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return 'Just now';
            }

            formatAudioTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            showError(message) {
                alert(message); // In production, use a proper notification system
            }
        }

        // Initialize the chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.connectXChat = new ConnectXChat();
        });
    </script>
</body>
</html>
