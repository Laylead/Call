<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BetFun Casino</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: #111;
      color: #fff;
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(45deg, #222, #333);
      padding: 1rem;
      text-align: center;
      font-size: 2rem;
    }
    .login-container, .game-container, .admin-dashboard {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }
    button {
      padding: 10px 20px;
      background: gold;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    .wheel, .game, .popup, .admin-settings {
      margin: 20px auto;
      max-width: 500px;
      background: #222;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }
    .game {
      background: #1b1b1b;
    }
    .popup {
      background: rgba(0,0,0,0.9);
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>BetFun Casino</header>

  <div class="login-container active" id="auth">
    <h2>Login / Signup</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <button onclick="signup()">Signup</button>
  </div>

  <div class="game-container" id="main">
    <div id="balance-display">Balance: 0 credits</div>

    <div class="wheel" id="welcome-wheel">
      <h3>Welcome Spin (Bonus)</h3>
      <button onclick="spinWheel()">Spin</button>
      <div id="wheel-result"></div>
    </div>

    <div class="game" id="games">
      <h3>Casino Games</h3>
      <button onclick="playLimbo()">Limbo</button>
      <button onclick="playGuessBox()">Guess the Box</button>
      <button onclick="playDodge()">Dodge Game</button>
    </div>
  </div>

  <div class="admin-dashboard" id="admin">
    <h2>Admin Panel</h2>
    <label>CPA Offer URL:</label>
    <input type="text" id="cpa-url"><br><br>
    <button onclick="saveCPAUrl()">Save URL</button>
    <div id="admin-status"></div>
  </div>

  <div class="popup hidden" id="cpa-wall">
    <div>
      <h3>Access Restricted</h3>
      <p>Complete a quick task to continue.</p>
      <button onclick="redirectToCPA()">Subscribe</button>
    </div>
  </div>

  <div class="popup hidden" id="cpa-return">
    <div>
      <h3>Did you complete the task?</h3>
      <button onclick="cpaResponse('yes')">Yes</button>
      <button onclick="cpaResponse('no')">No</button>
    </div>
  </div>

  <script src="/configuration.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script>
    let app, auth, db, user;

    window.onload = async () => {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();

      auth.onAuthStateChanged(async u => {
        if (u) {
          user = u;
          const isAdmin = u.email === 'admin@example.com';
          document.getElementById('auth').classList.remove('active');
          if (isAdmin) {
            document.getElementById('admin').classList.add('active');
            loadCPAUrl();
          } else {
            document.getElementById('main').classList.add('active');
            loadBalance();
          }
        }
      });
    };

    function signup() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, pass);
    }

    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass);
    }

    async function loadBalance() {
      const doc = await db.collection('users').doc(user.uid).get();
      if (!doc.exists) await db.collection('users').doc(user.uid).set({ balance: 0, plays: 0 });
      document.getElementById('balance-display').innerText = `Balance: ${doc.data().balance} credits`;
    }

    async function spinWheel() {
      const reward = Math.floor(Math.random() * 11) + 20;
      await db.collection('users').doc(user.uid).update({
        balance: firebase.firestore.FieldValue.increment(reward)
      });
      document.getElementById('wheel-result').innerText = `You won ${reward} credits!`;
      loadBalance();
    }

    function playLimbo() {
      playGame('Limbo', 5, Math.random() < 0.5);
    }

    function playGuessBox() {
      playGame('Guess Box', 10, Math.random() < 0.4);
    }

    function playDodge() {
      playGame('Dodge', 15, Math.random() < 0.3);
    }

    async function playGame(name, cost, win) {
      const userRef = db.collection('users').doc(user.uid);
      const snap = await userRef.get();
      const balance = snap.data().balance || 0;
      const plays = snap.data().plays || 0;

      if (balance < cost) return alert("Insufficient credits");

      await userRef.update({
        balance: firebase.firestore.FieldValue.increment(-cost),
        plays: firebase.firestore.FieldValue.increment(1)
      });

      if (plays + 1 >= 4) {
        document.getElementById('cpa-wall').classList.remove('hidden');
      }

      if (win) {
        const reward = cost * 2;
        await userRef.update({ balance: firebase.firestore.FieldValue.increment(reward) });
        alert(`You won ${reward} credits!`);
      } else {
        alert("You lost, try again.");
      }

      loadBalance();
    }

    async function redirectToCPA() {
      const urlDoc = await db.doc('settings/cpaConfig').get();
      const url = urlDoc.exists ? urlDoc.data().offerUrl : '#';

      await db.collection('users').doc(user.uid).update({
        cpaClickTime: new Date(),
        userAgent: navigator.userAgent
      });

      window.open(url, '_blank');
      document.getElementById('cpa-wall').classList.add('hidden');
      setTimeout(() => document.getElementById('cpa-return').classList.remove('hidden'), 5000);
    }

    async function cpaResponse(answer) {
      await db.collection('users').doc(user.uid).update({ cpaAnswer: answer });
      document.getElementById('cpa-return').classList.add('hidden');
      if (answer === 'no') alert("Fake accounts will be banned!");
    }

    async function saveCPAUrl() {
      const url = document.getElementById('cpa-url').value;
      await db.doc('settings/cpaConfig').set({ offerUrl: url });
      document.getElementById('admin-status').innerText = "URL Saved!";
    }

    async function loadCPAUrl() {
      const snap = await db.doc('settings/cpaConfig').get();
      if (snap.exists) document.getElementById('cpa-url').value = snap.data().offerUrl;
    }
  </script>
</body>
</html>
