<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stop the Timer Game</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All CSS styles remain exactly the same as provided previously */
        /* ... (keeping all existing CSS styles) ... */
    </style>
</head>
<body>
    <!-- All HTML structure remains exactly the same as provided previously -->
    <!-- ... (keeping all existing HTML structure) ... -->

    <script>
    // Game variables
    let timerInterval;
    let startTime;
    let currentTime = 0;
    let isRunning = false;
    let gamesPlayed = 0;
    let bestTime = 0;
    let walletBalance = 0;
    let giftCardBalance = 0;
    let giveawayCashbackBalance = 0;
    let user = null;
    let isAdmin = false;
    let isAffiliate = false;
    let currentGiveaway = null;
    let activeGiftCard = null;
    let affiliateEarnings = 0;
    let affiliateBalance = 0;
    let referredUsers = 0;
    let activeLinks = 0;
    let selectedUserId = null;
    let userCountry = 'nigeria';
    let adminCurrentCountry = 'nigeria';
    let failedGiftCardAttempts = 0;
    const MAX_GIFTCARD_ATTEMPTS = 5;

    // Initialize with default config first
    let gameSettings = {
        nigeria: {
            gamePrice: 100,
            dailyWinners: 10,
            winningTime: 5.00,
            difficulty: 'medium',
            giftCardPaymentUrl: '#',
            openGiveawayPrice: 2000,
            openGiveawayPaymentUrl: '#',
            fundWalletUrl: '#',
            affiliateCommission: 10,
            giveawayCashback: 15,
            currency: 'â‚¦'
        },
        other: {
            gamePrice: 0.5,
            dailyWinners: 10,
            winningTime: 5.00,
            difficulty: 'medium',
            giftCardPaymentUrl: '#',
            openGiveawayPrice: 3,
            openGiveawayPaymentUrl: '#',
            fundWalletUrl: '#',
            affiliateCommission: 10,
            giveawayCashback: 15,
            currency: 'USDT '
        }
    };

    let socialSettings = {};

    // DOM elements (keeping all existing DOM element references)
    // ... (all existing DOM element variables remain the same) ...

    // Get all modals
    const modals = document.querySelectorAll('.modal');
    
    // Firebase services
    let db, auth;

    // ========== ENHANCED FIREBASE FUNCTIONS ==========

    // Initialize Firebase
    function initializeFirebase() {
        try {
            if (!window.firebaseConfig) {
                throw new Error("Firebase configuration not found. Please check your config.js file.");
            }
            
            const config = window.firebaseConfig;
            
            // Initialize Firebase
            firebase.initializeApp(config);
            
            // Initialize services
            db = firebase.firestore();
            auth = firebase.auth();
            
            console.log("Firebase initialized successfully");
            
            // Set up auth state listener
            auth.onAuthStateChanged(handleAuthStateChanged);
            
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            alert("Error initializing Firebase: " + error.message);
        }
    }

    // ========== ENHANCED DATA LOADING FUNCTIONS ==========

    // Enhanced user data loading
    async function loadUserData(userId) {
        try {
            console.log("Loading user data for:", userId);
            
            // Set up real-time listener for user data
            db.collection('users').doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    console.log("User data received:", userData);
                    
                    // Update UI with user data
                    gamesPlayed = userData.gamesPlayed || 0;
                    bestTime = userData.bestTime || 0;
                    walletBalance = userData.walletBalance || 0;
                    giftCardBalance = userData.giftCardBalance || 0;
                    giveawayCashbackBalance = userData.giveawayCashbackBalance || 0;
                    isAdmin = userData.isAdmin || false;
                    isAffiliate = userData.isAffiliate || false;
                    userCountry = userData.country || 'nigeria';
                    failedGiftCardAttempts = userData.failedGiftCardAttempts || 0;
                    
                    updateStats();
                    updateWalletBalance();
                    updateCurrencyDisplays();
                    
                    // Show admin section if user is admin
                    if (isAdmin) {
                        adminSection.style.display = 'block';
                        loadAdminData();
                    } else {
                        adminSection.style.display = 'none';
                    }
                    
                    // Load affiliate data if user is affiliate
                    if (isAffiliate) {
                        loadAffiliateData(userId);
                    }
                }
            }, (error) => {
                console.error("Error in user data listener:", error);
            });
            
            // Load transactions
            loadTransactionHistory();
            
            // Load gift cards
            db.collection('giftCards')
                .where('userId', '==', userId)
                .where('isActive', '==', true)
                .onSnapshot((snapshot) => {
                    console.log("User gift cards snapshot:", snapshot.size, "documents");
                    updateAvailableGiftCards(snapshot);
                }, (error) => {
                    console.error("Error in gift cards listener:", error);
                });
                
            // Load customer care messages
            loadCustomerCareMessages();
            
        } catch (error) {
            console.error("Error loading user data:", error);
        }
    }

    // Enhanced transaction history loading
    async function loadTransactionHistory() {
        try {
            console.log("Setting up transaction history listener...");
            // Set up real-time listener for transactions
            db.collection('transactions')
                .where('userId', '==', user.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    console.log("Transactions snapshot received:", snapshot.size, "documents");
                    updateTransactionTable(snapshot);
                }, (error) => {
                    console.error("Error in transactions listener:", error);
                    // Show user-friendly error
                    transactionTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger);">Error loading transactions</td></tr>';
                });
        } catch (error) {
            console.error("Error setting up transaction listener:", error);
        }
    }

    // Enhanced payment requests loading (Admin)
    async function loadPaymentRequests() {
        try {
            console.log("Loading payment requests...");
            db.collection('transactions')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    console.log("Payment requests snapshot:", snapshot.size, "documents");
                    updatePaymentRequestsTable(snapshot);
                }, (error) => {
                    console.error("Error in payment requests listener:", error);
                    document.getElementById('pendingTransactionsList').innerHTML = 
                        '<p style="text-align: center; color: var(--danger);">Error loading payment requests</p>';
                });
        } catch (error) {
            console.error("Error loading payment requests:", error);
        }
    }

    // Enhanced withdrawal requests loading (Admin)
    async function loadWithdrawalRequests() {
        try {
            console.log("Loading withdrawal requests...");
            db.collection('withdrawalRequests')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    console.log("Withdrawal requests snapshot:", snapshot.size, "documents");
                    updateWithdrawalRequestsTable(snapshot);
                }, (error) => {
                    console.error("Error in withdrawal requests listener:", error);
                    document.getElementById('withdrawalRequestsList').innerHTML = 
                        '<p style="text-align: center; color: var(--danger);">Error loading withdrawal requests</p>';
                });
        } catch (error) {
            console.error("Error loading withdrawal requests:", error);
        }
    }

    // Enhanced customer care with conversation tracking
    async function loadCustomerCareMessages() {
        try {
            console.log("Loading customer care messages...");
            
            // First, check if there's an active conversation
            const conversationQuery = await db.collection('conversations')
                .where('userId', '==', user.uid)
                .where('status', '==', 'open')
                .get();
                
            if (!conversationQuery.empty) {
                const conversationId = conversationQuery.docs[0].id;
                
                // Load messages for this conversation
                db.collection('messages')
                    .where('conversationId', '==', conversationId)
                    .orderBy('createdAt', 'asc')
                    .onSnapshot((snapshot) => {
                        console.log("Customer care messages snapshot:", snapshot.size, "documents");
                        updateCustomerCareMessages(snapshot);
                    }, (error) => {
                        console.error("Error in customer care messages listener:", error);
                    });
            } else {
                // No active conversation, show welcome message
                chatMessages.innerHTML = `
                    <div class="message admin">
                        <div class="message-header">
                            <span>Admin</span>
                            <span>Just now</span>
                        </div>
                        <div>Hello! How can we help you today?</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error("Error loading customer care messages:", error);
        }
    }

    // Enhanced admin data loading
    async function loadAdminData() {
        try {
            console.log("Setting up admin listeners...");
            
            // Load users
            db.collection('users').onSnapshot((snapshot) => {
                console.log("Users snapshot:", snapshot.size, "documents");
                updateUsersList(snapshot);
            });

            // Load conversations for messages
            db.collection('conversations')
                .where('status', '==', 'open')
                .orderBy('updatedAt', 'desc')
                .onSnapshot((snapshot) => {
                    console.log("Conversations snapshot:", snapshot.size, "documents");
                    updateAdminConversationsList(snapshot);
                });

            // Load assignable users
            db.collection('users').onSnapshot((snapshot) => {
                updateAssignUserSelect(snapshot);
            });

            // Load payment requests
            loadPaymentRequests();

            // Load withdrawal requests  
            loadWithdrawalRequests();

            // Load gift cards
            loadAllGiftCards();

        } catch (error) {
            console.error("Error setting up admin listeners:", error);
        }
    }

    // ========== ENHANCED DATA DISPLAY FUNCTIONS ==========

    // Update payment requests table with gift card modal style
    function updatePaymentRequestsTable(transactionsSnapshot) {
        const pendingTransactionsList = document.getElementById('pendingTransactionsList');
        
        if (!pendingTransactionsList) {
            console.error('Pending transactions list element not found');
            return;
        }
        
        if (transactionsSnapshot.empty) {
            pendingTransactionsList.innerHTML = '<p style="text-align: center; padding: 20px;">No pending payment requests</p>';
            return;
        }
        
        let tableHTML = `
            <table class="gift-cards-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Payment Description</th>
                        <th>Account Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            const date = transaction.createdAt ? transaction.createdAt.toDate().toLocaleDateString() : 'N/A';
            const currencySymbol = transaction.country === 'nigeria' ? 'â‚¦' : 'USDT ';
            
            tableHTML += `
                <tr>
                    <td>${transaction.name || 'N/A'} (${transaction.email || 'N/A'})</td>
                    <td>${transaction.type || 'Wallet Funding'}</td>
                    <td>${currencySymbol}${transaction.amount}</td>
                    <td>${date}</td>
                    <td>${transaction.paymentDescription || 'Not provided'}</td>
                    <td>${transaction.accountDetails || 'Not provided'}</td>
                    <td>
                        <div class="transaction-actions">
                            <button class="btn btn-success btn-sm" onclick="approveTransaction('${doc.id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="declineTransaction('${doc.id}')">Decline</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableHTML += '</tbody></table>';
        pendingTransactionsList.innerHTML = tableHTML;
    }

    // Update withdrawal requests table with gift card modal style
    function updateWithdrawalRequestsTable(requestsSnapshot) {
        const withdrawalRequestsList = document.getElementById('withdrawalRequestsList');
        
        if (!withdrawalRequestsList) {
            console.error('Withdrawal requests list element not found');
            return;
        }
        
        if (requestsSnapshot.empty) {
            withdrawalRequestsList.innerHTML = '<p style="text-align: center; padding: 20px;">No pending withdrawal requests</p>';
            return;
        }
        
        let tableHTML = `
            <table class="gift-cards-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Payment Method</th>
                        <th>Account Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        requestsSnapshot.forEach(doc => {
            const request = doc.data();
            const date = request.createdAt ? request.createdAt.toDate().toLocaleDateString() : 'N/A';
            const currencySymbol = request.country === 'nigeria' ? 'â‚¦' : 'USDT ';
            
            tableHTML += `
                <tr>
                    <td>${request.userId}</td>
                    <td>${request.type === 'giveaway_cashback' ? 'Giveaway Cashback' : 'Affiliate'} Withdrawal</td>
                    <td>${currencySymbol}${request.amount}</td>
                    <td>${date}</td>
                    <td>${request.paymentMethod || 'N/A'}</td>
                    <td>${request.accountDetails || 'N/A'}</td>
                    <td>
                        <div class="transaction-actions">
                            <button class="btn btn-success btn-sm" onclick="approveWithdrawal('${doc.id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="declineWithdrawal('${doc.id}')">Decline</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableHTML += '</tbody></table>';
        withdrawalRequestsList.innerHTML = tableHTML;
    }

    // Enhanced transaction table update
    function updateTransactionTable(transactionsSnapshot) {
        if (transactionsSnapshot.empty) {
            transactionTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">No transactions yet</td></tr>';
            transactionDropdown.innerHTML = '';
            return;
        }
        
        let tableHTML = '';
        let dropdownHTML = '';
        let count = 0;
        
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            const date = transaction.createdAt ? transaction.createdAt.toDate().toLocaleDateString() : 'N/A';
            const currencySymbol = userCountry === 'nigeria' ? 'â‚¦' : 'USDT ';
            const amount = transaction.amount || 0;
            const formattedAmount = amount >= 0 ? 
                `<span style="color: var(--success)">+${currencySymbol}${Math.abs(amount)}</span>` : 
                `<span style="color: var(--danger)">-${currencySymbol}${Math.abs(amount)}</span>`;
            
            const rowHTML = `
                <tr>
                    <td>${date}</td>
                    <td>${transaction.type || 'Transaction'}</td>
                    <td>${formattedAmount}</td>
                    <td>${transaction.status || 'completed'}</td>
                </tr>
            `;
            
            if (count < 5) {
                tableHTML += rowHTML;
            } else {
                dropdownHTML += rowHTML;
            }
            count++;
        });
        
        transactionTable.innerHTML = tableHTML;
        
        if (dropdownHTML) {
            transactionDropdown.innerHTML = `<table>${dropdownHTML}</table>`;
            transactionToggle.style.display = 'block';
        } else {
            transactionDropdown.innerHTML = '';
            transactionToggle.style.display = 'none';
        }
        
        updateLastUpdatedTime();
    }

    // ========== ENHANCED UTILITY FUNCTIONS ==========

    // Utility functions for data consistency
    async function createTransaction(userId, data) {
        const transactionData = {
            userId: userId,
            type: data.type || 'Transaction',
            amount: data.amount || 0,
            status: data.status || 'completed',
            description: data.description || '',
            country: data.country || 'nigeria',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            ...data // Spread any additional fields
        };
        
        return await db.collection('transactions').add(transactionData);
    }

    async function createWithdrawalRequest(userId, data) {
        const requestData = {
            userId: userId,
            type: data.type || 'withdrawal',
            amount: data.amount || 0,
            status: 'pending',
            paymentMethod: data.paymentMethod || 'bank',
            accountDetails: data.accountDetails || '',
            country: data.country || 'nigeria',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            ...data
        };
        
        return await db.collection('withdrawalRequests').add(requestData);
    }

    async function createMessage(conversationId, data) {
        const messageData = {
            conversationId: conversationId,
            sender: data.sender || 'user',
            text: data.text || '',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            ...data
        };
        
        return await db.collection('messages').add(messageData);
    }

    // Enhanced error handling and loading states
    function showLoadingState(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `<p style="text-align: center; padding: 20px;">${message}</p>`;
        }
    }

    function showErrorState(elementId, message = 'Error loading data') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `<p style="text-align: center; color: var(--danger); padding: 20px;">${message}</p>`;
        }
    }

    function showEmptyState(elementId, message = 'No data available') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `<p style="text-align: center; padding: 20px;">${message}</p>`;
        }
    }

    // Debug function to check Firestore data
    async function debugFirestoreData() {
        console.log("=== FIRESTORE DEBUG INFO ===");
        
        // Check transactions
        const transactions = await db.collection('transactions').get();
        console.log("Total transactions:", transactions.size);
        
        // Check pending transactions
        const pending = await db.collection('transactions').where('status', '==', 'pending').get();
        console.log("Pending transactions:", pending.size);
        
        // Check withdrawal requests
        const withdrawals = await db.collection('withdrawalRequests').get();
        console.log("Withdrawal requests:", withdrawals.size);
        
        // Check pending withdrawals
        const pendingWithdrawals = await db.collection('withdrawalRequests').where('status', '==', 'pending').get();
        console.log("Pending withdrawals:", pendingWithdrawals.size);
        
        // Check users
        const users = await db.collection('users').get();
        console.log("Total users:", users.size);
        
        console.log("=== DEBUG COMPLETE ===");
    }

    // ========== ENHANCED EVENT LISTENERS SETUP ==========

    function setupEventListeners() {
        console.log("Setting up event listeners...");
        
        // Game controls
        startBtn.addEventListener('click', startGame);
        stopBtn.addEventListener('click', stopGame);
        payGameBtn.addEventListener('click', () => openModal(giftCardValidationModal));
        
        // Auth controls
        loginBtn.addEventListener('click', () => openModal(loginModal));
        registerBtn.addEventListener('click', () => openModal(registerModal));
        logoutBtn.addEventListener('click', logout);
        
        // Dashboard controls
        fundWalletBtn.addEventListener('click', () => openModal(fundWalletModal));
        generateGiftCardBtn.addEventListener('click', () => openModal(generateGiftCardModal));
        customerCareBtn.addEventListener('click', () => openModal(customerCareModal));
        requestWithdrawalBtn.addEventListener('click', requestWithdrawal);
        requestAffiliateWithdrawalBtn.addEventListener('click', requestAffiliateWithdrawal);
        
        // Enhanced admin controls with proper data loading
        if (manageUsersBtn) manageUsersBtn.addEventListener('click', () => {
            openModal(document.getElementById('manageUsersModal'));
            // Users are loaded automatically via real-time listener
        });
        
        if (viewMessagesBtn) viewMessagesBtn.addEventListener('click', () => {
            openModal(document.getElementById('viewMessagesModal'));
            loadAdminConversations();
        });
        
        if (manageGiftCardsBtn) manageGiftCardsBtn.addEventListener('click', () => {
            openModal(document.getElementById('manageGiftCardsModal'));
            loadAllGiftCards();
        });
        
        if (generateVendorCardBtn) generateVendorCardBtn.addEventListener('click', () => openModal(document.getElementById('generateVendorCardModal')));
        if (assignCardBtn) assignCardBtn.addEventListener('click', () => openModal(document.getElementById('assignCardModal')));
        if (gameSettingsBtn) gameSettingsBtn.addEventListener('click', () => openModal(document.getElementById('gameSettingsModal')));
        if (socialSettingsBtn) socialSettingsBtn.addEventListener('click', () => openModal(document.getElementById('socialSettingsModal')));
        
        if (withdrawalRequestsBtn) withdrawalRequestsBtn.addEventListener('click', () => {
            openModal(document.getElementById('withdrawalRequestsModal'));
            loadWithdrawalRequests();
        });
        
        if (pendingTransactionsBtn) pendingTransactionsBtn.addEventListener('click', () => {
            openModal(document.getElementById('pendingTransactionsModal'));
            loadPaymentRequests();
        });
        
        // Shop controls
        shopGiftCardBtn.addEventListener('click', () => openModal(generateGiftCardModal));
        premiumBtn.addEventListener('click', () => alert('Premium features coming soon!'));
        merchandiseBtn.addEventListener('click', () => alert('Merchandise shop coming soon!'));
        
        // Gift card validation
        validateGiftcardBtn.addEventListener('click', validateGiftcard);
        
        // Gift card amount calculation
        giftCardAmount.addEventListener('input', function() {
            const amount = parseInt(this.value) || 0;
            giftCardValue.textContent = amount;
        });
        
        // Bulk gift card amount calculation
        bulkGiftCardAmount.addEventListener('input', function() {
            const amount = parseInt(this.value) || 0;
            const cardCount = Math.floor(amount / 100);
            bulkGiftCardCount.textContent = cardCount;
        });
        
        // Gift card type selection
        giftcardTypeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                giftcardTypeBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                giftCardTypeInput.value = this.dataset.type;
                
                if (this.dataset.type === 'single') {
                    singleGiftCardFields.style.display = 'block';
                    bulkGiftCardFields.style.display = 'none';
                } else {
                    singleGiftCardFields.style.display = 'none';
                    bulkGiftCardFields.style.display = 'block';
                }
            });
        });
        
        // Giveaway type selection - FIXED
        giveawayTypeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                giveawayTypeBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                giveawayTypeInput.value = this.dataset.type;
                
                if (this.dataset.type === 'giftcard') {
                    giftcardGiveawayFields.style.display = 'block';
                } else {
                    giftcardGiveawayFields.style.display = 'none';
                }
            });
        });
        
        // Country selection in registration
        countryBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                countryBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                userCountryInput.value = this.dataset.country;
                userCountry = this.dataset.country;
                
                // Update currency displays
                updateCurrencyDisplays();
            });
        });
        
        // Admin country tabs
        adminCountryTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                adminCountryTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                adminCurrentCountry = this.dataset.country;
                
                // Update admin settings form with current country settings
                updateAdminSettingsForm();
            });
        });
        
        // Giveaway form submission
        giveawayForm.addEventListener('submit', handleGiveawayCreation);
        
        // Copy giveaway link
        copyGiveawayLinkBtn.addEventListener('click', function() {
            giveawayLinkInput.select();
            document.execCommand('copy');
            alert('Giveaway link copied to clipboard!');
        });
        
        // Gift card form submission
        document.getElementById('giftCardForm').addEventListener('submit', handleGiftCardGeneration);
        
        // Vendor card form submission
        vendorCardForm.addEventListener('submit', handleVendorCardGeneration);
        
        // Assign card form submission
        assignCardForm.addEventListener('submit', handleAssignCard);
        
        // Customer care form submission
        customerCareForm.addEventListener('submit', handleCustomerCareMessage);
        
        // Admin reply form submission
        adminReplyForm.addEventListener('submit', handleAdminReply);
        
        // Settle conversation button
        if (settleConversationBtn) {
            settleConversationBtn.addEventListener('click', settleConversation);
        }
        
        // User messages filter change
        userMessagesFilter.addEventListener('change', handleUserMessagesFilterChange);
        
        // Fund wallet dropdown
        iHaveFundedBtn.addEventListener('click', function() {
            fundWalletDropdown.classList.toggle('active');
        });
        
        // Transaction dropdown toggle
        transactionToggle.addEventListener('click', function() {
            transactionDropdown.classList.toggle('active');
            this.textContent = transactionDropdown.classList.contains('active') ? 'Hide Transactions' : 'View All Transactions';
        });
        
        // Menu toggle
        menuToggle.addEventListener('click', toggleSidebar);
        
        // Payment method toggle
        if (paymentMethod) {
            paymentMethod.addEventListener('change', function() {
                if (this.value === 'crypto') {
                    cryptoDetails.style.display = 'block';
                } else {
                    cryptoDetails.style.display = 'none';
                }
            });
        }
        
        // Refresh buttons
        refreshTransactionsBtn.addEventListener('click', refreshTransactions);
        refreshWithdrawalRequestsBtn.addEventListener('click', refreshWithdrawalRequests);
        refreshPendingTransactionsBtn.addEventListener('click', refreshPendingTransactions);
        refreshGiftCardsBtn.addEventListener('click', refreshGiftCards);
        
        // Gift card management filters
        giftCardFilter.addEventListener('change', loadAllGiftCards);
        searchGiftCards.addEventListener('input', 
            debounce(loadAllGiftCards, 300)
        );
        
        // Form submissions
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('fundWalletForm').addEventListener('submit', handleFundWallet);
        
        // Game settings form
        document.getElementById('gameSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const gamePrice = parseFloat(document.getElementById('gamePrice').value);
            const dailyWinners = parseInt(document.getElementById('dailyWinners').value);
            const winningTime = parseFloat(document.getElementById('winningTimeSetting').value);
            const openGiveawayPrice = parseFloat(document.getElementById('openGiveawayPrice').value);
            const giftCardPaymentUrl = document.getElementById('giftCardPaymentUrl').value;
            const openGiveawayPaymentUrl = document.getElementById('openGiveawayPaymentUrl').value;
            const fundWalletUrl = document.getElementById('fundWalletUrl').value;
            
            try {
                // Save game settings for the current admin country
                const settings = {
                    gamePrice: gamePrice,
                    dailyWinners: dailyWinners,
                    winningTime: winningTime,
                    openGiveawayPrice: openGiveawayPrice,
                    giftCardPaymentUrl: giftCardPaymentUrl,
                    openGiveawayPaymentUrl: openGiveawayPaymentUrl,
                    fundWalletUrl: fundWalletUrl
                };
                
                await db.collection('config').doc(`gameSettings_${adminCurrentCountry}`).set(settings, { merge: true });
                
                alert('Game settings saved successfully!');
                closeModal(document.getElementById('gameSettingsModal'));
            } catch (error) {
                console.error("Error saving game settings:", error);
                alert('Error saving game settings: ' + error.message);
            }
        });
        
        // Social settings form
        document.getElementById('socialSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const youtubeUrl = document.getElementById('youtubeUrl').value;
            const tiktokUrl = document.getElementById('tiktokUrl').value;
            const twitterUrl = document.getElementById('twitterUrl').value;
            const facebookUrl = document.getElementById('facebookUrl').value;
            const instagramUrl = document.getElementById('instagramUrl').value;
            
            try {
                // Save social settings
                const settings = {
                    youtube: youtubeUrl,
                    tiktok: tiktokUrl,
                    twitter: twitterUrl,
                    facebook: facebookUrl,
                    instagram: instagramUrl
                };
                
                await db.collection('config').doc('socialSettings').set(settings, { merge: true });
                
                alert('Social settings saved successfully!');
                closeModal(document.getElementById('socialSettingsModal'));
            } catch (error) {
                console.error("Error saving social settings:", error);
                alert('Error saving social settings: ' + error.message);
            }
        });
        
        // Close buttons
        document.querySelectorAll('.close-btn').forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal');
                closeModal(modal);
            });
        });
        
        // Close modal when clicking outside
        modals.forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this);
                }
            });
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 900 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
        
        // Transaction filter
        transactionFilter.addEventListener('change', function() {
            filterTransactions(this.value);
        });
        
        // Giveaway filter
        giveawayFilter.addEventListener('change', function() {
            filterGiveaways(this.value);
        });
        
        // Search users
        if (searchUsers) {
            searchUsers.addEventListener('input', function() {
                searchUsersList(this.value);
            });
        }
        
        console.log("Event listeners setup complete");
    }

    // ========== KEEP ALL EXISTING FUNCTIONS ==========

    // All other existing functions remain the same (game functions, form handlers, etc.)
    // Only the data loading and display functions above have been enhanced

    // Initialize everything
    function init() {
        console.log("Initializing application...");
        
        // Initialize Firebase
        initializeFirebase();
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize UI
        updateTimerDisplay(currentTime);
        updateStats();
        updateWalletBalance();
        updateAffiliateStats();
        updateSidebarMenu();
        
        console.log("Application initialized successfully");
        
        // Temporary: Uncomment to debug Firestore data
        // setTimeout(() => {
        //     if (user) debugFirestoreData();
        // }, 3000);
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', init);

    // Export functions to global scope for HTML onclick handlers
    window.copyGiftCardCode = copyGiftCardCode;
    window.approveTransaction = approveTransaction;
    window.declineTransaction = declineTransaction;
    window.approveWithdrawal = approveWithdrawal;
    window.declineWithdrawal = declineWithdrawal;
    window.toggleVerification = toggleVerification;
    window.debitUser = debitUser;
    window.banUser = banUser;
    window.viewGiveaway = viewGiveaway;
    window.copyGiveawayLink = copyGiveawayLink;
    window.generateAffiliateLink = generateAffiliateLink;
    window.validateGiftcard = validateGiftcard;
    window.viewGiftCardDetails = viewGiftCardDetails;
    window.deactivateGiftCard = deactivateGiftCard;
    window.activateGiftCard = activateGiftCard;
    window.copyAffiliateLink = copyAffiliateLink;
    window.deactivateAffiliateLink = deactivateAffiliateLink;
    window.settleConversation = settleConversation;
    </script>

    <!-- Additional utility functions -->
    <script>
    // Utility function to format currency
    function formatCurrency(amount, country = 'nigeria') {
        const currency = country === 'nigeria' ? 'â‚¦' : 'USDT ';
        return `${currency}${amount.toFixed(2)}`;
    }

    // Utility function to generate random IDs
    function generateId(length = 8) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // Utility function to validate email
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // Utility function to format date
    function formatDate(date) {
        return new Date(date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Utility function to debounce function calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initialize modals with reset functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Reset gift card validation modal when opened
        document.getElementById('giftCardValidationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                resetGiftCardValidation();
            }
        });

        // Reset giveaway form when modal is closed
        document.getElementById('giveawaySection').addEventListener('click', function() {
            if (!giveawayCreatedSection.style.display || giveawayCreatedSection.style.display === 'none') {
                resetGiveawayForm();
            }
        });

        // Reset gift card form when modal is closed
        document.getElementById('generateGiftCardModal').addEventListener('click', function(e) {
            if (e.target === this) {
                resetGiftCardForm();
            }
        });

        // Reset vendor card form when modal is closed
        document.getElementById('generateVendorCardModal').addEventListener('click', function(e) {
            if (e.target === this) {
                resetVendorCardForm();
            }
        });

        // Load tasks when task modal is opened
        document.getElementById('taskCompletionModal').addEventListener('click', function() {
            loadTasks();
        });
    });

    // Handle page visibility changes for real-time updates
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && user) {
            // Page became visible, refresh data
            loadUserData(user.uid);
            if (isAdmin) {
                loadAdminData();
            }
        }
    });

    // Handle online/offline status
    window.addEventListener('online', function() {
        console.log('Application is online');
        // Refresh data when coming back online
        if (user) {
            loadUserData(user.uid);
        }
    });

    window.addEventListener('offline', function() {
        console.log('Application is offline');
        alert('You are currently offline. Some features may not work properly.');
    });

    // Error handling for uncaught errors
    window.addEventListener('error', function(e) {
        console.error('Uncaught error:', e.error);
        // You might want to send this to an error tracking service
    });

    // Handle beforeunload to clean up resources
    window.addEventListener('beforeunload', function() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    });
    </script>
</body>
</html>
