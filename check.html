<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kheemz Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body{
  font-family:'Inter',sans-serif;
  margin:0;
  background:linear-gradient(180deg,#131c2b,#090f18);
  color:#fff;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
}
#chatApp{
  position:fixed;
  bottom:20px;
  right:20px;
  width:400px;
  max-width:95%;
  height:550px;
  border-radius:16px;
  display:none;
  flex-direction:column;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.1);
  overflow:hidden;
}
header{
  background:rgba(255,255,255,0.05);
  padding:10px;
  text-align:center;
  font-weight:600;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
#chat-box{
  flex:1;
  overflow-y:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  max-width:75%;
  padding:10px 14px;
  border-radius:14px;
  word-wrap:break-word;
  animation:fadeIn .3s;
}
.msg.self{align-self:flex-end;background:linear-gradient(45deg,#ff6f2d,#ff4b98);}
.msg.other{align-self:flex-start;background:rgba(255,255,255,0.08);}
.msg img,.msg video{max-width:100%;border-radius:10px;margin-top:6px;}
small{display:block;font-size:11px;opacity:0.6;margin-top:3px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
#input-area{display:flex;gap:8px;padding:10px;background:rgba(255,255,255,0.06);border-top:1px solid rgba(255,255,255,0.1);}
#msg-input{flex:1;border:none;border-radius:10px;padding:10px;background:rgba(255,255,255,0.1);color:#fff;}
#msg-input:focus{outline:none;}
button,label{border:none;background:linear-gradient(45deg,#ff6f2d,#ff4b98);color:white;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;}
#file-input{display:none;}
#chatIcon{
  position:fixed;
  bottom:25px;
  right:25px;
  width:60px;
  height:60px;
  border-radius:50%;
  background:linear-gradient(45deg,#ff6f2d,#ff4b98);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:26px;
  cursor:pointer;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
  z-index:100;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:200;
}
.modal-content{
  background:#0e1624;
  padding:20px;
  border-radius:12px;
  width:90%;
  max-width:360px;
  color:#fff;
}
.modal input{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:none;
  border-radius:8px;
  background:rgba(255,255,255,0.1);
  color:#fff;
}
</style>
</head>
<body>

<!-- floating chat icon -->
<div id="chatIcon">💬</div>

<!-- chat window -->
<div id="chatApp">
  <header>🔥 Kheemz Chat</header>
  <div id="chat-box"></div>
  <div id="input-area">
    <label for="file-input"><i>📎</i></label>
    <input type="file" id="file-input" accept="image/*,video/*">
    <input type="text" id="msg-input" placeholder="Type a message...">
    <button id="send-btn">Send</button>
  </div>
</div>

<!-- login popup -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <h3>Login to Chat</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p style="text-align:center;font-size:13px;opacity:0.7;margin-top:8px">or use <b>anonymous</b> chat</p>
    <button id="anonBtn" class="ghost" style="background:rgba(255,255,255,0.15)">Continue as Guest</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="configuration.js"></script>

<script>
if(!window.FIREBASE_CONFIG){
  alert("Missing configuration.js file");
}else{
firebase.initializeApp(window.FIREBASE_CONFIG);
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();

const chatIcon=document.getElementById('chatIcon');
const chatApp=document.getElementById('chatApp');
const loginModal=document.getElementById('loginModal');
const loginBtn=document.getElementById('loginBtn');
const anonBtn=document.getElementById('anonBtn');
const emailInput=document.getElementById('loginEmail');
const passInput=document.getElementById('loginPass');
const chatBox=document.getElementById('chat-box');
const msgInput=document.getElementById('msg-input');
const sendBtn=document.getElementById('send-btn');
const fileInput=document.getElementById('file-input');

let currentUser=null;
let role='guest';

chatIcon.onclick=()=>{ loginModal.style.display='flex'; };

loginBtn.onclick=async()=>{
  try{
    const cred=await auth.signInWithEmailAndPassword(emailInput.value,passInput.value);
    currentUser=cred.user;
    await checkRole();
    startChat();
  }catch(e){alert(e.message);}
};

anonBtn.onclick=async()=>{
  const cred=await auth.signInAnonymously();
  currentUser=cred.user;
  role='guest';
  startChat();
};

async function checkRole(){
  const doc=await db.collection('users').doc(currentUser.uid).get();
  role=doc.exists?doc.data().role||'user':'user';
}

function startChat(){
  loginModal.style.display='none';
  chatApp.style.display='flex';
  chatIcon.style.display='none';
  listenMessages();
}

function listenMessages(){
  db.collection('messages').orderBy('timestamp','asc').onSnapshot(snap=>{
    chatBox.innerHTML='';
    snap.forEach(d=>renderMsg(d.data(),d.id));
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

function renderMsg(m,id){
  const div=document.createElement('div');
  div.className='msg '+(m.uid===currentUser?.uid?'self':'other');
  div.innerHTML=`<strong>${m.sender||'User'}</strong><br>${m.text||''}`;
  if(m.mediaUrl){
    if(m.mediaType.startsWith('video/')) div.innerHTML+=`<video src="${m.mediaUrl}" controls></video>`;
    else div.innerHTML+=`<img src="${m.mediaUrl}">`;
  }
  if(role==='admin'){ // admin delete power
    const del=document.createElement('button');
    del.textContent='🗑️';
    del.style='background:transparent;border:none;color:white;cursor:pointer;margin-left:8px;';
    del.onclick=()=>db.collection('messages').doc(id).delete();
    div.appendChild(del);
  }
  div.innerHTML+=`<small>${new Date(m.timestamp?.toDate?.()||Date.now()).toLocaleTimeString()}</small>`;
  chatBox.appendChild(div);
}

async function sendMessage(text,file){
  let mediaUrl='',mediaType='';
  if(file){
    const ref=storage.ref('chat/'+Date.now()+'_'+file.name);
    await ref.put(file);
    mediaUrl=await ref.getDownloadURL();
    mediaType=file.type;
  }
  await db.collection('messages').add({
    uid:currentUser.uid,
    sender:role==='admin'?'Admin':(currentUser.email||'User-'+currentUser.uid.slice(0,5)),
    text:text||'',
    mediaUrl,mediaType,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
}

sendBtn.onclick=async()=>{
  const text=msgInput.value.trim();
  const file=fileInput.files[0];
  if(!text && !file)return;
  await sendMessage(text,file);
  msgInput.value=''; fileInput.value='';
};
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendBtn.click();});

}
</script>
</body>
</html>
