<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeepSeek Dashboard</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase Core -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- External Config -->
  <script src="config.js"></script>
</head>

<body>
  <header>
    <h1>DeepSeek Dashboard</h1>
  </header>

  <main>
    <section id="dashboard">
      <h2>Available Giftcards</h2>
      <div id="availableGiftcards"></div>

      <h2>Your Transactions</h2>
      <table id="transactionTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="adminPanel" style="display:none;">
      <h2>Admin Panel</h2>
      <div id="pendingWithdrawals">
        <h3>Pending Withdrawals</h3>
        <ul id="pendingList"></ul>
      </div>

      <div id="adminChat">
        <h3>Admin Chat (Realtime)</h3>
        <div id="userList"></div>
        <div id="chatWindow"></div>
      </div>

      <div id="gameSettingsDisplay"></div>
    </section>

    <section id="giftcardCreate">
      <h2>Generate Giftcard</h2>
      <form id="generateGiftcardForm">
        <label>Code: <input type="text" id="gc_code"></label>
        <label>Amount: <input type="number" id="gc_amount"></label>
        <label>User ID: <input type="text" id="gc_creatorId"></label>
        <button type="submit">Generate</button>
      </form>
    </section>

    <section id="giftcardRedeem">
      <h2>Redeem Giftcard</h2>
      <form id="redeemGiftcardForm">
        <label>Code: <input type="text" id="redeem_code"></label>
        <button type="submit">Redeem</button>
      </form>
    </section>
  </main>

<script>
/* ------------------- Firebase Initialization -------------------- */
if (!window.firebaseConfig) {
  alert("Missing Firebase config.js. Please include your Firebase credentials.");
} else {
  firebase.initializeApp(window.firebaseConfig);
  window.db = firebase.firestore();
  window.auth = firebase.auth();
}

function $(id){ return document.getElementById(id); }
window.gameSettings = window.gameSettings || { nigeria: {}, other: {} };
/* ------------------- Auth State + Listeners -------------------- */
auth.onAuthStateChanged(async user => {
  if (!user) {
    console.log("User not logged in");
    return;
  }
  console.log("Logged in:", user.uid);

  // Available giftcards (active only)
  db.collection("giftCards")
    .where("userId", "==", user.uid)
    .where("isActive", "==", true)
    .onSnapshot(snapshot => {
      const container = $("availableGiftcards");
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.textContent = `${data.code} — ₦${data.remainingBalance || data.amount}`;
        container.appendChild(div);
      });
    }, err => console.error("giftCards listener error", err));

  // User transactions
  db.collection("transactions")
    .where("userId", "==", user.uid)
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      const tbody = $("transactionTable").querySelector("tbody");
      tbody.innerHTML = "";
      snapshot.forEach(doc => {
        const tx = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${tx.type || ""}</td>
          <td>${tx.amount || 0}</td>
          <td>${tx.status || ""}</td>
          <td>${tx.createdAt && tx.createdAt.toDate ? tx.createdAt.toDate().toLocaleString() : ""}</td>`;
        tbody.appendChild(tr);
      });
    }, err => console.error("transactions listener error", err));

  // Admin check
  const userDoc = await db.collection("users").doc(user.uid).get();
  const data = userDoc.exists ? userDoc.data() : {};
  if (data.isAdmin) {
    $("adminPanel").style.display = "block";

    // Pending withdrawals (handles case mismatch)
    try {
      db.collection("withdrawalRequests")
        .where("status", "==", "pending")
        .orderBy("createdAt", "desc")
        .onSnapshot(snap => {
          const list = $("pendingList");
          list.innerHTML = "";
          snap.forEach(doc => {
            const w = doc.data();
            const li = document.createElement("li");
            li.textContent = `${doc.id} — ₦${w.amount} — ${w.status}`;
            list.appendChild(li);
          });
        }, err => {
          db.collection("withdrawalRequests")
            .where("status", "in", ["Pending", "pending"])
            .orderBy("createdAt", "desc")
            .onSnapshot(snap2 => {
              const list = $("pendingList");
              list.innerHTML = "";
              snap2.forEach(doc => {
                const w = doc.data();
                const li = document.createElement("li");
                li.textContent = `${doc.id} — ₦${w.amount} — ${w.status}`;
                list.appendChild(li);
              });
            });
        });
    } catch (e) {
      console.error("Pending listener error", e);
    }

    // Admin chat user list
    db.collection("users").orderBy("createdAt", "desc").limit(200).get().then(snap => {
      const userList = $("userList");
      userList.innerHTML = "";
      snap.forEach(doc => {
        const u = doc.data();
        const btn = document.createElement("button");
        btn.textContent = u.displayName || doc.id;
        btn.onclick = () => {
          startAdminChatListenerFor(doc.id, chatSnap => {
            const chatWindow = $("chatWindow");
            chatWindow.innerHTML = "";
            chatSnap.forEach(mdoc => {
              const m = mdoc.data();
              const p = document.createElement("p");
              p.textContent = `${m.from === "admin" ? "Admin" : (m.fromName || m.userId)}: ${m.text}`;
              chatWindow.appendChild(p);
            });
          });
        };
        userList.appendChild(btn);
      });
    });
  }
});
/* ------------------- Giftcard & Redeem Handlers -------------------- */

// Generate Giftcard (Admin)
$("generateGiftcardForm").addEventListener("submit", async e => {
  e.preventDefault();
  const code = $("gc_code").value.trim();
  const amount = parseFloat($("gc_amount").value) || 0;
  const creatorId = $("gc_creatorId").value.trim();

  if (!code || !creatorId) return alert("Please fill all fields.");

  try {
    await createGiftCardNormalized({
      code,
      amount,
      remainingBalance: amount,
      creatorId,
      userId: creatorId,
      isActive: true
    });
    alert("Giftcard created successfully!");
  } catch (err) {
    console.error("Error creating giftcard:", err);
    alert("Error: " + err.message);
  }
});

// Redeem Giftcard (User)
$("redeemGiftcardForm").addEventListener("submit", async e => {
  e.preventDefault();
  const code = $("redeem_code").value.trim();
  const user = auth.currentUser;
  if (!user) return alert("Please sign in first.");

  try {
    const result = await validateGiftcardWithAttempts(user.uid, code, 5);

    if (!result.ok) {
      if (result.reason === "banned" || result.reason === "user_blocked") {
        alert("You have been banned for too many invalid attempts.");
      } else if (result.reason === "invalid") {
        alert(result.message || `Invalid card. ${result.attemptsLeft} attempts left.`);
      } else if (result.reason === "empty_or_inactive") {
        alert("This card has no balance or is inactive.");
      } else {
        alert(result.message || "Giftcard validation failed.");
      }
      return;
    }

    const cardRef = db.collection("giftCards").doc(result.docId);

    await db.runTransaction(async tx => {
      const snap = await tx.get(cardRef);
      const card = snap.data();
      if (!card.isActive || (card.remainingBalance || 0) <= 0) {
        throw new Error("Giftcard already used or empty.");
      }

      tx.update(cardRef, {
        remainingBalance: 0,
        isActive: false,
        lastUsedBy: user.uid,
        lastUsedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Record transaction
      const txRef = db.collection("transactions").doc();
      tx.set(txRef, {
        userId: user.uid,
        type: "giftcard_redeem",
        amount: card.amount,
        status: "completed",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    alert("Giftcard redeemed successfully!");
  } catch (err) {
    console.error("Redeem error:", err);
    alert("Redeem failed: " + err.message);
  }
});

/* ------------------- Realtime Config & Admin Chat Helpers -------------------- */

// Merge config docs safely (fixes spread syntax bug)
function safeConfigListener(docPath, target, key, cb) {
  db.doc(docPath).onSnapshot(doc => {
    if (!doc.exists) return;
    const data = doc.data() || {};
    target[key] = { ...(target[key] || {}), ...data };
    if (typeof cb === "function") cb(target[key]);
  });
}

// Apply to both configs
if (window.gameSettings) {
  safeConfigListener("config/gameSettings_nigeria", window.gameSettings, "nigeria", updateDisplay);
  safeConfigListener("config/gameSettings_other", window.gameSettings, "other", updateDisplay);
}

function updateDisplay() {
  $("gameSettingsDisplay").textContent = JSON.stringify(window.gameSettings, null, 2);
}

// Admin Chat Listener for selected user
let adminMessagesUnsub = null;
function startAdminChatListenerFor(selectedUserId, onUpdate) {
  if (adminMessagesUnsub) adminMessagesUnsub();
  if (!selectedUserId) return;
  adminMessagesUnsub = db.collection("messages")
    .where("userId", "==", selectedUserId)
    .orderBy("createdAt", "asc")
    .onSnapshot(onUpdate, err => console.error("Admin chat error", err));
}

/* ------------------- Utility Fixes -------------------- */

// Giftcard creation helper (used by admin and giveaway)
async function createGiftCardNormalized(card) {
  card = card || {};
  if (!card.code) throw new Error("Giftcard code required");
  card.remainingBalance = typeof card.remainingBalance === "number" ? card.remainingBalance : (card.amount || 0);
  card.isActive = typeof card.isActive === "boolean" ? card.isActive : true;
  if (!card.userId && card.creatorId) card.userId = card.creatorId;
  card.createdAt = firebase.firestore.FieldValue.serverTimestamp();
  return db.collection("giftCards").add(card);
}

// Giftcard validation with ban/attempts
async function validateGiftcardWithAttempts(userId, code, maxAttempts = 5) {
  const userRef = db.collection("users").doc(userId);
  const userSnap = await userRef.get();
  const userData = userSnap.exists ? userSnap.data() : {};
  if (userData.isBlocked) return { ok: false, reason: "user_blocked" };

  const q = await db.collection("giftCards").where("code", "==", code).limit(1).get();
  if (q.empty) {
    await userRef.update({ failedGiftCardAttempts: firebase.firestore.FieldValue.increment(1) });
    const refreshed = await userRef.get();
    const attempts = (refreshed.data().failedGiftCardAttempts || 0);
    if (attempts >= maxAttempts) {
      await userRef.update({ isBlocked: true });
      return { ok: false, reason: "banned" };
    }
    return { ok: false, reason: "invalid", attemptsLeft: maxAttempts - attempts, message: `Invalid card. ${maxAttempts - attempts} attempts remaining.` };
  }

  const doc = q.docs[0];
  const gc = doc.data();
  if (!gc.isActive || (gc.remainingBalance || 0) <= 0) return { ok: false, reason: "empty_or_inactive" };
  await userRef.update({ failedGiftCardAttempts: 0 });
  return { ok: true, docId: doc.id, giftCard: gc };
}
/* ------------------- Additional Runtime Patch & Diagnostics -------------------- */

// Normalized withdrawal creation helper
function createWithdrawalRequestNormalized(obj) {
  obj = obj || {};
  obj.status = "pending";
  obj.createdAt = firebase.firestore.FieldValue.serverTimestamp();
  return db.collection("withdrawalRequests").add(obj);
}
window.createWithdrawalRequestNormalized = createWithdrawalRequestNormalized;

// Diagnostics – confirm listeners
auth.onAuthStateChanged(user => {
  if (!user) return;
  db.collection("giftCards").where("userId", "==", user.uid).get().then(s => console.log("Giftcards:", s.size));
  db.collection("transactions").where("userId", "==", user.uid).get().then(s => console.log("Transactions:", s.size));
  db.collection("withdrawalRequests").where("userId", "==", user.uid).get().then(s => console.log("Withdrawals:", s.size));
});

/* ------------------- Initialization Log -------------------- */
console.log("DeepSeek fixed dashboard initialized with full Firestore integration.");
</script>

<!-- =================== END OF MAIN SCRIPT =================== -->

<footer style="margin-top:40px;text-align:center;">
  <p>&copy; 2025 DeepSeek System — Firebase Firestore Integrated</p>
</footer>

</body>
</html>
