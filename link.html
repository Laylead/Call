<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>UID Admin Demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 20px auto; }
    .card { border: 1px solid #ccc; padding: 15px; margin-top: 10px; border-radius: 8px; }
    .hidden { display: none; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <div class="card">
    <input id="email" type="email" placeholder="Email" /><br />
    <input id="password" type="password" placeholder="Password" /><br />
    <button id="login-btn">Login</button>
    <button id="logout-btn" class="hidden">Logout</button>
    <p id="status"></p>
  </div>

  <!-- Normal user dashboard -->
  <div id="user-dashboard" class="card hidden">
    <h3>Your Dashboard</h3>
    <p><b>Email:</b> <span id="user-email"></span></p>
    <p><b>Your Balance:</b> $<span id="user-balance">0</span></p>
  </div>

  <!-- Admin dashboard -->
  <div id="admin-dashboard" class="card hidden">
    <h3>Admin Panel (All Users)</h3>
    <div id="users-list"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Your config (with ADMIN_UID) -->
  <script src="configuration.js"></script>

  <script>
    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const loginBtn   = document.getElementById('login-btn');
    const logoutBtn  = document.getElementById('logout-btn');
    const statusP    = document.getElementById('status');
    const userDash   = document.getElementById('user-dashboard');
    const adminDash  = document.getElementById('admin-dashboard');
    const usersList  = document.getElementById('users-list');
    const userEmail  = document.getElementById('user-email');
    const userBal    = document.getElementById('user-balance');

    // Login
    loginBtn.onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      try {
        await auth.signInWithEmailAndPassword(email, password);
        statusP.textContent = "Logged in!";
      } catch (e) {
        statusP.textContent = e.message;
      }
    };

    // Logout
    logoutBtn.onclick = () => auth.signOut();

    // Auth state
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // logged out
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        userDash.classList.add('hidden');
        adminDash.classList.add('hidden');
        statusP.textContent = "Logged out";
        return;
      }

      // logged in
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      statusP.textContent = "";

      const isAdmin = (typeof ADMIN_UID !== "undefined" && user.uid === ADMIN_UID);

      if (isAdmin) {
        // ADMIN VIEW: see all users + fund
        userDash.classList.add('hidden');
        adminDash.classList.remove('hidden');
        loadAllUsersForAdmin();
      } else {
        // NORMAL USER VIEW: see own balance
        adminDash.classList.add('hidden');
        userDash.classList.remove('hidden');
        userEmail.textContent = user.email;
        loadUserBalance(user.uid, userBal);
      }
    });

    // Get or init a user's balance
    async function loadUserBalance(uid, spanEl) {
      const ref = db.collection("users").doc(uid);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({ balance: 0 });
        spanEl.textContent = 0;
      } else {
        spanEl.textContent = snap.data().balance || 0;
      }
    }

    // Admin: show all users and allow funding
    async function loadAllUsersForAdmin() {
      usersList.innerHTML = "Loading...";
      const snap = await db.collection("users").get();
      if (snap.empty) {
        usersList.textContent = "No users yet.";
        return;
      }

      usersList.innerHTML = "";
      snap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <p><b>UID:</b> ${doc.id}</p>
          <p><b>Email:</b> ${data.email || "unknown"}</p>
          <p><b>Balance:</b> $<span class="bal">${data.balance || 0}</span></p>
          <input type="number" class="amt" placeholder="Amount to add" />
          <button class="fund-btn">Fund</button>
        `;
        const amtInput = div.querySelector(".amt");
        const balSpan  = div.querySelector(".bal");
        const btn      = div.querySelector(".fund-btn");

        btn.onclick = async () => {
          const amount = Number(amtInput.value || 0);
          if (!amount) return;
          const newBalance = (data.balance || 0) + amount;
          await db.collection("users").doc(doc.id).update({ balance: newBalance });
          data.balance = newBalance;
          balSpan.textContent = newBalance;
          amtInput.value = "";
        };

        usersList.appendChild(div);
      });
    }
  </script>
</body>
</html>
