<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Casino CPA Platform</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="configuration.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(90deg, #0f0c29, #302b63, #24243e);
      padding: 1em;
      text-align: center;
      font-size: 1.5em;
    }
    .container {
      padding: 2em;
      max-width: 960px;
      margin: auto;
    }
    .section {
      background: #1e1e2f;
      margin: 1em 0;
      padding: 1.5em;
      border-radius: 10px;
      box-shadow: 0 0 10px #0008;
    }
    button {
      background: #ff416c;
      border: none;
      padding: 0.7em 1.5em;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin: 0.5em;
      font-weight: bold;
    }
    h2 {
      color: #ffcc00;
    }
    .popup {
      background: #222;
      padding: 2em;
      border: 2px solid #ff416c;
      border-radius: 8px;
      display: none;
      text-align: center;
    }
    .wheel-canvas {
      width: 100%;
      max-width: 300px;
      margin: auto;
      transform: rotate(0deg);
      transition: transform 4s cubic-bezier(0.33, 1, 0.68, 1);
    }
    .spin-button {
      background: #00c853;
    }
  </style>
</head>
<body>
  <header>üé∞ Welcome to Casino CPA Challenge</header>
  <div class="container">
    <div class="section">
      <h2>üé° Spin the Wheel</h2>
      <canvas id="wheelCanvas" class="wheel-canvas" width="300" height="300"></canvas>
      <button class="spin-button" onclick="spinWheel()">Spin</button>
      <p id="spinResult">Spin the wheel to earn credits!</p>
    </div>

    <div class="section">
      <h2>üïπÔ∏è Casino Games</h2>
      <p>Games Played: <span id="gamesPlayed">0</span> | Balance: <span id="balance">0</span> credits</p>
      <button onclick="playGame('limbo')">Play Limbo</button>
      <button onclick="playGame('guessBox')">Guess the Box</button>
      <button onclick="playGame('dodge')">Dodge Trap</button>
      <p id="gameResult"></p>
    </div>

    <div class="popup" id="cpaPopup">
      <h3>üöß Access Restricted</h3>
      <p>Complete a quick offer to continue playing.</p>
      <button onclick="startCpaOffer()">Go to Offer</button>
    </div>

    <div class="popup" id="confirmPopup">
      <h3>Did you finish the offer?</h3>
      <button onclick="submitCpaStatus('yes')">Yes</button>
      <button onclick="submitCpaStatus('no')">No</button>
    </div>

    <div class="section" id="withdrawalInfo" style="display:none">
      <h2>üí∏ Withdrawal Queue</h2>
      <p>Users ahead: <span id="queueCount">134</span></p>
    </div>
  </div>

  <audio id="spinSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>
  <audio id="gameSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <script>
    let db, auth;
    let userId = `guest-${Math.floor(Math.random() * 100000)}`;
    let balance = 0;
    let gamesPlayed = 0;
    let cpaOfferUrl = "";

    const sectors = [0, 10, 20, 30, 40, 50];
    let angle = 0;

    function initFirebase() {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();

      firebase.firestore().doc('settings/cpaConfig').get().then(doc => {
        if (doc.exists) cpaOfferUrl = doc.data().offerUrl;
      });
    }

    function drawWheel() {
      const canvas = document.getElementById("wheelCanvas");
      const ctx = canvas.getContext("2d");
      const radius = canvas.width / 2;
      const anglePer = 2 * Math.PI / sectors.length;

      for (let i = 0; i < sectors.length; i++) {
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, i * anglePer, (i + 1) * anglePer);
        ctx.fillStyle = i % 2 ? "#ff416c" : "#ffcc00";
        ctx.fill();
        ctx.fillStyle = "#000";
        ctx.font = "16px bold";
        ctx.fillText(`${sectors[i]}`,
          radius + Math.cos(i * anglePer + anglePer / 2) * radius * 0.6 - 10,
          radius + Math.sin(i * anglePer + anglePer / 2) * radius * 0.6 + 5
        );
      }
    }

    function spinWheel() {
      const spinSound = document.getElementById("spinSound");
      const winSound = document.getElementById("winSound");
      spinSound.play();

      const canvas = document.getElementById("wheelCanvas");
      const result = Math.floor(Math.random() * sectors.length);
      const finalAngle = (360 / sectors.length) * result + 360 * 5;
      canvas.style.transform = `rotate(${finalAngle}deg)`;

      setTimeout(() => {
        const won = sectors[result];
        balance += won;
        document.getElementById("spinResult").innerText = `üéâ You won ${won} credits!`;
        updateStats();
        winSound.play();
      }, 4200);
    }

    function playGame(type) {
      if (gamesPlayed >= 4 && !localStorage.getItem("cpaComplete")) {
        document.getElementById("cpaPopup").style.display = 'block';
        return;
      }

      const gameSound = document.getElementById("gameSound");
      gameSound.play();

      let gain = 0;
      if (type === 'limbo') gain = Math.floor(Math.random() * 20);
      if (type === 'guessBox') gain = [0, 30, 10][Math.floor(Math.random() * 3)];
      if (type === 'dodge') gain = Math.floor(Math.random() * 25);

      balance += gain;
      gamesPlayed++;
      document.getElementById("gameResult").innerText = `You played ${type} and won ${gain} credits!`;
      updateStats();

      if (balance >= 100) {
        document.getElementById("withdrawalInfo").style.display = 'block';
      }
    }

    function updateStats() {
      document.getElementById("gamesPlayed").innerText = gamesPlayed;
      document.getElementById("balance").innerText = balance;
    }

    function startCpaOffer() {
      const device = navigator.userAgent;
      fetch('https://api.ipify.org?format=json')
        .then(res => res.json())
        .then(data => {
          db.collection('users').doc(userId).set({
            cpaClickedAt: Date.now(),
            userAgent: device,
            ip: data.ip,
            balance,
            gamesPlayed
          });
        });

      document.getElementById("cpaPopup").style.display = 'none';
      window.open(cpaOfferUrl, '_blank');
      setTimeout(() => document.getElementById("confirmPopup").style.display = 'block', 1000);
    }

    function submitCpaStatus(ans) {
      if (ans === 'yes') {
        db.collection('users').doc(userId).update({ cpaClaimed: true });
        localStorage.setItem("cpaComplete", "true");
        alert("‚úÖ Access restored.");
      } else {
        alert("‚ö†Ô∏è Fake claims will be flagged.");
      }
      document.getElementById("confirmPopup").style.display = 'none';
    }

    window.onload = () => {
      initFirebase();
      drawWheel();
    };
  </script>
</body>
</html>
