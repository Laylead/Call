<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Casino Live App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script defer src="configuration.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: #1e1e2f;
      color: #fff;
    }
    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }
    input, button, select {
      width: 100%; padding: 10px; margin: 5px 0;
      border: none; border-radius: 5px;
    }
    .game, .admin-panel, .withdrawal-panel {
      display: none;
      background: #2c2c3c;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    .btn {
      background: #00b894;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .btn:disabled {
      background: #555;
    }
    .popup {
      position: fixed;
      top: 20%;
      left: 10%;
      right: 10%;
      background: #333;
      padding: 20px;
      text-align: center;
      z-index: 99;
      border-radius: 10px;
      display: none;
      animation: pop 0.3s ease-in-out;
    }
    @keyframes pop {
      0% { transform: scale(0.7); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Casino Game Platform</h2>

    <!-- Auth Section -->
    <div id="auth-section">
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button class="btn" onclick="signup()">Sign Up</button>
      <button class="btn" onclick="login()">Login</button>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="admin-panel">
      <h3>Admin Panel</h3>
      <input id="cpa-url" placeholder="CPA Offer URL">
      <button onclick="updateCPA()" class="btn">Update CPA Link</button>
      <h4>Withdrawals:</h4>
      <div id="withdrawals"></div>
    </div>

    <!-- Game Section -->
    <div class="game" id="game-section">
      <h3>Balance: <span id="balance">0</span> USDT</h3>
      <button class="btn" onclick="playSpin()">üé° Spin the Wheel</button>
      <button class="btn" onclick="playLimbo()">üéØ Limbo</button>
      <button class="btn" onclick="playGuess()">üéÅ Guess the Box</button>
      <button class="btn" onclick="playDodge()">üèÉ‚Äç‚ôÇÔ∏è Dodge</button>
      <button class="btn" onclick="requestWithdraw()">üí∏ Withdraw</button>
    </div>

    <!-- Withdraw Panel -->
    <div class="withdrawal-panel" id="withdraw-panel">
      <h3>Withdraw Funds</h3>
      <select id="withdraw-method">
        <option value="usdt">TRC20 USDT</option>
        <option value="bank">Bank Account</option>
      </select>
      <input id="withdraw-details" placeholder="Enter wallet or account details">
      <input id="withdraw-amount" type="number" placeholder="Amount">
      <button class="btn" onclick="submitWithdraw()">Submit Request</button>
    </div>
  </div>

  <div id="popup" class="popup"></div>

  <audio id="win-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="fail-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script>
    let app, auth, db, user, playCount = 0, cpaLink = "", balance = 0;

    setTimeout(() => {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
    }, 1000);

    function showPopup(msg) {
      const popup = document.getElementById("popup");
      popup.innerText = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 3000);
    }

    function signup() {
      const email = email.value, password = password.value;
      auth.createUserWithEmailAndPassword(email, password).then(cred => {
        db.collection("users").doc(cred.user.uid).set({ balance: 10, plays: 0, completedCPA: false });
        login();
      }).catch(e => showPopup(e.message));
    }

    function login() {
      const email = email.value, password = password.value;
      auth.signInWithEmailAndPassword(email, password).then(cred => {
        user = cred.user;
        loadUser();
      }).catch(e => showPopup(e.message));
    }

    function loadUser() {
      db.collection("users").doc(user.uid).onSnapshot(doc => {
        if (!doc.exists) return;
        let data = doc.data();
        balance = data.balance || 0;
        playCount = data.plays || 0;
        cpaLink = data.cpaLink || "";
        document.getElementById("balance").innerText = balance;
        document.getElementById("auth-section").style.display = "none";
        if (user.email === "admin@admin.com") {
          document.getElementById("admin-panel").style.display = "block";
          loadWithdrawals();
        } else {
          document.getElementById("game-section").style.display = "block";
        }
      });
    }

    function updateBalance(delta) {
      balance += delta;
      playCount++;
      db.collection("users").doc(user.uid).update({ balance, plays: playCount });
      document.getElementById("balance").innerText = balance;
      if (playCount >= 4) showPopup("Complete offer to withdraw!"), window.open(cpaLink, "_blank");
    }

    function playSpin() {
      const outcomes = [0, 2, 5, 10, "-", 3];
      const result = outcomes[Math.floor(Math.random() * outcomes.length)];
      if (result === "-") {
        document.getElementById("fail-sound").play();
        updateBalance(-2);
        showPopup("Oh no! You lost 2 USDT!");
      } else {
        document.getElementById("win-sound").play();
        updateBalance(result);
        showPopup("You won " + result + " USDT!");
      }
    }

    function playLimbo() {
      let chance = Math.random();
      if (chance > 0.7) {
        updateBalance(5);
        document.getElementById("win-sound").play();
        showPopup("You beat Limbo! +5 USDT");
      } else {
        updateBalance(-1);
        document.getElementById("fail-sound").play();
        showPopup("You lost Limbo! -1 USDT");
      }
    }

    function playGuess() {
      const correct = Math.floor(Math.random() * 3);
      const choice = Math.floor(Math.random() * 3);
      if (choice === correct) {
        updateBalance(4);
        document.getElementById("win-sound").play();
        showPopup("Right box! +4 USDT");
      } else {
        updateBalance(-2);
        document.getElementById("fail-sound").play();
        showPopup("Wrong box! -2 USDT");
      }
    }

    function playDodge() {
      let survived = Math.random() > 0.6;
      if (survived) {
        updateBalance(3);
        document.getElementById("win-sound").play();
        showPopup("You dodged! +3 USDT");
      } else {
        updateBalance(-2);
        document.getElementById("fail-sound").play();
        showPopup("Hit by trap! -2 USDT");
      }
    }

    function requestWithdraw() {
      document.getElementById("withdraw-panel").style.display = "block";
    }

    function submitWithdraw() {
      const method = document.getElementById("withdraw-method").value;
      const details = document.getElementById("withdraw-details").value;
      const amount = Number(document.getElementById("withdraw-amount").value);
      if (amount > balance) return showPopup("Insufficient balance");
      db.collection("withdrawals").add({ uid: user.uid, method, details, amount, status: "pending" });
      showPopup("Withdrawal requested!");
      document.getElementById("withdraw-panel").style.display = "none";
    }

    function updateCPA() {
      const link = document.getElementById("cpa-url").value;
      db.collection("users").get().then(snapshot => {
        snapshot.forEach(doc => {
          db.collection("users").doc(doc.id).update({ cpaLink: link });
        });
      });
      showPopup("CPA Link updated!");
    }

    function loadWithdrawals() {
      db.collection("withdrawals").onSnapshot(snapshot => {
        const box = document.getElementById("withdrawals");
        box.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          box.innerHTML += `<p>${d.method} ${d.amount} - ${d.details} [${d.status}]</p>`;
        });
      });
    }
  </script>
</body>
</html>
