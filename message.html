<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectX - Professional Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --gray-color: #6c757d;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-color: #333333;
            --message-sent: #4361ee;
            --message-received: #f0f0f0;
            --input-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 24px;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-actions i {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .header-actions i:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background-color: var(--card-bg);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        /* User Profiles Section - Made Smaller and Moved to Top */
        .user-profiles-section {
            padding: 15px;
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .user-profiles-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 5px;
            scrollbar-width: thin;
        }

        .user-profiles-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .user-profiles-scroll::-webkit-scrollbar-thumb {
            background-color: var(--gray-color);
            border-radius: 10px;
        }

        .user-profile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
            min-width: 55px;
        }

        .user-profile-item:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .user-profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            position: relative;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .user-profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile-name {
            font-size: 11px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 55px;
            color: var(--gray-color);
        }

        /* Chat List - Made Longer */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            height: calc(100vh - 160px);
            padding: 10px;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 10px;
            margin-bottom: 5px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chat-list-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
            transform: translateX(5px);
        }

        .chat-list-item.active {
            background-color: rgba(67, 97, 238, 0.08);
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            position: relative;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        .status-online {
            background-color: #4ade80;
        }

        .status-away {
            background-color: #f59e0b;
        }

        .status-offline {
            background-color: #9ca3af;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: var(--gray-color);
            font-size: 11px;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            color: var(--gray-color);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            position: relative;
        }

        /* Conversation Header */
        .conversation-header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .conversation-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-back-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            margin-right: 5px;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .conversation-user-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .conversation-user-details p {
            color: var(--gray-color);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .conversation-actions {
            display: flex;
            gap: 10px;
        }

        .conversation-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-color);
            background: none;
            border: none;
        }

        .conversation-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23f0f2f5' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.2s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background-color: var(--message-sent);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background-color: var(--message-received);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-media {
            margin-top: 8px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .message-media img {
            width: 100%;
            display: block;
        }

        /* Voice Message */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            margin-top: 8px;
        }

        .message.received .voice-message {
            background: rgba(0,0,0,0.05);
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message.received .voice-play-btn {
            background: rgba(0,0,0,0.1);
            color: var(--text-color);
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.6);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .message.received .voice-bar {
            background: rgba(0,0,0,0.3);
        }

        .voice-duration {
            font-size: 12px;
            min-width: 40px;
            text-align: center;
            opacity: 0.8;
        }

        /* Input Area */
        .input-area {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .balance-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .pricing-display {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            padding: 10px;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            font-size: 12px;
        }

        .pricing-item {
            flex: 1;
            text-align: center;
        }

        .pricing-type {
            color: var(--gray-color);
            margin-bottom: 3px;
        }

        .pricing-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .chat-input-wrapper {
            flex: 1;
            background-color: var(--input-bg);
            border-radius: 24px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            display: flex;
            align-items: flex-end;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            line-height: 1.4;
            max-height: 120px;
            min-height: 24px;
            resize: none;
            padding: 4px 0;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: var(--gray-color);
        }

        .input-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .input-action-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            transform: none;
        }

        /* Floating Search Widget */
        .floating-search {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: var(--transition);
        }

        .floating-search:hover {
            transform: scale(1.1);
        }

        .floating-search.active {
            width: 300px;
            border-radius: 25px;
            justify-content: flex-start;
            padding: 0 15px;
        }

        .floating-search.active i {
            margin-right: 10px;
        }

        .floating-search input {
            display: none;
            width: 100%;
            border: none;
            background: transparent;
            outline: none;
            color: white;
            font-size: 15px;
        }

        .floating-search.active input {
            display: block;
        }

        .floating-search input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Voice Recorder */
        .voice-recorder {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 200px;
        }

        .voice-recorder.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning-color);
            font-weight: 600;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-timer {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .recording-actions {
            display: flex;
            gap: 15px;
        }

        .record-action-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .record-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .record-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        .record-action-btn:hover {
            transform: scale(1.1);
        }

        /* Voice Preview */
        .voice-preview {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            min-width: 250px;
        }

        .voice-preview.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        .voice-preview-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .voice-preview-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .voice-preview-play-btn:hover {
            transform: scale(1.05);
        }

        .voice-preview-waveform {
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-preview-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            transition: height 0.2s ease;
        }

        .voice-preview-duration {
            font-size: 14px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
        }

        .voice-preview-actions {
            display: flex;
            gap: 10px;
        }

        .voice-preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .voice-preview-action-btn.delete {
            background-color: var(--warning-color);
            color: white;
        }

        .voice-preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        /* Media Preview */
        .media-preview {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .media-preview.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .media-preview-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .media-preview img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .media-preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-action-btn.send {
            background-color: var(--primary-color);
            color: white;
        }

        .preview-action-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .empty-state p {
            max-width: 300px;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background-color: var(--message-received);
            border-radius: 18px;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-bottom: 8px;
            max-width: 70px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Word Counter */
        .word-counter {
            font-size: 12px;
            color: var(--gray-color);
            text-align: right;
            margin-top: 5px;
            display: none;
        }

        .word-counter.near-limit {
            color: var(--warning-color);
        }

        /* Settings Modal - Professional Design */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: translateY(20px) scale(0.95);
            transition: var(--transition);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 22px;
        }

        .close-modal {
            font-size: 20px;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
            padding: 8px;
            border-radius: 50%;
        }

        .close-modal:hover {
            color: var(--warning-color);
            background-color: rgba(247, 37, 133, 0.1);
        }

        /* Settings Sections */
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section-title i {
            font-size: 18px;
        }

        .settings-grid {
            display: grid;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 15px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        /* Earnings and Pricing Cards */
        .earnings-info {
            background: rgba(67, 97, 238, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .earnings-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .earnings-item:last-child {
            margin-bottom: 0;
        }

        .earnings-label {
            color: var(--gray-color);
        }

        .earnings-value {
            font-weight: 600;
            color: var(--success-color);
        }

        .pricing-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .pricing-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .pricing-card-header i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .pricing-card-header h4 {
            font-size: 15px;
            font-weight: 600;
        }

        .pricing-input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .pricing-input-label {
            font-size: 12px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .pricing-currency {
            background: var(--body-bg);
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Verification Badge */
        .verified-badge {
            color: var(--primary-color);
            margin-left: 5px;
        }

        .mentor-badge {
            background: linear-gradient(135deg, #ff9a00, #ff6a00);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .status-badge.mentor {
            background: linear-gradient(135deg, #ff9a00, #ff6a00);
            color: white;
        }

        .status-badge.verified {
            background: linear-gradient(135deg, #4361ee, #4cc9f0);
            color: white;
        }

        /* Application Form */
        .application-form {
            max-width: 100%;
        }

        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .camera-container {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .camera-preview {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin: 0 auto 15px;
            display: none;
        }

        .camera-preview.active {
            display: block;
        }

        .camera-video {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .camera-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .camera-btn.capture {
            background-color: var(--primary-color);
            color: white;
        }

        .camera-btn.retake {
            background-color: var(--gray-color);
            color: white;
        }

        .application-note {
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .application-note i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        /* Application Message Styles */
        .application-message {
            max-width: 85%;
            padding: 15px;
            border-radius: 12px;
            background-color: var(--message-received);
            align-self: flex-start;
            margin-bottom: 15px;
        }

        .application-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .application-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        .application-user-info h4 {
            margin: 0;
            font-size: 14px;
        }

        .application-user-info p {
            margin: 0;
            font-size: 12px;
            color: var(--gray-color);
        }

        .application-details {
            margin-bottom: 15px;
        }

        .application-detail-item {
            display: flex;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .application-detail-label {
            font-weight: 600;
            min-width: 100px;
            color: var(--gray-color);
        }

        .application-detail-value {
            flex: 1;
        }

        .application-photo {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }

        .application-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .application-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 100px;
        }

        .application-action-btn.approve-mentor {
            background-color: #ff9a00;
            color: white;
        }

        .application-action-btn.approve-verified {
            background-color: #4361ee;
            color: white;
        }

        .application-action-btn.approve-both {
            background: linear-gradient(135deg, #4361ee, #ff9a00);
            color: white;
        }

        .application-action-btn.decline {
            background-color: var(--warning-color);
            color: white;
        }

        .application-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .context-menu.active {
            display: block;
            animation: slideIn 0.2s ease;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .context-menu-item.delete {
            color: var(--warning-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                height: 100%;
            }
            
            .chat-area {
                width: 100%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .conversation-header {
                padding: 12px 15px;
            }
            
            .messages-area {
                padding: 15px;
            }
            
            .input-area {
                padding: 12px 15px;
            }

            .floating-search {
                bottom: 80px;
                right: 15px;
            }

            .floating-search.active {
                width: calc(100% - 30px);
            }

            .user-profile-avatar {
                width: 40px;
                height: 40px;
            }

            .user-profile-name {
                font-size: 10px;
            }
        }

        /* Hide elements when in conversation view */
        .conversation-view header,
        .conversation-view .sidebar {
            display: none;
        }

        .conversation-view .chat-area {
            width: 100%;
        }

        .conversation-view .floating-search {
            display: none;
        }

        /* Enhanced Animations */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.5); }
            50% { box-shadow: 0 0 20px rgba(67, 97, 238, 0.8); }
            100% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.5); }
        }

        @keyframes smoothAppear {
            from { 
                opacity: 0; 
                transform: translateY(-10px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chat-list-item {
            animation: smoothAppear 0.3s ease-out;
        }

        .conversation-header {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>ConnectX Messages</h1>
        </div>
        <div class="header-actions">
            <i class="fas fa-cog" id="settingsBtn"></i>
            <a href="home.html" style="text-decoration: none; color: inherit;">
                <i class="fas fa-home"></i>
            </a>
            <div style="position: relative;">
                <i class="fas fa-bell" id="notificationsBtn"></i>
                <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Sidebar with Chat List -->
        <div class="sidebar">
            <!-- User Profiles Section - Made Smaller and Moved to Top -->
            <div class="user-profiles-section" id="userProfilesSection">
                <div class="user-profiles-scroll" id="userProfilesScroll">
                    <!-- User profiles will be populated here -->
                </div>
            </div>
            
            <div class="chat-list" id="chatList">
                <!-- Chat list will be populated here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-comments"></i>
                <h3>No conversation selected</h3>
                <p>Select a conversation from the list or start a new chat to begin messaging.</p>
            </div>
            
            <!-- Conversation View (hidden by default) -->
            <div class="conversation-view" id="conversationView" style="display: none;">
                <!-- Conversation Header -->
                <div class="conversation-header">
                    <div class="conversation-user-info">
                        <button class="conversation-back-btn" id="conversationBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="conversation-avatar" id="conversationAvatar">
                            <!-- Avatar will be loaded here -->
                        </div>
                        <div class="conversation-user-details">
                            <h3 id="conversationUserName">User Name</h3>
                            <p id="conversationUserStatus">
                                <span class="status-indicator status-online"></span>
                                <span id="statusText">Online</span>
                            </p>
                        </div>
                    </div>
                    <div class="conversation-actions">
                        <button class="conversation-action-btn" id="viewProfileBtn" title="View Profile">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="conversation-action-btn" id="moreActionsBtn" title="More Actions">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="balance-info">
                        <i class="fas fa-wallet"></i>
                        <span>Balance: <span class="balance-amount" id="balanceAmount">₦0</span></span>
                    </div>
                    
                    <!-- Pricing Display - Only shown when chatting with mentor/verified user -->
                    <div class="pricing-display" id="pricingDisplay" style="display: none;">
                        <div class="pricing-item">
                            <div class="pricing-type">Text Message</div>
                            <div class="pricing-amount" id="textPriceDisplay">₦0</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-type">Voice Message</div>
                            <div class="pricing-amount" id="voicePriceDisplay">₦0/min</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-type">Image Message</div>
                            <div class="pricing-amount" id="imagePriceDisplay">₦0</div>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="input-action-btn" id="attachBtn" title="Attach File">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="input-action-btn" id="voiceBtn" title="Record Voice">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <button class="send-btn" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="word-counter" id="wordCounter">0/35 words • ₦0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="blockUserBtn">
            <i class="fas fa-ban"></i>
            <span>Block User</span>
        </div>
        <div class="context-menu-item delete" id="deleteChatBtn">
            <i class="fas fa-trash"></i>
            <span>Delete Chat</span>
        </div>
    </div>
    
    <!-- Floating Search Widget -->
    <div class="floating-search" id="floatingSearch">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search users...">
    </div>
    
    <!-- Voice Recorder -->
    <div class="voice-recorder" id="voiceRecorder">
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <span>Recording</span>
        </div>
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="voice-waveform" id="voiceWaveform">
            <!-- Voice bars will be generated here -->
        </div>
        <div class="recording-actions">
            <button class="record-action-btn cancel" id="cancelRecordingBtn">
                <i class="fas fa-times"></i>
            </button>
            <button class="record-action-btn send" id="sendRecordingBtn">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>
    
    <!-- Voice Preview -->
    <div class="voice-preview" id="voicePreview">
        <div class="recording-timer" id="voicePreviewDuration">00:00</div>
        <div class="voice-preview-controls">
            <button class="voice-preview-play-btn" id="voicePreviewPlayBtn">
                <i class="fas fa-play"></i>
            </button>
            <div class="voice-preview-waveform" id="voicePreviewWaveform">
                <!-- Voice bars will be generated here -->
            </div>
        </div>
        <div class="voice-preview-actions">
            <button class="voice-preview-action-btn delete" id="deleteVoiceBtn">Delete</button>
            <button class="voice-preview-action-btn send" id="sendVoiceBtn">Send</button>
        </div>
    </div>
    
    <!-- Media Preview -->
    <div class="media-preview" id="mediaPreview">
        <div class="media-preview-content">
            <img id="mediaPreviewImage" src="" alt="Preview">
            <div>
                <div id="mediaPreviewName">image.jpg</div>
                <div class="media-preview-actions">
                    <button class="preview-action-btn send" id="sendMediaBtn">Send</button>
                    <button class="preview-action-btn cancel" id="cancelMediaBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat Settings</h2>
                <i class="fas fa-times close-modal" id="closeSettingsModal"></i>
            </div>
            
            <!-- Earnings Section -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-chart-line"></i>
                    Earnings Overview
                </h3>
                <div class="earnings-info">
                    <div class="earnings-item">
                        <span class="earnings-label">Total Earnings</span>
                        <span class="earnings-value" id="totalEarnings">₦0</span>
                    </div>
                    <div class="earnings-item">
                        <span class="earnings-label">Available for Withdrawal</span>
                        <span class="earnings-value" id="availableEarnings">₦0</span>
                    </div>
                </div>
            </div>
            
            <!-- Monetization Settings for Verified/Mentor Users -->
            <div class="settings-section" id="monetizationSettings" style="display: none;">
                <h3 class="settings-section-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Monetization Settings
                </h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color);">
                    Set your custom pricing for messages. 50% of earnings go to you, 50% to ConnectX.
                </p>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-comment-alt"></i>
                        <h4>Text Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per 35 words</div>
                            <input type="number" id="textMessagePrice" min="5" max="1000" value="10">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-microphone"></i>
                        <h4>Voice Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per minute</div>
                            <input type="number" id="voiceMessagePrice" min="10" max="5000" value="30">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <div class="pricing-card">
                    <div class="pricing-card-header">
                        <i class="fas fa-image"></i>
                        <h4>Image Messages</h4>
                    </div>
                    <div class="pricing-input-group">
                        <div>
                            <div class="pricing-input-label">Price per image</div>
                            <input type="number" id="imageMessagePrice" min="5" max="1000" value="15">
                        </div>
                        <div class="pricing-currency">₦</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="savePricingBtn">Save Pricing</button>
            </div>
            
            <!-- Apply for Monetization for Non-Verified/Non-Mentor Users -->
            <div class="settings-section" id="applyForMonetization" style="display: none;">
                <h3 class="settings-section-title">
                    <i class="fas fa-rocket"></i>
                    Monetize Your Profile
                </h3>
                <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color);">
                    Become a verified creator or mentor to monetize your messages. Apply now to get verified and set your own pricing.
                </p>
                <button class="btn btn-primary" id="applyMonetizationBtn">Apply for Monetization</button>
            </div>
            
            <!-- General Settings -->
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fas fa-sliders-h"></i>
                    General Settings
                </h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="onlineStatus">Online Status</label>
                        <select id="onlineStatus">
                            <option value="online">Online</option>
                            <option value="away">Away</option>
                            <option value="busy">Busy</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageSounds">Message Sounds</label>
                        <select id="messageSounds">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="browserNotifications">Browser Notifications</label>
                        <select id="browserNotifications">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>

    <!-- Monetization Application Modal -->
    <div class="modal" id="monetizationApplicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Apply for Monetization</h2>
                <i class="fas fa-times close-modal" id="closeApplicationModal"></i>
            </div>
            
            <div class="application-note">
                <i class="fas fa-info-circle"></i>
                <span>Your application will be reviewed by our team. You'll receive a response within 3-5 business days.</span>
            </div>
            
            <form id="monetizationApplicationForm" class="application-form">
                <div class="form-section">
                    <h3 class="form-section-title">Personal Information</h3>
                    
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" min="18" max="100" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="form-section-title">Contact Information</h3>
                    
                    <div class="form-group">
                        <label for="socialMediaLinks">Social Media Links</label>
                        <textarea id="socialMediaLinks" placeholder="Include links to your social media profiles (Instagram, Twitter, YouTube, etc.)" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactMethod">Preferred Contact Method</label>
                        <select id="contactMethod" required>
                            <option value="">Select contact method</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="email">Email</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactInfo">Contact Information</label>
                        <input type="text" id="contactInfo" placeholder="Phone number or email address" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="form-section-title">Live Photo Verification</h3>
                    
                    <div class="camera-container" id="cameraContainer">
                        <div id="cameraInstructions">
                            <i class="fas fa-camera" style="font-size: 40px; color: var(--gray-color); margin-bottom: 10px;"></i>
                            <p>Click "Start Camera" to take a live verification photo</p>
                        </div>
                        <video id="cameraVideo" class="camera-video" autoplay playsinline style="display: none;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <img id="cameraPreview" class="camera-preview" src="" alt="Photo Preview">
                        <div class="camera-controls" id="cameraControls" style="display: none;">
                            <button type="button" class="camera-btn capture" id="captureBtn">Capture Photo</button>
                            <button type="button" class="camera-btn retake" id="retakeBtn" style="display: none;">Retake</button>
                        </div>
                        <button type="button" class="camera-btn capture" id="startCameraBtn">Start Camera</button>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitApplicationBtn">Submit Application</button>
            </form>
        </div>
    </div>

    <!-- External Configuration -->
    <script src="configuration.js"></script>
    <script src="agora.js"></script>

    <!-- External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Chat Script -->
    <script>
        // Professional Chat Application with Monetization
        class ConnectXChat {
            constructor() {
                this.state = {
                    currentUser: null,
                    conversations: [],
                    activeConversation: null,
                    messages: [],
                    userProfile: null,
                    mediaFile: null,
                    isRecording: false,
                    recordingTimer: null,
                    recordingStartTime: null,
                    audioChunks: [],
                    mediaRecorder: null,
                    voiceNote: null,
                    conversationId: null,
                    isInConversationView: false,
                    balance: 0,
                    freeMessagesRemaining: 3,
                    settings: {
                        onlineStatus: 'online',
                        messageSounds: 'enabled',
                        browserNotifications: 'enabled'
                    },
                    audioContext: null,
                    analyser: null,
                    dataArray: null,
                    animationId: null,
                    networkUsers: [],
                    searchResults: [],
                    isVoicePreview: false,
                    audioPlayer: null,
                    isPlaying: false,
                    lastScrollTop: 0,
                    isSearchActive: false,
                    isMentor: false,
                    isVerified: false,
                    applicationPhoto: null,
                    recipientPricing: null,
                    cameraStream: null,
                    blockedUsers: [],
                    contextMenu: {
                        target: null,
                        type: null
                    }
                };

                this.init();
            }

            async init() {
                try {
                    // Check if external configuration is loaded
                    if (typeof firebaseConfig === 'undefined') {
                        console.error('Configuration not loaded.');
                        this.showError('Configuration Error');
                        return;
                    }
                    
                    // Initialize Firebase if not already initialized
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    this.setupDOMReferences();
                    this.setupEventListeners();
                    await this.checkAuthStatus();
                    await this.loadUserProfile();
                    await this.loadConversations();
                    await this.loadNetworkUsers();
                    await this.loadBlockedUsers();
                    await this.handleURLParameters();
                    
                    // Setup scroll behavior for user profiles
                    this.setupScrollBehavior();
                    
                    // Initialize Agora for audio
                    if (typeof AgoraService !== 'undefined') {
                        window.agoraService = new AgoraService();
                        await window.agoraService.initialize(agoraConfig.appId);
                    }
                    
                    console.log('ConnectX Chat initialized successfully');
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    this.showError('Initialization Error');
                }
            }

            setupDOMReferences() {
                this.elements = {
                    // Main container
                    mainContainer: document.getElementById('mainContainer'),
                    
                    // Header elements
                    settingsBtn: document.getElementById('settingsBtn'),
                    notificationsBtn: document.getElementById('notificationsBtn'),
                    notificationBadge: document.getElementById('notificationBadge'),
                    
                    // Sidebar elements
                    chatList: document.getElementById('chatList'),
                    userProfilesScroll: document.getElementById('userProfilesScroll'),
                    userProfilesSection: document.getElementById('userProfilesSection'),
                    
                    // Floating search widget
                    floatingSearch: document.getElementById('floatingSearch'),
                    searchInput: document.getElementById('searchInput'),
                    
                    // Chat area elements
                    chatArea: document.getElementById('chatArea'),
                    emptyState: document.getElementById('emptyState'),
                    
                    // Conversation view elements
                    conversationView: document.getElementById('conversationView'),
                    conversationBackBtn: document.getElementById('conversationBackBtn'),
                    conversationAvatar: document.getElementById('conversationAvatar'),
                    conversationUserName: document.getElementById('conversationUserName'),
                    conversationUserStatus: document.getElementById('conversationUserStatus'),
                    statusText: document.getElementById('statusText'),
                    viewProfileBtn: document.getElementById('viewProfileBtn'),
                    moreActionsBtn: document.getElementById('moreActionsBtn'),
                    messagesArea: document.getElementById('messagesArea'),
                    chatInput: document.getElementById('chatInput'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    attachBtn: document.getElementById('attachBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    wordCounter: document.getElementById('wordCounter'),
                    balanceAmount: document.getElementById('balanceAmount'),
                    pricingDisplay: document.getElementById('pricingDisplay'),
                    textPriceDisplay: document.getElementById('textPriceDisplay'),
                    voicePriceDisplay: document.getElementById('voicePriceDisplay'),
                    imagePriceDisplay: document.getElementById('imagePriceDisplay'),
                    
                    // Context menu
                    contextMenu: document.getElementById('contextMenu'),
                    blockUserBtn: document.getElementById('blockUserBtn'),
                    deleteChatBtn: document.getElementById('deleteChatBtn'),
                    
                    // Voice recording elements
                    voiceRecorder: document.getElementById('voiceRecorder'),
                    recordingTimer: document.getElementById('recordingTimer'),
                    voiceWaveform: document.getElementById('voiceWaveform'),
                    cancelRecordingBtn: document.getElementById('cancelRecordingBtn'),
                    sendRecordingBtn: document.getElementById('sendRecordingBtn'),
                    
                    // Voice preview elements
                    voicePreview: document.getElementById('voicePreview'),
                    voicePreviewDuration: document.getElementById('voicePreviewDuration'),
                    voicePreviewWaveform: document.getElementById('voicePreviewWaveform'),
                    voicePreviewPlayBtn: document.getElementById('voicePreviewPlayBtn'),
                    deleteVoiceBtn: document.getElementById('deleteVoiceBtn'),
                    sendVoiceBtn: document.getElementById('sendVoiceBtn'),
                    
                    // Media preview elements
                    mediaPreview: document.getElementById('mediaPreview'),
                    mediaPreviewImage: document.getElementById('mediaPreviewImage'),
                    mediaPreviewName: document.getElementById('mediaPreviewName'),
                    sendMediaBtn: document.getElementById('sendMediaBtn'),
                    cancelMediaBtn: document.getElementById('cancelMediaBtn'),
                    
                    // Settings modal elements
                    settingsModal: document.getElementById('settingsModal'),
                    closeSettingsModal: document.getElementById('closeSettingsModal'),
                    onlineStatus: document.getElementById('onlineStatus'),
                    messageSounds: document.getElementById('messageSounds'),
                    browserNotifications: document.getElementById('browserNotifications'),
                    saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                    totalEarnings: document.getElementById('totalEarnings'),
                    availableEarnings: document.getElementById('availableEarnings'),
                    monetizationSettings: document.getElementById('monetizationSettings'),
                    applyForMonetization: document.getElementById('applyForMonetization'),
                    textMessagePrice: document.getElementById('textMessagePrice'),
                    voiceMessagePrice: document.getElementById('voiceMessagePrice'),
                    imageMessagePrice: document.getElementById('imageMessagePrice'),
                    savePricingBtn: document.getElementById('savePricingBtn'),
                    applyMonetizationBtn: document.getElementById('applyMonetizationBtn'),
                    
                    // Monetization application modal
                    monetizationApplicationModal: document.getElementById('monetizationApplicationModal'),
                    closeApplicationModal: document.getElementById('closeApplicationModal'),
                    monetizationApplicationForm: document.getElementById('monetizationApplicationForm'),
                    fullName: document.getElementById('fullName'),
                    age: document.getElementById('age'),
                    country: document.getElementById('country'),
                    socialMediaLinks: document.getElementById('socialMediaLinks'),
                    contactMethod: document.getElementById('contactMethod'),
                    contactInfo: document.getElementById('contactInfo'),
                    cameraContainer: document.getElementById('cameraContainer'),
                    cameraVideo: document.getElementById('cameraVideo'),
                    cameraCanvas: document.getElementById('cameraCanvas'),
                    cameraPreview: document.getElementById('cameraPreview'),
                    cameraControls: document.getElementById('cameraControls'),
                    startCameraBtn: document.getElementById('startCameraBtn'),
                    captureBtn: document.getElementById('captureBtn'),
                    retakeBtn: document.getElementById('retakeBtn'),
                    submitApplicationBtn: document.getElementById('submitApplicationBtn'),
                    cameraInstructions: document.getElementById('cameraInstructions')
                };
            }

            setupEventListeners() {
                // Navigation
                this.elements.conversationBackBtn.addEventListener('click', () => this.exitConversationView());
                this.elements.viewProfileBtn.addEventListener('click', () => this.viewUserProfile());
                this.elements.moreActionsBtn.addEventListener('click', (e) => this.showContextMenu(e, 'conversation'));
                
                // Context menu
                this.elements.blockUserBtn.addEventListener('click', () => this.blockUser());
                this.elements.deleteChatBtn.addEventListener('click', () => this.deleteChat());
                document.addEventListener('click', (e) => {
                    if (!this.elements.contextMenu.contains(e.target)) {
                        this.hideContextMenu();
                    }
                });
                
                // Settings
                this.elements.settingsBtn.addEventListener('click', () => this.showSettingsModal());
                this.elements.closeSettingsModal.addEventListener('click', () => this.hideSettingsModal());
                this.elements.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
                this.elements.savePricingBtn.addEventListener('click', () => this.saveCustomPricing());
                this.elements.applyMonetizationBtn.addEventListener('click', () => this.showApplicationModal());
                
                // Monetization Application
                this.elements.closeApplicationModal.addEventListener('click', () => this.hideApplicationModal());
                this.elements.monetizationApplicationForm.addEventListener('submit', (e) => this.submitApplication(e));
                this.elements.startCameraBtn.addEventListener('click', () => this.startCamera());
                this.elements.captureBtn.addEventListener('click', () => this.capturePhoto());
                this.elements.retakeBtn.addEventListener('click', () => this.retakePhoto());
                
                // Floating Search Widget
                this.elements.floatingSearch.addEventListener('click', () => this.toggleSearch());
                this.elements.searchInput.addEventListener('input', () => this.handleSearch());
                this.elements.searchInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (!this.state.isSearchActive) return;
                        this.closeSearch();
                    }, 200);
                });
                
                // Message Input
                this.elements.chatInput.addEventListener('input', () => {
                    this.handleInputResize();
                    this.updateWordCounter();
                });
                
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.elements.sendMessageBtn.addEventListener('click', () => this.sendMessage());
                this.elements.attachBtn.addEventListener('click', () => this.handleAttachFile());
                this.elements.voiceBtn.addEventListener('click', () => this.startRecording());
                
                // Voice Recording
                this.elements.cancelRecordingBtn.addEventListener('click', () => this.cancelRecording());
                this.elements.sendRecordingBtn.addEventListener('click', () => this.stopRecording());
                
                // Voice Preview
                this.elements.voicePreviewPlayBtn.addEventListener('click', () => this.toggleVoicePlayback());
                this.elements.deleteVoiceBtn.addEventListener('click', () => this.deleteVoicePreview());
                this.elements.sendVoiceBtn.addEventListener('click', () => this.sendVoiceMessage());
                
                // Media Preview
                this.elements.sendMediaBtn.addEventListener('click', () => this.sendMediaMessage());
                this.elements.cancelMediaBtn.addEventListener('click', () => this.cancelMedia());
            }

            setupScrollBehavior() {
                const chatList = this.elements.chatList;
                let lastScrollTop = 0;
                let scrollTimeout;
                
                chatList.addEventListener('scroll', () => {
                    const scrollTop = chatList.scrollTop;
                    const userProfiles = this.elements.userProfilesSection;
                    
                    clearTimeout(scrollTimeout);
                    
                    if (scrollTop > lastScrollTop && scrollTop > 50) {
                        // Scrolling down - hide with smooth animation
                        userProfiles.style.transform = 'translateY(-100%)';
                        userProfiles.style.opacity = '0';
                        userProfiles.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                    } else if (scrollTop < lastScrollTop - 10) {
                        // Scrolling up - show with smooth animation
                        userProfiles.style.transform = 'translateY(0)';
                        userProfiles.style.opacity = '1';
                    }
                    
                    lastScrollTop = scrollTop;
                    
                    // Add glow effect to active conversation
                    this.updateActiveConversationGlow();
                });
            }

            updateActiveConversationGlow() {
                const activeItem = this.elements.chatList.querySelector('.chat-list-item.active');
                const allItems = this.elements.chatList.querySelectorAll('.chat-list-item');
                
                allItems.forEach(item => {
                    item.style.boxShadow = 'none';
                    item.style.transition = 'box-shadow 0.3s ease';
                });
                
                if (activeItem) {
                    activeItem.style.boxShadow = '0 0 20px rgba(67, 97, 238, 0.3)';
                }
            }

            async checkAuthStatus() {
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                            resolve();
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                });
            }

            async loadUserProfile() {
                if (!this.state.currentUser) return;

                try {
                    // Set up real-time listener for user profile
                    firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                this.state.userProfile = doc.data();
                                this.state.balance = this.state.userProfile.balance || 0;
                                this.state.freeMessagesRemaining = 3 - (this.state.userProfile.freeMessagesUsed || 0);
                                
                                // Check if user is mentor or verified
                                this.state.isMentor = this.state.userProfile.isMentor || false;
                                this.state.isVerified = this.state.userProfile.isVerified || false;
                                
                                // Update UI
                                this.elements.balanceAmount.textContent = `₦${this.state.balance}`;
                                
                                // Update earnings
                                const totalEarnings = this.state.userProfile.totalEarnings || 0;
                                const availableEarnings = this.state.userProfile.availableEarnings || 0;
                                this.elements.totalEarnings.textContent = `₦${totalEarnings}`;
                                this.elements.availableEarnings.textContent = `₦${availableEarnings}`;
                                
                                // Show/hide monetization settings based on user status
                                this.updateMonetizationUI();
                            }
                        }, error => {
                            console.error('Error loading user profile:', error);
                        });
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async loadBlockedUsers() {
                if (!this.state.currentUser) return;
                
                try {
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .get();
                    
                    if (userDoc.exists) {
                        this.state.blockedUsers = userDoc.data().blockedUsers || [];
                    }
                } catch (error) {
                    console.error('Error loading blocked users:', error);
                }
            }

            updateMonetizationUI() {
                if (this.state.isMentor || this.state.isVerified) {
                    // User is mentor or verified - show monetization settings
                    this.elements.monetizationSettings.style.display = 'block';
                    this.elements.applyForMonetization.style.display = 'none';
                    
                    // Load current pricing from user profile
                    this.loadUserPricing();
                } else {
                    // User is not mentor or verified - show apply button
                    this.elements.monetizationSettings.style.display = 'none';
                    this.elements.applyForMonetization.style.display = 'block';
                }
            }

            async loadUserPricing() {
                if (!this.state.userProfile) return;
                
                // Load custom pricing from user profile
                if (this.state.userProfile.customPricing) {
                    this.elements.textMessagePrice.value = this.state.userProfile.customPricing.text || 10;
                    this.elements.voiceMessagePrice.value = this.state.userProfile.customPricing.voice || 30;
                    this.elements.imageMessagePrice.value = this.state.userProfile.customPricing.image || 15;
                }
            }

            async loadNetworkUsers() {
                if (!this.state.currentUser) return;
                
                try {
                    // Load user's followers, following, and contacts
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const followers = userData.followers || [];
                        const following = userData.following || [];
                        
                        // Combine and deduplicate
                        const allUserIds = [...new Set([...followers, ...following])];
                        
                        // Filter out blocked users
                        const filteredUserIds = allUserIds.filter(userId => 
                            !this.state.blockedUsers.includes(userId)
                        );
                        
                        // Fetch user data for each ID
                        const userPromises = filteredUserIds.map(userId => 
                            firebase.firestore().collection('users').doc(userId).get()
                        );
                        
                        const userDocs = await Promise.all(userPromises);
                        this.state.networkUsers = userDocs
                            .filter(doc => doc.exists)
                            .map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                        
                        this.renderNetworkUsers();
                    }
                } catch (error) {
                    console.error('Error loading network users:', error);
                }
            }

            renderNetworkUsers() {
                if (!this.state.networkUsers.length) {
                    this.elements.userProfilesScroll.innerHTML = `
                        <div style="text-align: center; width: 100%; color: var(--gray-color); font-size: 12px;">
                            No users in your network yet
                        </div>
                    `;
                    return;
                }

                this.elements.userProfilesScroll.innerHTML = this.state.networkUsers.map(user => {
                    // Add status badges for mentors and verified users
                    let statusBadges = '';
                    if (user.isMentor) {
                        statusBadges += '<span class="status-badge mentor"><i class="fas fa-graduation-cap"></i></span>';
                    }
                    if (user.isVerified) {
                        statusBadges += '<span class="status-badge verified"><i class="fas fa-check"></i></span>';
                    }
                    
                    return `
                        <div class="user-profile-item" data-user-id="${user.id}">
                            <div class="user-profile-avatar">
                                ${user.profilePicture ? 
                                    `<img src="${user.profilePicture}" alt="${user.name}" loading="lazy">` :
                                    `${user.name.charAt(0).toUpperCase()}`
                                }
                                <div class="status-indicator ${`status-${user.onlineStatus || 'offline'}`}"></div>
                            </div>
                            <div class="user-profile-name">${user.name}${statusBadges}</div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners to user profile items
                this.elements.userProfilesScroll.querySelectorAll('.user-profile-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const userId = item.getAttribute('data-user-id');
                        this.startConversation(userId);
                    });
                    
                    // Add long press for context menu
                    let pressTimer;
                    item.addEventListener('mousedown', (e) => {
                        pressTimer = setTimeout(() => {
                            this.showContextMenu(e, 'user', item.getAttribute('data-user-id'));
                        }, 1000);
                    });
                    
                    item.addEventListener('mouseup', () => {
                        clearTimeout(pressTimer);
                    });
                    
                    item.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            this.showContextMenu(e, 'user', item.getAttribute('data-user-id'));
                        }, 1000);
                    });
                    
                    item.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                });
            }

            async loadConversations() {
                if (!this.state.currentUser) return;

                try {
                    const conversationsSnapshot = await firebase.firestore()
                        .collection('conversations')
                        .where('participants', 'array-contains', this.state.currentUser.uid)
                        .orderBy('lastMessageAt', 'desc')
                        .limit(50)
                        .get();
                    
                    this.state.conversations = conversationsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    this.renderConversations();
                    
                    // Set up real-time listener for conversations
                    this.setupConversationsListener();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            setupConversationsListener() {
                if (!this.state.currentUser) return;
                
                firebase.firestore()
                    .collection('conversations')
                    .where('participants', 'array-contains', this.state.currentUser.uid)
                    .orderBy('lastMessageAt', 'desc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        let hasUpdates = false;
                        
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added' || change.type === 'modified') {
                                const conversation = {
                                    id: change.doc.id,
                                    ...change.doc.data()
                                };
                                
                                // Check if the other participant is blocked
                                const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                                if (this.state.blockedUsers.includes(otherParticipantId)) {
                                    return; // Skip blocked conversations
                                }
                                
                                // Update conversation in state
                                const index = this.state.conversations.findIndex(c => c.id === conversation.id);
                                if (index !== -1) {
                                    this.state.conversations[index] = conversation;
                                } else {
                                    this.state.conversations.unshift(conversation);
                                }
                                
                                hasUpdates = true;
                                
                                // Play notification sound if enabled and it's a new message from another user
                                if (this.state.settings.messageSounds === 'enabled' && 
                                    change.type === 'modified' && 
                                    conversation.lastMessageSender !== this.state.currentUser.uid &&
                                    document.hidden) {
                                    this.playNotificationSound();
                                }
                                
                                // Show browser notification if enabled
                                if (this.state.settings.browserNotifications === 'enabled' && 
                                    change.type === 'modified' && 
                                    conversation.lastMessageSender !== this.state.currentUser.uid &&
                                    document.hidden) {
                                    this.showBrowserNotification(conversation);
                                }
                            }
                        });
                        
                        if (hasUpdates) {
                            // Re-render conversations
                            this.renderConversations();
                            
                            // Update notification badge
                            this.updateNotificationBadge();
                        }
                    }, error => {
                        console.error('Error in conversations listener:', error);
                    });
            }

            updateNotificationBadge() {
                const totalUnread = this.state.conversations.reduce((total, conversation) => {
                    return total + (conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0);
                }, 0);
                
                if (totalUnread > 0) {
                    this.elements.notificationBadge.textContent = totalUnread;
                    this.elements.notificationBadge.style.display = 'flex';
                } else {
                    this.elements.notificationBadge.style.display = 'none';
                }
            }

            playNotificationSound() {
                try {
                    // Create a pleasant notification sound
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    
                    oscillator.frequency.setValueAtTime(800, context.currentTime);
                    oscillator.frequency.setValueAtTime(600, context.currentTime + 0.1);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, context.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.1, context.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);
                    
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.5);
                    
                } catch (error) {
                    console.error('Error playing notification sound:', error);
                    // Fallback to HTML5 audio
                    const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
                    audio.volume = 0.3;
                    audio.play().catch(() => {}); // Silent fail if audio can't play
                }
            }

            async showBrowserNotification(conversation) {
                if (!("Notification" in window)) {
                    console.log('This browser does not support notifications');
                    return;
                }
                
                try {
                    let permission = Notification.permission;
                    
                    if (permission === "default") {
                        permission = await Notification.requestPermission();
                    }
                    
                    if (permission === "granted") {
                        const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                        const otherParticipant = conversation.participantsData?.[otherParticipantId];
                        
                        const notification = new Notification(`New message from ${otherParticipant?.name || 'Unknown User'}`, {
                            body: conversation.lastMessage?.substring(0, 50) || 'New message',
                            icon: otherParticipant?.profilePicture || '/icon.png',
                            badge: '/icon.png',
                            tag: conversation.id, // Group notifications by conversation
                            requireInteraction: false,
                            silent: false // Enable sound
                        });
                        
                        notification.onclick = () => {
                            window.focus();
                            this.loadConversation(conversation.id);
                            notification.close();
                        };
                        
                        // Auto-close after 5 seconds
                        setTimeout(() => notification.close(), 5000);
                        
                    } else if (permission === "denied") {
                        console.log('Notification permission denied');
                    }
                } catch (error) {
                    console.error('Error showing browser notification:', error);
                }
            }

            renderConversations() {
                if (!this.state.conversations.length) {
                    this.elements.chatList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No conversations yet</h3>
                            <p>Start a new chat to connect with others.</p>
                        </div>
                    `;
                    return;
                }

                this.elements.chatList.innerHTML = this.state.conversations.map(conversation => {
                    // Get the other participant's ID
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    const otherParticipant = conversation.participantsData ? conversation.participantsData[otherParticipantId] : null;
                    
                    const isActive = this.state.activeConversation && this.state.activeConversation.id === conversation.id;
                    const unreadCount = conversation.unreadCount && conversation.unreadCount[this.state.currentUser.uid] || 0;
                    
                    // Add status badges for mentors and verified users
                    let statusBadges = '';
                    if (otherParticipant && otherParticipant.isMentor) {
                        statusBadges += '<span class="status-badge mentor"><i class="fas fa-graduation-cap"></i></span>';
                    }
                    if (otherParticipant && otherParticipant.isVerified) {
                        statusBadges += '<span class="status-badge verified"><i class="fas fa-check"></i></span>';
                    }
                    
                    return `
                        <div class="chat-list-item ${isActive ? 'active' : ''}" data-conversation-id="${conversation.id}">
                            <div class="chat-avatar">
                                ${otherParticipant && otherParticipant.profilePicture ? 
                                    `<img src="${otherParticipant.profilePicture}" alt="${otherParticipant.name}" loading="lazy">` :
                                    `${otherParticipant ? otherParticipant.name.charAt(0).toUpperCase() : 'U'}`
                                }
                                <div class="status-indicator ${otherParticipant ? `status-${otherParticipant.onlineStatus || 'offline'}` : 'status-offline'}"></div>
                            </div>
                            <div class="chat-info">
                                <div class="chat-header-info">
                                    <div class="chat-name">${otherParticipant ? otherParticipant.name : 'Unknown User'}${statusBadges}</div>
                                    <div class="chat-time">${this.formatTime(conversation.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    ${conversation.lastMessageType === 'voice' ? '<i class="fas fa-microphone"></i> Voice message' : 
                                      conversation.lastMessageType === 'image' ? '<i class="fas fa-image"></i> Image' :
                                      conversation.lastMessageType === 'application' ? '<i class="fas fa-file-alt"></i> Application' :
                                      conversation.lastMessage || 'No messages yet'}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners to conversation items
                this.elements.chatList.querySelectorAll('.chat-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.getAttribute('data-conversation-id');
                        this.loadConversation(conversationId);
                    });
                    
                    // Add long press for context menu
                    let pressTimer;
                    item.addEventListener('mousedown', (e) => {
                        pressTimer = setTimeout(() => {
                            this.showContextMenu(e, 'conversation', item.getAttribute('data-conversation-id'));
                        }, 1000);
                    });
                    
                    item.addEventListener('mouseup', () => {
                        clearTimeout(pressTimer);
                    });
                    
                    item.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            this.showContextMenu(e, 'conversation', item.getAttribute('data-conversation-id'));
                        }, 1000);
                    });
                    
                    item.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                });
            }

            async loadConversation(conversationId) {
                try {
                    this.showLoading();
                    
                    // Update URL immediately
                    this.updateURLWithConversation(conversationId);
                    
                    const conversationDoc = await firebase.firestore()
                        .collection('conversations')
                        .doc(conversationId)
                        .get();
                    
                    if (!conversationDoc.exists) {
                        this.showError('Conversation not found');
                        return;
                    }
                    
                    const conversation = {
                        id: conversationDoc.id,
                        ...conversationDoc.data()
                    };
                    
                    this.state.activeConversation = conversation;
                    this.state.conversationId = conversationId;
                    
                    // Get the other participant's ID
                    const otherParticipantId = conversation.participants.find(id => id !== this.state.currentUser.uid);
                    
                    // Check if user is blocked
                    if (this.state.blockedUsers.includes(otherParticipantId)) {
                        this.showError('This user is blocked');
                        return;
                    }
                    
                    // Get user data for the other participant
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(otherParticipantId)
                        .get();
                    
                    if (userDoc.exists) {
                        this.state.activeConversation.user = {
                            id: otherParticipantId,
                            ...userDoc.data()
                        };
                        
                        // Check if recipient is mentor or verified and load their pricing
                        const recipientData = userDoc.data();
                        if (recipientData.isMentor || recipientData.isVerified) {
                            this.state.recipientPricing = recipientData.customPricing || {
                                text: 10,
                                voice: 30,
                                image: 15
                            };
                            this.showPricingDisplay();
                        } else {
                            this.hidePricingDisplay();
                        }
                    }
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    this.setupMessagesListener();
                    
                    // Mark conversation as read
                    await this.markAsRead();
                    
                    // Add glow animation to conversation header
                    this.animateConversationHeader();
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    this.showError('Failed to load conversation');
                }
            }

            animateConversationHeader() {
                const header = document.querySelector('.conversation-header');
                header.style.animation = 'pulseGlow 2s ease-in-out';
                
                setTimeout(() => {
                    header.style.animation = '';
                }, 2000);
            }

            updateURLWithConversation(conversationId) {
                const url = new URL(window.location);
                url.searchParams.set('conversation', conversationId);
                window.history.replaceState({}, '', url);
            }

            showPricingDisplay() {
                if (this.state.recipientPricing) {
                    this.elements.textPriceDisplay.textContent = `₦${this.state.recipientPricing.text}`;
                    this.elements.voicePriceDisplay.textContent = `₦${this.state.recipientPricing.voice}/min`;
                    this.elements.imagePriceDisplay.textContent = `₦${this.state.recipientPricing.image}`;
                    this.elements.pricingDisplay.style.display = 'flex';
                    this.updateWordCounter();
                }
            }

            hidePricingDisplay() {
                this.elements.pricingDisplay.style.display = 'none';
                this.elements.wordCounter.style.display = 'none';
            }

            async startConversation(userId) {
                try {
                    this.showLoading();
                    
                    // Check if user is blocked
                    if (this.state.blockedUsers.includes(userId)) {
                        this.showError('This user is blocked');
                        return;
                    }
                    
                    // Check if conversation already exists
                    const existingConversation = this.state.conversations.find(conv => 
                        conv.participants.includes(userId)
                    );
                    
                    if (existingConversation) {
                        await this.loadConversation(existingConversation.id);
                        return;
                    }
                    
                    // Get user data
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(userId)
                        .get();
                    
                    if (!userDoc.exists) {
                        this.showError('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Create new conversation
                    const conversationData = {
                        participants: [this.state.currentUser.uid, userId],
                        participantsData: {
                            [this.state.currentUser.uid]: {
                                name: this.state.userProfile.name,
                                profilePicture: this.state.userProfile.profilePicture,
                                onlineStatus: 'online'
                            },
                            [userId]: {
                                name: userData.name,
                                profilePicture: userData.profilePicture,
                                onlineStatus: userData.onlineStatus || 'offline'
                            }
                        },
                        messages: [],
                        lastMessage: '',
                        lastMessageType: '',
                        lastMessageSender: '',
                        lastMessageAt: new Date().toISOString(),
                        createdAt: new Date().toISOString(),
                        unreadCount: {
                            [this.state.currentUser.uid]: 0,
                            [userId]: 0
                        }
                    };
                    
                    const conversationRef = await firebase.firestore()
                        .collection('conversations')
                        .add(conversationData);
                    
                    this.state.activeConversation = {
                        id: conversationRef.id,
                        ...conversationData,
                        user: {
                            id: userId,
                            ...userData
                        }
                    };
                    
                    this.state.conversationId = conversationRef.id;
                    
                    // Update URL with conversation ID
                    this.updateURLWithConversation(conversationRef.id);
                    
                    // Check if recipient is mentor or verified
                    if (userData.isMentor || userData.isVerified) {
                        this.state.recipientPricing = userData.customPricing || {
                            text: 10,
                            voice: 30,
                            image: 15
                        };
                        this.showPricingDisplay();
                    } else {
                        this.hidePricingDisplay();
                    }
                    
                    // Update UI
                    this.enterConversationView();
                    this.updateConversationHeader();
                    await this.loadMessages();
                    this.setupMessagesListener();
                    
                } catch (error) {
                    console.error('Error starting conversation:', error);
                    this.showError('Failed to start conversation');
                }
            }

            async loadMessages() {
                if (!this.state.conversationId) return;

                try {
                    const conversationDoc = await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .get();
                    
                    if (conversationDoc.exists) {
                        const conversation = conversationDoc.data();
                        this.state.messages = conversation.messages || [];
                        this.renderMessages();
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            setupMessagesListener() {
                if (!this.state.conversationId) return;
                
                // Listen for new messages in real-time
                firebase.firestore()
                    .collection('conversations')
                    .doc(this.state.conversationId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const conversation = doc.data();
                            this.state.messages = conversation.messages || [];
                            this.renderMessages();
                            
                            // Mark as read if it's not our message
                            if (conversation.lastMessageSender !== this.state.currentUser.uid) {
                                this.markAsRead();
                            }
                        }
                    }, error => {
                        console.error('Error in messages listener:', error);
                    });
            }

            renderMessages() {
                if (!this.state.messages.length) {
                    this.elements.messagesArea.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-alt"></i>
                            <h3>No messages yet</h3>
                            <p>Send a message to start the conversation.</p>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = this.state.messages.map(message => {
                    const isSent = message.senderId === this.state.currentUser.uid;
                    
                    // Handle application messages specially
                    if (message.type === 'application') {
                        return this.renderApplicationMessage(message);
                    }
                    
                    let messageContent = '';
                    
                    if (message.type === 'text') {
                        messageContent = `
                            <div class="message-text">${message.content}</div>
                        `;
                    } else if (message.type === 'image') {
                        messageContent = `
                            <div class="message-media">
                                <img src="${message.mediaUrl}" alt="Shared image" loading="lazy">
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        messageContent = `
                            <div class="voice-message">
                                <button class="voice-play-btn" data-audio="${message.mediaUrl}">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="voice-waveform">
                                    ${this.generateVoiceWaveform()}
                                </div>
                                <div class="voice-duration">${message.duration || '0:00'}</div>
                            </div>
                        `;
                    }
                    
                    // Show pricing info for paid messages
                    let costInfo = '';
                    if (message.isPaid && message.cost) {
                        costInfo = `<div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Paid: ₦${message.cost}</div>`;
                    }
                    
                    return `
                        <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${message.id}">
                            ${messageContent}
                            <div class="message-time">${this.formatTime(message.createdAt)}</div>
                            ${costInfo}
                        </div>
                    `;
                }).join('');
                
                this.elements.messagesArea.innerHTML = messagesHTML;
                
                // Add event listeners to voice messages
                this.elements.messagesArea.querySelectorAll('.voice-play-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const audioUrl = e.target.closest('.voice-play-btn').getAttribute('data-audio');
                        this.playVoiceMessage(audioUrl, e.target.closest('.voice-message'));
                    });
                });
                
                // Add event listeners to application action buttons
                this.elements.messagesArea.querySelectorAll('.application-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.getAttribute('data-action');
                        const applicationId = e.target.getAttribute('data-application-id');
                        this.handleApplicationAction(applicationId, action);
                    });
                });
                
                // Scroll to bottom
                this.scrollToBottom();
            }

            renderApplicationMessage(message) {
                const applicationData = message.applicationData;
                const isRecruitmentor = this.state.activeConversation && 
                    this.state.activeConversation.user && 
                    this.state.activeConversation.user.username === 'recruitmentor';
                
                let actionButtons = '';
                
                // Only show action buttons if current user is recruitmentor
                if (isRecruitmentor) {
                    actionButtons = `
                        <div class="application-actions">
                            <button class="application-action-btn approve-mentor" data-application-id="${message.id}" data-action="approve_mentor">
                                Make Mentor
                            </button>
                            <button class="application-action-btn approve-verified" data-application-id="${message.id}" data-action="approve_verified">
                                Verify User
                            </button>
                            <button class="application-action-btn approve-both" data-application-id="${message.id}" data-action="approve_both">
                                Both
                            </button>
                            <button class="application-action-btn decline" data-application-id="${message.id}" data-action="decline">
                                Decline
                            </button>
                        </div>
                    `;
                }
                
                return `
                    <div class="application-message">
                        <div class="application-header">
                            <div class="application-avatar">
                                ${applicationData.applicantName ? applicationData.applicantName.charAt(0).toUpperCase() : 'A'}
                            </div>
                            <div class="application-user-info">
                                <h4>${applicationData.applicantName || 'Applicant'}</h4>
                                <p>Monetization Application</p>
                            </div>
                        </div>
                        <div class="application-details">
                            <div class="application-detail-item">
                                <span class="application-detail-label">Full Name:</span>
                                <span class="application-detail-value">${applicationData.fullName}</span>
                            </div>
                            <div class="application-detail-item">
                                <span class="application-detail-label">Age:</span>
                                <span class="application-detail-value">${applicationData.age}</span>
                            </div>
                            <div class="application-detail-item">
                                <span class="application-detail-label">Country:</span>
                                <span class="application-detail-value">${applicationData.country}</span>
                            </div>
                            <div class="application-detail-item">
                                <span class="application-detail-label">Social Media:</span>
                                <span class="application-detail-value">${applicationData.socialMediaLinks}</span>
                            </div>
                            <div class="application-detail-item">
                                <span class="application-detail-label">Contact:</span>
                                <span class="application-detail-value">${applicationData.contactInfo} (${applicationData.contactMethod})</span>
                            </div>
                        </div>
                        ${applicationData.photoUrl ? `<img src="${applicationData.photoUrl}" alt="Applicant Photo" class="application-photo">` : ''}
                        ${actionButtons}
                    </div>
                `;
            }

            async handleApplicationAction(applicationId, action) {
                try {
                    // Find the application message
                    const message = this.state.messages.find(m => m.id === applicationId);
                    if (!message || !message.applicationData) return;
                    
                    const applicantId = message.applicationData.applicantId;
                    
                    switch (action) {
                        case 'approve_mentor':
                            await firebase.firestore().collection('users').doc(applicantId).update({
                                isMentor: true
                            });
                            break;
                            
                        case 'approve_verified':
                            await firebase.firestore().collection('users').doc(applicantId).update({
                                isVerified: true
                            });
                            break;
                            
                        case 'approve_both':
                            await firebase.firestore().collection('users').doc(applicantId).update({
                                isMentor: true,
                                isVerified: true
                            });
                            break;
                            
                        case 'decline':
                            // Just remove the application message or mark as declined
                            break;
                    }
                    
                    // Remove the application message from the conversation
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayRemove(message)
                        });
                    
                    this.showNotification('Application Processed', `Application has been ${action.replace('_', ' ')}`);
                    
                } catch (error) {
                    console.error('Error processing application:', error);
                    this.showError('Failed to process application');
                }
            }

            async sendMessage() {
                const content = this.elements.chatInput.value.trim();
                if (!content && !this.state.mediaFile && !this.state.voiceNote) return;

                try {
                    let cost = 0;
                    let messageType = 'text';
                    let mediaUrl = null;
                    let duration = null;
                    let isPaidMessage = false;

                    // Check if this is a paid conversation (chatting with mentor/verified user)
                    if (this.state.activeConversation && this.state.activeConversation.user) {
                        const recipientData = this.state.activeConversation.user;
                        if (recipientData.isMentor || recipientData.isVerified) {
                            isPaidMessage = true;
                            
                            // Calculate cost based on recipient's pricing
                            if (this.state.mediaFile) {
                                messageType = 'image';
                                cost = this.state.recipientPricing.image;
                            } else if (this.state.voiceNote) {
                                messageType = 'voice';
                                const minutes = Math.ceil(this.parseDuration(this.state.voiceNote.duration) / 60);
                                cost = minutes * this.state.recipientPricing.voice;
                                duration = this.state.voiceNote.duration;
                            } else {
                                // Text message - check word count and calculate cost
                                const wordCount = content.split(/\s+/).length;
                                const baseWords = 35;
                                const baseCost = this.state.recipientPricing.text;
                                
                                if (wordCount <= baseWords) {
                                    cost = baseCost;
                                } else {
                                    // Additional cost for extra words
                                    const extraWords = wordCount - baseWords;
                                    const extraCost = Math.ceil(extraWords / 10) * (baseCost / 3);
                                    cost = baseCost + extraCost;
                                }
                            }
                        }
                    }

                    // Check if user has enough balance for paid messages
                    if (isPaidMessage && this.state.balance < cost) {
                        this.showError(`Insufficient balance. You need ₦${cost} to send this message.`);
                        return;
                    }

                    // Use free messages for text messages in non-paid conversations
                    if (!isPaidMessage && messageType === 'text' && this.state.freeMessagesRemaining > 0) {
                        this.state.freeMessagesRemaining--;
                    } else if (isPaidMessage) {
                        // Deduct balance for paid messages
                        const newBalance = this.state.balance - cost;
                        await firebase.firestore().collection('users').doc(this.state.currentUser.uid).update({
                            balance: newBalance,
                            freeMessagesUsed: 3 - this.state.freeMessagesRemaining
                        });
                        
                        this.state.balance = newBalance;
                        this.elements.balanceAmount.textContent = `₦${newBalance}`;
                        
                        // Distribute earnings - 50% to recipient, 50% to platform
                        if (isPaidMessage) {
                            const recipientEarnings = Math.floor(cost * 0.5);
                            const platformEarnings = cost - recipientEarnings;
                            
                            const recipientId = this.state.activeConversation.user.id;
                            
                            // Add earnings to the recipient
                            await firebase.firestore().collection('users').doc(recipientId).update({
                                totalEarnings: firebase.firestore.FieldValue.increment(recipientEarnings),
                                availableEarnings: firebase.firestore.FieldValue.increment(recipientEarnings)
                            });
                        }
                    }

                    let message = {
                        id: Date.now().toString(),
                        senderId: this.state.currentUser.uid,
                        content: content,
                        type: messageType,
                        createdAt: new Date().toISOString(),
                        isPaid: isPaidMessage,
                        cost: cost
                    };

                    // Handle media files
                    if (this.state.mediaFile) {
                        const fileRef = firebase.storage().ref().child(`messages/${this.state.currentUser.uid}/${Date.now()}_${this.state.mediaFile.name}`);
                        await fileRef.put(this.state.mediaFile);
                        mediaUrl = await fileRef.getDownloadURL();
                        
                        message.mediaUrl = mediaUrl;
                        message.content = '';
                    }

                    // Handle voice notes
                    if (this.state.voiceNote) {
                        const fileRef = firebase.storage().ref().child(`voice/${this.state.currentUser.uid}/${Date.now()}_voice.wav`);
                        await fileRef.put(this.state.voiceNote.blob);
                        mediaUrl = await fileRef.getDownloadURL();
                        
                        message.mediaUrl = mediaUrl;
                        message.duration = duration;
                        message.content = '';
                    }

                    // Add message to conversation
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayUnion(message),
                            lastMessage: content || (messageType === 'voice' ? 'Voice message' : 'Media'),
                            lastMessageType: messageType,
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date().toISOString(),
                            [`unreadCount.${this.state.activeConversation.user.id}`]: firebase.firestore.FieldValue.increment(1)
                        });

                    // Clear input and reset state
                    this.elements.chatInput.value = '';
                    this.state.mediaFile = null;
                    this.state.voiceNote = null;
                    this.hideMediaPreview();
                    this.hideVoicePreview();
                    this.handleInputResize();
                    this.updateWordCounter();

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message');
                }
            }

            async markAsRead() {
                if (!this.state.conversationId) return;

                try {
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(this.state.conversationId)
                        .update({
                            [`unreadCount.${this.state.currentUser.uid}`]: 0
                        });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }

            // Voice Recording
            async startRecording() {
                try {
                    // Use Agora for better audio quality if available
                    if (window.agoraService && window.agoraService.initialized) {
                        await this.startAgoraRecording();
                    } else {
                        // Fallback to standard MediaRecorder
                        await this.startStandardRecording();
                    }
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Could not access microphone');
                }
            }

            async startAgoraRecording() {
                try {
                    const audioTrack = await window.agoraService.createHighQualityAudioTrack();
                    const mediaStream = new MediaStream([audioTrack.getMediaStreamTrack()]);
                    
                    this.setupRecording(mediaStream);
                } catch (error) {
                    console.error('Agora recording failed, falling back to standard recording:', error);
                    await this.startStandardRecording();
                }
            }

            async startStandardRecording() {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                this.setupRecording(stream);
            }

            setupRecording(stream) {
                // Set up audio analysis for waveform
                this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.state.analyser = this.state.audioContext.createAnalyser();
                const source = this.state.audioContext.createMediaStreamSource(stream);
                source.connect(this.state.analyser);
                
                this.state.analyser.fftSize = 256;
                const bufferLength = this.state.analyser.frequencyBinCount;
                this.state.dataArray = new Uint8Array(bufferLength);
                
                this.state.audioChunks = [];
                this.state.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                this.state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.state.audioChunks.push(event.data);
                    }
                };
                
                this.state.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/webm' });
                    const duration = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                    
                    this.state.voiceNote = {
                        blob: audioBlob,
                        duration: this.formatAudioTime(duration),
                        url: URL.createObjectURL(audioBlob)
                    };
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Stop animation
                    if (this.state.animationId) {
                        cancelAnimationFrame(this.state.animationId);
                    }
                    
                    // Show voice preview
                    this.showVoicePreview();
                };
                
                this.state.mediaRecorder.start();
                this.state.isRecording = true;
                this.state.recordingStartTime = Date.now();
                
                // Show voice recorder UI
                this.elements.voiceRecorder.classList.add('active');
                
                // Start timer
                this.state.recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                    this.elements.recordingTimer.textContent = this.formatAudioTime(elapsed);
                }, 1000);
                
                // Start waveform animation
                this.animateWaveform();
            }

            animateWaveform() {
                if (!this.state.isRecording) return;
                
                this.state.analyser.getByteFrequencyData(this.state.dataArray);
                
                // Clear previous waveform
                this.elements.voiceWaveform.innerHTML = '';
                
                // Create new waveform bars
                const barCount = 20;
                const sliceWidth = Math.floor(this.state.dataArray.length / barCount);
                
                for (let i = 0; i < barCount; i++) {
                    const barValue = this.state.dataArray[i * sliceWidth] || 0;
                    const barHeight = Math.max(5, (barValue / 256) * 30);
                    const bar = document.createElement('div');
                    bar.className = 'voice-bar';
                    bar.style.height = `${barHeight}px`;
                    this.elements.voiceWaveform.appendChild(bar);
                }
                
                this.state.animationId = requestAnimationFrame(() => this.animateWaveform());
            }

            stopRecording() {
                if (this.state.mediaRecorder && this.state.isRecording) {
                    this.state.mediaRecorder.stop();
                    this.state.isRecording = false;
                    
                    // Hide voice recorder UI
                    this.elements.voiceRecorder.classList.remove('active');
                    
                    // Clear timer
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                        this.state.recordingTimer = null;
                    }
                }
            }

            cancelRecording() {
                this.stopRecording();
                this.state.voiceNote = null;
                this.hideVoicePreview();
            }

            showVoicePreview() {
                this.state.isVoicePreview = true;
                this.elements.voicePreviewDuration.textContent = this.state.voiceNote.duration;
                this.elements.voicePreview.classList.add('active');
                
                // Generate preview waveform
                this.generateVoicePreviewWaveform();
            }

            hideVoicePreview() {
                this.state.isVoicePreview = false;
                this.elements.voicePreview.classList.remove('active');
                this.state.voiceNote = null;
            }

            generateVoicePreviewWaveform() {
                this.elements.voicePreviewWaveform.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 30) + 10;
                    const bar = document.createElement('div');
                    bar.className = 'voice-preview-bar';
                    bar.style.height = `${height}px`;
                    this.elements.voicePreviewWaveform.appendChild(bar);
                }
            }

            toggleVoicePlayback() {
                if (!this.state.voiceNote) return;
                
                if (!this.state.audioPlayer) {
                    this.state.audioPlayer = new Audio(this.state.voiceNote.url);
                    
                    this.state.audioPlayer.addEventListener('ended', () => {
                        this.state.isPlaying = false;
                        this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                    });
                    
                    this.state.audioPlayer.addEventListener('timeupdate', () => {
                        const progress = this.state.audioPlayer.currentTime / this.state.audioPlayer.duration;
                        
                        // Animate voice bars during playback
                        const bars = this.elements.voicePreviewWaveform.querySelectorAll('.voice-preview-bar');
                        bars.forEach((bar, index) => {
                            const baseHeight = 10 + (index % 3) * 5;
                            const animation = Math.sin((Date.now() / 100) + index) * 8;
                            bar.style.height = `${baseHeight + animation}px`;
                        });
                    });
                }
                
                if (this.state.isPlaying) {
                    this.state.audioPlayer.pause();
                    this.state.isPlaying = false;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    this.state.audioPlayer.play();
                    this.state.isPlaying = true;
                    this.elements.voicePreviewPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                }
            }

            deleteVoicePreview() {
                if (this.state.audioPlayer) {
                    this.state.audioPlayer.pause();
                    this.state.audioPlayer = null;
                }
                this.state.isPlaying = false;
                this.hideVoicePreview();
            }

            sendVoiceMessage() {
                this.sendMessage();
            }

            playVoiceMessage(audioUrl, voiceElement) {
                const audio = new Audio(audioUrl);
                const playBtn = voiceElement.querySelector('.voice-play-btn');
                const voiceBars = voiceElement.querySelectorAll('.voice-bar');
                
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                audio.addEventListener('timeupdate', () => {
                    const progress = audio.currentTime / audio.duration;
                    
                    // Animate voice bars during playback
                    voiceBars.forEach((bar, index) => {
                        const baseHeight = 5 + (index % 3) * 3;
                        const animation = Math.sin((Date.now() / 100) + index) * 5;
                        bar.style.height = `${baseHeight + animation}px`;
                    });
                });
                
                audio.addEventListener('ended', () => {
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    // Reset voice bars
                    voiceBars.forEach(bar => {
                        bar.style.height = '10px';
                    });
                });
                
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            }

            // Media Handling
            handleAttachFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.previewMedia(file);
                    }
                };
                input.click();
            }

            previewMedia(file) {
                this.state.mediaFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.elements.mediaPreviewImage.src = e.target.result;
                    this.elements.mediaPreviewName.textContent = file.name;
                    this.elements.mediaPreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }

            sendMediaMessage() {
                this.sendMessage();
            }

            cancelMedia() {
                this.state.mediaFile = null;
                this.hideMediaPreview();
            }

            hideMediaPreview() {
                this.elements.mediaPreview.classList.remove('active');
            }

            // Context Menu
            showContextMenu(e, type, targetId = null) {
                e.preventDefault();
                
                this.state.contextMenu.type = type;
                this.state.contextMenu.target = targetId;
                
                const menu = this.elements.contextMenu;
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.add('active');
                
                // Show/hide menu items based on context
                if (type === 'user') {
                    this.elements.blockUserBtn.style.display = 'flex';
                    this.elements.deleteChatBtn.style.display = 'none';
                } else if (type === 'conversation') {
                    this.elements.blockUserBtn.style.display = 'flex';
                    this.elements.deleteChatBtn.style.display = 'flex';
                }
            }

            hideContextMenu() {
                this.elements.contextMenu.classList.remove('active');
            }

            async blockUser() {
                const targetId = this.state.contextMenu.target;
                if (!targetId) return;
                
                try {
                    // Add user to blocked list
                    const updatedBlockedUsers = [...this.state.blockedUsers, targetId];
                    
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            blockedUsers: updatedBlockedUsers
                        });
                    
                    this.state.blockedUsers = updatedBlockedUsers;
                    
                    // Remove conversation with blocked user
                    const conversationIndex = this.state.conversations.findIndex(conv => 
                        conv.participants.includes(targetId)
                    );
                    
                    if (conversationIndex !== -1) {
                        this.state.conversations.splice(conversationIndex, 1);
                        this.renderConversations();
                    }
                    
                    // If currently in conversation with blocked user, exit
                    if (this.state.activeConversation && 
                        this.state.activeConversation.user && 
                        this.state.activeConversation.user.id === targetId) {
                        this.exitConversationView();
                    }
                    
                    this.hideContextMenu();
                    this.showNotification('User Blocked', 'This user can no longer message you');
                    
                } catch (error) {
                    console.error('Error blocking user:', error);
                    this.showError('Failed to block user');
                }
            }

            async deleteChat() {
                const conversationId = this.state.contextMenu.target;
                if (!conversationId) return;
                
                try {
                    // Remove conversation from Firestore
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(conversationId)
                        .delete();
                    
                    // Remove from local state
                    const conversationIndex = this.state.conversations.findIndex(conv => conv.id === conversationId);
                    if (conversationIndex !== -1) {
                        this.state.conversations.splice(conversationIndex, 1);
                        this.renderConversations();
                    }
                    
                    // If currently viewing this conversation, exit
                    if (this.state.activeConversation && this.state.activeConversation.id === conversationId) {
                        this.exitConversationView();
                    }
                    
                    this.hideContextMenu();
                    this.showNotification('Chat Deleted', 'The conversation has been deleted');
                    
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    this.showError('Failed to delete chat');
                }
            }

            // UI Methods
            enterConversationView() {
                this.state.isInConversationView = true;
                this.elements.mainContainer.classList.add('conversation-view');
                this.elements.conversationView.style.display = 'block';
                this.elements.emptyState.style.display = 'none';
                
                // Hide floating search in conversation view
                this.elements.floatingSearch.style.display = 'none';
            }

            exitConversationView() {
                this.state.isInConversationView = false;
                this.elements.mainContainer.classList.remove('conversation-view');
                this.elements.conversationView.style.display = 'none';
                this.elements.emptyState.style.display = 'flex';
                this.state.activeConversation = null;
                this.state.conversationId = null;
                this.state.recipientPricing = null;
                
                // Show floating search again
                this.elements.floatingSearch.style.display = 'flex';
                
                // Update URL to remove conversation parameter
                const url = new URL(window.location);
                url.searchParams.delete('conversation');
                window.history.replaceState({}, '', url);
            }

            showLoading() {
                this.elements.conversationUserName.textContent = 'Loading...';
                this.elements.statusText.textContent = '';
            }

            updateConversationHeader() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                
                const user = this.state.activeConversation.user;
                
                this.elements.conversationUserName.textContent = user.name;
                
                if (user.profilePicture) {
                    this.elements.conversationAvatar.innerHTML = `<img src="${user.profilePicture}" alt="${user.name}" loading="lazy">`;
                } else {
                    this.elements.conversationAvatar.textContent = user.name.charAt(0).toUpperCase();
                }
                
                const status = user.onlineStatus || 'offline';
                this.elements.conversationUserStatus.innerHTML = `
                    <span class="status-indicator status-${status}"></span>
                    <span id="statusText">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
            }

            handleInputResize() {
                const textarea = this.elements.chatInput;
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, 120);
                textarea.style.height = newHeight + 'px';
                
                // Adjust input area padding based on height
                const inputArea = document.querySelector('.input-area');
                if (newHeight > 60) {
                    inputArea.style.paddingBottom = '20px';
                } else {
                    inputArea.style.paddingBottom = '15px';
                }
            }

            updateWordCounter() {
                const content = this.elements.chatInput.value.trim();
                if (!content || !this.state.recipientPricing) {
                    this.elements.wordCounter.style.display = 'none';
                    return;
                }
                
                const wordCount = content.split(/\s+/).length;
                const baseWords = 35;
                const baseCost = this.state.recipientPricing.text;
                
                let cost = baseCost;
                let extraInfo = '';
                
                if (wordCount > baseWords) {
                    const extraWords = wordCount - baseWords;
                    const extraCost = Math.ceil(extraWords / 10) * (baseCost / 3);
                    cost = baseCost + extraCost;
                    extraInfo = ` (+₦${extraCost} for ${extraWords} extra words)`;
                }
                
                this.elements.wordCounter.textContent = `${wordCount}/35 words • ₦${cost}${extraInfo}`;
                this.elements.wordCounter.style.display = 'block';
                
                if (wordCount > baseWords) {
                    this.elements.wordCounter.classList.add('near-limit');
                } else {
                    this.elements.wordCounter.classList.remove('near-limit');
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messagesArea.scrollTop = this.elements.messagesArea.scrollHeight;
                }, 100);
            }

            viewUserProfile() {
                if (!this.state.activeConversation || !this.state.activeConversation.user) return;
                const userId = this.state.activeConversation.user.id;
                window.location.href = `profile.html?user=${userId}`;
            }

            async startNewChat() {
                const username = prompt('Enter username to start a chat:');
                if (!username) return;
                
                try {
                    // Search for user by username
                    const usersSnapshot = await firebase.firestore()
                        .collection('users')
                        .where('username', '==', username)
                        .limit(1)
                        .get();
                    
                    if (usersSnapshot.empty) {
                        this.showError('User not found');
                        return;
                    }
                    
                    const userDoc = usersSnapshot.docs[0];
                    this.startConversation(userDoc.id);
                } catch (error) {
                    console.error('Error starting new chat:', error);
                    this.showError('Failed to start new chat');
                }
            }

            // Search functionality
            toggleSearch() {
                if (this.state.isSearchActive) {
                    this.closeSearch();
                } else {
                    this.openSearch();
                }
            }

            openSearch() {
                this.state.isSearchActive = true;
                this.elements.floatingSearch.classList.add('active');
                this.elements.searchInput.focus();
            }

            closeSearch() {
                this.state.isSearchActive = false;
                this.elements.floatingSearch.classList.remove('active');
                this.elements.searchInput.value = '';
                this.hideSearchResults();
            }

            async handleSearch() {
                const query = this.elements.searchInput.value.toLowerCase().trim();
                
                if (!query) {
                    this.hideSearchResults();
                    return;
                }
                
                // Implement search logic here
                // This is a simplified version - you would typically search your database
                console.log('Searching for:', query);
            }

            hideSearchResults() {
                // Implement hide search results
            }

            // Settings Methods
            showSettingsModal() {
                // Load current settings
                this.elements.onlineStatus.value = this.state.settings.onlineStatus;
                this.elements.messageSounds.value = this.state.settings.messageSounds;
                this.elements.browserNotifications.value = this.state.settings.browserNotifications;
                
                this.elements.settingsModal.classList.add('active');
            }

            hideSettingsModal() {
                this.elements.settingsModal.classList.remove('active');
            }

            async saveSettings() {
                try {
                    this.state.settings.onlineStatus = this.elements.onlineStatus.value;
                    this.state.settings.messageSounds = this.elements.messageSounds.value;
                    this.state.settings.browserNotifications = this.elements.browserNotifications.value;
                    
                    // Update user's online status in Firestore
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            onlineStatus: this.state.settings.onlineStatus
                        });
                    
                    this.showNotification('Settings Saved', 'Your chat settings have been updated');
                    this.hideSettingsModal();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Failed to save settings');
                }
            }

            // Monetization Application Methods
            showApplicationModal() {
                this.elements.monetizationApplicationModal.classList.add('active');
            }

            hideApplicationModal() {
                this.elements.monetizationApplicationModal.classList.remove('active');
                this.resetApplicationForm();
            }

            async startCamera() {
                try {
                    this.state.cameraStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: 640, 
                            height: 480,
                            facingMode: 'user'
                        } 
                    });
                    
                    this.elements.cameraVideo.srcObject = this.state.cameraStream;
                    this.elements.cameraVideo.style.display = 'block';
                    this.elements.cameraInstructions.style.display = 'none';
                    this.elements.cameraControls.style.display = 'flex';
                    this.elements.startCameraBtn.style.display = 'none';
                    this.elements.captureBtn.style.display = 'block';
                    this.elements.retakeBtn.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    this.showError('Could not access camera');
                }
            }

            capturePhoto() {
                const video = this.elements.cameraVideo;
                const canvas = this.elements.cameraCanvas;
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Stop the camera stream
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Show the captured image
                this.elements.cameraPreview.src = canvas.toDataURL('image/png');
                this.elements.cameraPreview.classList.add('active');
                this.elements.cameraVideo.style.display = 'none';
                this.elements.captureBtn.style.display = 'none';
                this.elements.retakeBtn.style.display = 'block';
                
                // Store the image data
                canvas.toBlob(blob => {
                    this.state.applicationPhoto = blob;
                }, 'image/png');
            }

            retakePhoto() {
                this.elements.cameraPreview.classList.remove('active');
                this.elements.cameraPreview.src = '';
                this.state.applicationPhoto = null;
                this.startCamera();
            }

            async submitApplication(e) {
                e.preventDefault();
                
                try {
                    // Enhanced validation
                    const requiredFields = [
                        this.elements.fullName,
                        this.elements.age, 
                        this.elements.country,
                        this.elements.socialMediaLinks,
                        this.elements.contactMethod,
                        this.elements.contactInfo
                    ];
                    
                    const missingFields = requiredFields.filter(field => !field.value.trim());
                    if (missingFields.length > 0 || !this.state.applicationPhoto) {
                        this.showError('Please fill all fields and take a verification photo');
                        return;
                    }

                    // Show loading state with timeout protection
                    this.elements.submitApplicationBtn.innerHTML = '<div class="loading"></div> Submitting...';
                    this.elements.submitApplicationBtn.disabled = true;

                    // Add timeout to prevent infinite loading
                    const submissionTimeout = setTimeout(() => {
                        this.showError('Submission timeout. Please try again.');
                        this.resetApplicationButton();
                    }, 30000);

                    // Upload photo with error handling
                    let photoUrl;
                    try {
                        const photoRef = firebase.storage().ref().child(`applications/${this.state.currentUser.uid}/${Date.now()}_verification.png`);
                        const snapshot = await photoRef.put(this.state.applicationPhoto);
                        photoUrl = await snapshot.ref.getDownloadURL();
                    } catch (uploadError) {
                        console.error('Photo upload failed:', uploadError);
                        this.showError('Failed to upload verification photo');
                        this.resetApplicationButton();
                        clearTimeout(submissionTimeout);
                        return;
                    }

                    // Create application data
                    const applicationData = {
                        applicantId: this.state.currentUser.uid,
                        applicantName: this.state.userProfile?.name || 'Unknown',
                        fullName: this.elements.fullName.value.trim(),
                        age: parseInt(this.elements.age.value),
                        country: this.elements.country.value.trim(),
                        socialMediaLinks: this.elements.socialMediaLinks.value.trim(),
                        contactMethod: this.elements.contactMethod.value,
                        contactInfo: this.elements.contactInfo.value.trim(),
                        photoUrl: photoUrl,
                        appliedAt: new Date().toISOString(),
                        status: 'pending'
                    };

                    // Save application to Firestore
                    await firebase.firestore()
                        .collection('monetizationApplications')
                        .add(applicationData);

                    // Send DM to recruitmentor
                    await this.sendApplicationToRecruitment(applicationData);

                    clearTimeout(submissionTimeout);
                    this.showNotification('Application Submitted', 'Your application has been submitted and is under review');
                    this.hideApplicationModal();

                } catch (error) {
                    console.error('Error submitting application:', error);
                    this.showError('Failed to submit application. Please check your connection and try again.');
                } finally {
                    this.resetApplicationButton();
                }
            }

            resetApplicationButton() {
                this.elements.submitApplicationBtn.innerHTML = 'Submit Application';
                this.elements.submitApplicationBtn.disabled = false;
            }

            async sendApplicationToRecruitment(applicationData) {
                try {
                    // Find recruitmentor user
                    const recruitmentorSnapshot = await firebase.firestore()
                        .collection('users')
                        .where('username', '==', 'recruitmentor')
                        .limit(1)
                        .get();

                    if (recruitmentorSnapshot.empty) {
                        console.error('Recruitmentor user not found');
                        return;
                    }

                    const recruitmentor = recruitmentorSnapshot.docs[0];
                    const recruitmentorId = recruitmentor.id;

                    // Check if conversation already exists
                    const existingConversation = this.state.conversations.find(conv => 
                        conv.participants.includes(recruitmentorId)
                    );

                    let conversationId;
                    if (existingConversation) {
                        conversationId = existingConversation.id;
                    } else {
                        // Create new conversation with recruitmentor
                        const conversationData = {
                            participants: [this.state.currentUser.uid, recruitmentorId],
                            participantsData: {
                                [this.state.currentUser.uid]: {
                                    name: this.state.userProfile.name,
                                    profilePicture: this.state.userProfile.profilePicture,
                                    onlineStatus: 'online'
                                },
                                [recruitmentorId]: {
                                    name: 'Recruitment Team',
                                    profilePicture: recruitmentor.data().profilePicture,
                                    onlineStatus: 'offline'
                                }
                            },
                            messages: [],
                            lastMessage: 'Monetization Application',
                            lastMessageType: 'system',
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            unreadCount: {
                                [this.state.currentUser.uid]: 0,
                                [recruitmentorId]: 1
                            }
                        };

                        const conversationRef = await firebase.firestore()
                            .collection('conversations')
                            .add(conversationData);
                        
                        conversationId = conversationRef.id;
                    }

                    // Create application message with action buttons
                    const applicationMessage = {
                        id: Date.now().toString(),
                        senderId: this.state.currentUser.uid,
                        type: 'application',
                        applicationData: applicationData,
                        createdAt: new Date().toISOString(),
                        actions: [
                            { type: 'approve_mentor', label: 'Make Mentor' },
                            { type: 'approve_verified', label: 'Verify User' },
                            { type: 'approve_both', label: 'Both' },
                            { type: 'decline', label: 'Decline' }
                        ]
                    };

                    // Add message to conversation
                    await firebase.firestore()
                        .collection('conversations')
                        .doc(conversationId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayUnion(applicationMessage),
                            lastMessage: 'Monetization Application',
                            lastMessageType: 'application',
                            lastMessageSender: this.state.currentUser.uid,
                            lastMessageAt: new Date().toISOString(),
                            [`unreadCount.${recruitmentorId}`]: firebase.firestore.FieldValue.increment(1)
                        });

                } catch (error) {
                    console.error('Error sending application to recruitment:', error);
                }
            }

            resetApplicationForm() {
                this.elements.monetizationApplicationForm.reset();
                this.elements.cameraPreview.classList.remove('active');
                this.elements.cameraPreview.src = '';
                this.elements.cameraVideo.style.display = 'none';
                this.elements.cameraInstructions.style.display = 'block';
                this.elements.cameraControls.style.display = 'none';
                this.elements.startCameraBtn.style.display = 'block';
                this.state.applicationPhoto = null;
                
                // Stop camera if it's running
                if (this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(track => track.stop());
                    this.state.cameraStream = null;
                }
            }

            async saveCustomPricing() {
                try {
                    const textPrice = parseInt(this.elements.textMessagePrice.value);
                    const voicePrice = parseInt(this.elements.voiceMessagePrice.value);
                    const imagePrice = parseInt(this.elements.imageMessagePrice.value);
                    
                    if (textPrice < 5 || textPrice > 1000) {
                        this.showError('Text message price must be between ₦5 and ₦1000');
                        return;
                    }
                    
                    if (voicePrice < 10 || voicePrice > 5000) {
                        this.showError('Voice message price must be between ₦10 and ₦5000 per minute');
                        return;
                    }

                    if (imagePrice < 5 || imagePrice > 1000) {
                        this.showError('Image message price must be between ₦5 and ₦1000');
                        return;
                    }
                    
                    // Save to user profile
                    await firebase.firestore()
                        .collection('users')
                        .doc(this.state.currentUser.uid)
                        .update({
                            customPricing: {
                                text: textPrice,
                                voice: voicePrice,
                                image: imagePrice
                            }
                        });
                    
                    this.showNotification('Pricing Updated', 'Your custom pricing has been saved');
                } catch (error) {
                    console.error('Error saving custom pricing:', error);
                    this.showError('Failed to save custom pricing');
                }
            }

            // Utility Methods
            formatTime(timestamp) {
                if (!timestamp) return 'Just now';
                
                const now = new Date();
                const postTime = new Date(timestamp);
                const diff = now - postTime;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (days > 0) return `${days}d ago`;
                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return 'Just now';
            }

            formatAudioTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            parseDuration(durationStr) {
                // Parse duration string like "01:25" to seconds
                const parts = durationStr.split(':');
                if (parts.length !== 2) return 0;
                
                const minutes = parseInt(parts[0]);
                const seconds = parseInt(parts[1]);
                
                return (minutes * 60) + seconds;
            }

            generateVoiceWaveform() {
                let waveform = '';
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 20) + 5;
                    waveform += `<div class="voice-bar" style="height: ${height}px;"></div>`;
                }
                return waveform;
            }

            async handleURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const conversationId = urlParams.get('conversation');
                
                if (conversationId) {
                    await this.loadConversation(conversationId);
                }
            }

            showError(message) {
                // Create a more user-friendly error notification
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--warning-color);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideInRight 0.3s ease;
                `;
                errorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            showNotification(title, message) {
                // Create a more user-friendly notification
                const notificationDiv = document.createElement('div');
                notificationDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--primary-color);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideInRight 0.3s ease;
                `;
                notificationDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">${title}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${message}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notificationDiv);
                
                setTimeout(() => {
                    notificationDiv.remove();
                }, 5000);
            }
        }

        // Initialize the chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.connectXChat = new ConnectXChat();
        });
    </script>
</body>
</html>
